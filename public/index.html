<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Pricing Calculator - Real-time Greeks & Analysis</title>
    <meta name="description" content="Interactive options pricing calculator with real-time Greeks analysis and model comparisons">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Math.js for calculations -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js"></script>
    
    <!-- Three.js for 3D visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fallback OrbitControls in case CDN fails -->
    <script>
        // OrbitControls fallback implementation
        if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
            THREE.OrbitControls = class OrbitControls {
                constructor(camera, domElement) {
                    this.camera = camera;
                    this.domElement = domElement;
                    this.enableDamping = true;
                    this.dampingFactor = 0.05;
                    this.enableZoom = true;
                    this.enableRotate = true;
                    this.enablePan = true;
                    
                    this.mouseX = 0;
                    this.mouseY = 0;
                    this.isMouseDown = false;
                    
                    this.initEventListeners();
                }
                
                initEventListeners() {
                    this.domElement.addEventListener('mousedown', (e) => {
                        this.isMouseDown = true;
                        this.mouseX = e.clientX;
                        this.mouseY = e.clientY;
                    });
                    
                    this.domElement.addEventListener('mouseup', () => {
                        this.isMouseDown = false;
                    });
                    
                    this.domElement.addEventListener('mousemove', (e) => {
                        if (this.isMouseDown && this.enableRotate) {
                            const deltaX = e.clientX - this.mouseX;
                            const deltaY = e.clientY - this.mouseY;
                            
                            this.camera.position.x = this.camera.position.x * Math.cos(deltaX * 0.01) - this.camera.position.z * Math.sin(deltaX * 0.01);
                            this.camera.position.z = this.camera.position.x * Math.sin(deltaX * 0.01) + this.camera.position.z * Math.cos(deltaX * 0.01);
                            this.camera.position.y += deltaY * 0.1;
                            
                            this.camera.lookAt(0, 0, 0);
                            
                            this.mouseX = e.clientX;
                            this.mouseY = e.clientY;
                        }
                    });
                    
                    this.domElement.addEventListener('wheel', (e) => {
                        if (this.enableZoom) {
                            const scale = e.deltaY > 0 ? 1.1 : 0.9;
                            this.camera.position.multiplyScalar(scale);
                            e.preventDefault();
                        }
                    });
                }
                
                update() {
                    // Basic damping could be implemented here
                }
            };
        }
    </script>
    
    <style>
        /* Custom animations and styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Options Calculator</h1>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors">Home</a>
                    <a href="#calculator" class="text-gray-600 hover:text-blue-600 transition-colors">Calculator</a>
                    <a href="#greeks" class="text-gray-600 hover:text-blue-600 transition-colors">Greeks</a>
                    <a href="#learn" class="text-gray-600 hover:text-blue-600 transition-colors">Learn</a>
                    <a href="#playground" class="text-gray-600 hover:text-blue-600 transition-colors">Playground</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-gradient text-white py-20">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-5xl font-bold mb-6">Advanced Options Pricing & Greeks Analysis</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Real-time options pricing with comprehensive Greeks analysis. 
                Professional-grade calculations using multiple validated pricing models.
            </p>
            <div class="flex justify-center space-x-4">
                <button onclick="scrollToSection('calculator')" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    Start Calculating
                </button>
                <button onclick="scrollToSection('learn')" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors">
                    Learn Basics
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        <!-- Options Calculator Section -->
        <section id="calculator" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Options Calculator</h3>
                
                <!-- Calculator Form -->
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Option Parameters</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol (Optional)</label>
                            <input type="text" id="symbol" placeholder="AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Price ($)</label>
                            <input type="number" id="stockPrice" value="150" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Strike Price ($)</label>
                            <input type="number" id="strikePrice" value="155" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Days to Expiry</label>
                            <input type="number" id="daysToExpiry" value="30" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Volatility (%)</label>
                            <input type="number" id="volatility" value="25" step="0.1" min="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Option Type</label>
                            <select id="optionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                            </select>
                        </div>
                        
                        <button onclick="calculateOption()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Calculate Option Price
                        </button>
                    </div>
                    
                    <!-- Results Display -->
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Pricing Results</h4>
                        <div id="results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Enter parameters and click calculate to see results
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Visualization Section -->
        <section id="greeks" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Greeks Dashboard</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Values</h4>
                        <div id="greeksDisplay" class="space-y-3">
                            <!-- Greeks will be displayed here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Chart</h4>
                        <div class="relative w-full" style="height: 400px;">
                            <canvas id="greeksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Greeks Tutorial -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎓 Interactive Greeks Tutorial</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">Learn the difference between actual rates and sensitivity measures through interactive examples. This addresses the common confusion between rates and Greeks.</p>
                
                <!-- Tutorial Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">📊</span>
                            Risk-Free Rate (Actual Rate)
                        </h4>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="text-sm font-medium text-gray-700 w-16">Rate:</label>
                            <input type="range" id="tutorialRate" min="1" max="10" step="0.5" value="4" class="flex-1">
                            <span id="tutorialRateValue" class="text-xl font-bold text-green-600 w-16">4.0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This is the actual interest rate in the economy:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• Fed funds rate</li>
                                <li>• Treasury bond yields</li>
                                <li>• What banks pay on deposits</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">⚡</span>
                            Rho (Rate Sensitivity)
                        </h4>
                        <div class="text-center mb-3">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="tutorialRhoValue">$0.27</div>
                            <p class="text-sm text-gray-600">per 1% rate change</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This tells you how much your option price changes:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• NOT the rate itself</li>
                                <li>• Rate of change (derivative)</li>
                                <li>• Like speed vs distance</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Demonstration -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="font-semibold text-gray-800 mb-6 text-center flex items-center justify-center">
                        <span class="text-2xl mr-2">🎯</span>
                        See the Difference in Action
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="p-6 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-2xl font-bold text-green-700 mb-2" id="currentOptionPrice">$8.45</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Current Option Price</p>
                            <p class="text-xs text-green-600">At <span id="currentRate1">4.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-2xl font-bold text-blue-700 mb-2" id="newOptionPrice">$8.72</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">New Option Price</p>
                            <p class="text-xs text-blue-600">At <span id="newRate">5.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-2xl font-bold text-purple-700 mb-2" id="priceChange">+$0.27</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Price Change</p>
                            <p class="text-xs text-purple-600 font-semibold">This equals Rho!</p>
                        </div>
                    </div>
                    
                    <!-- Dynamic Explanation -->
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center">
                            <span class="text-xl mr-2">💡</span>
                            Key Insight
                        </h5>
                        <div class="space-y-2 text-amber-700">
                            <p class="font-medium">
                                Risk-Free Rate = <span id="explanationCurrentRate">4%</span> (the actual rate)
                            </p>
                            <p class="font-medium">
                                Rho = <span id="explanationRho">$0.27</span> (how much price changes per 1% rate move)
                            </p>
                            <p class="text-sm border-t border-amber-200 pt-2 mt-3">
                                <strong>Example:</strong> If rates go from <span id="explanationFromRate">4%</span> → <span id="explanationToRate">5%</span>, 
                                your option gains <span id="explanationGain">$0.27</span> in value.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Algorithm Animations Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎬 Algorithm Visualizations</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">See how options pricing models work step-by-step. Watch the mathematics come to life through interactive animations.</p>
                
                <!-- Algorithm Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showAlgorithm('binomial')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="binomialBtn">
                        🌳 Binomial Tree
                    </button>
                    <button onclick="showAlgorithm('trinomial')" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors" id="trinomialBtn">
                        🔷 Trinomial Tree
                    </button>
                    <button onclick="showAlgorithm('blackscholes')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="blackscholesBtn">
                        📐 Black-Scholes
                    </button>
                    <button onclick="showAlgorithm('montecarlo')" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="montecarloBtn">
                        🎲 Monte Carlo
                    </button>
                </div>
                
                <!-- Binomial Tree Animation -->
                <div id="binomialAnimation" class="algorithm-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🌳</span>
                            Binomial Tree Model (Cox-Ross-Rubinstein)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Step-by-Step Construction</h5>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Steps:</span>
                                            <input type="range" id="binomialSteps" min="1" max="5" value="3" class="ml-4">
                                            <span id="binomialStepsValue" class="font-bold ml-2">3</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Speed:</span>
                                            <input type="range" id="animationSpeed" min="500" max="3000" value="1500" class="ml-4">
                                            <span class="text-xs ml-2">Slow → Fast</span>
                                        </div>
                                        <button onclick="animateBinomialTree()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-3">
                                            ▶️ Animate Tree Construction
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tree Visualization Canvas -->
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="treeCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">🌳</div>
                                            <p>Click "Animate Tree Construction" to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Explanation Panel -->
                            <div class="space-y-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">How It Works</h5>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <div class="step-explanation" id="step1">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">1</span>
                                                <div>
                                                    <strong>Start:</strong> Current stock price S₀ = $<span class="font-mono">100</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step2">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">2</span>
                                                <div>
                                                    <strong>Up/Down:</strong> Price can go up by factor u = <span class="font-mono">1.05</span> or down by d = <span class="font-mono">0.95</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step3">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">3</span>
                                                <div>
                                                    <strong>Risk-Neutral:</strong> Probability p = <span class="font-mono">0.52</span>, (1-p) = <span class="font-mono">0.48</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step4">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">4</span>
                                                <div>
                                                    <strong>Work Backwards:</strong> Start from expiry, calculate option values at each node
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">Current Step</h5>
                                    <div id="currentStepDisplay" class="text-sm text-amber-700">
                                        Ready to begin animation...
                                    </div>
                                </div>
                                
                                <!-- Mathematical Formula -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Key Formulas</h5>
                                    <div class="space-y-2 text-xs font-mono text-gray-600">
                                        <div>u = e^(σ√Δt) ≈ 1.05</div>
                                        <div>d = 1/u ≈ 0.95</div>
                                        <div>p = (e^(rΔt) - d)/(u - d)</div>
                                        <div>V = e^(-rΔt)[pV_up + (1-p)V_down]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trinomial Tree Animation -->
                <div id="trinomialAnimation" class="algorithm-content" style="display: none;">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🔷</span>
                            Trinomial Tree Model (Boyle)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h5 class="text-lg font-semibold">Tree Evolution</h5>
                                    <div class="flex gap-2">
                                        <button onclick="animateTrinomialTree()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">
                                            ▶️ Animate
                                        </button>
                                        <button onclick="resetTrinomialAnimation()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-semibold hover:bg-gray-700">
                                            🔄 Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="mb-4 space-y-3">
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Steps:</label>
                                        <input type="range" id="trinomialSteps" min="2" max="4" value="3" class="flex-1">
                                        <span id="trinomialStepsDisplay" class="text-sm font-mono">3</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Speed:</label>
                                        <input type="range" id="trinomialSpeed" min="500" max="3000" value="1500" class="flex-1">
                                        <span class="text-sm">Slow ↔ Fast</span>
                                    </div>
                                </div>
                                
                                <!-- Animation Canvas -->
                                <div id="trinomialCanvas" class="bg-gray-50 rounded-lg min-h-64 border overflow-auto">
                                    <div class="p-8 text-center text-gray-500">
                                        <div class="text-4xl mb-4">🔷</div>
                                        <p>Click "Animate" to see trinomial tree construction</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Educational Content -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Trinomial vs Binomial</h5>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔺</span>
                                                <div>
                                                    <strong>Up Move:</strong> Price increases by factor u = <span class="font-mono">e^(σ√(2Δt))</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">➡️</span>
                                                <div>
                                                    <strong>Middle Move:</strong> Price stays the same (unique to trinomial)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔻</span>
                                                <div>
                                                    <strong>Down Move:</strong> Price decreases by factor d = 1/u
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🎯</span>
                                                <div>
                                                    <strong>Better Accuracy:</strong> 16.4% more accurate than binomial trees
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Current Step</h5>
                                    <div id="trinomialStepDisplay" class="text-sm text-green-700">
                                        Ready to begin trinomial tree animation...
                                    </div>
                                </div>
                                
                                <!-- Probability Formulas -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Risk-Neutral Probabilities</h5>
                                    <div class="text-sm space-y-2 font-mono">
                                        <div><strong>p_u</strong> = ((e^(r·Δt) - d)(u - 1)) / ((u - d)(u - 1))</div>
                                        <div><strong>p_m</strong> = 1 - p_u - p_d</div>
                                        <div><strong>p_d</strong> = ((e^(r·Δt) - d)(1 - d)) / ((u - d)(1 - d))</div>
                                    </div>
                                </div>
                                
                                <!-- Advantages -->
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">🚀 Advantages</h5>
                                    <ul class="text-sm text-purple-700 space-y-1">
                                        <li>• <strong>Higher accuracy</strong> with fewer steps</li>
                                        <li>• <strong>Stable convergence</strong> to analytical solutions</li>
                                        <li>• <strong>Better for exotic options</strong> with barriers</li>
                                        <li>• <strong>Recommended model</strong> for production use</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monte Carlo Animation -->
                <div id="montecarloAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎲</span>
                            Monte Carlo Simulation
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Simulation Controls -->
                            <div class="space-y-4">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">Simulation Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Paths:</span>
                                            <input type="range" id="mcPaths" min="100" max="10000" step="100" value="1000" class="ml-4">
                                            <span id="mcPathsValue" class="font-bold ml-2">1,000</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Show Paths:</span>
                                            <input type="range" id="mcShowPaths" min="10" max="100" value="50" class="ml-4">
                                            <span id="mcShowPathsValue" class="font-bold ml-2">50</span>
                                        </div>
                                        <button onclick="animateMonteCarlo()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                            🎲 Run Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Statistics Panel -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Live Statistics</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Paths Completed:</span>
                                            <span id="mcPathsCompleted" class="font-bold">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Current Price:</span>
                                            <span id="mcCurrentPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Standard Error:</span>
                                            <span id="mcStandardError" class="font-bold">±$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Confidence:</span>
                                            <span id="mcConfidence" class="font-bold">95%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Path Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="mcCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📈</div>
                                            <p>Click "Run Simulation" to see random paths</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Insight -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-2">💡 Key Insight</h5>
                                    <p class="text-sm text-yellow-700">
                                        Each path follows: S(t) = S₀ × e^((r-σ²/2)t + σ√t×Z) where Z ~ N(0,1). 
                                        More paths = more accurate price!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Black-Scholes Animation -->
                <div id="blackscholesAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📐</span>
                            Black-Scholes Formula
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formula Breakdown -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">Formula Components</h5>
                                    <button onclick="animateBlackScholes()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors mb-4">
                                        📐 Break Down Formula
                                    </button>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="formula-step opacity-30" id="bsStep1">
                                            <div class="font-mono bg-white p-2 rounded">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                                            <p class="text-purple-700 mt-1">Call option price formula</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep2">
                                            <div class="font-mono bg-white p-2 rounded">d₁ = [ln(S/K) + (r + σ²/2)T] / (σ√T)</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (adjusted for drift)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep3">
                                            <div class="font-mono bg-white p-2 rounded">d₂ = d₁ - σ√T</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (risk-adjusted)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep4">
                                            <div class="font-mono bg-white p-2 rounded">N(x) = Cumulative normal distribution</div>
                                            <p class="text-purple-700 mt-1">Probability of being in-the-money</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Calculation -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Live Calculation</h5>
                                    <div id="bsCalculation" class="space-y-2 text-sm font-mono">
                                        <div>S₀ = $100, K = $105, T = 0.082 years</div>
                                        <div>r = 4%, σ = 25%</div>
                                        <div id="bsLiveCalc">Click "Break Down Formula" to see calculation...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Normal Distribution Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-64" id="bsCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📊</div>
                                            <p>Normal distribution visualization will appear here</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Assumptions -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">⚠️ Key Assumptions</h5>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>• Constant volatility and risk-free rate</li>
                                        <li>• No dividends (can be adjusted)</li>
                                        <li>• European exercise only</li>
                                        <li>• Log-normal stock price distribution</li>
                                        <li>• No transaction costs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3D Greeks Surface Plots Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🌊 3D Greeks Surface Plots</h3>
                <p class="text-gray-600 text-center mb-8">Visualize how Greeks change across stock price and time dimensions</p>
                
                <!-- 3D Controls -->
                <div class="bg-white rounded-lg p-6 mb-6">
                    <div class="grid md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Greek to Visualize</label>
                            <select id="greek3D" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="delta">Delta (Price Sensitivity)</option>
                                <option value="gamma">Gamma (Delta Change)</option>
                                <option value="theta">Theta (Time Decay)</option>
                                <option value="vega">Vega (Volatility Sensitivity)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Base Stock Price ($)</label>
                            <input type="number" id="base3DStock" value="100" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price ($)</label>
                            <input type="number" id="strike3D" value="105" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Volatility (%)</label>
                            <input type="number" id="vol3D" value="25" min="5" max="100" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-center space-x-4 mb-4">
                        <button id="generate3D" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            🎨 Generate 3D Surface
                        </button>
                        <button id="rotate3D" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            🔄 Auto Rotate
                        </button>
                    </div>
                </div>
                
                <!-- 3D Canvas Container -->
                <div class="bg-white rounded-lg p-4 mb-6">
                    <div id="threejs-container" class="w-full h-96 bg-gray-900 rounded-lg relative">
                        <div id="loading3D" class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center">
                                <div class="animate-spin text-4xl mb-4">🌀</div>
                                <p>Loading 3D visualization...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3D Analysis Display -->
                <div id="surface-analysis" class="grid md:grid-cols-3 gap-4 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Surface Statistics</h5>
                        <div id="surface-stats" class="text-sm text-gray-600">
                            <div class="mb-1">Max Value: <span id="max-value" class="font-mono text-blue-600">--</span></div>
                            <div class="mb-1">Min Value: <span id="min-value" class="font-mono text-red-600">--</span></div>
                            <div>Range: <span id="value-range" class="font-mono text-green-600">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Key Insights</h5>
                        <div id="surface-insights" class="text-sm text-gray-600">
                            <div id="insight-text">Click "Generate 3D Surface" to see insights</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Interactive Guide</h5>
                        <div class="text-sm text-gray-600">
                            <div class="mb-1">🖱️ <strong>Mouse:</strong> Rotate view</div>
                            <div class="mb-1">🔍 <strong>Scroll:</strong> Zoom in/out</div>
                            <div>🎯 <strong>Click:</strong> Reset view</div>
                        </div>
                    </div>
                </div>

                <!-- Educational Context -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">🎓 Understanding 3D Greeks</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">What You're Seeing:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>X-Axis:</strong> Stock prices (around current price)</li>
                                <li>• <strong>Y-Axis:</strong> Time to expiration (days)</li>
                                <li>• <strong>Z-Axis (Height):</strong> Greek value</li>
                                <li>• <strong>Colors:</strong> Heat map of values</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">Key Patterns:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>Delta:</strong> Steeper near strike, flatter far away</li>
                                <li>• <strong>Gamma:</strong> Peaks at-the-money, fades with time</li>
                                <li>• <strong>Theta:</strong> Accelerates as expiration approaches</li>
                                <li>• <strong>Vega:</strong> Highest with time, peaks at-the-money</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Education Section -->
        <section id="learn" class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Understanding the Greeks</h3>
            
            <!-- Common Misconception Alert -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 mb-8">
                <div class="flex">
                    <div class="text-amber-400 text-2xl mr-3">⚠️</div>
                    <div>
                        <h4 class="text-lg font-semibold text-amber-800 mb-2">Common Confusion: Rho ≠ Risk-Free Rate</h4>
                        <p class="text-amber-700">The risk-free rate is the actual interest rate (like 4%). <strong>Rho</strong> is how much your option price <em>changes</em> when that rate moves by 1%.</p>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <h5 class="font-bold text-blue-800 mb-2">Delta (Δ)</h5>
                    <p class="text-sm text-blue-700 mb-2">Speed of price change</p>
                    <p class="text-xs text-gray-600">If stock moves $1, option moves ~$Delta. Call: 0-1, Put: -1-0</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                    <h5 class="font-bold text-green-800 mb-2">Gamma (Γ)</h5>
                    <p class="text-sm text-green-700 mb-2">Acceleration</p>
                    <p class="text-xs text-gray-600">How much Delta changes per $1 stock move. Higher = more responsive</p>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                    <h5 class="font-bold text-red-800 mb-2">Theta (Θ)</h5>
                    <p class="text-sm text-red-700 mb-2">Time decay</p>
                    <p class="text-xs text-gray-600">$ lost per day. Always negative - time kills options</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                    <h5 class="font-bold text-purple-800 mb-2">Vega (V)</h5>
                    <p class="text-sm text-purple-700 mb-2">Volatility sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% volatility move (25% → 26%)</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h5 class="font-bold text-yellow-800 mb-2">Rho (ρ)</h5>
                    <p class="text-sm text-yellow-700 mb-2">Rate sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% rate move (4% → 5%). Call: +, Put: -</p>
                </div>
            </div>

            <!-- Interactive Examples -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-semibold mb-4">Real-World Example</h4>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium mb-3">📱 AAPL $150 Call, $155 Strike, 30 days</h5>
                        <div class="space-y-2 text-sm">
                            <div><strong>Delta = 0.35:</strong> If AAPL rises $1 → Call gains ~$0.35</div>
                            <div><strong>Gamma = 0.02:</strong> That 0.35 delta becomes ~0.37</div>
                            <div><strong>Theta = -0.08:</strong> Loses $0.08 every day that passes</div>
                            <div><strong>Vega = 0.12:</strong> If volatility rises 1% → Call gains $0.12</div>
                            <div><strong>Rho = 0.27:</strong> If rates rise from 4%→5% → Call gains $0.27</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium mb-3">🎯 Key Insights</h5>
                        <ul class="text-sm space-y-1 text-gray-700">
                            <li>• <strong>All Greeks are rates of change</strong> (derivatives)</li>
                            <li>• Delta shows directional exposure</li>
                            <li>• Gamma shows how fast that changes</li>
                            <li>• Theta is your daily bleed</li>
                            <li>• Vega matters most for earnings/events</li>
                            <li>• Rho barely matters unless rates are moving fast</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Calculator Features</h3>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-blue-600 text-3xl mb-4">📊</div>
                    <h4 class="text-xl font-semibold mb-3">Real-time Pricing</h4>
                    <p class="text-gray-600 mb-4">Calculate options prices using multiple validated pricing models with instant results.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-green-600 text-3xl mb-4">📈</div>
                    <h4 class="text-xl font-semibold mb-3">Greeks Analysis</h4>
                    <p class="text-gray-600 mb-4">Complete Greeks calculation with visual charts showing risk sensitivities.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-purple-600 text-3xl mb-4">🧮</div>
                    <h4 class="text-xl font-semibold mb-3">Model Comparison</h4>
                    <p class="text-gray-600 mb-4">Compare Trinomial, Binomial, Black-Scholes, and Monte Carlo pricing side-by-side.</p>
                </div>
            </div>
        </section>

        <!-- Payoff Diagram Builder Section -->
        <section id="playground" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Strategy Builder & Payoff Diagrams</h3>
                
                <!-- Strategy Builder Controls -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Build Your Strategy</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                                <select id="strategyType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="single">Single Option</option>
                                    <option value="covered-call">Covered Call</option>
                                    <option value="protective-put">Protective Put</option>
                                    <option value="straddle">Long Straddle</option>
                                    <option value="strangle">Long Strangle</option>
                                    <option value="butterfly">Butterfly Spread</option>
                                    <option value="custom">Custom Multi-Leg</option>
                                </select>
                            </div>
                            
                            <div id="strategyParams" class="space-y-3">
                                <!-- Strategy parameters will be populated here -->
                            </div>
                            
                            <button onclick="buildPayoffDiagram()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Generate Payoff Diagram
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Payoff Chart</h4>
                        <div class="relative w-full bg-gray-50 rounded-lg" style="height: 300px;">
                            <canvas id="payoffChart"></canvas>
                        </div>
                        
                        <div id="strategyMetrics" class="mt-4 space-y-2">
                            <!-- Strategy metrics will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Predefined Strategy Examples -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-4">Popular Strategies</h4>
                    <div class="grid md:grid-cols-4 gap-4">
                        <button onclick="loadStrategy('covered-call')" class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-blue-800">Covered Call</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + sell call</p>
                            <p class="text-xs text-blue-600 mt-1">📈 Neutral/Bullish</p>
                        </button>
                        
                        <button onclick="loadStrategy('protective-put')" class="bg-green-50 hover:bg-green-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-green-800">Protective Put</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + buy put</p>
                            <p class="text-xs text-green-600 mt-1">📈 Bullish protection</p>
                        </button>
                        
                        <button onclick="loadStrategy('straddle')" class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-purple-800">Long Straddle</h5>
                            <p class="text-xs text-gray-600 mt-1">Buy call + put same strike</p>
                            <p class="text-xs text-purple-600 mt-1">⚡ High volatility play</p>
                        </button>
                        
                        <button onclick="loadStrategy('iron-condor')" class="bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-yellow-800">Iron Condor</h5>
                            <p class="text-xs text-gray-600 mt-1">4-leg neutral strategy</p>
                            <p class="text-xs text-yellow-600 mt-1">😴 Low volatility play</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">About</h3>
                <div class="text-center">
                    <p class="text-gray-600 mb-6">Professional options pricing calculator with advanced Greeks analysis and model comparison capabilities.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">Multiple Models</h5>
                            <p class="text-sm text-blue-600">Trinomial, Binomial, Black-Scholes, Monte Carlo</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">Real-time Greeks</h5>
                            <p class="text-sm text-green-600">Delta, Gamma, Theta, Vega, Rho analysis</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-2">Validated Accuracy</h5>
                            <p class="text-sm text-purple-600">Market-tested pricing algorithms</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-red-800 mb-2">Professional Grade</h5>
                            <p class="text-sm text-red-600">Industry-standard calculations</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h5 class="text-lg font-semibold mb-4">Options Calculator</h5>
                    <p class="text-gray-400">Professional-grade options pricing and Greeks analysis.</p>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Models</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Trinomial Trees</li>
                        <li>Binomial Trees</li>
                        <li>Black-Scholes</li>
                        <li>Monte Carlo</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Analysis</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Complete Greeks Suite</li>
                        <li>Model Comparison</li>
                        <li>Risk Visualization</li>
                        <li>Real-time Updates</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>Professional Options Pricing Calculator</p>
            </div>
        </div>
    </footer>

    <!-- Include the pricing library -->
    <script type="module" src="../lib/index.js"></script>
    
    <!-- Main application JavaScript -->
    <script type="module">
        // Import pricing functions from our validated library
        let pricingLibrary;
        let greeksChart;
        
        // Initialize the application
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Import pricing library
                const module = await import('../lib/index.js');
                pricingLibrary = module;
                console.log('🚀 Pricing library loaded successfully');
                console.log('📊 Loaded modules:', Object.keys(module));
                
                // Initialize Greeks chart with fixed responsive settings
                initializeGreeksChart();
                
            } catch (error) {
                console.error('❌ Failed to load pricing library:', error);
                // Show error to user
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Library Loading Error</h5>
                        <p class="text-sm">Failed to load the pricing library. Please check the console for details.</p>
                    </div>
                `;
            }
        });

        // Initialize Greeks radar chart with proper responsive settings
        function initializeGreeksChart() {
            const ctx = document.getElementById('greeksChart').getContext('2d');
            
            greeksChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Delta', 'Gamma', 'Theta', 'Vega', 'Rho'],
                    datasets: [{
                        label: 'Greeks Values',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                circular: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                display: false
                            },
                            min: -1,
                            max: 1
                        }
                    }
                }
            });
        }

        // Calculator functionality - with safety checks
        window.calculateOption = function() {
            // Prevent recursive calls
            if (isCalculating) {
                console.log('Already calculating, skipping...');
                return;
            }
            
            if (!pricingLibrary) {
                console.error('Pricing library not loaded yet');
                return;
            }

            isCalculating = true;

            try {
                const params = {
                    symbol: document.getElementById('symbol').value || undefined,
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    strikePrice: parseFloat(document.getElementById('strikePrice').value),
                    daysToExpiry: parseInt(document.getElementById('daysToExpiry').value),
                    volatility: parseFloat(document.getElementById('volatility').value) / 100,
                    optionType: document.getElementById('optionType').value
                };

                // Validate inputs
                if (isNaN(params.stockPrice) || isNaN(params.strikePrice) || isNaN(params.daysToExpiry) || isNaN(params.volatility)) {
                    throw new Error('Please enter valid numbers for all fields');
                }

                // Simple pricing only - no complex calculations
                const price = pricingLibrary.priceOption(params);
                
                // Basic Greeks calculation
                const greeks = pricingLibrary.calculateGreeks({
                    ...params,
                    timeToExpiry: params.daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                });
                
                displayResults(price, greeks, params);
                updateGreeksDisplay(greeks);
                updateGreeksChart(greeks);
                
            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Calculation Error</h5>
                        <p class="text-sm">Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                isCalculating = false;
            }
        };

        function displayResults(price, greeks, params) {
            const intrinsic = params.optionType === 'call' 
                ? Math.max(0, params.stockPrice - params.strikePrice)
                : Math.max(0, params.strikePrice - params.stockPrice);
            const timeValue = price - intrinsic;

            document.getElementById('results').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h5 class="font-semibold text-blue-800 mb-2">Option Price</h5>
                        <div class="text-3xl font-bold text-blue-600">$${price.toFixed(2)}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-sm text-green-600">Intrinsic Value</div>
                            <div class="font-semibold text-green-800">$${intrinsic.toFixed(2)}</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <div class="text-sm text-purple-600">Time Value</div>
                            <div class="font-semibold text-purple-800">$${timeValue.toFixed(2)}</div>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        function updateGreeksDisplay(greeks) {
            if (!greeks || Object.keys(greeks).length === 0) return;

            const greeksHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Delta</span>
                            <div class="text-xs text-gray-600">Price change per $1 stock move</div>
                            <div class="text-xs text-blue-700 mt-1">≈ ${((greeks.delta || 0) * 100).toFixed(1)}% of stock moves</div>
                        </div>
                        <span class="font-bold text-blue-600">${greeks.delta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Gamma</span>
                            <div class="text-xs text-gray-600">Delta change per $1 stock move</div>
                            <div class="text-xs text-green-700 mt-1">Higher = more delta acceleration</div>
                        </div>
                        <span class="font-bold text-green-600">${greeks.gamma?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Theta</span>
                            <div class="text-xs text-gray-600">Price decay per day</div>
                            <div class="text-xs text-red-700 mt-1">Time is your enemy: $${((greeks.theta || 0) * -1).toFixed(2)}/day lost</div>
                        </div>
                        <span class="font-bold text-red-600">${greeks.theta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Vega</span>
                            <div class="text-xs text-gray-600">Price change per 1% volatility</div>
                            <div class="text-xs text-purple-700 mt-1">Vol from ${((greeks.vega || 0) > 0 ? '24% → 25%' : '25% → 24%')} = $${Math.abs(greeks.vega || 0).toFixed(2)}</div>
                        </div>
                        <span class="font-bold text-purple-600">${greeks.vega?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Rho</span>
                            <div class="text-xs text-gray-600">Price change per 1% rate change</div>
                            <div class="text-xs text-yellow-700 mt-1">Rates 4% → 5% = $${(greeks.rho || 0).toFixed(2)} change</div>
                        </div>
                        <span class="font-bold text-yellow-600">${greeks.rho?.toFixed(4) || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('greeksDisplay').innerHTML = greeksHtml;
        }

        // Update Greeks chart with real values
        function updateGreeksChart(greeks) {
            if (!greeksChart || !greeks) return;
            
            // Normalize values for radar chart visualization
            const normalizeValue = (value, maxExpected) => {
                return Math.max(-1, Math.min(1, value / maxExpected));
            };
            
            const chartData = [
                normalizeValue(greeks.delta || 0, 1),      // Delta: -1 to 1
                normalizeValue(greeks.gamma || 0, 0.1),    // Gamma: normalize around 0.1
                normalizeValue(greeks.theta || 0, 0.1),    // Theta: normalize around 0.1 (daily)
                normalizeValue(greeks.vega || 0, 0.5),     // Vega: normalize around 0.5
                normalizeValue(greeks.rho || 0, 0.2)       // Rho: normalize around 0.2
            ];
            
            greeksChart.data.datasets[0].data = chartData;
            greeksChart.update('none'); // No animation for smooth real-time updates
        }

        // Smooth scrolling
        window.scrollToSection = function(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth' 
            });
        };

        // Manual calculation only - prevent infinite loops
        let isCalculating = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - ready for manual calculations');
            // Remove all auto-calculation to prevent infinite loops
        });

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Payoff Diagram Builder Functions
        let payoffChart;
        let currentStrategy = {};

        // Initialize payoff chart
        function initializePayoffChart() {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            
            payoffChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Strategy Payoff at Expiration'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price at Expiration ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)'
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load predefined strategy
        window.loadStrategy = function(strategyType) {
            document.getElementById('strategyType').value = strategyType;
            populateStrategyParams(strategyType);
            buildPayoffDiagram();
        };

        // Populate strategy parameters based on selected strategy
        function populateStrategyParams(strategyType) {
            const paramsContainer = document.getElementById('strategyParams');
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            
            let paramsHtml = '';
            
            switch (strategyType) {
                case 'single':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <select id="position" class="w-full px-2 py-1 border rounded">
                                <option value="long-call">Long Call</option>
                                <option value="short-call">Short Call</option>
                                <option value="long-put">Long Put</option>
                                <option value="short-put">Short Put</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="strike1" value="${stockPrice + 5}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'covered-call':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Sell 1 call</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'protective-put':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Buy 1 put</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'straddle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (same strike)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="straddleStrike" value="${stockPrice}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'strangle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (different strikes)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
            }
            
            paramsContainer.innerHTML = paramsHtml;
        }

        // Build and display payoff diagram
        window.buildPayoffDiagram = function() {
            if (!pricingLibrary) {
                console.error('Pricing library not loaded');
                return;
            }

            const strategyType = document.getElementById('strategyType').value;
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            const volatility = parseFloat(document.getElementById('volatility').value) / 100 || 0.25;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 30;
            
            // Generate stock price range for payoff calculation
            const minPrice = stockPrice * 0.7;
            const maxPrice = stockPrice * 1.3;
            const priceStep = (maxPrice - minPrice) / 50;
            const stockPrices = [];
            const payoffs = [];
            
            for (let price = minPrice; price <= maxPrice; price += priceStep) {
                stockPrices.push(price);
                payoffs.push(calculateStrategyPayoff(strategyType, price, stockPrice, volatility, daysToExpiry));
            }
            
            // Update chart
            payoffChart.data.labels = stockPrices.map(p => p.toFixed(0));
            payoffChart.data.datasets = [{
                label: getStrategyName(strategyType),
                data: payoffs,
                borderColor: 'rgb(147, 51, 234)',
                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                borderWidth: 2,
                fill: true
            }];
            
            payoffChart.update();
            
            // Update strategy metrics
            updateStrategyMetrics(strategyType, payoffs, stockPrices, stockPrice);
        };

        function calculateStrategyPayoff(strategyType, currentPrice, stockPrice, volatility, daysToExpiry) {
            const timeToExpiry = daysToExpiry / 365;
            
            switch (strategyType) {
                case 'single':
                    const position = document.getElementById('position')?.value || 'long-call';
                    const strike = parseFloat(document.getElementById('strike1')?.value) || stockPrice + 5;
                    
                    if (position === 'long-call') {
                        return Math.max(0, currentPrice - strike);
                    } else if (position === 'short-call') {
                        return -Math.max(0, currentPrice - strike);
                    } else if (position === 'long-put') {
                        return Math.max(0, strike - currentPrice);
                    } else if (position === 'short-put') {
                        return -Math.max(0, strike - currentPrice);
                    }
                    break;
                    
                case 'covered-call':
                    const callStrike = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const stockProfit = currentPrice - stockPrice;
                    const callPayoff = -Math.max(0, currentPrice - callStrike);
                    return stockProfit + callPayoff;
                    
                case 'protective-put':
                    const putStrike = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const stockProfitPP = currentPrice - stockPrice;
                    const putPayoff = Math.max(0, putStrike - currentPrice);
                    return stockProfitPP + putPayoff;
                    
                case 'straddle':
                    const straddleStrike = parseFloat(document.getElementById('straddleStrike')?.value) || stockPrice;
                    const callPayoffStraddle = Math.max(0, currentPrice - straddleStrike);
                    const putPayoffStraddle = Math.max(0, straddleStrike - currentPrice);
                    return callPayoffStraddle + putPayoffStraddle;
                    
                case 'strangle':
                    const putStrikeStrangle = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const callStrikeStrangle = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const callPayoffStrangle = Math.max(0, currentPrice - callStrikeStrangle);
                    const putPayoffStrangle = Math.max(0, putStrikeStrangle - currentPrice);
                    return callPayoffStrangle + putPayoffStrangle;
            }
            
            return 0;
        }

        function getStrategyName(strategyType) {
            const names = {
                'single': 'Single Option',
                'covered-call': 'Covered Call',
                'protective-put': 'Protective Put',
                'straddle': 'Long Straddle',
                'strangle': 'Long Strangle',
                'butterfly': 'Butterfly Spread'
            };
            return names[strategyType] || strategyType;
        }

        function updateStrategyMetrics(strategyType, payoffs, stockPrices, currentStockPrice) {
            const maxProfit = Math.max(...payoffs);
            const maxLoss = Math.min(...payoffs);
            const currentIndex = stockPrices.findIndex(p => p >= currentStockPrice);
            const currentPayoff = payoffs[currentIndex] || 0;
            
            // Find breakeven points
            const breakevens = [];
            for (let i = 1; i < payoffs.length; i++) {
                if ((payoffs[i-1] <= 0 && payoffs[i] >= 0) || (payoffs[i-1] >= 0 && payoffs[i] <= 0)) {
                    breakevens.push(stockPrices[i]);
                }
            }
            
            document.getElementById('strategyMetrics').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-green-50 p-2 rounded">
                        <div class="font-medium text-green-800">Max Profit</div>
                        <div class="text-green-600">$${maxProfit.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded">
                        <div class="font-medium text-red-800">Max Loss</div>
                        <div class="text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded col-span-2">
                        <div class="font-medium text-blue-800">Breakevens</div>
                        <div class="text-blue-600">$${breakevens.map(b => b.toFixed(2)).join(', ')}</div>
                    </div>
                </div>
            `;
        }

        // Initialize payoff chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add small delay to ensure Chart.js is ready
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    initializePayoffChart();
                    populateStrategyParams('single');
                }
            }, 500);
        });

        // Auto-update strategy params when strategy type changes
        document.addEventListener('change', function(e) {
            if (e.target.id === 'strategyType') {
                populateStrategyParams(e.target.value);
            }
        });

        // Interactive Greeks Tutorial Functionality
        function initializeTutorial() {
            const rateSlider = document.getElementById('tutorialRate');
            const rateValue = document.getElementById('tutorialRateValue');
            const rhoValue = document.getElementById('tutorialRhoValue');
            const currentPrice = document.getElementById('currentOptionPrice');
            const newPrice = document.getElementById('newOptionPrice');
            const priceChange = document.getElementById('priceChange');
            const currentRate1 = document.getElementById('currentRate1');
            const newRate = document.getElementById('newRate');
            const explanationCurrentRate = document.getElementById('explanationCurrentRate');
            const explanationRho = document.getElementById('explanationRho');
            const explanationFromRate = document.getElementById('explanationFromRate');
            const explanationToRate = document.getElementById('explanationToRate');
            const explanationGain = document.getElementById('explanationGain');
            
            // Base option parameters for tutorial
            const baseParams = {
                stockPrice: 100,
                strikePrice: 105,
                daysToExpiry: 30,
                volatility: 0.25,
                optionType: 'call'
            };
            
            function updateTutorial() {
                const currentRiskFreeRate = parseFloat(rateSlider.value) / 100;
                const newRiskFreeRate = currentRiskFreeRate + 0.01; // +1%
                
                // Update display values
                rateValue.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                currentRate1.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                newRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                explanationCurrentRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationFromRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationToRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                
                try {
                    if (pricingLibrary && pricingLibrary.binomialPrice) {
                        // Calculate prices at both rates
                        const priceAtCurrentRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: currentRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const priceAtNewRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: newRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const change = priceAtNewRate - priceAtCurrentRate;
                        
                        // Update displays
                        currentPrice.textContent = '$' + priceAtCurrentRate.toFixed(2);
                        newPrice.textContent = '$' + priceAtNewRate.toFixed(2);
                        priceChange.textContent = (change >= 0 ? '+' : '') + '$' + change.toFixed(2);
                        rhoValue.textContent = '$' + change.toFixed(2);
                        explanationRho.textContent = '$' + change.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(change).toFixed(2);
                        
                        // Color coding for price change
                        const changeColor = change >= 0 ? 'text-green-700' : 'text-red-700';
                        priceChange.className = `text-2xl font-bold ${changeColor} mb-2`;
                        
                    } else {
                        // Fallback with estimated values
                        const estimatedRho = 0.25 + (currentRiskFreeRate - 0.04) * 2; // Rough estimation
                        rhoValue.textContent = '$' + estimatedRho.toFixed(2);
                        explanationRho.textContent = '$' + estimatedRho.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(estimatedRho).toFixed(2);
                    }
                } catch (error) {
                    console.warn('Tutorial calculation error:', error);
                    // Show default values if calculation fails
                    const defaultRho = 0.27;
                    rhoValue.textContent = '$' + defaultRho.toFixed(2);
                    explanationRho.textContent = '$' + defaultRho.toFixed(2);
                    explanationGain.textContent = '$' + Math.abs(defaultRho).toFixed(2);
                }
            }
            
            // Initialize tutorial
            updateTutorial();
            
            // Add event listener for rate slider
            rateSlider.addEventListener('input', updateTutorial);
        }
        
        // Initialize tutorial when pricing library is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeTutorial();
                initializeAlgorithmAnimations();
            }, 1000); // Wait for pricing library to load
        });

        // Algorithm Animation Functionality
        function initializeAlgorithmAnimations() {
            // Initialize slider values
            document.getElementById('binomialSteps').addEventListener('input', function() {
                document.getElementById('binomialStepsValue').textContent = this.value;
            });
            
            // Trinomial tree input listeners
            document.getElementById('trinomialSteps').addEventListener('input', function() {
                document.getElementById('trinomialStepsDisplay').textContent = this.value;
            });
            
            document.getElementById('mcPaths').addEventListener('input', function() {
                document.getElementById('mcPathsValue').textContent = parseInt(this.value).toLocaleString();
            });
            
            document.getElementById('mcShowPaths').addEventListener('input', function() {
                document.getElementById('mcShowPathsValue').textContent = this.value;
            });
        }
        
        // Algorithm switching functionality
        function showAlgorithm(algorithm) {
            // Hide all algorithm content
            const contents = document.querySelectorAll('.algorithm-content');
            contents.forEach(content => {
                content.classList.add('hidden');
                content.style.display = 'none';
            });
            
            // Reset button styles
            const buttons = ['binomialBtn', 'trinomialBtn', 'blackscholesBtn', 'montecarloBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
            });
            
            // Show selected algorithm
            const targetElement = document.getElementById(algorithm + 'Animation');
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.style.display = 'block';
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(algorithm + 'Btn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getButtonColor(algorithm));
            }
        }
        
        function getButtonColor(algorithm) {
            const colors = {
                'binomial': 'bg-blue-700',
                'trinomial': 'bg-green-700',
                'blackscholes': 'bg-purple-700',
                'montecarlo': 'bg-red-700'
            };
            return colors[algorithm] || 'bg-blue-700';
        }
        
        // Binomial Tree Animation
        function animateBinomialTree() {
            const steps = parseInt(document.getElementById('binomialSteps').value);
            const speed = parseInt(document.getElementById('animationSpeed').value);
            const canvas = document.getElementById('treeCanvas');
            const stepDisplay = document.getElementById('currentStepDisplay');
            
            // Reset step explanations
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.opacity = '0.3';
            }
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">Building Binomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 4;
            
            function nextStep() {
                currentStep++;
                
                // Highlight current step
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}`).style.opacity = '1';
                }
                
                switch(currentStep) {
                    case 1:
                        stepDisplay.textContent = "Starting with current stock price S₀ = $100";
                        canvas.innerHTML = createTreeVisualization(1, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = "Adding up and down movements for each time step";
                        canvas.innerHTML = createTreeVisualization(2, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = "Calculating risk-neutral probabilities";
                        canvas.innerHTML = createTreeVisualization(3, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = "Working backwards to find option value";
                        canvas.innerHTML = createTreeVisualization(4, steps);
                        break;
                    default:
                        stepDisplay.textContent = "Animation complete! Tree shows all possible paths.";
                        return;
                }
                
                if (currentStep < totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }

        // Trinomial Tree Animation
        function animateTrinomialTree() {
            const steps = parseInt(document.getElementById('trinomialSteps').value);
            const speed = parseInt(document.getElementById('trinomialSpeed').value);
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            // Update steps display
            document.getElementById('trinomialStepsDisplay').textContent = steps;
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">🔷 Building Trinomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 5; // More steps for trinomial explanation
            
            function nextStep() {
                switch (currentStep) {
                    case 0:
                        stepDisplay.textContent = 'Step 1: Initialize root node with current stock price';
                        canvas.innerHTML = createTrinomialVisualization(1, steps);
                        break;
                    case 1:
                        stepDisplay.textContent = 'Step 2: Calculate up, middle, and down factors (u, m=1, d)';
                        canvas.innerHTML = createTrinomialVisualization(2, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = 'Step 3: Calculate risk-neutral probabilities (p_u, p_m, p_d)';
                        canvas.innerHTML = createTrinomialVisualization(3, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = 'Step 4: Build complete tree forward to expiration';
                        canvas.innerHTML = createTrinomialVisualization(4, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = 'Step 5: Work backwards calculating option values using trinomial recombination';
                        canvas.innerHTML = createTrinomialVisualization(5, steps);
                        break;
                }
                
                currentStep++;
                if (currentStep <= totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }
        
        function createTrinomialVisualization(step, maxSteps) {
            const S0 = 100; // Current stock price
            const u = 1.22; // Up factor (higher than binomial)
            const d = 1/u; // Down factor
            const m = 1.0; // Middle factor (stays same)
            
            let html = '<div class="p-4">';
            html += '<div class="text-center mb-4"><h6 class="font-bold text-lg">Trinomial Tree Construction</h6></div>';
            
            if (step >= 1) {
                // Root node
                html += '<div class="flex justify-center mb-4">';
                html += `<div class="bg-blue-100 border-2 border-blue-500 rounded-lg p-2 text-center">`;
                html += `<div class="font-bold">S₀</div><div class="text-sm">$${S0}</div>`;
                html += '</div></div>';
                
                if (step >= 2) {
                    // First level (showing three branches)
                    html += '<div class="flex justify-center space-x-8 mb-4">';
                    
                    // Up node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-green-100 border-2 border-green-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Su</div><div class="text-sm">$${(S0 * u).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-green-700">×${u.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Middle node (unique to trinomial)
                    html += `<div class="text-center">`;
                    html += `<div class="bg-yellow-100 border-2 border-yellow-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sm</div><div class="text-sm">$${(S0 * m).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-yellow-700">×${m.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Down node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-red-100 border-2 border-red-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sd</div><div class="text-sm">$${(S0 * d).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-red-700">×${d.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    html += '</div>';
                    
                    if (step >= 3) {
                        // Add probability explanations
                        html += '<div class="bg-gray-50 rounded-lg p-3 mt-4 text-center">';
                        html += '<div class="text-sm font-semibold mb-2">Risk-Neutral Probabilities:</div>';
                        html += '<div class="grid grid-cols-3 gap-4 text-xs">';
                        html += '<div class="text-green-700"><strong>p_u = 0.25</strong><br>Up probability</div>';
                        html += '<div class="text-yellow-700"><strong>p_m = 0.50</strong><br>Middle probability</div>';
                        html += '<div class="text-red-700"><strong>p_d = 0.25</strong><br>Down probability</div>';
                        html += '</div>';
                        html += '<div class="text-xs text-gray-600 mt-2">p_u + p_m + p_d = 1.0 ✓</div>';
                        html += '</div>';
                        
                        if (step >= 4) {
                            // Show next level to demonstrate recombination
                            html += '<div class="mt-6">';
                            html += '<div class="text-center text-sm font-semibold mb-3">Next Time Step (Recombining Tree):</div>';
                            html += '<div class="flex justify-center space-x-4">';
                            
                            const prices = [
                                S0 * u * u,
                                S0 * u * m,
                                S0 * u * d, // Same as S0 * m * u (recombining!)
                                S0 * m * d,
                                S0 * d * d
                            ];
                            
                            prices.forEach((price, i) => {
                                let colorClass = '';
                                if (i === 0) {
                                    colorClass = 'bg-green-50 border-green-300';
                                } else if (i === prices.length - 1) {
                                    colorClass = 'bg-red-50 border-red-300';
                                } else {
                                    colorClass = 'bg-blue-50 border-blue-300';
                                }
                                html += '<div class="' + colorClass + ' border rounded p-1 text-xs text-center">';
                                html += '$' + price.toFixed(1);
                                html += '</div>';
                            });
                            
                            html += '</div>';
                            html += '<div class="text-xs text-center text-gray-600 mt-2">Notice: Su*d = Sm*u (recombining tree structure)</div>';
                            html += '</div>';
                            
                            if (step >= 5) {
                                // Show option valuation
                                html += '<div class="mt-4 bg-purple-50 rounded-lg p-3">';
                                html += '<div class="text-sm font-semibold text-purple-800 mb-2">🔄 Working Backwards:</div>';
                                html += '<div class="text-xs text-purple-700 space-y-1">';
                                html += '<div>1. Start at expiration: Option value = max(S-K, 0) for calls</div>';
                                html += '<div>2. At each earlier node: V = e^(-r×Δt) × (p_u×V_u + p_m×V_m + p_d×V_d)</div>';
                                html += '<div>3. Continue until reaching root node</div>';
                                html += '<div class="font-semibold text-green-700">Result: More accurate than binomial (3 branches vs 2)</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        }
                    }
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function resetTrinomialAnimation() {
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            canvas.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <div class="text-4xl mb-4">🔷</div>
                    <p>Click "Animate" to see trinomial tree construction</p>
                </div>
            `;
            stepDisplay.textContent = 'Ready to begin trinomial tree animation...';
        }
        
        function createTreeVisualization(step, totalSteps) {
            let html = '<div class="p-4">';
            
            if (step === 1) {
                html += `
                    <div class="flex justify-center">
                        <div class="bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center font-bold">
                            $100
                        </div>
                    </div>
                    <div class="text-center mt-2 text-sm text-gray-600">Current Stock Price</div>
                `;
            } else if (step === 2) {
                html += `
                    <div class="space-y-6">
                        ${Array.from({length: Math.min(totalSteps + 1, 4)}, (_, t) => `
                            <div class="flex justify-center items-center" style="gap: ${40 + t * 30}px;">
                                ${Array.from({length: t + 1}, (_, i) => {
                                    const price = 100 * Math.pow(1.05, t - i) * Math.pow(0.95, i);
                                    return `
                                        <div class="bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xs font-bold">
                                            $${price.toFixed(0)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (step === 3) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-yellow-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Risk-Neutral Probabilities</div>
                            <div class="text-xs mt-1">p = 0.52 (up), 1-p = 0.48 (down)</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="200" height="120" viewBox="0 0 200 120">
                                <line x1="100" y1="100" x2="50" y2="20" stroke="#10B981" stroke-width="3"/>
                                <line x1="100" y1="100" x2="150" y2="20" stroke="#EF4444" stroke-width="3"/>
                                <circle cx="100" cy="100" r="15" fill="#3B82F6"/>
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="150" cy="20" r="12" fill="#EF4444"/>
                                <text x="100" y="105" text-anchor="middle" font-size="10" fill="white">$100</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$105</text>
                                <text x="150" y="25" text-anchor="middle" font-size="8" fill="white">$95</text>
                                <text x="75" y="65" font-size="8" fill="#10B981">52%</text>
                                <text x="125" y="65" font-size="8" fill="#EF4444">48%</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else if (step === 4) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Backward Induction</div>
                            <div class="text-xs mt-1">Start from expiry, work backwards</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="250" height="150" viewBox="0 0 250 150">
                                <!-- Final nodes -->
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="125" cy="75" r="12" fill="#F59E0B"/>
                                <circle cx="200" cy="130" r="12" fill="#EF4444"/>
                                <!-- Intermediate nodes -->
                                <circle cx="90" cy="47" r="10" fill="#8B5CF6"/>
                                <circle cx="160" cy="102" r="10" fill="#8B5CF6"/>
                                <!-- Root node -->
                                <circle cx="125" cy="75" r="15" fill="#3B82F6"/>
                                <!-- Lines -->
                                <line x1="125" y1="75" x2="90" y2="47" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="125" y1="75" x2="160" y2="102" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="90" y1="47" x2="50" y2="20" stroke="#10B981" stroke-width="2"/>
                                <line x1="90" y1="47" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="200" y2="130" stroke="#EF4444" stroke-width="2"/>
                                <!-- Values -->
                                <text x="125" y="80" text-anchor="middle" font-size="10" fill="white">$6.15</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$10.5</text>
                                <text x="200" y="135" text-anchor="middle" font-size="8" fill="white">$0</text>
                                <text x="90" y="52" text-anchor="middle" font-size="8" fill="white">$8.2</text>
                                <text x="160" y="107" text-anchor="middle" font-size="8" fill="white">$2.4</text>
                            </svg>
                        </div>
                    </div>
                    <div class="text-center mt-4 text-sm text-green-600 font-semibold">
                        Option Value: $6.15
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Monte Carlo Animation
        function animateMonteCarlo() {
            const totalPaths = parseInt(document.getElementById('mcPaths').value);
            const showPaths = parseInt(document.getElementById('mcShowPaths').value);
            const canvas = document.getElementById('mcCanvas');
            
            let pathsCompleted = 0;
            let runningTotal = 0;
            let runningSquareTotal = 0;
            
            canvas.innerHTML = `
                <div class="h-full">
                    <div class="text-center mb-4 font-semibold">Simulating ${totalPaths.toLocaleString()} Price Paths</div>
                    <div class="relative h-64 bg-white rounded border">
                        <canvas id="mcPathCanvas" width="400" height="200" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 bg-blue-100 rounded-full h-2">
                        <div id="mcProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            const pathCanvas = document.getElementById('mcPathCanvas');
            const ctx = pathCanvas.getContext('2d');
            
            // Setup canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 200);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 180);
            ctx.lineTo(380, 180);
            ctx.moveTo(40, 20);
            ctx.lineTo(40, 180);
            ctx.stroke();
            
            let pathsDrawn = 0;
            const batchSize = Math.ceil(totalPaths / 100); // Update in batches
            
            function simulateBatch() {
                for (let i = 0; i < Math.min(batchSize, totalPaths - pathsCompleted); i++) {
                    const optionValue = simulatePath();
                    runningTotal += optionValue;
                    runningSquareTotal += optionValue * optionValue;
                    pathsCompleted++;
                    
                    // Draw some paths for visualization
                    if (pathsDrawn < showPaths && pathsCompleted % Math.floor(totalPaths / showPaths) === 0) {
                        drawRandomPath(ctx, pathsDrawn);
                        pathsDrawn++;
                    }
                }
                
                // Update statistics
                updateMonteCarloStats(pathsCompleted, totalPaths, runningTotal, runningSquareTotal);
                
                if (pathsCompleted < totalPaths) {
                    setTimeout(simulateBatch, 10);
                } else {
                    document.getElementById('mcProgressBar').style.width = '100%';
                }
            }
            
            simulateBatch();
        }
        
        function simulatePath() {
            // Simple Monte Carlo option pricing
            const S0 = 100, K = 105, T = 30/365, r = 0.04, sigma = 0.25;
            const dt = T / 30;
            let S = S0;
            
            // Generate random path
            for (let i = 0; i < 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * Z);
            }
            
            // Option payoff (call option)
            return Math.max(S - K, 0) * Math.exp(-r * T);
        }
        
        function drawRandomPath(ctx, pathIndex) {
            const S0 = 100;
            const colors = ['rgba(59, 130, 246, 0.4)', 'rgba(16, 185, 129, 0.4)', 'rgba(239, 68, 68, 0.4)'];
            
            ctx.strokeStyle = colors[pathIndex % colors.length];
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            let S = S0;
            let prevX = 40;
            let prevY = 180 - (S - 80) * 2; // Scale to canvas
            
            ctx.moveTo(prevX, prevY);
            
            for (let i = 1; i <= 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((0.04 - 0.5 * 0.25 * 0.25) * (30/365/30) + 0.25 * Math.sqrt(30/365/30) * Z);
                
                const x = 40 + (i / 30) * 340;
                const y = Math.max(20, Math.min(180, 180 - (S - 80) * 2));
                
                ctx.lineTo(x, y);
                prevX = x;
                prevY = y;
            }
            
            ctx.stroke();
        }
        
        function normalRandom() {
            // Box-Muller transformation
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        
        function updateMonteCarloStats(completed, total, runningTotal, runningSquareTotal) {
            const currentPrice = runningTotal / completed;
            const variance = (runningSquareTotal / completed) - (currentPrice * currentPrice);
            const standardError = Math.sqrt(variance / completed);
            
            document.getElementById('mcPathsCompleted').textContent = completed.toLocaleString();
            document.getElementById('mcCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
            document.getElementById('mcStandardError').textContent = '±$' + (1.96 * standardError).toFixed(2);
            
            const progress = (completed / total) * 100;
            document.getElementById('mcProgressBar').style.width = progress + '%';
        }
        
        // Black-Scholes Animation
        function animateBlackScholes() {
            const steps = ['bsStep1', 'bsStep2', 'bsStep3', 'bsStep4'];
            const calculation = document.getElementById('bsLiveCalc');
            
            // Reset opacity
            steps.forEach(step => {
                document.getElementById(step).style.opacity = '0.3';
            });
            
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).style.opacity = '1';
                    
                    switch(currentStep) {
                        case 0:
                            calculation.innerHTML = `
                                <div>Breaking down the Black-Scholes formula...</div>
                                <div class="mt-2 text-purple-600">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                            `;
                            break;
                        case 1:
                            calculation.innerHTML = `
                                <div>d₁ = [ln(100/105) + (0.04 + 0.25²/2)×0.082] / (0.25×√0.082)</div>
                                <div>d₁ = [-0.0488 + 0.0059] / 0.0717 = -0.598</div>
                            `;
                            break;
                        case 2:
                            calculation.innerHTML = `
                                <div>d₂ = d₁ - σ√T = -0.598 - 0.25×√0.082</div>
                                <div>d₂ = -0.598 - 0.0717 = -0.670</div>
                            `;
                            break;
                        case 3:
                            calculation.innerHTML = `
                                <div>N(d₁) = N(-0.598) = 0.275</div>
                                <div>N(d₂) = N(-0.670) = 0.251</div>
                                <div class="mt-2 text-green-600 font-bold">C = 100×0.275 - 105×e^(-0.04×0.082)×0.251 = $1.31</div>
                            `;
                            break;
                    }
                    
                    currentStep++;
                    setTimeout(nextStep, 2000);
                }
            }
            
            nextStep();
        }

        // ============================================================================
        // 3D GREEKS SURFACE PLOTS IMPLEMENTATION
        // ============================================================================

        let scene, camera, renderer, surfaceMesh, controls;
        let animationFrame;
        let isRotating = false;

        function initialize3DVisualization() {
            const container = document.getElementById('threejs-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(15, 15, 15);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Clear container and add renderer
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Controls setup (OrbitControls)
            if (typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.enableRotate = true;
                controls.enablePan = true;
            }

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x00ffff, 0.5);
            pointLight.position.set(-10, 10, -5);
            scene.add(pointLight);

            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20, 0x666666, 0x444444);
            gridHelper.position.y = -5;
            scene.add(gridHelper);

            // Add axis helpers
            const axesHelper = new THREE.AxesHelper(10);
            scene.add(axesHelper);

            // Start animation loop
            animate3D();

            console.log('3D Visualization initialized successfully');
        }

        function generate3DSurface() {
            const greekType = document.getElementById('greek3D').value;
            const baseStock = parseFloat(document.getElementById('base3DStock').value);
            const strike = parseFloat(document.getElementById('strike3D').value);
            const volatility = parseFloat(document.getElementById('vol3D').value) / 100;

            // Remove existing surface
            if (surfaceMesh) {
                scene.remove(surfaceMesh);
            }

            // Generate surface data
            const resolution = 30;
            const stockRange = baseStock * 0.4; // ±40% range
            const timeRange = 90; // 0-90 days

            const geometry = new THREE.PlaneGeometry(20, 20, resolution - 1, resolution - 1);
            const vertices = geometry.attributes.position.array;
            const colors = [];

            let minValue = Infinity;
            let maxValue = -Infinity;

            // Calculate Greeks for each point
            for (let i = 0; i < resolution; i++) {
                for (let j = 0; j < resolution; j++) {
                    const stockPrice = baseStock + (stockRange * 2 * (i / (resolution - 1)) - stockRange);
                    const timeToExpiry = (timeRange * (j / (resolution - 1)) + 1) / 365; // 1-90 days
                    
                    // Calculate Greek value using our pricing library
                    try {
                        const greeks = pricingLibrary.calculateGreeks({
                            stockPrice: stockPrice,
                            strikePrice: strike,
                            timeToExpiry: timeToExpiry,
                            riskFreeRate: 0.04,
                            volatility: volatility,
                            dividendYield: 0.015,
                            optionType: 'call',
                            exerciseStyle: 'american'
                        });

                        let value = 0;
                        switch (greekType) {
                            case 'delta':
                                value = greeks.delta;
                                break;
                            case 'gamma':
                                value = greeks.gamma;
                                break;
                            case 'theta':
                                value = greeks.theta * 365; // Convert to per-year for better scaling
                                break;
                            case 'vega':
                                value = greeks.vega * 100; // Convert to per-vol-point for better scaling
                                break;
                        }

                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = value * 3; // Scale Z for visibility

                        minValue = Math.min(minValue, value);
                        maxValue = Math.max(maxValue, value);

                        // Color based on value (heat map)
                        const normalizedValue = (value - minValue) / (maxValue - minValue) || 0;
                        const color = new THREE.Color();
                        color.setHSL(0.7 * (1 - normalizedValue), 0.8, 0.5); // Blue to Red gradient
                        colors.push(color.r, color.g, color.b);

                    } catch (error) {
                        console.warn('Error calculating Greeks:', error);
                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = 0;
                        colors.push(0.5, 0.5, 0.5); // Gray for errors
                    }
                }
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            // Create surface material
            const material = new THREE.MeshLambertMaterial({
                vertexColors: true,
                side: THREE.DoubleSide,
                wireframe: false
            });

            // Create mesh
            surfaceMesh = new THREE.Mesh(geometry, material);
            surfaceMesh.rotation.x = -Math.PI / 2; // Rotate to make it horizontal
            surfaceMesh.castShadow = true;
            surfaceMesh.receiveShadow = true;

            scene.add(surfaceMesh);

            // Update analysis display
            updateSurfaceAnalysis(greekType, minValue, maxValue, baseStock, strike, volatility * 100);

            // Show analysis section
            document.getElementById('surface-analysis').style.display = 'grid';
            
            console.log(`3D ${greekType} surface generated with range: ${minValue.toFixed(4)} to ${maxValue.toFixed(4)}`);
        }

        function updateSurfaceAnalysis(greekType, minValue, maxValue, stockPrice, strike, volatility) {
            // Update statistics
            document.getElementById('max-value').textContent = maxValue.toFixed(4);
            document.getElementById('min-value').textContent = minValue.toFixed(4);
            document.getElementById('value-range').textContent = (maxValue - minValue).toFixed(4);

            // Generate insights based on Greek type
            const insightText = document.getElementById('insight-text');
            let insights = '';

            switch (greekType) {
                case 'delta':
                    insights = `
                        <div class="mb-2"><strong>Delta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Peak at strike price ($${strike})</div>
                            <div>• Call delta: 0 (far OTM) → 1 (far ITM)</div>
                            <div>• Steepest slope around at-the-money</div>
                            <div>• Less time sensitivity for far ITM/OTM</div>
                        </div>
                    `;
                    break;
                case 'gamma':
                    insights = `
                        <div class="mb-2"><strong>Gamma Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Decreases rapidly away from strike</div>
                            <div>• Increases as expiration approaches</div>
                            <div>• Near zero for far ITM/OTM options</div>
                        </div>
                    `;
                    break;
                case 'theta':
                    insights = `
                        <div class="mb-2"><strong>Theta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Most negative (decay) at-the-money</div>
                            <div>• Accelerates as expiration approaches</div>
                            <div>• Lower time decay for far ITM/OTM</div>
                            <div>• Time decay is option holder's enemy</div>
                        </div>
                    `;
                    break;
                case 'vega':
                    insights = `
                        <div class="mb-2"><strong>Vega Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Increases with more time to expiry</div>
                            <div>• Near zero for far ITM/OTM options</div>
                            <div>• Volatility=${volatility}% impacts premium</div>
                        </div>
                    `;
                    break;
            }

            insightText.innerHTML = insights;
        }

        function animate3D() {
            animationFrame = requestAnimationFrame(animate3D);

            if (controls) {
                controls.update();
            }

            if (isRotating && surfaceMesh) {
                surfaceMesh.rotation.z += 0.005;
            }

            renderer.render(scene, camera);
        }

        function toggle3DRotation() {
            isRotating = !isRotating;
            const button = document.getElementById('rotate3D');
            button.textContent = isRotating ? '⏸️ Stop Rotation' : '🔄 Auto Rotate';
        }

        // Event listeners for 3D functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize 3D scene when the page loads
            setTimeout(initialize3DVisualization, 500);

            // Event listeners
            document.getElementById('generate3D').addEventListener('click', generate3DSurface);
            document.getElementById('rotate3D').addEventListener('click', toggle3DRotation);

            // Auto-generate initial surface
            setTimeout(() => {
                generate3DSurface();
            }, 1000);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (camera && renderer) {
                    const container = document.getElementById('threejs-container');
                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                }
            });
        });
    </script>
</body>
</html>
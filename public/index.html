<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Pricing Calculator - Real-time Greeks & Analysis</title>
    <meta name="description" content="Interactive options pricing calculator with real-time Greeks analysis and model comparisons">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Math.js for calculations -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js"></script>
    
    <!-- Three.js for 3D visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fallback OrbitControls in case CDN fails -->
    <script>
        // OrbitControls fallback implementation
        if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
            THREE.OrbitControls = class OrbitControls {
                constructor(camera, domElement) {
                    this.camera = camera;
                    this.domElement = domElement;
                    this.enableDamping = true;
                    this.dampingFactor = 0.05;
                    this.enableZoom = true;
                    this.enableRotate = true;
                    this.enablePan = true;
                    
                    this.mouseX = 0;
                    this.mouseY = 0;
                    this.isMouseDown = false;
                    
                    this.initEventListeners();
                }
                
                initEventListeners() {
                    this.domElement.addEventListener('mousedown', (e) => {
                        this.isMouseDown = true;
                        this.mouseX = e.clientX;
                        this.mouseY = e.clientY;
                    });
                    
                    this.domElement.addEventListener('mouseup', () => {
                        this.isMouseDown = false;
                    });
                    
                    this.domElement.addEventListener('mousemove', (e) => {
                        if (this.isMouseDown && this.enableRotate) {
                            const deltaX = e.clientX - this.mouseX;
                            const deltaY = e.clientY - this.mouseY;
                            
                            this.camera.position.x = this.camera.position.x * Math.cos(deltaX * 0.01) - this.camera.position.z * Math.sin(deltaX * 0.01);
                            this.camera.position.z = this.camera.position.x * Math.sin(deltaX * 0.01) + this.camera.position.z * Math.cos(deltaX * 0.01);
                            this.camera.position.y += deltaY * 0.1;
                            
                            this.camera.lookAt(0, 0, 0);
                            
                            this.mouseX = e.clientX;
                            this.mouseY = e.clientY;
                        }
                    });
                    
                    this.domElement.addEventListener('wheel', (e) => {
                        if (this.enableZoom) {
                            const scale = e.deltaY > 0 ? 1.1 : 0.9;
                            this.camera.position.multiplyScalar(scale);
                            e.preventDefault();
                        }
                    });
                }
                
                update() {
                    // Basic damping could be implemented here
                }
            };
        }
    </script>
    
    <style>
        /* Custom animations and styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Options Calculator</h1>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors">Home</a>
                    <a href="#calculator" class="text-gray-600 hover:text-blue-600 transition-colors">Calculator</a>
                    <a href="#greeks" class="text-gray-600 hover:text-blue-600 transition-colors">Greeks</a>
                    <a href="#learn" class="text-gray-600 hover:text-blue-600 transition-colors">Learn</a>
                    <a href="#playground" class="text-gray-600 hover:text-blue-600 transition-colors">Playground</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-gradient text-white py-20">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-5xl font-bold mb-6">Advanced Options Pricing & Greeks Analysis</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Real-time options pricing with comprehensive Greeks analysis. 
                Professional-grade calculations using multiple validated pricing models.
            </p>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="scrollToSection('calculator')" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    Start Calculating
                </button>
                <button onclick="scrollToSection('learn')" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors">
                    Learn Basics
                </button>
                <button onclick="scrollToSection('live-market')" class="border-2 border-yellow-300 text-yellow-300 px-8 py-3 rounded-lg font-semibold hover:bg-yellow-300 hover:text-blue-800 transition-colors">
                    📈 Live Markets
                </button>
                <button onclick="scrollToSection('professional-data')" class="border-2 border-purple-300 text-purple-300 px-8 py-3 rounded-lg font-semibold hover:bg-purple-300 hover:text-blue-800 transition-colors">
                    ⚡ Professional
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        <!-- Options Calculator Section -->
        <section id="calculator" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Options Calculator</h3>
                
                <!-- Calculator Form -->
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Option Parameters</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol (Optional)</label>
                            <input type="text" id="symbol" placeholder="AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Price ($)</label>
                            <input type="number" id="stockPrice" value="150" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Strike Price ($)</label>
                            <input type="number" id="strikePrice" value="155" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Days to Expiry</label>
                            <input type="number" id="daysToExpiry" value="30" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Volatility (%)</label>
                            <input type="number" id="volatility" value="25" step="0.1" min="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Option Type</label>
                            <select id="optionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                            </select>
                        </div>
                        
                        <button onclick="calculateOption()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Calculate Option Price
                        </button>
                    </div>
                    
                    <!-- Results Display -->
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Pricing Results</h4>
                        <div id="results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Enter parameters and click calculate to see results
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Visualization Section -->
        <section id="greeks" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Greeks Dashboard</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Values</h4>
                        <div id="greeksDisplay" class="space-y-3">
                            <!-- Greeks will be displayed here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Chart</h4>
                        <div class="relative w-full" style="height: 400px;">
                            <canvas id="greeksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Greeks Tutorial -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎓 Interactive Greeks Tutorial</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">Learn the difference between actual rates and sensitivity measures through interactive examples. This addresses the common confusion between rates and Greeks.</p>
                
                <!-- Tutorial Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">📊</span>
                            Risk-Free Rate (Actual Rate)
                        </h4>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="text-sm font-medium text-gray-700 w-16">Rate:</label>
                            <input type="range" id="tutorialRate" min="1" max="10" step="0.5" value="4" class="flex-1">
                            <span id="tutorialRateValue" class="text-xl font-bold text-green-600 w-16">4.0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This is the actual interest rate in the economy:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• Fed funds rate</li>
                                <li>• Treasury bond yields</li>
                                <li>• What banks pay on deposits</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">⚡</span>
                            Rho (Rate Sensitivity)
                        </h4>
                        <div class="text-center mb-3">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="tutorialRhoValue">$0.27</div>
                            <p class="text-sm text-gray-600">per 1% rate change</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This tells you how much your option price changes:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• NOT the rate itself</li>
                                <li>• Rate of change (derivative)</li>
                                <li>• Like speed vs distance</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Demonstration -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="font-semibold text-gray-800 mb-6 text-center flex items-center justify-center">
                        <span class="text-2xl mr-2">🎯</span>
                        See the Difference in Action
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="p-6 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-2xl font-bold text-green-700 mb-2" id="currentOptionPrice">$8.45</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Current Option Price</p>
                            <p class="text-xs text-green-600">At <span id="currentRate1">4.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-2xl font-bold text-blue-700 mb-2" id="newOptionPrice">$8.72</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">New Option Price</p>
                            <p class="text-xs text-blue-600">At <span id="newRate">5.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-2xl font-bold text-purple-700 mb-2" id="priceChange">+$0.27</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Price Change</p>
                            <p class="text-xs text-purple-600 font-semibold">This equals Rho!</p>
                        </div>
                    </div>
                    
                    <!-- Dynamic Explanation -->
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center">
                            <span class="text-xl mr-2">💡</span>
                            Key Insight
                        </h5>
                        <div class="space-y-2 text-amber-700">
                            <p class="font-medium">
                                Risk-Free Rate = <span id="explanationCurrentRate">4%</span> (the actual rate)
                            </p>
                            <p class="font-medium">
                                Rho = <span id="explanationRho">$0.27</span> (how much price changes per 1% rate move)
                            </p>
                            <p class="text-sm border-t border-amber-200 pt-2 mt-3">
                                <strong>Example:</strong> If rates go from <span id="explanationFromRate">4%</span> → <span id="explanationToRate">5%</span>, 
                                your option gains <span id="explanationGain">$0.27</span> in value.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Algorithm Animations Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎬 Algorithm Visualizations</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">See how options pricing models work step-by-step. Watch the mathematics come to life through interactive animations.</p>
                
                <!-- Algorithm Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showAlgorithm('binomial')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="binomialBtn">
                        🌳 Binomial Tree
                    </button>
                    <button onclick="showAlgorithm('trinomial')" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors" id="trinomialBtn">
                        🔷 Trinomial Tree
                    </button>
                    <button onclick="showAlgorithm('blackscholes')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="blackscholesBtn">
                        📐 Black-Scholes
                    </button>
                    <button onclick="showAlgorithm('montecarlo')" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="montecarloBtn">
                        🎲 Monte Carlo
                    </button>
                    <button onclick="showAlgorithm('jumpdiffusion')" class="px-6 py-3 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 transition-colors" id="jumpdiffusionBtn">
                        ⚡ Jump Diffusion
                    </button>
                </div>
                
                <!-- Binomial Tree Animation -->
                <div id="binomialAnimation" class="algorithm-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🌳</span>
                            Binomial Tree Model (Cox-Ross-Rubinstein)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Step-by-Step Construction</h5>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Steps:</span>
                                            <input type="range" id="binomialSteps" min="1" max="5" value="3" class="ml-4">
                                            <span id="binomialStepsValue" class="font-bold ml-2">3</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Speed:</span>
                                            <input type="range" id="animationSpeed" min="500" max="3000" value="1500" class="ml-4">
                                            <span class="text-xs ml-2">Slow → Fast</span>
                                        </div>
                                        <button onclick="animateBinomialTree()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-3">
                                            ▶️ Animate Tree Construction
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tree Visualization Canvas -->
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="treeCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">🌳</div>
                                            <p>Click "Animate Tree Construction" to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Explanation Panel -->
                            <div class="space-y-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">How It Works</h5>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <div class="step-explanation" id="step1">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">1</span>
                                                <div>
                                                    <strong>Start:</strong> Current stock price S₀ = $<span class="font-mono">100</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step2">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">2</span>
                                                <div>
                                                    <strong>Up/Down:</strong> Price can go up by factor u = <span class="font-mono">1.05</span> or down by d = <span class="font-mono">0.95</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step3">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">3</span>
                                                <div>
                                                    <strong>Risk-Neutral:</strong> Probability p = <span class="font-mono">0.52</span>, (1-p) = <span class="font-mono">0.48</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step4">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">4</span>
                                                <div>
                                                    <strong>Work Backwards:</strong> Start from expiry, calculate option values at each node
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">Current Step</h5>
                                    <div id="currentStepDisplay" class="text-sm text-amber-700">
                                        Ready to begin animation...
                                    </div>
                                </div>
                                
                                <!-- Mathematical Formula -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Key Formulas</h5>
                                    <div class="space-y-2 text-xs font-mono text-gray-600">
                                        <div>u = e^(σ√Δt) ≈ 1.05</div>
                                        <div>d = 1/u ≈ 0.95</div>
                                        <div>p = (e^(rΔt) - d)/(u - d)</div>
                                        <div>V = e^(-rΔt)[pV_up + (1-p)V_down]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trinomial Tree Animation -->
                <div id="trinomialAnimation" class="algorithm-content" style="display: none;">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🔷</span>
                            Trinomial Tree Model (Boyle)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h5 class="text-lg font-semibold">Tree Evolution</h5>
                                    <div class="flex gap-2">
                                        <button onclick="animateTrinomialTree()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">
                                            ▶️ Animate
                                        </button>
                                        <button onclick="resetTrinomialAnimation()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-semibold hover:bg-gray-700">
                                            🔄 Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="mb-4 space-y-3">
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Steps:</label>
                                        <input type="range" id="trinomialSteps" min="2" max="4" value="3" class="flex-1">
                                        <span id="trinomialStepsDisplay" class="text-sm font-mono">3</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Speed:</label>
                                        <input type="range" id="trinomialSpeed" min="500" max="3000" value="1500" class="flex-1">
                                        <span class="text-sm">Slow ↔ Fast</span>
                                    </div>
                                </div>
                                
                                <!-- Animation Canvas -->
                                <div id="trinomialCanvas" class="bg-gray-50 rounded-lg min-h-64 border overflow-auto">
                                    <div class="p-8 text-center text-gray-500">
                                        <div class="text-4xl mb-4">🔷</div>
                                        <p>Click "Animate" to see trinomial tree construction</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Educational Content -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Trinomial vs Binomial</h5>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔺</span>
                                                <div>
                                                    <strong>Up Move:</strong> Price increases by factor u = <span class="font-mono">e^(σ√(2Δt))</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">➡️</span>
                                                <div>
                                                    <strong>Middle Move:</strong> Price stays the same (unique to trinomial)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔻</span>
                                                <div>
                                                    <strong>Down Move:</strong> Price decreases by factor d = 1/u
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🎯</span>
                                                <div>
                                                    <strong>Better Accuracy:</strong> 16.4% more accurate than binomial trees
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Current Step</h5>
                                    <div id="trinomialStepDisplay" class="text-sm text-green-700">
                                        Ready to begin trinomial tree animation...
                                    </div>
                                </div>
                                
                                <!-- Probability Formulas -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Risk-Neutral Probabilities</h5>
                                    <div class="text-sm space-y-2 font-mono">
                                        <div><strong>p_u</strong> = ((e^(r·Δt) - d)(u - 1)) / ((u - d)(u - 1))</div>
                                        <div><strong>p_m</strong> = 1 - p_u - p_d</div>
                                        <div><strong>p_d</strong> = ((e^(r·Δt) - d)(1 - d)) / ((u - d)(1 - d))</div>
                                    </div>
                                </div>
                                
                                <!-- Advantages -->
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">🚀 Advantages</h5>
                                    <ul class="text-sm text-purple-700 space-y-1">
                                        <li>• <strong>Higher accuracy</strong> with fewer steps</li>
                                        <li>• <strong>Stable convergence</strong> to analytical solutions</li>
                                        <li>• <strong>Better for exotic options</strong> with barriers</li>
                                        <li>• <strong>Recommended model</strong> for production use</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monte Carlo Animation -->
                <div id="montecarloAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎲</span>
                            Monte Carlo Simulation
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Simulation Controls -->
                            <div class="space-y-4">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">Simulation Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Paths:</span>
                                            <input type="range" id="mcPaths" min="100" max="10000" step="100" value="1000" class="ml-4">
                                            <span id="mcPathsValue" class="font-bold ml-2">1,000</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Show Paths:</span>
                                            <input type="range" id="mcShowPaths" min="10" max="100" value="50" class="ml-4">
                                            <span id="mcShowPathsValue" class="font-bold ml-2">50</span>
                                        </div>
                                        <button onclick="animateMonteCarlo()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                            🎲 Run Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Statistics Panel -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Live Statistics</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Paths Completed:</span>
                                            <span id="mcPathsCompleted" class="font-bold">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Current Price:</span>
                                            <span id="mcCurrentPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Standard Error:</span>
                                            <span id="mcStandardError" class="font-bold">±$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Confidence:</span>
                                            <span id="mcConfidence" class="font-bold">95%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Path Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="mcCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📈</div>
                                            <p>Click "Run Simulation" to see random paths</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Insight -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-2">💡 Key Insight</h5>
                                    <p class="text-sm text-yellow-700">
                                        Each path follows: S(t) = S₀ × e^((r-σ²/2)t + σ√t×Z) where Z ~ N(0,1). 
                                        More paths = more accurate price!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Black-Scholes Animation -->
                <div id="blackscholesAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📐</span>
                            Black-Scholes Formula
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formula Breakdown -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">Formula Components</h5>
                                    <button onclick="animateBlackScholes()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors mb-4">
                                        📐 Break Down Formula
                                    </button>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="formula-step opacity-30" id="bsStep1">
                                            <div class="font-mono bg-white p-2 rounded">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                                            <p class="text-purple-700 mt-1">Call option price formula</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep2">
                                            <div class="font-mono bg-white p-2 rounded">d₁ = [ln(S/K) + (r + σ²/2)T] / (σ√T)</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (adjusted for drift)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep3">
                                            <div class="font-mono bg-white p-2 rounded">d₂ = d₁ - σ√T</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (risk-adjusted)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep4">
                                            <div class="font-mono bg-white p-2 rounded">N(x) = Cumulative normal distribution</div>
                                            <p class="text-purple-700 mt-1">Probability of being in-the-money</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Calculation -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Live Calculation</h5>
                                    <div id="bsCalculation" class="space-y-2 text-sm font-mono">
                                        <div>S₀ = $100, K = $105, T = 0.082 years</div>
                                        <div>r = 4%, σ = 25%</div>
                                        <div id="bsLiveCalc">Click "Break Down Formula" to see calculation...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Normal Distribution Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-64" id="bsCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📊</div>
                                            <p>Normal distribution visualization will appear here</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Assumptions -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">⚠️ Key Assumptions</h5>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>• Constant volatility and risk-free rate</li>
                                        <li>• No dividends (can be adjusted)</li>
                                        <li>• European exercise only</li>
                                        <li>• Log-normal stock price distribution</li>
                                        <li>• No transaction costs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jump Diffusion Animation -->
                <div id="jumpdiffusionAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">⚡</span>
                            Jump Diffusion Model (Merton)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Jump Controls -->
                            <div class="space-y-4">
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-3">Jump Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Intensity (λ):</span>
                                            <input type="range" id="jumpIntensity" min="0.1" max="5" step="0.1" value="2" class="ml-4">
                                            <span id="jumpIntensityValue" class="font-bold ml-2">2.0</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Size (μ_J):</span>
                                            <input type="range" id="jumpMean" min="-0.1" max="0.1" step="0.01" value="-0.02" class="ml-4">
                                            <span id="jumpMeanValue" class="font-bold ml-2">-2%</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Vol (σ_J):</span>
                                            <input type="range" id="jumpVol" min="0.05" max="0.2" step="0.01" value="0.08" class="ml-4">
                                            <span id="jumpVolValue" class="font-bold ml-2">8%</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Time Steps:</span>
                                            <input type="range" id="jumpSteps" min="100" max="1000" step="50" value="250" class="ml-4">
                                            <span id="jumpStepsValue" class="font-bold ml-2">250</span>
                                        </div>
                                        <button onclick="animateJumpDiffusion()" class="w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                                            ⚡ Start Jump Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Educational Content -->
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">🎯 Why Jump Diffusion?</h5>
                                    <div class="text-sm text-red-700 space-y-2">
                                        <p><strong>Market Reality:</strong> Stock prices can jump suddenly due to news, earnings, or market crashes.</p>
                                        <p><strong>Black-Scholes Limitation:</strong> Assumes continuous, smooth price changes only.</p>
                                        <p><strong>Jump Enhancement:</strong> Adds sudden price jumps to normal diffusion process.</p>
                                        <div class="font-mono bg-white p-2 rounded mt-3">
                                            dS = μSdt + σSdW + SdJ
                                        </div>
                                        <p><strong>dJ:</strong> Jump component with Poisson arrival</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="jumpCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">⚡</div>
                                            <p>Jump diffusion simulation will appear here</p>
                                            <p class="text-sm mt-2">Click "Start Jump Simulation" to see price paths with sudden jumps</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Jump Statistics -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Jump Statistics</h5>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="block text-gray-600">Expected Jumps/Year:</span>
                                            <span id="expectedJumps" class="font-bold text-blue-800">2.0</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Observed Jumps:</span>
                                            <span id="observedJumps" class="font-bold text-blue-800">0</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Avg Jump Size:</span>
                                            <span id="avgJumpSize" class="font-bold text-blue-800">0%</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Price Range:</span>
                                            <span id="priceRange" class="font-bold text-blue-800">$0 - $0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Model Comparison -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">📊 Model Comparison</h5>
                                    <div class="text-sm text-green-700 space-y-1">
                                        <div class="flex justify-between">
                                            <span>Black-Scholes Price:</span>
                                            <span id="bsJumpPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Jump-Diffusion Price:</span>
                                            <span id="jdJumpPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Jump Premium:</span>
                                            <span id="jumpPremium" class="font-bold">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Tutorials Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">📚 Interactive Tutorials</h3>
                <p class="text-gray-600 text-center mb-8">Step-by-step guided learning experiences to master options concepts</p>
                
                <!-- Tutorial Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showTutorial('greeks')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="greeksTutorialBtn">
                        📊 Understanding Greeks
                    </button>
                    <button onclick="showTutorial('options-basics')" class="px-6 py-3 bg-pink-600 text-white rounded-lg font-semibold hover:bg-pink-700 transition-colors" id="optionsBasicsTutorialBtn">
                        🎯 Options Basics
                    </button>
                    <button onclick="showTutorial('pricing-models')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors" id="pricingModelsTutorialBtn">
                        ⚙️ Pricing Models
                    </button>
                    <button onclick="showTutorial('risk-management')" class="px-6 py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors" id="riskManagementTutorialBtn">
                        🛡️ Risk Management
                    </button>
                </div>
                
                <!-- Understanding Greeks Tutorial -->
                <div id="greeksTutorial" class="tutorial-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📊</span>
                            Understanding the Greeks - Interactive Tutorial
                        </h4>
                        
                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="tutorialProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-500" id="progressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div id="tutorialStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-purple-800">Step 1: What are the Greeks?</div>
                                        <p class="text-purple-700">The "Greeks" are risk sensitivities that measure how an option's price changes with respect to various factors. They're called Greeks because most are represented by Greek letters (Δ, Γ, Θ, ν, ρ).</p>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Think of Greeks as:</strong>
                                            <ul class="mt-2 text-sm space-y-1">
                                                <li>• <strong>Delta (Δ):</strong> Speed - how fast price moves with stock</li>
                                                <li>• <strong>Gamma (Γ):</strong> Acceleration - how speed changes</li>
                                                <li>• <strong>Theta (Θ):</strong> Time decay - daily price erosion</li>
                                                <li>• <strong>Vega (ν):</strong> Volatility sensitivity</li>
                                                <li>• <strong>Rho (ρ):</strong> Interest rate sensitivity</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousTutorialStep()" id="prevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextTutorialStep()" id="nextBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Live Greeks Demo</h5>
                                    <div id="tutorialDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Price: <span id="tutorialStockPrice">$100</span></label>
                                                <input type="range" id="tutorialStockSlider" min="80" max="120" value="100" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Days to Expiry: <span id="tutorialDaysValue">30</span></label>
                                                <input type="range" id="tutorialDaysSlider" min="1" max="90" value="30" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Volatility: <span id="tutorialVolValue">25%</span></label>
                                                <input type="range" id="tutorialVolSlider" min="10" max="50" value="25" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Greeks Display for Tutorial -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Current Greeks</h5>
                                    <div class="space-y-2 text-sm" id="tutorialGreeksDisplay">
                                        <div class="flex justify-between">
                                            <span>Delta (Δ):</span>
                                            <span class="font-bold" id="tutorialDelta">0.60</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Gamma (Γ):</span>
                                            <span class="font-bold" id="tutorialGamma">0.03</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Theta (Θ):</span>
                                            <span class="font-bold" id="tutorialTheta">-0.15</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Vega (ν):</span>
                                            <span class="font-bold" id="tutorialVega">0.20</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">💡 Key Insight</h5>
                                    <p class="text-sm text-green-700" id="tutorialInsight">
                                        Move the stock price slider and watch how Delta changes the option value. Delta tells you how much the option price moves for each $1 stock price change!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Options Basics Tutorial -->
                <div id="optionsBasicsTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎯</span>
                            Options Basics - Interactive Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Options Basics -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="optionsBasicsProgress">Step 1 of 6</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-pink-600 h-2 rounded-full transition-all duration-500" id="optionsBasicsProgressBar" style="width: 16.6%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-pink-50 p-4 rounded-lg">
                                    <div id="optionsBasicsStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-pink-800">Step 1: What is an Option?</div>
                                        <p class="text-pink-700">An option is a contract that gives you the RIGHT (not obligation) to buy or sell a stock at a specific price by a certain date. Think of it like a reservation at a restaurant - you have the right to use it, but you don't have to.</p>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Key Components:</strong>
                                            <ul class="mt-2 text-sm space-y-1">
                                                <li>• <strong>Strike Price:</strong> The price at which you can buy/sell</li>
                                                <li>• <strong>Expiration Date:</strong> When the option expires</li>
                                                <li>• <strong>Premium:</strong> The cost to buy the option</li>
                                                <li>• <strong>Underlying Asset:</strong> The stock the option is based on</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousOptionsBasicsStep()" id="optionsBasicsPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextOptionsBasicsStep()" id="optionsBasicsNextBtn" class="px-4 py-2 bg-pink-600 text-white rounded-lg font-medium hover:bg-pink-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Interactive Example</h5>
                                    <div id="optionsBasicsDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div class="bg-blue-100 p-3 rounded">
                                                <div class="text-sm font-medium text-blue-800">Example: AAPL Call Option</div>
                                                <div class="text-xs text-blue-600 mt-1">
                                                    <div>Current AAPL Price: $150</div>
                                                    <div>Strike Price: $155</div>
                                                    <div>Expires: 30 days</div>
                                                    <div>Premium: $3.50</div>
                                                </div>
                                            </div>
                                            <div class="text-sm">
                                                <strong>What this means:</strong> You pay $350 ($3.50 × 100 shares) for the right to buy 100 AAPL shares at $155 each, anytime in the next 30 days.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dynamic Visualization Area -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">📊 Visualization</h5>
                                    <div id="optionsBasicsVisualization">
                                        <div class="h-32 bg-white rounded border flex items-center justify-center">
                                            <div class="text-center text-gray-500">
                                                <div class="text-2xl mb-1">📈</div>
                                                <div class="text-sm">Option concept diagram</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-3">💡 Key Point</h5>
                                    <p class="text-sm text-yellow-700" id="optionsBasicsInsight">
                                        Options give you leverage and limited risk. You can control 100 shares for much less money than buying the stock outright!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="pricingModelsTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">⚙️</span>
                            Pricing Models Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Pricing Models -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="pricingModelsProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" id="pricingModelsProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <div id="pricingModelsStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-indigo-800">Step 1: Why Multiple Pricing Models?</div>
                                        <p class="text-indigo-700">Different pricing models make different assumptions and trade off accuracy for speed. Understanding when to use each model is crucial for effective options trading.</p>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousPricingModelsStep()" id="pricingModelsPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextPricingModelsStep()" id="pricingModelsNextBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo Area -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Live Model Comparison</h5>
                                    <div id="pricingModelsDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Price: <span id="modelsStockPrice">$100</span></label>
                                                <input type="range" id="modelsStockSlider" min="80" max="120" value="100" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Days to Expiry: <span id="modelsDaysValue">30</span></label>
                                                <input type="range" id="modelsDaysSlider" min="1" max="90" value="30" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Volatility: <span id="modelsVolValue">25%</span></label>
                                                <input type="range" id="modelsVolSlider" min="10" max="50" value="25" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Model Prices Display -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Model Comparison</h5>
                                    <div class="space-y-2 text-sm" id="modelPricesDisplay">
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                                Trinomial:
                                            </span>
                                            <span class="font-bold" id="modelTrinomialPrice">$8.45</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                                Binomial:
                                            </span>
                                            <span class="font-bold" id="modelBinomialPrice">$8.42</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                                Black-Scholes:
                                            </span>
                                            <span class="font-bold" id="modelBSPrice">$8.38</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                                Monte Carlo:
                                            </span>
                                            <span class="font-bold" id="modelMCPrice">$8.41 ±0.05</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                                                Jump Diffusion:
                                            </span>
                                            <span class="font-bold" id="modelJDPrice">$8.62</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">💡 Key Insight</h5>
                                    <p class="text-sm text-green-700" id="modelsInsight">
                                        Notice how different models give slightly different prices. The trinomial model is generally the most accurate, while Black-Scholes is the fastest but assumes no early exercise.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="riskManagementTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🛡️</span>
                            Risk Management Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Risk Management -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="riskManagementProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-emerald-600 h-2 rounded-full transition-all duration-500" id="riskManagementProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-emerald-50 p-4 rounded-lg">
                                    <div id="riskManagementStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-emerald-800">Step 1: The Foundation of Options Risk</div>
                                        <p class="text-emerald-700">Successful options trading starts with understanding and managing risk. Unlike stock trading, options have multiple risk dimensions that must be monitored continuously.</p>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousRiskManagementStep()" id="riskManagementPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextRiskManagementStep()" id="riskManagementNextBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo Area -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Portfolio Risk Simulator</h5>
                                    <div id="riskManagementDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Portfolio Size: <span id="portfolioSize">$10,000</span></label>
                                                <input type="range" id="portfolioSlider" min="5000" max="50000" step="1000" value="10000" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Risk Per Trade: <span id="riskPerTrade">2%</span></label>
                                                <input type="range" id="riskSlider" min="1" max="10" step="0.5" value="2" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Win Rate: <span id="winRate">60%</span></label>
                                                <input type="range" id="winRateSlider" min="30" max="80" step="5" value="60" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Metrics Display -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Risk Analysis</h5>
                                    <div class="space-y-2 text-sm" id="riskMetricsDisplay">
                                        <div class="flex justify-between items-center">
                                            <span>Max Loss Per Trade:</span>
                                            <span class="font-bold text-red-600" id="maxLossPerTrade">$200</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Position Size:</span>
                                            <span class="font-bold" id="positionSize">2 contracts</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Expected Value:</span>
                                            <span class="font-bold text-green-600" id="expectedValue">+$24</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Kelly Criterion:</span>
                                            <span class="font-bold" id="kellyCriterion">3.6%</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Risk of Ruin:</span>
                                            <span class="font-bold text-orange-600" id="riskOfRuin">8.2%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">🛡️ Risk Insight</h5>
                                    <p class="text-sm text-green-700" id="riskInsight">
                                        Risk management starts with position sizing. Never risk more than 1-2% of your portfolio on a single trade, regardless of how confident you feel!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3D Greeks Surface Plots Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🌊 3D Greeks Surface Plots</h3>
                <p class="text-gray-600 text-center mb-8">Visualize how Greeks change across stock price and time dimensions</p>
                
                <!-- 3D Controls -->
                <div class="bg-white rounded-lg p-6 mb-6">
                    <div class="grid md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Greek to Visualize</label>
                            <select id="greek3D" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="delta">Delta (Price Sensitivity)</option>
                                <option value="gamma">Gamma (Delta Change)</option>
                                <option value="theta">Theta (Time Decay)</option>
                                <option value="vega">Vega (Volatility Sensitivity)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Base Stock Price ($)</label>
                            <input type="number" id="base3DStock" value="100" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price ($)</label>
                            <input type="number" id="strike3D" value="105" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Volatility (%)</label>
                            <input type="number" id="vol3D" value="25" min="5" max="100" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-center space-x-4 mb-4">
                        <button id="generate3D" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            🎨 Generate 3D Surface
                        </button>
                        <button id="rotate3D" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            🔄 Auto Rotate
                        </button>
                    </div>
                </div>
                
                <!-- 3D Canvas Container -->
                <div class="bg-white rounded-lg p-4 mb-6">
                    <div id="threejs-container" class="w-full h-96 bg-gray-900 rounded-lg relative">
                        <div id="loading3D" class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center">
                                <div class="animate-spin text-4xl mb-4">🌀</div>
                                <p>Loading 3D visualization...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3D Analysis Display -->
                <div id="surface-analysis" class="grid md:grid-cols-3 gap-4 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Surface Statistics</h5>
                        <div id="surface-stats" class="text-sm text-gray-600">
                            <div class="mb-1">Max Value: <span id="max-value" class="font-mono text-blue-600">--</span></div>
                            <div class="mb-1">Min Value: <span id="min-value" class="font-mono text-red-600">--</span></div>
                            <div>Range: <span id="value-range" class="font-mono text-green-600">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Key Insights</h5>
                        <div id="surface-insights" class="text-sm text-gray-600">
                            <div id="insight-text">Click "Generate 3D Surface" to see insights</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Interactive Guide</h5>
                        <div class="text-sm text-gray-600">
                            <div class="mb-1">🖱️ <strong>Mouse:</strong> Rotate view</div>
                            <div class="mb-1">🔍 <strong>Scroll:</strong> Zoom in/out</div>
                            <div>🎯 <strong>Click:</strong> Reset view</div>
                        </div>
                    </div>
                </div>

                <!-- Educational Context -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">🎓 Understanding 3D Greeks</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">What You're Seeing:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>X-Axis:</strong> Stock prices (around current price)</li>
                                <li>• <strong>Y-Axis:</strong> Time to expiration (days)</li>
                                <li>• <strong>Z-Axis (Height):</strong> Greek value</li>
                                <li>• <strong>Colors:</strong> Heat map of values</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">Key Patterns:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>Delta:</strong> Steeper near strike, flatter far away</li>
                                <li>• <strong>Gamma:</strong> Peaks at-the-money, fades with time</li>
                                <li>• <strong>Theta:</strong> Accelerates as expiration approaches</li>
                                <li>• <strong>Vega:</strong> Highest with time, peaks at-the-money</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Practice Playground Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🏗️ Practice Playground</h3>
                <p class="text-lg text-gray-600 mb-8 text-center">Test your knowledge and experiment with advanced options concepts</p>

                <!-- Practice Tool Selection -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="showPracticeTool('market-scenario')" class="practice-tool-btn p-4 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-center">
                        <div class="text-2xl mb-2">📊</div>
                        <div class="font-semibold">Market Scenario Simulator</div>
                    </button>
                    <button onclick="showPracticeTool('strategy-backtest')" class="practice-tool-btn p-4 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-center">
                        <div class="text-2xl mb-2">📈</div>
                        <div class="font-semibold">Strategy Backtesting</div>
                    </button>
                    <button onclick="showPracticeTool('greeks-sensitivity')" class="practice-tool-btn p-4 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-center">
                        <div class="text-2xl mb-2">📏</div>
                        <div class="font-semibold">Greeks Sensitivity</div>
                    </button>
                    <button onclick="showPracticeTool('volatility-smile')" class="practice-tool-btn p-4 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition text-center">
                        <div class="text-2xl mb-2">😊</div>
                        <div class="font-semibold">Volatility Smile</div>
                    </button>
                </div>

                <!-- Market Scenario Simulator -->
                <div id="market-scenario-tool" class="practice-tool hidden">
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <h4 class="text-xl font-bold mb-4 text-purple-600">📊 Market Scenario Simulator</h4>
                        <p class="text-gray-600 mb-6">Test how different market conditions affect your options positions</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Scenario Controls -->
                            <div>
                                <h5 class="font-semibold mb-3">Market Scenario</h5>
                                <div class="space-y-3 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Scenario Type</label>
                                        <select id="scenarioType" class="w-full p-2 border rounded" onchange="updateScenario()">
                                            <option value="bull">Bull Market (+20% over 6 months)</option>
                                            <option value="bear">Bear Market (-25% over 6 months)</option>
                                            <option value="sideways">Sideways Market (±5% volatility)</option>
                                            <option value="crash">Market Crash (-40% in 1 month)</option>
                                            <option value="recovery">Recovery (+30% over 3 months)</option>
                                            <option value="volatile">High Volatility (±30% swings)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Time Period (Days)</label>
                                        <input type="range" id="scenarioDays" min="7" max="365" value="90" onchange="updateScenario()" class="w-full">
                                        <div class="text-sm text-gray-600">Days: <span id="scenarioDaysValue">90</span></div>
                                    </div>
                                </div>

                                <!-- Position Setup -->
                                <h5 class="font-semibold mb-3">Your Position</h5>
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Position Type</label>
                                            <select id="scenarioPosition" class="w-full p-2 border rounded" onchange="updateScenario()">
                                                <option value="long-call">Long Call</option>
                                                <option value="long-put">Long Put</option>
                                                <option value="short-call">Short Call</option>
                                                <option value="short-put">Short Put</option>
                                                <option value="straddle">Long Straddle</option>
                                                <option value="strangle">Long Strangle</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Strike</label>
                                            <input type="number" id="scenarioStrike" value="155" onchange="updateScenario()" class="w-full p-2 border rounded">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Current Stock Price</label>
                                            <input type="number" id="scenarioStock" value="150" onchange="updateScenario()" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Volatility (%)</label>
                                            <input type="number" id="scenarioVol" value="25" min="5" max="100" onchange="updateScenario()" class="w-full p-2 border rounded">
                                        </div>
                                    </div>
                                    <button onclick="runScenario()" class="w-full bg-purple-600 text-white p-2 rounded hover:bg-purple-700 transition">
                                        Run Scenario Simulation
                                    </button>
                                </div>
                            </div>

                            <!-- Results Display -->
                            <div>
                                <h5 class="font-semibold mb-3">Scenario Results</h5>
                                <div id="scenarioResults" class="space-y-4">
                                    <div class="bg-gray-50 p-4 rounded text-center text-gray-500">
                                        Select a scenario and run simulation to see results
                                    </div>
                                </div>
                                
                                <!-- Scenario Chart -->
                                <div class="mt-6">
                                    <canvas id="scenarioChart" width="400" height="250" class="w-full border rounded"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Backtesting Tool -->
                <div id="strategy-backtest-tool" class="practice-tool hidden">
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <h4 class="text-xl font-bold mb-4 text-blue-600">📈 Strategy Backtesting</h4>
                        <p class="text-gray-600 mb-6">Test how your options strategies would have performed historically</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Strategy Configuration -->
                            <div>
                                <h5 class="font-semibold mb-3">Strategy Setup</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Strategy Type</label>
                                        <select id="backtestStrategy" class="w-full p-2 border rounded" onchange="updateBacktest()">
                                            <option value="covered-call">Covered Call</option>
                                            <option value="cash-secured-put">Cash Secured Put</option>
                                            <option value="iron-condor">Iron Condor</option>
                                            <option value="bull-call-spread">Bull Call Spread</option>
                                            <option value="bear-put-spread">Bear Put Spread</option>
                                            <option value="long-straddle">Long Straddle</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">DTE at Entry</label>
                                            <input type="number" id="backtestDTE" value="45" min="7" max="90" onchange="updateBacktest()" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">DTE at Exit</label>
                                            <input type="number" id="backtestExitDTE" value="21" min="0" max="45" onchange="updateBacktest()" class="w-full p-2 border rounded">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Profit Target (%)</label>
                                            <input type="number" id="backtestProfitTarget" value="50" min="10" max="100" onchange="updateBacktest()" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Stop Loss (%)</label>
                                            <input type="number" id="backtestStopLoss" value="200" min="100" max="500" onchange="updateBacktest()" class="w-full p-2 border rounded">
                                        </div>
                                    </div>
                                    <button onclick="runBacktest()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">
                                        Run Historical Backtest
                                    </button>
                                </div>
                            </div>

                            <!-- Backtest Results -->
                            <div>
                                <h5 class="font-semibold mb-3">Performance Metrics</h5>
                                <div id="backtestResults" class="space-y-3">
                                    <div class="bg-gray-50 p-4 rounded text-center text-gray-500">
                                        Configure strategy and run backtest to see results
                                    </div>
                                </div>
                                
                                <!-- Performance Chart -->
                                <div class="mt-6">
                                    <canvas id="backtestChart" width="400" height="200" class="w-full border rounded"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Greeks Sensitivity Analysis -->
                <div id="greeks-sensitivity-tool" class="practice-tool hidden">
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <h4 class="text-xl font-bold mb-4 text-green-600">📏 Greeks Sensitivity Analysis</h4>
                        <p class="text-gray-600 mb-6">Analyze how Greeks change across different market conditions</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Analysis Controls -->
                            <div>
                                <h5 class="font-semibold mb-3">Analysis Parameters</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Focus Greek</label>
                                        <select id="sensitivityGreek" class="w-full p-2 border rounded" onchange="updateSensitivity()">
                                            <option value="delta">Delta - Price Sensitivity</option>
                                            <option value="gamma">Gamma - Delta Sensitivity</option>
                                            <option value="theta">Theta - Time Decay</option>
                                            <option value="vega">Vega - Volatility Sensitivity</option>
                                            <option value="rho">Rho - Interest Rate Sensitivity</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Stock Price Range</label>
                                            <div class="flex gap-1">
                                                <input type="number" id="sensitivityStockMin" value="130" class="flex-1 p-2 border rounded" placeholder="Min">
                                                <input type="number" id="sensitivityStockMax" value="170" class="flex-1 p-2 border rounded" placeholder="Max">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Time Range (Days)</label>
                                            <div class="flex gap-1">
                                                <input type="number" id="sensitivityTimeMin" value="1" class="flex-1 p-2 border rounded" placeholder="Min">
                                                <input type="number" id="sensitivityTimeMax" value="90" class="flex-1 p-2 border rounded" placeholder="Max">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Strike</label>
                                            <input type="number" id="sensitivityStrike" value="150" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Vol (%)</label>
                                            <input type="number" id="sensitivityVol" value="25" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Type</label>
                                            <select id="sensitivityType" class="w-full p-2 border rounded">
                                                <option value="call">Call</option>
                                                <option value="put">Put</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onclick="runSensitivityAnalysis()" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700 transition">
                                        Run Sensitivity Analysis
                                    </button>
                                </div>
                            </div>

                            <!-- Sensitivity Results -->
                            <div>
                                <h5 class="font-semibold mb-3">Sensitivity Results</h5>
                                <div id="sensitivityResults" class="space-y-3 mb-4">
                                    <div class="bg-gray-50 p-4 rounded text-center text-gray-500">
                                        Run analysis to see sensitivity metrics
                                    </div>
                                </div>
                                
                                <!-- Sensitivity Chart -->
                                <div class="mt-6">
                                    <canvas id="sensitivityChart" width="400" height="250" class="w-full border rounded"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Volatility Smile Explorer -->
                <div id="volatility-smile-tool" class="practice-tool hidden">
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <h4 class="text-xl font-bold mb-4 text-yellow-600">😊 Volatility Smile Explorer</h4>
                        <p class="text-gray-600 mb-6">Explore how implied volatility varies across strike prices and time</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Smile Configuration -->
                            <div>
                                <h5 class="font-semibold mb-3">Smile Parameters</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Market Regime</label>
                                        <select id="smileRegime" class="w-full p-2 border rounded" onchange="updateVolatilitySmile()">
                                            <option value="normal">Normal Market</option>
                                            <option value="stressed">Stressed Market</option>
                                            <option value="earnings">Earnings Event</option>
                                            <option value="crash">Post-Crash</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Current Stock Price</label>
                                            <input type="number" id="smileStock" value="150" onchange="updateVolatilitySmile()" class="w-full p-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">ATM Volatility (%)</label>
                                            <input type="number" id="smileATMVol" value="25" min="5" max="80" onchange="updateVolatilitySmile()" class="w-full p-2 border rounded">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Skew</label>
                                            <input type="range" id="smileSkew" min="-20" max="20" value="-5" onchange="updateVolatilitySmile()" class="w-full">
                                            <div class="text-xs text-gray-600 text-center">Put skew: <span id="skewValue">-5</span>%</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Smile</label>
                                            <input type="range" id="smileCurvature" min="0" max="15" value="3" onchange="updateVolatilitySmile()" class="w-full">
                                            <div class="text-xs text-gray-600 text-center">Curvature: <span id="curvatureValue">3</span></div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Days</label>
                                            <input type="number" id="smileDays" value="30" min="7" max="365" onchange="updateVolatilitySmile()" class="w-full p-2 border rounded text-sm">
                                        </div>
                                    </div>
                                    <button onclick="generateVolatilitySmile()" class="w-full bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700 transition">
                                        Generate Volatility Surface
                                    </button>
                                </div>
                            </div>

                            <!-- Smile Analysis -->
                            <div>
                                <h5 class="font-semibold mb-3">Smile Analysis</h5>
                                <div id="smileAnalysis" class="space-y-3 mb-4">
                                    <div class="bg-gray-50 p-4 rounded text-center text-gray-500">
                                        Generate volatility surface to see analysis
                                    </div>
                                </div>
                                
                                <!-- Volatility Smile Chart -->
                                <div class="mt-6">
                                    <canvas id="volatilitySmileChart" width="400" height="250" class="w-full border rounded"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Algorithm Deep Dives Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🔬 Algorithm Deep Dives</h3>
                <p class="text-gray-600 text-center mb-8">Interactive mathematical foundations and visual explorations of options pricing models</p>
                
                <!-- Deep Dive Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showDeepDive('binomial')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="binomialDeepDiveBtn">
                        🌳 Binomial Method
                    </button>
                    <button onclick="showDeepDive('blackscholes')" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="blackscholesDeepDiveBtn">
                        📊 Black-Scholes  
                    </button>
                    <button onclick="showDeepDive('trinomial')" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="trinomialDeepDiveBtn">
                        🔱 Trinomial Tree
                    </button>
                    <button onclick="showDeepDive('montecarlo')" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="montecarloDeepDiveBtn">
                        🎲 Monte Carlo
                    </button>
                    <button onclick="showDeepDive('jumpdiffusion')" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="jumpdiffusionDeepDiveBtn">
                        💥 Jump Diffusion
                    </button>
                </div>
                
                <!-- Cox-Ross-Rubinstein Binomial Method Deep Dive -->
                <div id="binomialDeepDive" class="deep-dive-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🌳</span>
                            Cox-Ross-Rubinstein Binomial Method Deep Dive
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Theory and Mathematical Foundation -->
                            <div class="space-y-6">
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">📚 Mathematical Foundation</h5>
                                    <div class="space-y-3 text-sm text-blue-700">
                                        <div>
                                            <strong>Core Idea:</strong> Model stock price as a series of up/down moves in discrete time steps.
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>Up Factor:</strong> u = e<sup>σ√Δt</sup><br>
                                            <strong>Down Factor:</strong> d = e<sup>-σ√Δt</sup> = 1/u<br>
                                            <strong>Risk-neutral Probability:</strong> p = (e<sup>rΔt</sup> - d) / (u - d)
                                        </div>
                                        <div>
                                            <strong>Key Insight:</strong> In a risk-neutral world, the expected return equals the risk-free rate.
                                            This allows us to value options without knowing the actual probability of stock moves.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">🎯 Interactive Parameters</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-green-700 mb-1">Stock Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="binomialStockSlider" min="50" max="200" value="100" step="5" class="flex-1">
                                                <span id="binomialStockValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$100</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-green-700 mb-1">Strike Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="binomialStrikeSlider" min="50" max="200" value="105" step="5" class="flex-1">
                                                <span id="binomialStrikeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$105</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-green-700 mb-1">Volatility (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="binomialVolSlider" min="10" max="80" value="25" step="5" class="flex-1">
                                                <span id="binomialVolValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">25%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-green-700 mb-1">Time Steps</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="binomialStepsSlider" min="3" max="15" value="8" step="1" class="flex-1">
                                                <span id="binomialStepsValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">8</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">📊 Calculated Values</h5>
                                    <div id="binomialCalculations" class="space-y-2 text-sm font-mono">
                                        <div class="flex justify-between">
                                            <span>Up Factor (u):</span>
                                            <span id="upFactor" class="text-green-600">1.142</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Down Factor (d):</span>
                                            <span id="downFactor" class="text-red-600">0.876</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Risk-Neutral Prob (p):</span>
                                            <span id="riskNeutralProb" class="text-blue-600">0.543</span>
                                        </div>
                                        <div class="flex justify-between border-t pt-2 font-bold">
                                            <span>Option Price:</span>
                                            <span id="binomialOptionPrice" class="text-purple-600">$6.42</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Binomial Tree Visualization -->
                            <div class="space-y-6">
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">🌳 Interactive Binomial Tree</h5>
                                    <div id="binomialTreeContainer" class="w-full h-96 bg-gray-50 rounded-lg relative overflow-hidden">
                                        <svg id="binomialTreeSVG" width="100%" height="100%" class="absolute inset-0">
                                        </svg>
                                        <div class="absolute top-2 right-2 bg-white px-2 py-1 rounded text-xs">
                                            <span>Click nodes to explore paths</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-orange-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-orange-800 mb-3">🔍 Path Analysis</h5>
                                    <div id="pathAnalysis" class="space-y-2 text-sm">
                                        <div class="text-orange-700">
                                            <strong>Selected Path:</strong> <span id="selectedPath">Click on tree nodes to analyze paths</span>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="flex justify-between mb-1">
                                                <span>Final Stock Price:</span>
                                                <span id="finalStockPrice" class="font-mono">--</span>
                                            </div>
                                            <div class="flex justify-between mb-1">
                                                <span>Option Payoff:</span>
                                                <span id="optionPayoff" class="font-mono">--</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Path Probability:</span>
                                                <span id="pathProbability" class="font-mono">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">⚡ Key Insights</h5>
                                    <div class="space-y-2 text-sm text-red-700">
                                        <div>• <strong>Recombining Tree:</strong> Up-then-down equals down-then-up, keeping complexity manageable</div>
                                        <div>• <strong>American vs European:</strong> Can check early exercise at each node for American options</div>
                                        <div>• <strong>Convergence:</strong> As steps increase, binomial approaches Black-Scholes</div>
                                        <div>• <strong>Computational:</strong> Grows exponentially: n steps = 2ⁿ paths (but recombines to n+1 final states)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Placeholder for other deep dives -->
                <!-- Black-Scholes Deep Dive -->
                <div id="blackscholesDeepDive" class="deep-dive-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📊</span>
                            Black-Scholes Model Deep Dive
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Assumptions and Theory -->
                            <div class="space-y-6">
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">📐 Key Assumptions</h5>
                                    <div class="space-y-3 text-sm text-green-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong>1. Geometric Brownian Motion:</strong><br>
                                            dS = μS dt + σS dW<br>
                                            <em>Stock price follows continuous random walk</em>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>2. Constant Parameters:</strong><br>
                                            • Risk-free rate (r) is constant<br>
                                            • Volatility (σ) is constant<br>
                                            • No dividends during option life
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>3. Market Conditions:</strong><br>
                                            • No transaction costs<br>
                                            • Perfect liquidity<br>
                                            • European exercise only
                                        </div>
                                        <div class="bg-yellow-100 p-2 rounded text-xs">
                                            ⚠️ <strong>Reality Check:</strong> These assumptions rarely hold perfectly in real markets!
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">🎯 Interactive Parameters</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Stock Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="bsStockSlider" min="50" max="200" value="100" step="5" class="flex-1">
                                                <span id="bsStockValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$100</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Strike Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="bsStrikeSlider" min="50" max="200" value="105" step="5" class="flex-1">
                                                <span id="bsStrikeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$105</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Time to Expiry (days)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="bsTimeSlider" min="1" max="365" value="30" step="1" class="flex-1">
                                                <span id="bsTimeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">30</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Volatility (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="bsVolSlider" min="5" max="100" value="25" step="5" class="flex-1">
                                                <span id="bsVolValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">25%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Risk-Free Rate (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="bsRateSlider" min="0" max="10" value="4" step="0.5" class="flex-1">
                                                <span id="bsRateValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">4.0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">🔢 Formula Breakdown</h5>
                                    <div class="space-y-3 text-sm font-mono bg-white p-4 rounded">
                                        <div><strong>Call Price Formula:</strong></div>
                                        <div class="text-purple-600">C = S₀N(d₁) - Ke⁻ʳᵀN(d₂)</div>
                                        <div class="mt-3 text-xs text-gray-600">
                                            <div>d₁ = [ln(S₀/K) + (r + σ²/2)T] / (σ√T)</div>
                                            <div>d₂ = d₁ - σ√T</div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t">
                                            <div class="flex justify-between">
                                                <span>d₁:</span>
                                                <span id="bsD1" class="text-blue-600">0.234</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>d₂:</span>
                                                <span id="bsD2" class="text-blue-600">0.112</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>N(d₁):</span>
                                                <span id="bsNd1" class="text-green-600">0.592</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>N(d₂):</span>
                                                <span id="bsNd2" class="text-green-600">0.545</span>
                                            </div>
                                            <div class="flex justify-between border-t pt-2 font-bold">
                                                <span>Call Price:</span>
                                                <span id="bsCallPrice" class="text-purple-600">$6.42</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization and Analysis -->
                            <div class="space-y-6">
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">📈 Normal Distribution Visualization</h5>
                                    <div id="bsDistributionContainer" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="bsDistributionCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Shows the probability distributions used in N(d₁) and N(d₂) calculations
                                    </div>
                                </div>
                                
                                <div class="bg-orange-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-orange-800 mb-3">🔬 Sensitivity Analysis</h5>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-white p-3 rounded">
                                            <div class="text-sm font-medium text-orange-700">Moneyness Effect</div>
                                            <div id="moneynessEffect" class="text-xs text-orange-600 mt-1">ATM: Highest sensitivity</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="text-sm font-medium text-orange-700">Time Effect</div>
                                            <div id="timeEffect" class="text-xs text-orange-600 mt-1">More time = higher value</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="text-sm font-medium text-orange-700">Volatility Effect</div>
                                            <div id="volEffect" class="text-xs text-orange-600 mt-1">Higher vol = higher price</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="text-sm font-medium text-orange-700">Interest Rate</div>
                                            <div id="rateEffect" class="text-xs text-orange-600 mt-1">Higher rate = higher calls</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">⚠️ Model Limitations</h5>
                                    <div class="space-y-2 text-sm text-red-700">
                                        <div>• <strong>Constant Volatility:</strong> Real volatility changes over time and market conditions</div>
                                        <div>• <strong>No Dividends:</strong> Many stocks pay dividends during option life</div>
                                        <div>• <strong>European Exercise:</strong> Most US options are American (early exercise)</div>
                                        <div>• <strong>Perfect Markets:</strong> No bid-ask spreads or transaction costs</div>
                                        <div>• <strong>Normal Returns:</strong> Markets exhibit fat tails and skewness</div>
                                        <div class="bg-white p-3 rounded mt-3">
                                            <strong>💡 Reality:</strong> Despite limitations, Black-Scholes provides excellent baseline pricing. 
                                            Modern traders adjust for volatility smiles, dividends, and early exercise premiums.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-indigo-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-indigo-800 mb-3">🎯 Key Insights</h5>
                                    <div class="space-y-2 text-sm text-indigo-700">
                                        <div>• <strong>Instant Calculation:</strong> No iterative process like binomial/trinomial</div>
                                        <div>• <strong>Mathematical Elegance:</strong> Closed-form solution with proven theory</div>
                                        <div>• <strong>Foundation:</strong> Basis for most modern options pricing models</div>
                                        <div>• <strong>Greeks:</strong> Analytical derivatives provide exact hedge ratios</div>
                                        <div>• <strong>Benchmark:</strong> Industry standard for comparing other models</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trinomial vs Binomial Comparison Deep Dive -->
                <div id="trinomialDeepDive" class="deep-dive-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🔱</span>
                            Trinomial vs Binomial Comparison
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Theory and Comparison -->
                            <div class="space-y-6">
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">⚖️ Model Comparison</h5>
                                    <div class="space-y-4">
                                        <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                            <h6 class="font-medium text-blue-800">Binomial Model</h6>
                                            <div class="text-sm text-blue-700 mt-2">
                                                <div>• <strong>Branches:</strong> 2 per node (up/down)</div>
                                                <div>• <strong>Formula:</strong> u = e<sup>σ√Δt</sup>, d = 1/u</div>
                                                <div>• <strong>Probability:</strong> p = (e<sup>rΔt</sup> - d)/(u - d)</div>
                                                <div>• <strong>Best for:</strong> American options, simplicity</div>
                                            </div>
                                        </div>
                                        <div class="bg-white p-4 rounded border-l-4 border-purple-500">
                                            <h6 class="font-medium text-purple-800">Trinomial Model</h6>
                                            <div class="text-sm text-purple-700 mt-2">
                                                <div>• <strong>Branches:</strong> 3 per node (up/middle/down)</div>
                                                <div>• <strong>Formula:</strong> u = e<sup>σ√3Δt</sup>, d = 1/u</div>
                                                <div>• <strong>Probabilities:</strong> p<sub>u</sub>, p<sub>m</sub>, p<sub>d</sub></div>
                                                <div>• <strong>Best for:</strong> Higher accuracy, barrier options</div>
                                            </div>
                                        </div>
                                        <div class="bg-green-100 p-3 rounded text-sm">
                                            ✅ <strong>Verdict:</strong> Trinomial is 16.4% more accurate in our validation study
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-indigo-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-indigo-800 mb-3">🎯 Interactive Comparison</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-indigo-700 mb-1">Stock Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="triStockSlider" min="50" max="200" value="100" step="5" class="flex-1">
                                                <span id="triStockValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$100</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-indigo-700 mb-1">Strike Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="triStrikeSlider" min="50" max="200" value="105" step="5" class="flex-1">
                                                <span id="triStrikeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$105</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-indigo-700 mb-1">Volatility (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="triVolSlider" min="10" max="80" value="25" step="5" class="flex-1">
                                                <span id="triVolValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">25%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-indigo-700 mb-1">Time Steps</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="triStepsSlider" min="5" max="50" value="20" step="5" class="flex-1">
                                                <span id="triStepsValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">20</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-orange-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-orange-800 mb-3">📊 Price Comparison</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-blue-700 font-medium">Binomial Price:</span>
                                            <span id="trinomialBinomialPrice" class="font-mono text-blue-600">$6.42</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-purple-700 font-medium">Trinomial Price:</span>
                                            <span id="trinomialTrinomialPrice" class="font-mono text-purple-600">$6.45</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-green-700 font-medium">Black-Scholes:</span>
                                            <span id="trinomialBSPrice" class="font-mono text-green-600">$6.44</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded border-t-2 border-gray-300">
                                            <span class="font-bold text-gray-800">Price Difference:</span>
                                            <span id="priceDifference" class="font-mono font-bold text-red-600">$0.03</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization and Performance -->
                            <div class="space-y-6">
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">📈 Convergence Analysis</h5>
                                    <div id="convergenceChart" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="convergenceCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Shows how both models converge to Black-Scholes as steps increase
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-3">⚡ Performance Analysis</h5>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="bg-white p-3 rounded">
                                            <div class="font-medium text-yellow-700">Computational Cost</div>
                                            <div id="computationalCost" class="text-xs text-yellow-600 mt-1">Trinomial: ~50% more expensive</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="font-medium text-yellow-700">Memory Usage</div>
                                            <div id="memoryUsage" class="text-xs text-yellow-600 mt-1">Trinomial uses more nodes</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="font-medium text-yellow-700">Accuracy Gain</div>
                                            <div id="accuracyGain" class="text-xs text-yellow-600 mt-1">16.4% better than binomial</div>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <div class="font-medium text-yellow-700">Best Use Case</div>
                                            <div id="bestUseCase" class="text-xs text-yellow-600 mt-1">When accuracy matters most</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">🎯 When to Use Each Model</h5>
                                    <div class="space-y-3 text-sm text-red-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-blue-800">Use Binomial When:</strong><br>
                                            • Learning options pricing concepts<br>
                                            • Speed is more important than precision<br>
                                            • Simple American option exercise<br>
                                            • Teaching tree-based methods
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-purple-800">Use Trinomial When:</strong><br>
                                            • Maximum accuracy is needed<br>
                                            • Pricing exotic/barrier options<br>
                                            • Professional trading systems<br>
                                            • Validating other models
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">💡 Key Insights</h5>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <div>• <strong>Stability:</strong> Trinomial has better numerical stability</div>
                                        <div>• <strong>Flexibility:</strong> Trinomial handles more complex payoffs</div>
                                        <div>• <strong>Trade-off:</strong> 50% more computation for 16% better accuracy</div>
                                        <div>• <strong>Industry Standard:</strong> Most professional systems use trinomial</div>
                                        <div>• <strong>Educational:</strong> Both models teach the same fundamental concepts</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monte Carlo Convergence Deep Dive -->
                <div id="montecarloDeepDive" class="deep-dive-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎲</span>
                            Monte Carlo Convergence Demonstration
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Theory and Controls -->
                            <div class="space-y-6">
                                <div class="bg-orange-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-orange-800 mb-3">🎲 Monte Carlo Method</h5>
                                    <div class="space-y-3 text-sm text-orange-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong>Core Idea:</strong> Simulate thousands of possible stock price paths and average the payoffs
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>Stock Path:</strong> S<sub>T</sub> = S<sub>0</sub> × e<sup>(r - σ²/2)T + σ√T × Z</sup><br>
                                            <em>Where Z is a random normal variable</em>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>Option Price:</strong> e<sup>-rT</sup> × Average(max(S<sub>T</sub> - K, 0))
                                        </div>
                                        <div class="bg-yellow-100 p-2 rounded text-xs">
                                            💡 <strong>Key Insight:</strong> More simulations = more accurate price (Law of Large Numbers)
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">🎯 Simulation Parameters</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Stock Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="mcStockSlider" min="50" max="200" value="100" step="5" class="flex-1">
                                                <span id="mcStockValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$100</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Strike Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="mcStrikeSlider" min="50" max="200" value="105" step="5" class="flex-1">
                                                <span id="mcStrikeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$105</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Volatility (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="mcVolSlider" min="10" max="80" value="25" step="5" class="flex-1">
                                                <span id="mcVolValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">25%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Max Simulations</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="mcSimsSlider" min="1000" max="100000" value="10000" step="1000" class="flex-1">
                                                <span id="mcSimsValue" class="w-20 text-sm font-mono bg-white px-2 py-1 rounded">10,000</span>
                                            </div>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button id="runMCSimulation" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold">
                                                🚀 Run Simulation
                                            </button>
                                            <button id="resetMCSimulation" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors">
                                                🔄 Reset
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">📊 Convergence Results</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-purple-700 font-medium">Monte Carlo Price:</span>
                                            <span id="mcFinalPrice" class="font-mono text-purple-600">$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-green-700 font-medium">Black-Scholes Price:</span>
                                            <span id="mcBSReference" class="font-mono text-green-600">$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-red-700 font-medium">Standard Error:</span>
                                            <span id="mcStandardError" class="font-mono text-red-600">±$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded border-t-2 border-gray-300">
                                            <span class="font-bold text-gray-800">95% Confidence:</span>
                                            <span id="mcConfidenceInterval" class="font-mono font-bold text-blue-600">[$--, $--]</span>
                                        </div>
                                    </div>
                                    <div id="mcProgress" class="mt-4 hidden">
                                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                                            <span>Simulation Progress</span>
                                            <span id="mcProgressText">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div id="mcProgressBar" class="bg-orange-600 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization -->
                            <div class="space-y-6">
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">📈 Price Convergence</h5>
                                    <div id="mcConvergenceChart" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="mcConvergenceCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Shows how the estimated price converges as simulations increase
                                    </div>
                                </div>
                                
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">🎯 Sample Price Paths</h5>
                                    <div id="mcPathsChart" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="mcPathsCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Shows sample simulated stock price paths (first 20 simulations)
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">🎯 Statistical Insights</h5>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <div>• <strong>Law of Large Numbers:</strong> Average payoff approaches true expected value</div>
                                        <div>• <strong>Central Limit Theorem:</strong> Standard error decreases as √N</div>
                                        <div>• <strong>Confidence Intervals:</strong> 95% chance true price is within bounds</div>
                                        <div>• <strong>Convergence Rate:</strong> Double accuracy requires 4× more simulations</div>
                                        <div>• <strong>Variance Reduction:</strong> Techniques like antithetic variables can improve efficiency</div>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">⚖️ Monte Carlo vs Other Methods</h5>
                                    <div class="space-y-3 text-sm text-red-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-green-800">Advantages:</strong><br>
                                            • Handles complex payoffs easily<br>
                                            • Works for path-dependent options<br>
                                            • Provides confidence intervals<br>
                                            • Scales well to high dimensions
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-red-800">Disadvantages:</strong><br>
                                            • Computationally expensive<br>
                                            • Slow convergence (√N rate)<br>
                                            • Statistical noise in results<br>
                                            • Not suitable for Greeks calculation
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jump Diffusion Deep Dive -->
                <div id="jumpdiffusionDeepDive" class="deep-dive-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">💥</span>
                            Jump Diffusion for Market Crash Modeling
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Theory and Parameters -->
                            <div class="space-y-6">
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">💥 Jump Diffusion Model</h5>
                                    <div class="space-y-3 text-sm text-red-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong>Why Jump Diffusion?</strong><br>
                                            Traditional models assume continuous price movements, but markets experience sudden jumps during crashes, news events, and liquidity crises.
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>Model Formula:</strong><br>
                                            dS = μS dt + σS dW + S(J-1) dN<br>
                                            <em>Where dN is a Poisson jump process</em>
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong>Jump Parameters:</strong><br>
                                            • λ = Jump frequency (intensity)<br>
                                            • μ<sub>J</sub> = Average jump size<br>
                                            • σ<sub>J</sub> = Jump size volatility
                                        </div>
                                        <div class="bg-yellow-100 p-2 rounded text-xs">
                                            📊 <strong>Real Markets:</strong> S&P 500 has ~2 significant jumps per year during normal times, more during crises
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">🎯 Jump Parameters</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Stock Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="jdStockSlider" min="50" max="200" value="100" step="5" class="flex-1">
                                                <span id="jdStockValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$100</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Strike Price ($)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="jdStrikeSlider" min="50" max="200" value="105" step="5" class="flex-1">
                                                <span id="jdStrikeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">$105</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Jump Intensity (λ)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="jdIntensitySlider" min="0" max="10" value="2" step="0.5" class="flex-1">
                                                <span id="jdIntensityValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">2.0</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Jump Size (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="jdJumpSizeSlider" min="-50" max="20" value="-10" step="5" class="flex-1">
                                                <span id="jdJumpSizeValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">-10%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-blue-700 mb-1">Jump Volatility (%)</label>
                                            <div class="flex items-center space-x-3">
                                                <input type="range" id="jdJumpVolSlider" min="5" max="30" value="15" step="5" class="flex-1">
                                                <span id="jdJumpVolValue" class="w-16 text-sm font-mono bg-white px-2 py-1 rounded">15%</span>
                                            </div>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button id="simulateJumpPaths" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">
                                                💥 Simulate Crashes
                                            </button>
                                            <button id="resetJumpSimulation" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors">
                                                🔄 Reset
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">📊 Market Scenario Analysis</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-purple-700 font-medium">Standard Price:</span>
                                            <span id="jdStandardPrice" class="font-mono text-purple-600">$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-red-700 font-medium">Jump-Adjusted Price:</span>
                                            <span id="jdJumpPrice" class="font-mono text-red-600">$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-white p-3 rounded">
                                            <span class="text-orange-700 font-medium">Crash Premium:</span>
                                            <span id="jdCrashPremium" class="font-mono text-orange-600">$--</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded border-t-2 border-gray-300">
                                            <span class="font-bold text-gray-800">Premium %:</span>
                                            <span id="jdPremiumPercent" class="font-mono font-bold text-blue-600">--%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">🎯 Market Scenarios</h5>
                                    <div class="grid grid-cols-2 gap-3 text-sm">
                                        <button onclick="setMarketScenario('normal')" class="p-2 bg-white rounded border hover:bg-green-100 text-left">
                                            <div class="font-medium text-green-700">📈 Normal Market</div>
                                            <div class="text-xs text-green-600">λ=0.5, μ=-2%, σ=8%</div>
                                        </button>
                                        <button onclick="setMarketScenario('volatile')" class="p-2 bg-white rounded border hover:bg-green-100 text-left">
                                            <div class="font-medium text-green-700">📊 Volatile Market</div>
                                            <div class="text-xs text-green-600">λ=2, μ=-5%, σ=12%</div>
                                        </button>
                                        <button onclick="setMarketScenario('crash')" class="p-2 bg-white rounded border hover:bg-green-100 text-left">
                                            <div class="font-medium text-green-700">💥 Market Crisis</div>
                                            <div class="text-xs text-green-600">λ=8, μ=-15%, σ=25%</div>
                                        </button>
                                        <button onclick="setMarketScenario('bubble')" class="p-2 bg-white rounded border hover:bg-green-100 text-left">
                                            <div class="font-medium text-green-700">🫧 Bubble Pop</div>
                                            <div class="text-xs text-green-600">λ=4, μ=-20%, σ=20%</div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization -->
                            <div class="space-y-6">
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">💥 Jump Diffusion Paths</h5>
                                    <div id="jdPathsChart" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="jdPathsCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Shows price paths with sudden jumps (crashes) compared to normal diffusion
                                    </div>
                                </div>
                                
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">📊 Return Distribution</h5>
                                    <div id="jdDistributionChart" class="w-full h-64 bg-gray-50 rounded-lg relative">
                                        <canvas id="jdDistributionCanvas" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Compares normal (thin tails) vs jump diffusion (fat tails) return distributions
                                    </div>
                                </div>
                                
                                <div class="bg-orange-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-orange-800 mb-3">📈 Historical Context</h5>
                                    <div class="space-y-2 text-sm text-orange-700">
                                        <div>• <strong>Black Monday 1987:</strong> -22% in one day</div>
                                        <div>• <strong>COVID Crash 2020:</strong> -12% single day drops</div>
                                        <div>• <strong>Flash Crash 2010:</strong> -9% in minutes</div>
                                        <div>• <strong>Brexit Vote 2016:</strong> Currency jumps of 10%+</div>
                                        <div>• <strong>Lehman Crisis 2008:</strong> Multiple -5% days</div>
                                        <div class="bg-white p-2 rounded text-xs mt-3">
                                            📊 <strong>Data:</strong> These extreme moves are 10-50× more likely with jump diffusion vs normal models
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-indigo-50 p-6 rounded-lg">
                                    <h5 class="font-semibold text-indigo-800 mb-3">💡 Practical Applications</h5>
                                    <div class="space-y-3 text-sm text-indigo-700">
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-green-800">For Traders:</strong><br>
                                            • Options become more expensive before earnings<br>
                                            • Put options have higher crash premiums<br>
                                            • VIX options price in jump risk
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-blue-800">For Risk Managers:</strong><br>
                                            • Stress testing portfolios<br>
                                            • Calculating tail risk (VaR, CVaR)<br>
                                            • Setting hedge ratios for crashes
                                        </div>
                                        <div class="bg-white p-3 rounded">
                                            <strong class="text-purple-800">For Academics:</strong><br>
                                            • Explaining volatility smiles<br>
                                            • Modeling earnings announcements<br>
                                            • Studying market microstructure
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Education Section -->
        <section id="learn" class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Understanding the Greeks</h3>
            
            <!-- Common Misconception Alert -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 mb-8">
                <div class="flex">
                    <div class="text-amber-400 text-2xl mr-3">⚠️</div>
                    <div>
                        <h4 class="text-lg font-semibold text-amber-800 mb-2">Common Confusion: Rho ≠ Risk-Free Rate</h4>
                        <p class="text-amber-700">The risk-free rate is the actual interest rate (like 4%). <strong>Rho</strong> is how much your option price <em>changes</em> when that rate moves by 1%.</p>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <h5 class="font-bold text-blue-800 mb-2">Delta (Δ)</h5>
                    <p class="text-sm text-blue-700 mb-2">Speed of price change</p>
                    <p class="text-xs text-gray-600">If stock moves $1, option moves ~$Delta. Call: 0-1, Put: -1-0</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                    <h5 class="font-bold text-green-800 mb-2">Gamma (Γ)</h5>
                    <p class="text-sm text-green-700 mb-2">Acceleration</p>
                    <p class="text-xs text-gray-600">How much Delta changes per $1 stock move. Higher = more responsive</p>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                    <h5 class="font-bold text-red-800 mb-2">Theta (Θ)</h5>
                    <p class="text-sm text-red-700 mb-2">Time decay</p>
                    <p class="text-xs text-gray-600">$ lost per day. Always negative - time kills options</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                    <h5 class="font-bold text-purple-800 mb-2">Vega (V)</h5>
                    <p class="text-sm text-purple-700 mb-2">Volatility sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% volatility move (25% → 26%)</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h5 class="font-bold text-yellow-800 mb-2">Rho (ρ)</h5>
                    <p class="text-sm text-yellow-700 mb-2">Rate sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% rate move (4% → 5%). Call: +, Put: -</p>
                </div>
            </div>

            <!-- Interactive Examples -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-semibold mb-4">Real-World Example</h4>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium mb-3">📱 AAPL $150 Call, $155 Strike, 30 days</h5>
                        <div class="space-y-2 text-sm">
                            <div><strong>Delta = 0.35:</strong> If AAPL rises $1 → Call gains ~$0.35</div>
                            <div><strong>Gamma = 0.02:</strong> That 0.35 delta becomes ~0.37</div>
                            <div><strong>Theta = -0.08:</strong> Loses $0.08 every day that passes</div>
                            <div><strong>Vega = 0.12:</strong> If volatility rises 1% → Call gains $0.12</div>
                            <div><strong>Rho = 0.27:</strong> If rates rise from 4%→5% → Call gains $0.27</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium mb-3">🎯 Key Insights</h5>
                        <ul class="text-sm space-y-1 text-gray-700">
                            <li>• <strong>All Greeks are rates of change</strong> (derivatives)</li>
                            <li>• Delta shows directional exposure</li>
                            <li>• Gamma shows how fast that changes</li>
                            <li>• Theta is your daily bleed</li>
                            <li>• Vega matters most for earnings/events</li>
                            <li>• Rho barely matters unless rates are moving fast</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Calculator Features</h3>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-blue-600 text-3xl mb-4">📊</div>
                    <h4 class="text-xl font-semibold mb-3">Real-time Pricing</h4>
                    <p class="text-gray-600 mb-4">Calculate options prices using multiple validated pricing models with instant results.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-green-600 text-3xl mb-4">📈</div>
                    <h4 class="text-xl font-semibold mb-3">Greeks Analysis</h4>
                    <p class="text-gray-600 mb-4">Complete Greeks calculation with visual charts showing risk sensitivities.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-purple-600 text-3xl mb-4">🧮</div>
                    <h4 class="text-xl font-semibold mb-3">Model Comparison</h4>
                    <p class="text-gray-600 mb-4">Compare Trinomial, Binomial, Black-Scholes, and Monte Carlo pricing side-by-side.</p>
                </div>
            </div>
        </section>

        <!-- Payoff Diagram Builder Section -->
        <section id="playground" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Strategy Builder & Payoff Diagrams</h3>
                
                <!-- Strategy Builder Controls -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Build Your Strategy</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                                <select id="strategyType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="single">Single Option</option>
                                    <option value="covered-call">Covered Call</option>
                                    <option value="protective-put">Protective Put</option>
                                    <option value="straddle">Long Straddle</option>
                                    <option value="strangle">Long Strangle</option>
                                    <option value="butterfly">Butterfly Spread</option>
                                    <option value="custom">Custom Multi-Leg</option>
                                </select>
                            </div>
                            
                            <div id="strategyParams" class="space-y-3">
                                <!-- Strategy parameters will be populated here -->
                            </div>
                            
                            <button onclick="buildPayoffDiagram()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Generate Payoff Diagram
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Payoff Chart</h4>
                        <div class="relative w-full bg-gray-50 rounded-lg" style="height: 300px;">
                            <canvas id="payoffChart"></canvas>
                        </div>
                        
                        <div id="strategyMetrics" class="mt-4 space-y-2">
                            <!-- Strategy metrics will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Predefined Strategy Examples -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-4">Popular Strategies</h4>
                    <div class="grid md:grid-cols-4 gap-4">
                        <button onclick="loadStrategy('covered-call')" class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-blue-800">Covered Call</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + sell call</p>
                            <p class="text-xs text-blue-600 mt-1">📈 Neutral/Bullish</p>
                        </button>
                        
                        <button onclick="loadStrategy('protective-put')" class="bg-green-50 hover:bg-green-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-green-800">Protective Put</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + buy put</p>
                            <p class="text-xs text-green-600 mt-1">📈 Bullish protection</p>
                        </button>
                        
                        <button onclick="loadStrategy('straddle')" class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-purple-800">Long Straddle</h5>
                            <p class="text-xs text-gray-600 mt-1">Buy call + put same strike</p>
                            <p class="text-xs text-purple-600 mt-1">⚡ High volatility play</p>
                        </button>
                        
                        <button onclick="loadStrategy('iron-condor')" class="bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-yellow-800">Iron Condor</h5>
                            <p class="text-xs text-gray-600 mt-1">4-leg neutral strategy</p>
                            <p class="text-xs text-yellow-600 mt-1">😴 Low volatility play</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">About</h3>
                <div class="text-center">
                    <p class="text-gray-600 mb-6">Professional options pricing calculator with advanced Greeks analysis and model comparison capabilities.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">Multiple Models</h5>
                            <p class="text-sm text-blue-600">Trinomial, Binomial, Black-Scholes, Monte Carlo</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">Real-time Greeks</h5>
                            <p class="text-sm text-green-600">Delta, Gamma, Theta, Vega, Rho analysis</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-2">Validated Accuracy</h5>
                            <p class="text-sm text-purple-600">Market-tested pricing algorithms</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-red-800 mb-2">Professional Grade</h5>
                            <p class="text-sm text-red-600">Industry-standard calculations</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Market Integration Section -->
        <section id="live-market" class="mb-16">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">📈 Live Market Integration</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Real-time options chains, implied volatility surfaces, and market maker perspectives
                </p>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-6 text-left max-w-4xl mx-auto">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>🚀 Phase 3 Features:</strong> Live market data integration, real-time options chains, 
                                implied volatility surfaces, and advanced learning paths with progression tracking.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Market Tools Navigation -->
            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button onclick="showMarketTool('options-chain')" class="market-tool-btn px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="optionsChainBtn">
                    📊 Live Options Chain
                </button>
                <button onclick="showMarketTool('iv-surface')" class="market-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="ivSurfaceBtn">
                    🏔️ IV Surface
                </button>
                <button onclick="showMarketTool('market-maker')" class="market-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="marketMakerBtn">
                    🏦 Market Maker View
                </button>
                <button onclick="showMarketTool('learning-paths')" class="market-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="learningPathsBtn">
                    🎓 Learning Paths
                </button>
            </div>

            <!-- Options Chain Tool -->
            <div id="optionsChainTool" class="market-tool-content bg-white rounded-xl shadow-lg p-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Controls -->
                    <div>
                        <h3 class="text-2xl font-bold mb-6">📊 Real-Time Options Chain</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol</label>
                                <select id="chainSymbol" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="SPY">SPY - S&P 500 ETF</option>
                                    <option value="AAPL">AAPL - Apple Inc</option>
                                    <option value="MSFT">MSFT - Microsoft</option>
                                    <option value="TSLA">TSLA - Tesla</option>
                                    <option value="NVDA">NVDA - NVIDIA</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Expiration Date</label>
                                <select id="chainExpiration" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="7">Weekly (7 days)</option>
                                    <option value="14">Bi-weekly (14 days)</option>
                                    <option value="30" selected>Monthly (30 days)</option>
                                    <option value="60">Quarterly (60 days)</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Moneyness Range</label>
                                <select id="chainMoneyness" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="5">±5% (10 strikes)</option>
                                    <option value="10" selected>±10% (20 strikes)</option>
                                    <option value="15">±15% (30 strikes)</option>
                                    <option value="20">±20% (40 strikes)</option>
                                </select>
                            </div>
                            
                            <button onclick="generateOptionsChain()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                📊 Generate Options Chain
                            </button>
                        </div>
                        
                        <!-- Market Data Stats -->
                        <div class="mt-6 bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">📈 Market Statistics</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Current Price:</span>
                                    <span id="currentPrice" class="font-mono">$450.25</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Implied Vol:</span>
                                    <span id="avgImpliedVol" class="font-mono">22.5%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Put/Call Ratio:</span>
                                    <span id="putCallRatio" class="font-mono">0.85</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Volume:</span>
                                    <span id="totalVolume" class="font-mono">2,450,000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options Chain Display -->
                    <div>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">🎯 Live Options Chain</h4>
                            <div class="text-xs text-gray-500 mb-2">Updated every 15 seconds (simulated)</div>
                            
                            <!-- Chain Headers -->
                            <div class="grid grid-cols-7 gap-1 text-xs font-semibold text-gray-700 mb-2">
                                <div class="text-center">Call Vol</div>
                                <div class="text-center">Call IV</div>
                                <div class="text-center">Call Price</div>
                                <div class="text-center bg-blue-100 p-1 rounded">Strike</div>
                                <div class="text-center">Put Price</div>
                                <div class="text-center">Put IV</div>
                                <div class="text-center">Put Vol</div>
                            </div>
                            
                            <!-- Chain Data Container -->
                            <div id="optionsChainData" class="space-y-1 max-h-96 overflow-y-auto">
                                <!-- Will be populated by JavaScript -->
                                <div class="text-center text-gray-500 py-4">
                                    Click "Generate Options Chain" to load data
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Analysis -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h5 class="font-semibold text-blue-800 mb-2">💡 Quick Analysis</h5>
                            <div id="chainAnalysis" class="text-sm text-blue-700">
                                Options chain analysis will appear here after generating data
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IV Surface Tool -->
            <div id="ivSurfaceTool" class="market-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-6">🏔️ Implied Volatility Surface</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol</label>
                                <select id="ivSurfaceSymbol" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="SPY">SPY - S&P 500 ETF</option>
                                    <option value="AAPL">AAPL - Apple Inc</option>
                                    <option value="MSFT">MSFT - Microsoft</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Surface Type</label>
                                <select id="surfaceType" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="iv-surface">IV Surface (Strike vs Time)</option>
                                    <option value="volatility-smile">Volatility Smile</option>
                                    <option value="term-structure">Term Structure</option>
                                </select>
                            </div>
                            
                            <button onclick="generateIVSurface()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                🏔️ Generate IV Surface
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div id="ivSurface3D" class="h-96 bg-gray-100 rounded-lg flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <div class="text-4xl mb-2">🏔️</div>
                                <div>Click "Generate IV Surface" to view 3D visualization</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Maker View Tool -->
            <div id="marketMakerTool" class="market-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <h3 class="text-2xl font-bold mb-6">🏦 Market Maker Perspective</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-lg font-semibold mb-4">📊 Order Flow Analysis</h4>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-700">Bid-Ask Spreads</div>
                                <canvas id="bidAskChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-4">⚖️ Risk Management</h4>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-700">Portfolio Greeks</div>
                                <canvas id="portfolioGreeksChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning Paths Tool -->
            <div id="learningPathsTool" class="market-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <h3 class="text-2xl font-bold mb-6">🎓 Progressive Learning Paths</h3>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Beginner Path -->
                    <div class="bg-green-50 rounded-lg p-6">
                        <div class="text-2xl mb-3">🌱</div>
                        <h4 class="text-xl font-bold text-green-800 mb-3">Beginner Path</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                <span class="text-sm">Options Basics</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                <span class="text-sm">Understanding Greeks</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Simple Strategies</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Risk Management</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-green-700">Progress: 2/4 completed</div>
                    </div>
                    
                    <!-- Intermediate Path -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <div class="text-2xl mb-3">📊</div>
                        <h4 class="text-xl font-bold text-blue-800 mb-3">Intermediate Path</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Pricing Models</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Advanced Strategies</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Market Analysis</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Portfolio Greeks</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-blue-700">Progress: 0/4 completed</div>
                        <div class="text-xs text-blue-600 mt-1">Unlock after Beginner Path</div>
                    </div>
                    
                    <!-- Advanced Path -->
                    <div class="bg-purple-50 rounded-lg p-6">
                        <div class="text-2xl mb-3">🚀</div>
                        <h4 class="text-xl font-bold text-purple-800 mb-3">Advanced Path</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Exotic Options</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Market Making</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Quantitative Models</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                <span class="text-sm text-gray-500">Algorithm Trading</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-purple-700">Progress: 0/4 completed</div>
                        <div class="text-xs text-purple-600 mt-1">Unlock after Intermediate Path</div>
                    </div>
                </div>
                
                <!-- Achievements -->
                <div class="mt-8 bg-yellow-50 rounded-lg p-6">
                    <h4 class="text-lg font-bold text-yellow-800 mb-4">🏆 Achievements & Certificates</h4>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-white rounded-lg border-2 border-yellow-200">
                            <div class="text-2xl mb-1">🥇</div>
                            <div class="text-sm font-semibold">Options Master</div>
                            <div class="text-xs text-gray-500">Completed all tutorials</div>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border-2 border-gray-200 opacity-50">
                            <div class="text-2xl mb-1">📊</div>
                            <div class="text-sm font-semibold">Greeks Expert</div>
                            <div class="text-xs text-gray-500">Master all Greeks concepts</div>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border-2 border-gray-200 opacity-50">
                            <div class="text-2xl mb-1">⚡</div>
                            <div class="text-sm font-semibold">Speed Trader</div>
                            <div class="text-xs text-gray-500">Complete 50 calculations</div>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border-2 border-gray-200 opacity-50">
                            <div class="text-2xl mb-1">🎯</div>
                            <div class="text-sm font-semibold">Strategy Builder</div>
                            <div class="text-xs text-gray-500">Create 10 strategies</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Phase 4A: Professional Market Data Section -->
        <section id="professional-data" class="mb-16">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">⚡ Professional Market Data</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Real-time market data integration with professional-grade analytics and optimization tools
                </p>
                <div class="bg-purple-50 border-l-4 border-purple-400 p-4 mt-6 text-left max-w-4xl mx-auto">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm text-purple-700">
                                <strong>🚀 Phase 4A Preview:</strong> Advanced market data feeds, strategy optimization engine, 
                                portfolio risk analytics, and mobile PWA capabilities. <em>Professional tier features in development.</em>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Professional Tools Navigation -->
            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button onclick="showProfessionalTool('market-data')" class="professional-tool-btn px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="marketDataBtn">
                    📊 Market Data API
                </button>
                <button onclick="showProfessionalTool('strategy-optimizer')" class="professional-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="strategyOptimizerBtn">
                    🎯 Strategy Optimizer
                </button>
                <button onclick="showProfessionalTool('risk-analytics')" class="professional-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="riskAnalyticsBtn">
                    ⚖️ Risk Analytics
                </button>
                <button onclick="showProfessionalTool('portfolio-manager')" class="professional-tool-btn px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition-colors" id="portfolioManagerBtn">
                    💼 Portfolio Manager
                </button>
            </div>

            <!-- Market Data API Tool -->
            <div id="marketDataTool" class="professional-tool-content bg-white rounded-xl shadow-lg p-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- API Configuration -->
                    <div>
                        <h3 class="text-2xl font-bold mb-6">📊 Real-Time Market Data API</h3>
                        
                        <div class="space-y-4">
                            <!-- Data Provider Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Provider</label>
                                <select id="dataProvider" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="demo">Demo Mode (Simulated)</option>
                                    <option value="alphavantage">Alpha Vantage (API Required)</option>
                                    <option value="polygon">Polygon.io (API Required)</option>
                                    <option value="iex">IEX Cloud (API Required)</option>
                                </select>
                            </div>
                            
                            <!-- API Key Input -->
                            <div id="apiKeySection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                <input type="password" id="apiKey" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter your API key">
                            </div>
                            
                            <!-- Data Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Types</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="realtimeQuotes" checked class="mr-2">
                                        <span class="text-sm">Real-time Options Quotes</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="historicalData" checked class="mr-2">
                                        <span class="text-sm">Historical Price Data</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="volumeData" checked class="mr-2">
                                        <span class="text-sm">Volume & Open Interest</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="greeksData" class="mr-2">
                                        <span class="text-sm">Live Greeks (Provider Dependent)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button onclick="connectMarketData()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                🔌 Connect to Market Data
                            </button>
                        </div>
                        
                        <!-- Connection Status -->
                        <div class="mt-6 bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">📡 Connection Status</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Status:</span>
                                    <span id="connectionStatus" class="font-mono text-orange-600">Disconnected</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Provider:</span>
                                    <span id="activeProvider" class="font-mono">Demo Mode</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Rate Limit:</span>
                                    <span id="rateLimit" class="font-mono">500/min</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Latency:</span>
                                    <span id="latency" class="font-mono">~250ms</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Data Feed -->
                    <div>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">📈 Live Data Stream</h4>
                            <div class="text-xs text-gray-500 mb-2">Updates every 1-5 seconds (depending on provider)</div>
                            
                            <!-- Sample Data Display -->
                            <div id="liveDataFeed" class="space-y-2 max-h-80 overflow-y-auto text-sm font-mono">
                                <div class="text-center text-gray-500 py-8">
                                    Click "Connect to Market Data" to start live stream
                                </div>
                            </div>
                        </div>
                        
                        <!-- Market Statistics -->
                        <div class="bg-green-50 rounded-lg p-4">
                            <h5 class="font-semibold text-green-800 mb-2">📊 Market Statistics</h5>
                            <div id="marketStats" class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Active Symbols:</span>
                                    <span id="activeSymbols" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Updates/min:</span>
                                    <span id="updatesPerMin" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Data Volume:</span>
                                    <span id="dataVolume" class="font-mono">0 KB</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Uptime:</span>
                                    <span id="uptime" class="font-mono">0:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Optimizer Tool -->
            <div id="strategyOptimizerTool" class="professional-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <h3 class="text-2xl font-bold mb-6">🎯 Advanced Strategy Optimization</h3>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Strategy Configuration</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                                <select id="optimizerStrategy" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="straddle">Long Straddle</option>
                                    <option value="strangle">Long Strangle</option>
                                    <option value="iron-condor">Iron Condor</option>
                                    <option value="butterfly">Butterfly Spread</option>
                                    <option value="covered-call">Covered Call</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Optimization Objective</label>
                                <select id="optimizationObjective" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="max-return">Maximize Expected Return</option>
                                    <option value="max-sharpe">Maximize Sharpe Ratio</option>
                                    <option value="min-risk">Minimize Risk (VaR)</option>
                                    <option value="max-prob">Maximize Profit Probability</option>
                                </select>
                            </div>
                            
                            <button onclick="runStrategyOptimization()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                🚀 Run Optimization
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div id="optimizationResults" class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-2">🎯 Optimization Results</h5>
                            <div class="text-center text-gray-500 py-8">
                                Run optimization to see results
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Analytics Tool -->
            <div id="riskAnalyticsTool" class="professional-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <h3 class="text-2xl font-bold mb-6">⚖️ Portfolio Risk Analytics</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-lg font-semibold mb-4">📊 Risk Metrics</h4>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-700">Value at Risk (95%)</div>
                                <canvas id="varChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-4">🔗 Correlation Matrix</h4>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-700">Asset Correlations</div>
                                <canvas id="correlationChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Manager Tool -->
            <div id="portfolioManagerTool" class="professional-tool-content bg-white rounded-xl shadow-lg p-8 hidden">
                <h3 class="text-2xl font-bold mb-6">💼 Professional Portfolio Manager</h3>
                
                <div class="text-center text-gray-500 py-12">
                    <div class="text-4xl mb-4">🚧</div>
                    <div class="text-lg font-semibold mb-2">Coming Soon</div>
                    <div>Advanced portfolio management tools with real-time tracking and optimization</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h5 class="text-lg font-semibold mb-4">Options Calculator</h5>
                    <p class="text-gray-400">Professional-grade options pricing and Greeks analysis.</p>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Models</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Trinomial Trees</li>
                        <li>Binomial Trees</li>
                        <li>Black-Scholes</li>
                        <li>Monte Carlo</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Analysis</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Complete Greeks Suite</li>
                        <li>Model Comparison</li>
                        <li>Risk Visualization</li>
                        <li>Real-time Updates</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>Professional Options Pricing Calculator</p>
            </div>
        </div>
    </footer>

    <!-- Include the pricing library -->
    <script type="module" src="../lib/index.js"></script>
    
    <!-- Main application JavaScript -->
    <script type="module">
        // Import pricing functions from our validated library
        let pricingLibrary;
        let greeksChart;
        let isCalculating = false; // Prevent recursive calculations
        
        // ======= COMMON UTILITY FUNCTIONS (to avoid duplicates) =======
        
        function normalRandom() {
            // Box-Muller transformation for normal random variables
            if (!normalRandom.hasSpare) {
                normalRandom.hasSpare = true;
                const u1 = Math.random();
                const u2 = Math.random();
                normalRandom.spare = Math.sqrt(-2 * Math.log(u1)) * Math.sin(2 * Math.PI * u2);
                return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            } else {
                normalRandom.hasSpare = false;
                return normalRandom.spare;
            }
        }
        
        function erf(x) {
            // Error function approximation
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }
        
        function normalCDF(x) {
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }
        
        function normalPDF(x) {
            return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
        }
        
        function factorial(n) {
            if (n <= 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }
        
        // ======= END COMMON UTILITY FUNCTIONS =======
        
        // Initialize the application
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Import pricing library
                const module = await import('../lib/index.js');
                pricingLibrary = module;
                console.log('🚀 Pricing library loaded successfully');
                console.log('📊 Loaded modules:', Object.keys(module));
                
                // Initialize Greeks chart with fixed responsive settings
                initializeGreeksChart();
                
            } catch (error) {
                console.error('❌ Failed to load pricing library:', error);
                // Show error to user
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Library Loading Error</h5>
                        <p class="text-sm">Failed to load the pricing library. Please check the console for details.</p>
                    </div>
                `;
            }
        });

        // Initialize Greeks radar chart with proper responsive settings
        function initializeGreeksChart() {
            const ctx = document.getElementById('greeksChart').getContext('2d');
            
            greeksChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Delta', 'Gamma', 'Theta', 'Vega', 'Rho'],
                    datasets: [{
                        label: 'Greeks Values',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                circular: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                display: false
                            },
                            min: -1,
                            max: 1
                        }
                    }
                }
            });
        }

        // Calculator functionality - with safety checks
        window.calculateOption = function() {
            // Prevent recursive calls
            if (isCalculating) {
                console.log('Already calculating, skipping...');
                return;
            }
            
            if (!pricingLibrary) {
                console.error('Pricing library not loaded yet');
                return;
            }

            isCalculating = true;

            try {
                const params = {
                    symbol: document.getElementById('symbol').value || undefined,
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    strikePrice: parseFloat(document.getElementById('strikePrice').value),
                    daysToExpiry: parseInt(document.getElementById('daysToExpiry').value),
                    volatility: parseFloat(document.getElementById('volatility').value) / 100,
                    optionType: document.getElementById('optionType').value
                };

                // Validate inputs
                if (isNaN(params.stockPrice) || isNaN(params.strikePrice) || isNaN(params.daysToExpiry) || isNaN(params.volatility)) {
                    throw new Error('Please enter valid numbers for all fields');
                }

                // Simple pricing only - no complex calculations
                const price = pricingLibrary.priceOption(params);
                
                // Basic Greeks calculation
                const greeks = pricingLibrary.calculateGreeks({
                    ...params,
                    timeToExpiry: params.daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                });
                
                displayResults(price, greeks, params);
                updateGreeksDisplay(greeks);
                updateGreeksChart(greeks);
                
            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Calculation Error</h5>
                        <p class="text-sm">Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                isCalculating = false;
            }
        };

        function displayResults(price, greeks, params) {
            const intrinsic = params.optionType === 'call' 
                ? Math.max(0, params.stockPrice - params.strikePrice)
                : Math.max(0, params.strikePrice - params.stockPrice);
            const timeValue = price - intrinsic;

            document.getElementById('results').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h5 class="font-semibold text-blue-800 mb-2">Option Price</h5>
                        <div class="text-3xl font-bold text-blue-600">$${price.toFixed(2)}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-sm text-green-600">Intrinsic Value</div>
                            <div class="font-semibold text-green-800">$${intrinsic.toFixed(2)}</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <div class="text-sm text-purple-600">Time Value</div>
                            <div class="font-semibold text-purple-800">$${timeValue.toFixed(2)}</div>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        function updateGreeksDisplay(greeks) {
            if (!greeks || Object.keys(greeks).length === 0) return;

            const greeksHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Delta</span>
                            <div class="text-xs text-gray-600">Price change per $1 stock move</div>
                            <div class="text-xs text-blue-700 mt-1">≈ ${((greeks.delta || 0) * 100).toFixed(1)}% of stock moves</div>
                        </div>
                        <span class="font-bold text-blue-600">${greeks.delta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Gamma</span>
                            <div class="text-xs text-gray-600">Delta change per $1 stock move</div>
                            <div class="text-xs text-green-700 mt-1">Higher = more delta acceleration</div>
                        </div>
                        <span class="font-bold text-green-600">${greeks.gamma?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Theta</span>
                            <div class="text-xs text-gray-600">Price decay per day</div>
                            <div class="text-xs text-red-700 mt-1">Time is your enemy: $${((greeks.theta || 0) * -1).toFixed(2)}/day lost</div>
                        </div>
                        <span class="font-bold text-red-600">${greeks.theta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Vega</span>
                            <div class="text-xs text-gray-600">Price change per 1% volatility</div>
                            <div class="text-xs text-purple-700 mt-1">Vol from ${((greeks.vega || 0) > 0 ? '24% → 25%' : '25% → 24%')} = $${Math.abs(greeks.vega || 0).toFixed(2)}</div>
                        </div>
                        <span class="font-bold text-purple-600">${greeks.vega?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Rho</span>
                            <div class="text-xs text-gray-600">Price change per 1% rate change</div>
                            <div class="text-xs text-yellow-700 mt-1">Rates 4% → 5% = $${(greeks.rho || 0).toFixed(2)} change</div>
                        </div>
                        <span class="font-bold text-yellow-600">${greeks.rho?.toFixed(4) || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('greeksDisplay').innerHTML = greeksHtml;
        }

        // Update Greeks chart with real values
        function updateGreeksChart(greeks) {
            if (!greeksChart || !greeks) return;
            
            // Normalize values for radar chart visualization
            const normalizeValue = (value, maxExpected) => {
                return Math.max(-1, Math.min(1, value / maxExpected));
            };
            
            const chartData = [
                normalizeValue(greeks.delta || 0, 1),      // Delta: -1 to 1
                normalizeValue(greeks.gamma || 0, 0.1),    // Gamma: normalize around 0.1
                normalizeValue(greeks.theta || 0, 0.1),    // Theta: normalize around 0.1 (daily)
                normalizeValue(greeks.vega || 0, 0.5),     // Vega: normalize around 0.5
                normalizeValue(greeks.rho || 0, 0.2)       // Rho: normalize around 0.2
            ];
            
            greeksChart.data.datasets[0].data = chartData;
            greeksChart.update('none'); // No animation for smooth real-time updates
        }

        // Smooth scrolling
        window.scrollToSection = function(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth' 
            });
        };

        // Manual calculation only - prevent infinite loops
        // isCalculating already declared above
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - ready for manual calculations');
            // Remove all auto-calculation to prevent infinite loops
        });

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Payoff Diagram Builder Functions
        let payoffChart;
        let currentStrategy = {};

        // Initialize payoff chart
        function initializePayoffChart() {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            
            payoffChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Strategy Payoff at Expiration'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price at Expiration ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)'
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load predefined strategy
        window.loadStrategy = function(strategyType) {
            document.getElementById('strategyType').value = strategyType;
            populateStrategyParams(strategyType);
            buildPayoffDiagram();
        };

        // Populate strategy parameters based on selected strategy
        function populateStrategyParams(strategyType) {
            const paramsContainer = document.getElementById('strategyParams');
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            
            let paramsHtml = '';
            
            switch (strategyType) {
                case 'single':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <select id="position" class="w-full px-2 py-1 border rounded">
                                <option value="long-call">Long Call</option>
                                <option value="short-call">Short Call</option>
                                <option value="long-put">Long Put</option>
                                <option value="short-put">Short Put</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="strike1" value="${stockPrice + 5}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'covered-call':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Sell 1 call</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'protective-put':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Buy 1 put</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'straddle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (same strike)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="straddleStrike" value="${stockPrice}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'strangle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (different strikes)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
            }
            
            paramsContainer.innerHTML = paramsHtml;
        }

        // Build and display payoff diagram
        window.buildPayoffDiagram = function() {
            if (!pricingLibrary) {
                console.error('Pricing library not loaded');
                return;
            }

            const strategyType = document.getElementById('strategyType').value;
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            const volatility = parseFloat(document.getElementById('volatility').value) / 100 || 0.25;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 30;
            
            // Generate stock price range for payoff calculation
            const minPrice = stockPrice * 0.7;
            const maxPrice = stockPrice * 1.3;
            const priceStep = (maxPrice - minPrice) / 50;
            const stockPrices = [];
            const payoffs = [];
            
            for (let price = minPrice; price <= maxPrice; price += priceStep) {
                stockPrices.push(price);
                payoffs.push(calculateStrategyPayoff(strategyType, price, stockPrice, volatility, daysToExpiry));
            }
            
            // Update chart
            payoffChart.data.labels = stockPrices.map(p => p.toFixed(0));
            payoffChart.data.datasets = [{
                label: getStrategyName(strategyType),
                data: payoffs,
                borderColor: 'rgb(147, 51, 234)',
                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                borderWidth: 2,
                fill: true
            }];
            
            payoffChart.update();
            
            // Update strategy metrics
            updateStrategyMetrics(strategyType, payoffs, stockPrices, stockPrice);
        };

        function calculateStrategyPayoff(strategyType, currentPrice, stockPrice, volatility, daysToExpiry) {
            const timeToExpiry = daysToExpiry / 365;
            
            switch (strategyType) {
                case 'single':
                    const position = document.getElementById('position')?.value || 'long-call';
                    const strike = parseFloat(document.getElementById('strike1')?.value) || stockPrice + 5;
                    
                    if (position === 'long-call') {
                        return Math.max(0, currentPrice - strike);
                    } else if (position === 'short-call') {
                        return -Math.max(0, currentPrice - strike);
                    } else if (position === 'long-put') {
                        return Math.max(0, strike - currentPrice);
                    } else if (position === 'short-put') {
                        return -Math.max(0, strike - currentPrice);
                    }
                    break;
                    
                case 'covered-call':
                    const callStrike = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const stockProfit = currentPrice - stockPrice;
                    const callPayoff = -Math.max(0, currentPrice - callStrike);
                    return stockProfit + callPayoff;
                    
                case 'protective-put':
                    const putStrike = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const stockProfitPP = currentPrice - stockPrice;
                    const putPayoff = Math.max(0, putStrike - currentPrice);
                    return stockProfitPP + putPayoff;
                    
                case 'straddle':
                    const straddleStrike = parseFloat(document.getElementById('straddleStrike')?.value) || stockPrice;
                    const callPayoffStraddle = Math.max(0, currentPrice - straddleStrike);
                    const putPayoffStraddle = Math.max(0, straddleStrike - currentPrice);
                    return callPayoffStraddle + putPayoffStraddle;
                    
                case 'strangle':
                    const putStrikeStrangle = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const callStrikeStrangle = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const callPayoffStrangle = Math.max(0, currentPrice - callStrikeStrangle);
                    const putPayoffStrangle = Math.max(0, putStrikeStrangle - currentPrice);
                    return callPayoffStrangle + putPayoffStrangle;
            }
            
            return 0;
        }

        function getStrategyName(strategyType) {
            const names = {
                'single': 'Single Option',
                'covered-call': 'Covered Call',
                'protective-put': 'Protective Put',
                'straddle': 'Long Straddle',
                'strangle': 'Long Strangle',
                'butterfly': 'Butterfly Spread'
            };
            return names[strategyType] || strategyType;
        }

        function updateStrategyMetrics(strategyType, payoffs, stockPrices, currentStockPrice) {
            const maxProfit = Math.max(...payoffs);
            const maxLoss = Math.min(...payoffs);
            const currentIndex = stockPrices.findIndex(p => p >= currentStockPrice);
            const currentPayoff = payoffs[currentIndex] || 0;
            
            // Find breakeven points
            const breakevens = [];
            for (let i = 1; i < payoffs.length; i++) {
                if ((payoffs[i-1] <= 0 && payoffs[i] >= 0) || (payoffs[i-1] >= 0 && payoffs[i] <= 0)) {
                    breakevens.push(stockPrices[i]);
                }
            }
            
            document.getElementById('strategyMetrics').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-green-50 p-2 rounded">
                        <div class="font-medium text-green-800">Max Profit</div>
                        <div class="text-green-600">$${maxProfit.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded">
                        <div class="font-medium text-red-800">Max Loss</div>
                        <div class="text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded col-span-2">
                        <div class="font-medium text-blue-800">Breakevens</div>
                        <div class="text-blue-600">$${breakevens.map(b => b.toFixed(2)).join(', ')}</div>
                    </div>
                </div>
            `;
        }

        // Initialize payoff chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add small delay to ensure Chart.js is ready
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    initializePayoffChart();
                    populateStrategyParams('single');
                }
            }, 500);
        });

        // Auto-update strategy params when strategy type changes
        document.addEventListener('change', function(e) {
            if (e.target.id === 'strategyType') {
                populateStrategyParams(e.target.value);
            }
        });

        // Interactive Greeks Tutorial Functionality
        function initializeTutorial() {
            const rateSlider = document.getElementById('tutorialRate');
            const rateValue = document.getElementById('tutorialRateValue');
            const rhoValue = document.getElementById('tutorialRhoValue');
            const currentPrice = document.getElementById('currentOptionPrice');
            const newPrice = document.getElementById('newOptionPrice');
            const priceChange = document.getElementById('priceChange');
            const currentRate1 = document.getElementById('currentRate1');
            const newRate = document.getElementById('newRate');
            const explanationCurrentRate = document.getElementById('explanationCurrentRate');
            const explanationRho = document.getElementById('explanationRho');
            const explanationFromRate = document.getElementById('explanationFromRate');
            const explanationToRate = document.getElementById('explanationToRate');
            const explanationGain = document.getElementById('explanationGain');
            
            // Base option parameters for tutorial
            const baseParams = {
                stockPrice: 100,
                strikePrice: 105,
                daysToExpiry: 30,
                volatility: 0.25,
                optionType: 'call'
            };
            
            function updateTutorial() {
                const currentRiskFreeRate = parseFloat(rateSlider.value) / 100;
                const newRiskFreeRate = currentRiskFreeRate + 0.01; // +1%
                
                // Update display values
                rateValue.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                currentRate1.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                newRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                explanationCurrentRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationFromRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationToRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                
                try {
                    if (pricingLibrary && pricingLibrary.binomialPrice) {
                        // Calculate prices at both rates
                        const priceAtCurrentRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: currentRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const priceAtNewRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: newRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const change = priceAtNewRate - priceAtCurrentRate;
                        
                        // Update displays
                        currentPrice.textContent = '$' + priceAtCurrentRate.toFixed(2);
                        newPrice.textContent = '$' + priceAtNewRate.toFixed(2);
                        priceChange.textContent = (change >= 0 ? '+' : '') + '$' + change.toFixed(2);
                        rhoValue.textContent = '$' + change.toFixed(2);
                        explanationRho.textContent = '$' + change.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(change).toFixed(2);
                        
                        // Color coding for price change
                        const changeColor = change >= 0 ? 'text-green-700' : 'text-red-700';
                        priceChange.className = `text-2xl font-bold ${changeColor} mb-2`;
                        
                    } else {
                        // Fallback with estimated values
                        const estimatedRho = 0.25 + (currentRiskFreeRate - 0.04) * 2; // Rough estimation
                        rhoValue.textContent = '$' + estimatedRho.toFixed(2);
                        explanationRho.textContent = '$' + estimatedRho.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(estimatedRho).toFixed(2);
                    }
                } catch (error) {
                    console.warn('Tutorial calculation error:', error);
                    // Show default values if calculation fails
                    const defaultRho = 0.27;
                    rhoValue.textContent = '$' + defaultRho.toFixed(2);
                    explanationRho.textContent = '$' + defaultRho.toFixed(2);
                    explanationGain.textContent = '$' + Math.abs(defaultRho).toFixed(2);
                }
            }
            
            // Initialize tutorial
            updateTutorial();
            
            // Add event listener for rate slider
            rateSlider.addEventListener('input', updateTutorial);
        }
        
        // Initialize tutorial when pricing library is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeTutorial();
                initializeAlgorithmAnimations();
                
                // Initialize deep dives - show binomial by default
                showDeepDive('binomial');
            }, 1000); // Wait for pricing library to load
        });

        // Algorithm Animation Functionality
        function initializeAlgorithmAnimations() {
            // Initialize slider values
            document.getElementById('binomialSteps').addEventListener('input', function() {
                document.getElementById('binomialStepsValue').textContent = this.value;
            });
            
            // Trinomial tree input listeners
            document.getElementById('trinomialSteps').addEventListener('input', function() {
                document.getElementById('trinomialStepsDisplay').textContent = this.value;
            });
            
            document.getElementById('mcPaths').addEventListener('input', function() {
                document.getElementById('mcPathsValue').textContent = parseInt(this.value).toLocaleString();
            });
            
            document.getElementById('mcShowPaths').addEventListener('input', function() {
                document.getElementById('mcShowPathsValue').textContent = this.value;
            });
            
            // Jump Diffusion sliders
            document.getElementById('jumpIntensity').addEventListener('input', function() {
                document.getElementById('jumpIntensityValue').textContent = parseFloat(this.value).toFixed(1);
            });
            
            document.getElementById('jumpMean').addEventListener('input', function() {
                document.getElementById('jumpMeanValue').textContent = (parseFloat(this.value) * 100).toFixed(0) + '%';
            });
            
            document.getElementById('jumpVol').addEventListener('input', function() {
                document.getElementById('jumpVolValue').textContent = (parseFloat(this.value) * 100).toFixed(0) + '%';
            });
            
            document.getElementById('jumpSteps').addEventListener('input', function() {
                document.getElementById('jumpStepsValue').textContent = this.value;
            });
        }
        
        // Algorithm switching functionality - Make globally accessible
        window.showAlgorithm = function(algorithm) {
            // Hide all algorithm content
            const contents = document.querySelectorAll('.algorithm-content');
            contents.forEach(content => {
                content.classList.add('hidden');
                content.style.display = 'none';
            });
            
            // Reset button styles
            const buttons = ['binomialBtn', 'trinomialBtn', 'blackscholesBtn', 'montecarloBtn', 'jumpdiffusionBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
            });
            
            // Show selected algorithm
            const targetElement = document.getElementById(algorithm + 'Animation');
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.style.display = 'block';
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(algorithm + 'Btn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getButtonColor(algorithm));
            }
        }
        
        function getButtonColor(algorithm) {
            const colors = {
                'binomial': 'bg-blue-700',
                'trinomial': 'bg-green-700',
                'blackscholes': 'bg-purple-700',
                'montecarlo': 'bg-red-700',
                'jumpdiffusion': 'bg-yellow-700'
            };
            return colors[algorithm] || 'bg-blue-700';
        }
        
        // Binomial Tree Animation - Make globally accessible
        window.animateBinomialTree = function() {
            const steps = parseInt(document.getElementById('binomialSteps').value);
            const speed = parseInt(document.getElementById('animationSpeed').value);
            const canvas = document.getElementById('treeCanvas');
            const stepDisplay = document.getElementById('currentStepDisplay');
            
            // Reset step explanations
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.opacity = '0.3';
            }
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">Building Binomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 4;
            
            function nextStep() {
                currentStep++;
                
                // Highlight current step
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}`).style.opacity = '1';
                }
                
                switch(currentStep) {
                    case 1:
                        stepDisplay.textContent = "Starting with current stock price S₀ = $100";
                        canvas.innerHTML = createTreeVisualization(1, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = "Adding up and down movements for each time step";
                        canvas.innerHTML = createTreeVisualization(2, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = "Calculating risk-neutral probabilities";
                        canvas.innerHTML = createTreeVisualization(3, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = "Working backwards to find option value";
                        canvas.innerHTML = createTreeVisualization(4, steps);
                        break;
                    default:
                        stepDisplay.textContent = "Animation complete! Tree shows all possible paths.";
                        return;
                }
                
                if (currentStep < totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }

        // Trinomial Tree Animation
        window.animateTrinomialTree = function() {
            const steps = parseInt(document.getElementById('trinomialSteps').value);
            const speed = parseInt(document.getElementById('trinomialSpeed').value);
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            // Update steps display
            document.getElementById('trinomialStepsDisplay').textContent = steps;
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">🔷 Building Trinomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 5; // More steps for trinomial explanation
            
            function nextStep() {
                switch (currentStep) {
                    case 0:
                        stepDisplay.textContent = 'Step 1: Initialize root node with current stock price';
                        canvas.innerHTML = createTrinomialVisualization(1, steps);
                        break;
                    case 1:
                        stepDisplay.textContent = 'Step 2: Calculate up, middle, and down factors (u, m=1, d)';
                        canvas.innerHTML = createTrinomialVisualization(2, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = 'Step 3: Calculate risk-neutral probabilities (p_u, p_m, p_d)';
                        canvas.innerHTML = createTrinomialVisualization(3, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = 'Step 4: Build complete tree forward to expiration';
                        canvas.innerHTML = createTrinomialVisualization(4, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = 'Step 5: Work backwards calculating option values using trinomial recombination';
                        canvas.innerHTML = createTrinomialVisualization(5, steps);
                        break;
                }
                
                currentStep++;
                if (currentStep <= totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }
        
        function createTrinomialVisualization(step, maxSteps) {
            const S0 = 100; // Current stock price
            const u = 1.22; // Up factor (higher than binomial)
            const d = 1/u; // Down factor
            const m = 1.0; // Middle factor (stays same)
            
            let html = '<div class="p-4">';
            html += '<div class="text-center mb-4"><h6 class="font-bold text-lg">Trinomial Tree Construction</h6></div>';
            
            if (step >= 1) {
                // Root node
                html += '<div class="flex justify-center mb-4">';
                html += `<div class="bg-blue-100 border-2 border-blue-500 rounded-lg p-2 text-center">`;
                html += `<div class="font-bold">S₀</div><div class="text-sm">$${S0}</div>`;
                html += '</div></div>';
                
                if (step >= 2) {
                    // First level (showing three branches)
                    html += '<div class="flex justify-center space-x-8 mb-4">';
                    
                    // Up node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-green-100 border-2 border-green-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Su</div><div class="text-sm">$${(S0 * u).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-green-700">×${u.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Middle node (unique to trinomial)
                    html += `<div class="text-center">`;
                    html += `<div class="bg-yellow-100 border-2 border-yellow-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sm</div><div class="text-sm">$${(S0 * m).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-yellow-700">×${m.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Down node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-red-100 border-2 border-red-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sd</div><div class="text-sm">$${(S0 * d).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-red-700">×${d.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    html += '</div>';
                    
                    if (step >= 3) {
                        // Add probability explanations
                        html += '<div class="bg-gray-50 rounded-lg p-3 mt-4 text-center">';
                        html += '<div class="text-sm font-semibold mb-2">Risk-Neutral Probabilities:</div>';
                        html += '<div class="grid grid-cols-3 gap-4 text-xs">';
                        html += '<div class="text-green-700"><strong>p_u = 0.25</strong><br>Up probability</div>';
                        html += '<div class="text-yellow-700"><strong>p_m = 0.50</strong><br>Middle probability</div>';
                        html += '<div class="text-red-700"><strong>p_d = 0.25</strong><br>Down probability</div>';
                        html += '</div>';
                        html += '<div class="text-xs text-gray-600 mt-2">p_u + p_m + p_d = 1.0 ✓</div>';
                        html += '</div>';
                        
                        if (step >= 4) {
                            // Show next level to demonstrate recombination
                            html += '<div class="mt-6">';
                            html += '<div class="text-center text-sm font-semibold mb-3">Next Time Step (Recombining Tree):</div>';
                            html += '<div class="flex justify-center space-x-4">';
                            
                            const prices = [
                                S0 * u * u,
                                S0 * u * m,
                                S0 * u * d, // Same as S0 * m * u (recombining!)
                                S0 * m * d,
                                S0 * d * d
                            ];
                            
                            prices.forEach((price, i) => {
                                let colorClass = '';
                                if (i === 0) {
                                    colorClass = 'bg-green-50 border-green-300';
                                } else if (i === prices.length - 1) {
                                    colorClass = 'bg-red-50 border-red-300';
                                } else {
                                    colorClass = 'bg-blue-50 border-blue-300';
                                }
                                html += '<div class="' + colorClass + ' border rounded p-1 text-xs text-center">';
                                html += '$' + price.toFixed(1);
                                html += '</div>';
                            });
                            
                            html += '</div>';
                            html += '<div class="text-xs text-center text-gray-600 mt-2">Notice: Su*d = Sm*u (recombining tree structure)</div>';
                            html += '</div>';
                            
                            if (step >= 5) {
                                // Show option valuation
                                html += '<div class="mt-4 bg-purple-50 rounded-lg p-3">';
                                html += '<div class="text-sm font-semibold text-purple-800 mb-2">🔄 Working Backwards:</div>';
                                html += '<div class="text-xs text-purple-700 space-y-1">';
                                html += '<div>1. Start at expiration: Option value = max(S-K, 0) for calls</div>';
                                html += '<div>2. At each earlier node: V = e^(-r×Δt) × (p_u×V_u + p_m×V_m + p_d×V_d)</div>';
                                html += '<div>3. Continue until reaching root node</div>';
                                html += '<div class="font-semibold text-green-700">Result: More accurate than binomial (3 branches vs 2)</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        }
                    }
                }
            }
            
            html += '</div>';
            return html;
        }
        
        window.resetTrinomialAnimation = function() {
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            canvas.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <div class="text-4xl mb-4">🔷</div>
                    <p>Click "Animate" to see trinomial tree construction</p>
                </div>
            `;
            stepDisplay.textContent = 'Ready to begin trinomial tree animation...';
        }
        
        function createTreeVisualization(step, totalSteps) {
            let html = '<div class="p-4">';
            
            if (step === 1) {
                html += `
                    <div class="flex justify-center">
                        <div class="bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center font-bold">
                            $100
                        </div>
                    </div>
                    <div class="text-center mt-2 text-sm text-gray-600">Current Stock Price</div>
                `;
            } else if (step === 2) {
                html += `
                    <div class="space-y-6">
                        ${Array.from({length: Math.min(totalSteps + 1, 4)}, (_, t) => `
                            <div class="flex justify-center items-center" style="gap: ${40 + t * 30}px;">
                                ${Array.from({length: t + 1}, (_, i) => {
                                    const price = 100 * Math.pow(1.05, t - i) * Math.pow(0.95, i);
                                    return `
                                        <div class="bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xs font-bold">
                                            $${price.toFixed(0)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (step === 3) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-yellow-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Risk-Neutral Probabilities</div>
                            <div class="text-xs mt-1">p = 0.52 (up), 1-p = 0.48 (down)</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="200" height="120" viewBox="0 0 200 120">
                                <line x1="100" y1="100" x2="50" y2="20" stroke="#10B981" stroke-width="3"/>
                                <line x1="100" y1="100" x2="150" y2="20" stroke="#EF4444" stroke-width="3"/>
                                <circle cx="100" cy="100" r="15" fill="#3B82F6"/>
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="150" cy="20" r="12" fill="#EF4444"/>
                                <text x="100" y="105" text-anchor="middle" font-size="10" fill="white">$100</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$105</text>
                                <text x="150" y="25" text-anchor="middle" font-size="8" fill="white">$95</text>
                                <text x="75" y="65" font-size="8" fill="#10B981">52%</text>
                                <text x="125" y="65" font-size="8" fill="#EF4444">48%</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else if (step === 4) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Backward Induction</div>
                            <div class="text-xs mt-1">Start from expiry, work backwards</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="250" height="150" viewBox="0 0 250 150">
                                <!-- Final nodes -->
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="125" cy="75" r="12" fill="#F59E0B"/>
                                <circle cx="200" cy="130" r="12" fill="#EF4444"/>
                                <!-- Intermediate nodes -->
                                <circle cx="90" cy="47" r="10" fill="#8B5CF6"/>
                                <circle cx="160" cy="102" r="10" fill="#8B5CF6"/>
                                <!-- Root node -->
                                <circle cx="125" cy="75" r="15" fill="#3B82F6"/>
                                <!-- Lines -->
                                <line x1="125" y1="75" x2="90" y2="47" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="125" y1="75" x2="160" y2="102" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="90" y1="47" x2="50" y2="20" stroke="#10B981" stroke-width="2"/>
                                <line x1="90" y1="47" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="200" y2="130" stroke="#EF4444" stroke-width="2"/>
                                <!-- Values -->
                                <text x="125" y="80" text-anchor="middle" font-size="10" fill="white">$6.15</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$10.5</text>
                                <text x="200" y="135" text-anchor="middle" font-size="8" fill="white">$0</text>
                                <text x="90" y="52" text-anchor="middle" font-size="8" fill="white">$8.2</text>
                                <text x="160" y="107" text-anchor="middle" font-size="8" fill="white">$2.4</text>
                            </svg>
                        </div>
                    </div>
                    <div class="text-center mt-4 text-sm text-green-600 font-semibold">
                        Option Value: $6.15
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Monte Carlo Animation
        window.animateMonteCarlo = function() {
            const totalPaths = parseInt(document.getElementById('mcPaths').value);
            const showPaths = parseInt(document.getElementById('mcShowPaths').value);
            const canvas = document.getElementById('mcCanvas');
            
            let pathsCompleted = 0;
            let runningTotal = 0;
            let runningSquareTotal = 0;
            
            canvas.innerHTML = `
                <div class="h-full">
                    <div class="text-center mb-4 font-semibold">Simulating ${totalPaths.toLocaleString()} Price Paths</div>
                    <div class="relative h-64 bg-white rounded border">
                        <canvas id="mcPathCanvas" width="400" height="200" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 bg-blue-100 rounded-full h-2">
                        <div id="mcProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            const pathCanvas = document.getElementById('mcPathCanvas');
            const ctx = pathCanvas.getContext('2d');
            
            // Setup canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 200);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 180);
            ctx.lineTo(380, 180);
            ctx.moveTo(40, 20);
            ctx.lineTo(40, 180);
            ctx.stroke();
            
            let pathsDrawn = 0;
            const batchSize = Math.ceil(totalPaths / 100); // Update in batches
            
            function simulateBatch() {
                for (let i = 0; i < Math.min(batchSize, totalPaths - pathsCompleted); i++) {
                    const optionValue = simulatePath();
                    runningTotal += optionValue;
                    runningSquareTotal += optionValue * optionValue;
                    pathsCompleted++;
                    
                    // Draw some paths for visualization
                    if (pathsDrawn < showPaths && pathsCompleted % Math.floor(totalPaths / showPaths) === 0) {
                        drawRandomPath(ctx, pathsDrawn);
                        pathsDrawn++;
                    }
                }
                
                // Update statistics
                updateMonteCarloStats(pathsCompleted, totalPaths, runningTotal, runningSquareTotal);
                
                if (pathsCompleted < totalPaths) {
                    setTimeout(simulateBatch, 10);
                } else {
                    document.getElementById('mcProgressBar').style.width = '100%';
                }
            }
            
            simulateBatch();
        }
        
        function simulatePath() {
            // Simple Monte Carlo option pricing
            const S0 = 100, K = 105, T = 30/365, r = 0.04, sigma = 0.25;
            const dt = T / 30;
            let S = S0;
            
            // Generate random path
            for (let i = 0; i < 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * Z);
            }
            
            // Option payoff (call option)
            return Math.max(S - K, 0) * Math.exp(-r * T);
        }
        
        function drawRandomPath(ctx, pathIndex) {
            const S0 = 100;
            const colors = ['rgba(59, 130, 246, 0.4)', 'rgba(16, 185, 129, 0.4)', 'rgba(239, 68, 68, 0.4)'];
            
            ctx.strokeStyle = colors[pathIndex % colors.length];
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            let S = S0;
            let prevX = 40;
            let prevY = 180 - (S - 80) * 2; // Scale to canvas
            
            ctx.moveTo(prevX, prevY);
            
            for (let i = 1; i <= 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((0.04 - 0.5 * 0.25 * 0.25) * (30/365/30) + 0.25 * Math.sqrt(30/365/30) * Z);
                
                const x = 40 + (i / 30) * 340;
                const y = Math.max(20, Math.min(180, 180 - (S - 80) * 2));
                
                ctx.lineTo(x, y);
                prevX = x;
                prevY = y;
            }
            
            ctx.stroke();
        }
        
        // normalRandom function moved to avoid duplication - see line 4326
        
        function updateMonteCarloStats(completed, total, runningTotal, runningSquareTotal) {
            const currentPrice = runningTotal / completed;
            const variance = (runningSquareTotal / completed) - (currentPrice * currentPrice);
            const standardError = Math.sqrt(variance / completed);
            
            document.getElementById('mcPathsCompleted').textContent = completed.toLocaleString();
            document.getElementById('mcCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
            document.getElementById('mcStandardError').textContent = '±$' + (1.96 * standardError).toFixed(2);
            
            const progress = (completed / total) * 100;
            document.getElementById('mcProgressBar').style.width = progress + '%';
        }
        
        // Black-Scholes Animation
        window.animateBlackScholes = function() {
            const steps = ['bsStep1', 'bsStep2', 'bsStep3', 'bsStep4'];
            const calculation = document.getElementById('bsLiveCalc');
            
            // Reset opacity
            steps.forEach(step => {
                document.getElementById(step).style.opacity = '0.3';
            });
            
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).style.opacity = '1';
                    
                    switch(currentStep) {
                        case 0:
                            calculation.innerHTML = `
                                <div>Breaking down the Black-Scholes formula...</div>
                                <div class="mt-2 text-purple-600">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                            `;
                            break;
                        case 1:
                            calculation.innerHTML = `
                                <div>d₁ = [ln(100/105) + (0.04 + 0.25²/2)×0.082] / (0.25×√0.082)</div>
                                <div>d₁ = [-0.0488 + 0.0059] / 0.0717 = -0.598</div>
                            `;
                            break;
                        case 2:
                            calculation.innerHTML = `
                                <div>d₂ = d₁ - σ√T = -0.598 - 0.25×√0.082</div>
                                <div>d₂ = -0.598 - 0.0717 = -0.670</div>
                            `;
                            break;
                        case 3:
                            calculation.innerHTML = `
                                <div>N(d₁) = N(-0.598) = 0.275</div>
                                <div>N(d₂) = N(-0.670) = 0.251</div>
                                <div class="mt-2 text-green-600 font-bold">C = 100×0.275 - 105×e^(-0.04×0.082)×0.251 = $1.31</div>
                            `;
                            break;
                    }
                    
                    currentStep++;
                    setTimeout(nextStep, 2000);
                }
            }
            
            nextStep();
        }

        // ============================================================================
        // JUMP DIFFUSION ANIMATION IMPLEMENTATION
        // ============================================================================

        let jumpPaths = [];
        let jumpStats = { jumps: 0, totalJumpSize: 0 };

        window.animateJumpDiffusion = function() {
            const intensity = parseFloat(document.getElementById('jumpIntensity').value);
            const jumpMean = parseFloat(document.getElementById('jumpMean').value);
            const jumpVol = parseFloat(document.getElementById('jumpVol').value);
            const steps = parseInt(document.getElementById('jumpSteps').value);
            
            // Reset statistics
            jumpStats = { jumps: 0, totalJumpSize: 0 };
            jumpPaths = [];
            
            // Get current option parameters
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 100;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 105;
            const timeToExpiry = parseFloat(document.getElementById('daysToExpiry').value) || 30;
            const riskFreeRate = parseFloat(document.getElementById('riskFreeRate').value) || 4;
            const volatility = parseFloat(document.getElementById('volatility').value) || 25;
            
            // Convert to decimal
            const r = riskFreeRate / 100;
            const sigma = volatility / 100;
            const T = timeToExpiry / 365;
            
            // Generate 5 sample paths for visualization
            const numPaths = 5;
            const dt = T / steps;
            
            for (let path = 0; path < numPaths; path++) {
                const prices = [stockPrice];
                let currentPrice = stockPrice;
                let pathJumps = 0;
                let pathJumpSize = 0;
                
                for (let i = 1; i <= steps; i++) {
                    // Standard Brownian motion component
                    const dW = Math.sqrt(dt) * normalRandom();
                    
                    // Check for jump (Poisson process)
                    const jumpProbability = intensity * dt;
                    const hasJump = Math.random() < jumpProbability;
                    
                    let jumpComponent = 0;
                    if (hasJump) {
                        // Generate jump size (log-normal)
                        const jumpSize = jumpMean + jumpVol * normalRandom();
                        jumpComponent = Math.exp(jumpSize) - 1;
                        pathJumps++;
                        pathJumpSize += jumpComponent;
                        jumpStats.jumps++;
                        jumpStats.totalJumpSize += jumpComponent;
                    }
                    
                    // Jump-diffusion price evolution
                    const drift = (r - intensity * (Math.exp(jumpMean + 0.5 * jumpVol * jumpVol) - 1)) * dt;
                    const diffusion = sigma * dW;
                    const jump = jumpComponent;
                    
                    currentPrice = currentPrice * Math.exp(drift + diffusion + Math.log(1 + jump));
                    prices.push(currentPrice);
                }
                
                jumpPaths.push({
                    prices: prices,
                    jumps: pathJumps,
                    avgJumpSize: pathJumps > 0 ? pathJumpSize / pathJumps : 0
                });
            }
            
            // Update statistics display
            updateJumpStatistics(intensity, T);
            
            // Calculate and display model prices
            updateJumpPricing(stockPrice, strikePrice, T, r, sigma, intensity, jumpMean, jumpVol);
            
            // Render the visualization
            renderJumpVisualization(steps, T);
        }
        
        function updateJumpStatistics(intensity, T) {
            document.getElementById('expectedJumps').textContent = (intensity * T).toFixed(1);
            document.getElementById('observedJumps').textContent = jumpStats.jumps;
            
            const avgJump = jumpStats.jumps > 0 ? (jumpStats.totalJumpSize / jumpStats.jumps * 100).toFixed(1) : '0';
            document.getElementById('avgJumpSize').textContent = avgJump + '%';
            
            // Calculate price range
            let minPrice = Infinity, maxPrice = -Infinity;
            jumpPaths.forEach(path => {
                path.prices.forEach(price => {
                    minPrice = Math.min(minPrice, price);
                    maxPrice = Math.max(maxPrice, price);
                });
            });
            
            if (jumpPaths.length > 0) {
                document.getElementById('priceRange').textContent = 
                    '$' + minPrice.toFixed(0) + ' - $' + maxPrice.toFixed(0);
            }
        }
        
        function updateJumpPricing(S, K, T, r, sigma, lambda, mu, sigmaJ) {
            // Calculate Black-Scholes price (for comparison)
            const bsPrice = calculateBlackScholesPrice(S, K, T, r, sigma);
            
            // Approximate Jump-Diffusion price using Merton's formula
            // This is a simplified implementation for educational purposes
            const jumpDiffusionPrice = calculateJumpDiffusionPrice(S, K, T, r, sigma, lambda, mu, sigmaJ);
            
            document.getElementById('bsJumpPrice').textContent = '$' + bsPrice.toFixed(2);
            document.getElementById('jdJumpPrice').textContent = '$' + jumpDiffusionPrice.toFixed(2);
            document.getElementById('jumpPremium').textContent = '$' + (jumpDiffusionPrice - bsPrice).toFixed(2);
        }
        
        // calculateJumpDiffusionPrice function moved to avoid duplication - see line 6398 for full implementation
        
        function renderJumpVisualization(steps, T) {
            const canvas = document.getElementById('jumpCanvas');
            const ctx = document.createElement('canvas');
            ctx.width = canvas.clientWidth - 20;
            ctx.height = canvas.clientHeight - 20;
            ctx.style.width = '100%';
            ctx.style.height = '100%';
            
            // Clear canvas and add the new one
            canvas.innerHTML = '';
            canvas.appendChild(ctx);
            
            const context = ctx.getContext('2d');
            const width = ctx.width;
            const height = ctx.height;
            
            // Set up axes
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // Find price bounds
            let minPrice = Infinity, maxPrice = -Infinity;
            jumpPaths.forEach(path => {
                path.prices.forEach(price => {
                    minPrice = Math.min(minPrice, price);
                    maxPrice = Math.max(maxPrice, price);
                });
            });
            
            const priceRange = maxPrice - minPrice;
            minPrice -= priceRange * 0.1;
            maxPrice += priceRange * 0.1;
            
            // Clear background
            context.fillStyle = '#f9fafb';
            context.fillRect(0, 0, width, height);
            
            // Draw grid
            context.strokeStyle = '#e5e7eb';
            context.lineWidth = 1;
            
            // Vertical grid lines (time)
            for (let i = 0; i <= 10; i++) {
                const x = padding + (i / 10) * chartWidth;
                context.beginPath();
                context.moveTo(x, padding);
                context.lineTo(x, height - padding);
                context.stroke();
            }
            
            // Horizontal grid lines (price)
            for (let i = 0; i <= 10; i++) {
                const y = padding + (i / 10) * chartHeight;
                context.beginPath();
                context.moveTo(padding, y);
                context.lineTo(width - padding, y);
                context.stroke();
            }
            
            // Draw axes
            context.strokeStyle = '#374151';
            context.lineWidth = 2;
            context.beginPath();
            context.moveTo(padding, height - padding);
            context.lineTo(width - padding, height - padding);
            context.moveTo(padding, padding);
            context.lineTo(padding, height - padding);
            context.stroke();
            
            // Draw price paths
            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            
            jumpPaths.forEach((path, pathIndex) => {
                context.strokeStyle = colors[pathIndex % colors.length];
                context.lineWidth = 2;
                context.beginPath();
                
                path.prices.forEach((price, i) => {
                    const x = padding + (i / (steps)) * chartWidth;
                    const y = height - padding - ((price - minPrice) / (maxPrice - minPrice)) * chartHeight;
                    
                    if (i === 0) {
                        context.moveTo(x, y);
                    } else {
                        context.lineTo(x, y);
                    }
                });
                
                context.stroke();
            });
            
            // Add labels
            context.fillStyle = '#374151';
            context.font = '12px Arial';
            context.textAlign = 'center';
            context.fillText('Time', width / 2, height - 10);
            
            context.save();
            context.translate(15, height / 2);
            context.rotate(-Math.PI / 2);
            context.fillText('Stock Price ($)', 0, 0);
            context.restore();
            
            // Price axis labels
            context.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const price = minPrice + (i / 5) * (maxPrice - minPrice);
                const y = height - padding - (i / 5) * chartHeight;
                context.fillText('$' + price.toFixed(0), padding - 5, y + 3);
            }
        }
        
        // normalRandom function available globally - defined at top of script

        // ============================================================================
        // INTERACTIVE TUTORIALS IMPLEMENTATION
        // ============================================================================

        let currentTutorialStep = 0;
        let currentTutorial = 'greeks';
        
        // Tutorial content data
        const tutorialContent = {
            greeks: {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: What are the Greeks?",
                        content: `
                            <p class="text-purple-700">The "Greeks" are risk sensitivities that measure how an option's price changes with respect to various factors. They're called Greeks because most are represented by Greek letters (Δ, Γ, Θ, ν, ρ).</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Think of Greeks as:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Delta (Δ):</strong> Speed - how fast price moves with stock</li>
                                    <li>• <strong>Gamma (Γ):</strong> Acceleration - how speed changes</li>
                                    <li>• <strong>Theta (Θ):</strong> Time decay - daily price erosion</li>
                                    <li>• <strong>Vega (ν):</strong> Volatility sensitivity</li>
                                    <li>• <strong>Rho (ρ):</strong> Interest rate sensitivity</li>
                                </ul>
                            </div>
                        `,
                        insight: "Move the stock price slider and watch how Delta changes the option value. Delta tells you how much the option price moves for each $1 stock price change!",
                        focusGreek: "delta"
                    },
                    {
                        title: "Step 2: Delta - The Price Speedometer",
                        content: `
                            <p class="text-purple-700">Delta measures how much an option's price changes when the underlying stock price moves by $1. It ranges from 0 to 1 for calls, and 0 to -1 for puts.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Delta Examples:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Call with Δ = 0.60:</strong> Price rises $0.60 per $1 stock increase</li>
                                    <li>• <strong>Put with Δ = -0.40:</strong> Price falls $0.40 per $1 stock increase</li>
                                    <li>• <strong>At-the-money:</strong> Delta ≈ 0.50 (50% probability of expiring ITM)</li>
                                    <li>• <strong>Deep ITM:</strong> Delta approaches 1.0 (almost certain to expire ITM)</li>
                                </ul>
                            </div>
                        `,
                        insight: "Watch how Delta changes as you move the stock price! Notice it's highest when the option is at-the-money (stock price = strike price).",
                        focusGreek: "delta"
                    },
                    {
                        title: "Step 3: Gamma - The Acceleration Factor",
                        content: `
                            <p class="text-purple-700">Gamma measures how much Delta changes when the stock price moves by $1. Think of it as the "acceleration" of your option's price sensitivity.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Why Gamma Matters:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>High Gamma:</strong> Delta changes quickly = more risk/reward</li>
                                    <li>• <strong>ATM options:</strong> Highest gamma (most acceleration)</li>
                                    <li>• <strong>Short-term options:</strong> Gamma spikes near expiration</li>
                                    <li>• <strong>Risk management:</strong> High gamma = position can change fast</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust the days to expiry! Notice how gamma gets larger as expiration approaches - this is why short-term options are so sensitive!",
                        focusGreek: "gamma"
                    },
                    {
                        title: "Step 4: Theta - The Time Thief",
                        content: `
                            <p class="text-purple-700">Theta measures how much an option loses value each day due to time decay. It's always negative for long positions because time works against you.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Time Decay Reality:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Theta = -0.15:</strong> Option loses $15 per day per contract</li>
                                    <li>• <strong>ATM options:</strong> Highest theta (most time decay)</li>
                                    <li>• <strong>Weekends count:</strong> Monday options show 3 days of decay</li>
                                    <li>• <strong>Final weeks:</strong> Theta accelerates dramatically</li>
                                </ul>
                            </div>
                        `,
                        insight: "Reduce the days to expiry and watch Theta become more negative! Time decay accelerates as expiration approaches - this is the option seller's friend!",
                        focusGreek: "theta"
                    },
                    {
                        title: "Step 5: Vega - The Volatility Amplifier",
                        content: `
                            <p class="text-purple-700">Vega measures how much an option's price changes when volatility increases by 1%. Higher volatility means higher option prices because there's more chance of big moves.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Volatility Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Vega = 0.20:</strong> Price rises $20 per 1% volatility increase</li>
                                    <li>• <strong>ATM options:</strong> Highest vega (most vol sensitivity)</li>
                                    <li>• <strong>Earnings/events:</strong> Vol often spikes before, crashes after</li>
                                    <li>• <strong>Long options:</strong> Want high vol, short options want low vol</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust the volatility slider and see how dramatically option prices change! This is why options are expensive before earnings announcements!",
                        focusGreek: "vega"
                    }
                ]
            },
            'options-basics': {
                totalSteps: 6,
                steps: [
                    {
                        title: "Step 1: What is an Option?",
                        content: `
                            <p class="text-pink-700">An option is a contract that gives you the RIGHT (not obligation) to buy or sell a stock at a specific price by a certain date. Think of it like a reservation at a restaurant - you have the right to use it, but you don't have to.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Key Components:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Strike Price:</strong> The price at which you can buy/sell</li>
                                    <li>• <strong>Expiration Date:</strong> When the option expires</li>
                                    <li>• <strong>Premium:</strong> The cost to buy the option</li>
                                    <li>• <strong>Underlying Asset:</strong> The stock the option is based on</li>
                                </ul>
                            </div>
                        `,
                        insight: "Options give you leverage and limited risk. You can control 100 shares for much less money than buying the stock outright!",
                        demo: {
                            type: "basic_example",
                            content: `
                                <div class="bg-blue-100 p-3 rounded">
                                    <div class="text-sm font-medium text-blue-800">Example: AAPL Call Option</div>
                                    <div class="text-xs text-blue-600 mt-1">
                                        <div>Current AAPL Price: $150</div>
                                        <div>Strike Price: $155</div>
                                        <div>Expires: 30 days</div>
                                        <div>Premium: $3.50</div>
                                    </div>
                                </div>
                                <div class="text-sm mt-2">
                                    <strong>What this means:</strong> You pay $350 ($3.50 × 100 shares) for the right to buy 100 AAPL shares at $155 each, anytime in the next 30 days.
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 2: Calls vs Puts",
                        content: `
                            <p class="text-pink-700">There are two types of options: Calls and Puts. Think of them as betting on whether a stock will go up or down.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Call Options:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Right to BUY</strong> at strike price</li>
                                    <li>• <strong>Bullish:</strong> You think stock will go UP</li>
                                    <li>• <strong>Profit when:</strong> Stock price > Strike + Premium</li>
                                    <li>• <strong>Max Loss:</strong> Premium paid</li>
                                </ul>
                                <strong class="block mt-3">Put Options:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Right to SELL</strong> at strike price</li>
                                    <li>• <strong>Bearish:</strong> You think stock will go DOWN</li>
                                    <li>• <strong>Profit when:</strong> Stock price < Strike - Premium</li>
                                    <li>• <strong>Max Loss:</strong> Premium paid</li>
                                </ul>
                            </div>
                        `,
                        insight: "Calls profit from UP moves, Puts profit from DOWN moves. Your maximum loss is always limited to the premium you paid!",
                        demo: {
                            type: "call_put_comparison",
                            content: `
                                <div class="space-y-2">
                                    <div class="bg-green-100 p-2 rounded text-xs">
                                        <strong class="text-green-800">CALL EXAMPLE</strong><br>
                                        AAPL $155 Call @ $3.50<br>
                                        If AAPL → $160: Profit = $160-$155-$3.50 = $1.50/share
                                    </div>
                                    <div class="bg-red-100 p-2 rounded text-xs">
                                        <strong class="text-red-800">PUT EXAMPLE</strong><br>
                                        AAPL $145 Put @ $2.25<br>
                                        If AAPL → $140: Profit = $145-$140-$2.25 = $2.75/share
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 3: In-the-Money vs Out-of-the-Money",
                        content: `
                            <p class="text-pink-700">Options are classified based on their relationship to the current stock price. This determines their intrinsic value.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>For CALLS (Stock = $150):</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>ITM:</strong> Strike < $150 (e.g., $145 call) - Has intrinsic value</li>
                                    <li>• <strong>ATM:</strong> Strike = $150 (e.g., $150 call) - At the money</li>
                                    <li>• <strong>OTM:</strong> Strike > $150 (e.g., $155 call) - Only time value</li>
                                </ul>
                                <strong class="block mt-3">For PUTS (Stock = $150):</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>ITM:</strong> Strike > $150 (e.g., $155 put) - Has intrinsic value</li>
                                    <li>• <strong>ATM:</strong> Strike = $150 (e.g., $150 put) - At the money</li>
                                    <li>• <strong>OTM:</strong> Strike < $150 (e.g., $145 put) - Only time value</li>
                                </ul>
                            </div>
                        `,
                        insight: "ITM options are more expensive but safer. OTM options are cheaper but require bigger stock moves to be profitable!",
                        demo: {
                            type: "moneyness_table",
                            content: `
                                <div class="text-xs">
                                    <div class="grid grid-cols-3 gap-1 mb-2 font-bold text-center">
                                        <div class="bg-red-200 p-1 rounded">OTM</div>
                                        <div class="bg-yellow-200 p-1 rounded">ATM</div>
                                        <div class="bg-green-200 p-1 rounded">ITM</div>
                                    </div>
                                    <div class="text-center text-gray-600 text-xs mb-1">AAPL @ $150</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs">
                                            <span>$160 Call:</span><span class="text-red-600">OTM - $0.50</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span>$150 Call:</span><span class="text-yellow-600">ATM - $3.50</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span>$140 Call:</span><span class="text-green-600">ITM - $12.00</span>
                                        </div>
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 4: Time Decay - Your Enemy or Friend?",
                        content: `
                            <p class="text-pink-700">Time decay (Theta) is the enemy of option buyers and the friend of option sellers. Every day that passes, options lose value due to approaching expiration.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Time Decay Facts:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Accelerates:</strong> Decay speeds up in final 30 days</li>
                                    <li>• <strong>ATM highest:</strong> At-the-money options lose most time value</li>
                                    <li>• <strong>Weekends count:</strong> 3 days of decay hit on Monday</li>
                                    <li>• <strong>Never stops:</strong> Decay happens even when markets are closed</li>
                                </ul>
                                <strong class="block mt-3">Strategy Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Buying options:</strong> Time decay works against you</li>
                                    <li>• <strong>Selling options:</strong> Time decay works for you</li>
                                </ul>
                            </div>
                        `,
                        insight: "Time decay is why many option buyers lose money even when they're right about direction. Factor in time decay to your predictions!",
                        demo: {
                            type: "time_decay_chart",
                            content: `
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-center mb-2 font-bold">Option Value Over Time</div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between"><span>90 days:</span><span>$5.50</span></div>
                                        <div class="flex justify-between"><span>60 days:</span><span>$4.20</span></div>
                                        <div class="flex justify-between"><span>30 days:</span><span>$2.80</span></div>
                                        <div class="flex justify-between"><span>7 days:</span><span>$1.10</span></div>
                                        <div class="flex justify-between"><span>1 day:</span><span>$0.15</span></div>
                                    </div>
                                    <div class="text-xs text-red-600 text-center mt-2">
                                        Stock stayed at $150, but option lost 97% of value!
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 5: Volatility - The Option's Best Friend",
                        content: `
                            <p class="text-pink-700">Volatility is the amount a stock price moves up and down. Higher volatility = higher option prices, because there's more chance of big profitable moves.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Volatility Types:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Historical Vol:</strong> How much stock moved in the past</li>
                                    <li>• <strong>Implied Vol:</strong> What market expects future movement to be</li>
                                    <li>• <strong>Vol Crush:</strong> IV drops after earnings/events</li>
                                </ul>
                                <strong class="block mt-3">Trading Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Before earnings:</strong> IV spikes, options get expensive</li>
                                    <li>• <strong>After earnings:</strong> IV crashes, options lose value fast</li>
                                    <li>• <strong>Buy low IV:</strong> When market is calm</li>
                                    <li>• <strong>Sell high IV:</strong> When market expects big moves</li>
                                </ul>
                            </div>
                        `,
                        insight: "You can be right about direction but still lose money if volatility drops! Always check IV before buying options.",
                        demo: {
                            type: "volatility_impact",
                            content: `
                                <div class="space-y-2 text-xs">
                                    <div class="bg-blue-100 p-2 rounded">
                                        <strong>Low Volatility (15%)</strong><br>
                                        AAPL $155 Call: $1.20<br>
                                        Market expects small moves
                                    </div>
                                    <div class="bg-orange-100 p-2 rounded">
                                        <strong>High Volatility (45%)</strong><br>
                                        AAPL $155 Call: $6.80<br>
                                        Market expects big moves (earnings week)
                                    </div>
                                    <div class="text-center text-gray-600">
                                        Same option, 467% price difference!
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 6: Common Beginner Mistakes",
                        content: `
                            <p class="text-pink-700">Learn from others' mistakes! Here are the most common pitfalls that trap new options traders.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Top 5 Beginner Mistakes:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Buying OTM weeklies:</strong> Low probability, high decay</li>
                                    <li>• <strong>Ignoring time decay:</strong> Not factoring in daily losses</li>
                                    <li>• <strong>Chasing lottery tickets:</strong> Deep OTM "cheap" options</li>
                                    <li>• <strong>Not taking profits:</strong> Holding winning trades too long</li>
                                    <li>• <strong>Buying high IV:</strong> Overpaying right before vol crush</li>
                                </ul>
                                <strong class="block mt-3">Smart Strategies:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Start with ATM/ITM:</strong> Higher probability trades</li>
                                    <li>• <strong>Give yourself time:</strong> 45+ days to expiration</li>
                                    <li>• <strong>Take profits at 25-50%:</strong> Don't be greedy</li>
                                    <li>• <strong>Paper trade first:</strong> Practice without real money</li>
                                </ul>
                            </div>
                        `,
                        insight: "Most option buyers lose money not because they're wrong about direction, but because they ignore time decay and volatility!",
                        demo: {
                            type: "mistake_examples",
                            content: `
                                <div class="space-y-2 text-xs">
                                    <div class="bg-red-100 p-2 rounded border-l-4 border-red-400">
                                        <strong class="text-red-800">❌ Bad Trade</strong><br>
                                        Buy $180 AAPL calls expiring Friday<br>
                                        Stock at $150, needs 20% gain in 3 days
                                    </div>
                                    <div class="bg-green-100 p-2 rounded border-l-4 border-green-400">
                                        <strong class="text-green-800">✅ Better Trade</strong><br>
                                        Buy $155 AAPL calls expiring in 60 days<br>
                                        Stock at $150, needs 3.3% gain with time
                                    </div>
                                </div>
                            `
                        }
                    }
                ]
            },
            'pricing-models': {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: Why Multiple Pricing Models?",
                        content: `
                            <p class="text-indigo-700">Different pricing models make different assumptions and trade off accuracy for speed. Understanding when to use each model is crucial for effective options trading.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>The Five Models:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Black-Scholes:</strong> Fast analytical formula (European options)</li>
                                    <li>• <strong>Binomial:</strong> Industry standard tree model</li>
                                    <li>• <strong>Trinomial:</strong> More accurate tree model (recommended)</li>
                                    <li>• <strong>Monte Carlo:</strong> Statistical simulation with confidence intervals</li>
                                    <li>• <strong>Jump Diffusion:</strong> Handles market crashes and sudden moves</li>
                                </ul>
                                <div class="mt-3 bg-blue-50 p-2 rounded text-xs">
                                    <strong>Validation:</strong> All models tested against 671,360 real market options from June 2024
                                </div>
                            </div>
                        `,
                        insight: "Notice how different models give slightly different prices. The trinomial model is generally the most accurate, while Black-Scholes is the fastest but assumes no early exercise."
                    },
                    {
                        title: "Step 2: Black-Scholes - The Speed Demon",
                        content: `
                            <p class="text-indigo-700">Black-Scholes uses a mathematical formula to instantly calculate option prices. It's blazingly fast but makes strict assumptions about market behavior.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Key Assumptions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Constant volatility:</strong> Vol stays the same until expiration</li>
                                    <li>• <strong>No early exercise:</strong> European-style options only</li>
                                    <li>• <strong>No dividends:</strong> (or constant dividend yield)</li>
                                    <li>• <strong>Constant risk-free rate:</strong> Interest rates don't change</li>
                                    <li>• <strong>Log-normal distribution:</strong> Stock prices follow smooth curves</li>
                                </ul>
                                <strong class="block mt-3">Best For:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• Quick estimates and screening</li>
                                    <li>• European options (index options)</li>
                                    <li>• When speed matters more than precision</li>
                                </ul>
                            </div>
                        `,
                        insight: "Change parameters quickly and see how Black-Scholes responds instantly! Perfect for real-time trading systems, but less accurate for American options."
                    },
                    {
                        title: "Step 3: Binomial Trees - The Industry Standard",
                        content: `
                            <p class="text-indigo-700">The binomial model builds a tree of possible stock price paths, calculating option values at each node. It handles American early exercise and is widely used by professionals.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>How It Works:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Price tree:</strong> Stock can go up or down each period</li>
                                    <li>• <strong>Risk-neutral probabilities:</strong> Mathematical, not real probabilities</li>
                                    <li>• <strong>Backward induction:</strong> Works from expiration back to today</li>
                                    <li>• <strong>Early exercise:</strong> Checks American exercise at each node</li>
                                </ul>
                                <strong class="block mt-3">Accuracy:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• 50 steps: Good for most trading (±$0.01 typical error)</li>
                                    <li>• 100+ steps: High precision (±$0.003 typical error)</li>
                                    <li>• More steps = better accuracy but slower computation</li>
                                </ul>
                            </div>
                        `,
                        insight: "Try changing days to expiry and see how the models diverge more for American options with dividends - this shows the early exercise premium!"
                    },
                    {
                        title: "Step 4: Trinomial Trees - The Accuracy Champion",
                        content: `
                            <p class="text-indigo-700">Trinomial models use three possible moves (up, down, stay same) at each step instead of two. This provides 16.4% better accuracy than binomial models according to our market validation.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Advantages:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Better convergence:</strong> More stable as steps increase</li>
                                    <li>• <strong>Smoother Greeks:</strong> Less numerical noise in sensitivities</li>
                                    <li>• <strong>Flexible calibration:</strong> Matches market volatility better</li>
                                    <li>• <strong>Professional standard:</strong> Used by most banks and hedge funds</li>
                                </ul>
                                <strong class="block mt-3">Validation Results:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• 16.4% more accurate than binomial baseline</li>
                                    <li>• 4.8% average implied volatility difference vs market</li>
                                    <li>• 87% of options within 5% IV difference</li>
                                </ul>
                                <div class="bg-green-50 p-2 rounded text-xs mt-3">
                                    <strong>💡 Recommendation:</strong> Use trinomial for production trading systems
                                </div>
                            </div>
                        `,
                        insight: "Watch how trinomial prices stay closest to market consensus! The extra accuracy is especially valuable for complex strategies and risk management."
                    },
                    {
                        title: "Step 5: Monte Carlo & Jump Diffusion - Advanced Realism",
                        content: `
                            <p class="text-indigo-700">Monte Carlo simulates thousands of random price paths, while Jump Diffusion adds sudden market crashes. These models capture real market complexity that simple models miss.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Monte Carlo Benefits:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Statistical confidence:</strong> Provides error bounds (±$0.05)</li>
                                    <li>• <strong>Complex payoffs:</strong> Handles path-dependent options</li>
                                    <li>• <strong>Flexible modeling:</strong> Any volatility/rate process</li>
                                </ul>
                                <strong class="block mt-3">Jump Diffusion Realism:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Market crashes:</strong> Captures COVID-19, 2008 financial crisis style drops</li>
                                    <li>• <strong>Earnings gaps:</strong> Models sudden 10%+ moves</li>
                                    <li>• <strong>Fat tails:</strong> More realistic than normal distribution</li>
                                    <li>• <strong>Risk premiums:</strong> Higher prices reflect crash risk</li>
                                </ul>
                                <div class="bg-orange-50 p-2 rounded text-xs mt-3">
                                    <strong>📊 Usage:</strong> Jump diffusion prices typically 2-8% higher during volatile periods
                                </div>
                            </div>
                        `,
                        insight: "Compare normal models vs jump diffusion - notice how crash risk increases option values, especially for protective puts and portfolio insurance!"
                    }
                ]
            },
            'risk-management': {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: The Foundation of Options Risk",
                        content: `
                            <p class="text-emerald-700">Successful options trading starts with understanding and managing risk. Unlike stock trading, options have multiple risk dimensions that must be monitored continuously.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Options Risk Dimensions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Directional Risk (Delta):</strong> Stock price movement</li>
                                    <li>• <strong>Time Decay Risk (Theta):</strong> Value loss over time</li>
                                    <li>• <strong>Volatility Risk (Vega):</strong> Changes in implied volatility</li>
                                    <li>• <strong>Acceleration Risk (Gamma):</strong> How quickly delta changes</li>
                                    <li>• <strong>Interest Rate Risk (Rho):</strong> Rate changes (usually minor)</li>
                                </ul>
                                <div class="mt-3 bg-red-50 p-2 rounded text-xs">
                                    <strong>⚠️ Key Insight:</strong> You can be right about direction but still lose money due to time decay or volatility crush!
                                </div>
                            </div>
                        `,
                        insight: "Risk management starts with position sizing. Never risk more than 1-2% of your portfolio on a single trade, regardless of how confident you feel!"
                    },
                    {
                        title: "Step 2: Position Sizing - Your Safety Net",
                        content: `
                            <p class="text-emerald-700">Position sizing is the most critical risk management tool. It determines how much you can lose on any single trade and protects you from catastrophic losses.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Position Sizing Rules:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>1-2% Rule:</strong> Risk only 1-2% of portfolio per trade</li>
                                    <li>• <strong>Kelly Criterion:</strong> Mathematical optimal bet sizing</li>
                                    <li>• <strong>Fixed Dollar Amount:</strong> Same $ risk per trade</li>
                                    <li>• <strong>Volatility Adjusted:</strong> Smaller size for high-vol stocks</li>
                                </ul>
                                <strong class="block mt-3">Example Calculation:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• Portfolio: $10,000</li>
                                    <li>• Risk per trade: 2% = $200</li>
                                    <li>• Option cost: $3.00</li>
                                    <li>• Stop loss: 50% = $1.50 risk per share</li>
                                    <li>• <strong>Position size:</strong> $200 ÷ $1.50 = 133 shares (1 contract)</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust your position size based on the portfolio slider. Notice how larger portfolios can take bigger risks while maintaining the same percentage risk."
                    },
                    {
                        title: "Step 3: Stop Losses & Profit Taking",
                        content: `
                            <p class="text-emerald-700">Setting exit rules before entering a trade removes emotion from your decisions and ensures consistent risk management across all positions.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Exit Strategy Rules:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Stop Loss:</strong> Exit at 50% loss (before worthless)</li>
                                    <li>• <strong>Profit Target:</strong> Take profits at 25-50% gain</li>
                                    <li>• <strong>Time Stop:</strong> Exit 7-10 days before expiration</li>
                                    <li>• <strong>Volatility Stop:</strong> Exit if IV drops by 30%+</li>
                                </ul>
                                <strong class="block mt-3">Why These Rules Work:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>50% stop loss:</strong> Prevents total loss, preserves capital</li>
                                    <li>• <strong>25-50% profit:</strong> Captures gains before time decay</li>
                                    <li>• <strong>Time stop:</strong> Avoids final week gamma risk</li>
                                    <li>• <strong>IV stop:</strong> Exits before vol crush events</li>
                                </ul>
                            </div>
                        `,
                        insight: "Professional traders take profits early and cut losses quickly. The win rate slider shows how these exit rules affect your expected value over many trades."
                    },
                    {
                        title: "Step 4: Portfolio Greeks Management",
                        content: `
                            <p class="text-emerald-700">Managing portfolio-level Greeks helps you understand your overall exposure and avoid concentration risk in any single risk factor.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Portfolio Greek Limits:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Net Delta:</strong> Keep between -0.2 to +0.2 per $1000</li>
                                    <li>• <strong>Gamma Exposure:</strong> Limit to 0.1 per $1000 capital</li>
                                    <li>• <strong>Theta Income:</strong> Positive theta helps offset losses</li>
                                    <li>• <strong>Vega Exposure:</strong> Don't exceed 0.5 per $1000 capital</li>
                                </ul>
                                <strong class="block mt-3">Risk Scenarios:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>High Delta:</strong> Vulnerable to market crashes</li>
                                    <li>• <strong>High Gamma:</strong> Position can change quickly</li>
                                    <li>• <strong>Negative Theta:</strong> Losing money every day</li>
                                    <li>• <strong>High Vega:</strong> Vulnerable to vol crush</li>
                                </ul>
                            </div>
                        `,
                        insight: "Think of Greeks as your portfolio's vital signs. Just like a doctor monitors heart rate and blood pressure, you should monitor delta, theta, and vega exposure."
                    },
                    {
                        title: "Step 5: Psychological Risk Management",
                        content: `
                            <p class="text-emerald-700">The biggest risk in options trading isn't market risk—it's psychological risk. Managing your emotions and behavior is crucial for long-term success.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Emotional Risk Factors:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>FOMO:</strong> Chasing trades you missed</li>
                                    <li>• <strong>Revenge Trading:</strong> Trying to make back losses quickly</li>
                                    <li>• <strong>Overconfidence:</strong> Increasing size after wins</li>
                                    <li>• <strong>Analysis Paralysis:</strong> Over-thinking simple trades</li>
                                </ul>
                                <strong class="block mt-3">Psychological Solutions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Trade Journal:</strong> Track emotions, not just P&L</li>
                                    <li>• <strong>Position Limits:</strong> Max 3-5 open positions</li>
                                    <li>• <strong>Daily Max Loss:</strong> Stop trading at -1% portfolio loss</li>
                                    <li>• <strong>Regular Breaks:</strong> Take time off after big wins/losses</li>
                                    <li>• <strong>Paper Trading:</strong> Practice new strategies risk-free</li>
                                </ul>
                                <div class="bg-green-50 p-2 rounded text-xs mt-3">
                                    <strong>💡 Pro Tip:</strong> The best traders are boring. They follow their rules consistently, regardless of emotions.
                                </div>
                            </div>
                        `,
                        insight: "Risk of Ruin percentage shows your long-term survival probability. Lower risk per trade dramatically improves your chances of long-term success!"
                    }
                ]
            }
        };

        window.showTutorial = function(tutorialType) {
            // Hide all tutorial content
            const tutorials = document.querySelectorAll('.tutorial-content');
            tutorials.forEach(tutorial => {
                tutorial.classList.add('hidden');
            });
            
            // Reset button styles  
            const buttons = ['greeksTutorialBtn', 'optionsBasicsTutorialBtn', 'pricingModelsTutorialBtn', 'riskManagementTutorialBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                if (element) {
                    element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
                }
            });
            
            // Show selected tutorial
            const targetTutorial = document.getElementById(tutorialType + 'Tutorial');
            if (targetTutorial) {
                targetTutorial.classList.remove('hidden');
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(tutorialType + 'TutorialBtn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getTutorialButtonColor(tutorialType));
            }
            
            // Initialize tutorial based on type
            if (tutorialType === 'greeks') {
                currentTutorial = 'greeks';
                currentTutorialStep = 0;
                updateTutorialStep();
                initializeTutorialSliders();
            } else if (tutorialType === 'options-basics') {
                currentTutorial = 'options-basics';
                currentTutorialStep = 0;
                updateOptionsBasicsStep();
            } else if (tutorialType === 'pricing-models') {
                currentTutorial = 'pricing-models';
                currentTutorialStep = 0;
                updatePricingModelsStep();
                initializePricingModelsSliders();
            } else if (tutorialType === 'risk-management') {
                currentTutorial = 'risk-management';
                currentTutorialStep = 0;
                updateRiskManagementStep();
                initializeRiskManagementSliders();
            }
        }
        
        function getTutorialButtonColor(tutorialType) {
            const colors = {
                'greeks': 'bg-purple-700',
                'options-basics': 'bg-pink-700',
                'pricing-models': 'bg-indigo-700',
                'risk-management': 'bg-emerald-700'
            };
            return colors[tutorialType] || 'bg-purple-700';
        }
        
        window.nextTutorialStep = function() {
            const tutorial = tutorialContent[currentTutorial];
            if (currentTutorialStep < tutorial.totalSteps - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            }
        }
        
        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }
        
        function updateTutorialStep() {
            const tutorial = tutorialContent[currentTutorial];
            const step = tutorial.steps[currentTutorialStep];
            
            // Update progress
            document.getElementById('tutorialProgress').textContent = `Step ${currentTutorialStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentTutorialStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('tutorialStep').innerHTML = `
                <div class="text-lg font-semibold text-purple-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('tutorialInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentTutorialStep === 0;
            prevBtn.className = currentTutorialStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentTutorialStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentTutorialStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    // Show completion message in the UI instead of alert
                    document.getElementById('tutorialContent').innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center"><div class="text-green-800 text-xl font-semibold mb-2">🎉 Tutorial Complete!</div><p class="text-green-700">Congratulations! You\'ve mastered the Greeks. Try the other tutorials or explore the platform.</p></div>';
                };
            } else {
                nextBtn.onclick = nextTutorialStep;
            }
            
            // Update tutorial Greeks calculation
            updateTutorialGreeks();
        }
        
        function initializeTutorialSliders() {
            // Stock price slider
            const stockSlider = document.getElementById('tutorialStockSlider');
            stockSlider.addEventListener('input', function() {
                document.getElementById('tutorialStockPrice').textContent = '$' + this.value;
                updateTutorialGreeks();
            });
            
            // Days slider
            const daysSlider = document.getElementById('tutorialDaysSlider');
            daysSlider.addEventListener('input', function() {
                document.getElementById('tutorialDaysValue').textContent = this.value;
                updateTutorialGreeks();
            });
            
            // Volatility slider
            const volSlider = document.getElementById('tutorialVolSlider');
            volSlider.addEventListener('input', function() {
                document.getElementById('tutorialVolValue').textContent = this.value + '%';
                updateTutorialGreeks();
            });
            
            // Initial calculation
            updateTutorialGreeks();
        }
        
        function updateTutorialGreeks() {
            const stockPrice = parseFloat(document.getElementById('tutorialStockSlider').value);
            const daysToExpiry = parseInt(document.getElementById('tutorialDaysSlider').value);
            const volatility = parseFloat(document.getElementById('tutorialVolSlider').value) / 100;
            
            // Use simplified Black-Scholes for tutorial
            const strikePrice = 105; // Fixed strike for tutorial
            const riskFreeRate = 0.04;
            const timeToExpiry = daysToExpiry / 365;
            
            try {
                // Calculate Greeks using our existing function
                const greeks = calculateBlackScholesGreeks(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility);
                
                // Update display with highlighting for current step
                const currentStep = tutorialContent[currentTutorial].steps[currentTutorialStep];
                const focusGreek = currentStep.focusGreek;
                
                document.getElementById('tutorialDelta').innerHTML = 
                    (focusGreek === 'delta' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.delta.toFixed(3) + 
                    (focusGreek === 'delta' ? '</span>' : '');
                
                document.getElementById('tutorialGamma').innerHTML = 
                    (focusGreek === 'gamma' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.gamma.toFixed(3) + 
                    (focusGreek === 'gamma' ? '</span>' : '');
                
                document.getElementById('tutorialTheta').innerHTML = 
                    (focusGreek === 'theta' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.theta.toFixed(3) + 
                    (focusGreek === 'theta' ? '</span>' : '');
                
                document.getElementById('tutorialVega').innerHTML = 
                    (focusGreek === 'vega' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.vega.toFixed(3) + 
                    (focusGreek === 'vega' ? '</span>' : '');
                    
            } catch (error) {
                console.error('Tutorial Greeks calculation error:', error);
            }
        }
        
        function calculateBlackScholesGreeks(S, K, T, r, sigma) {
            // Black-Scholes Greeks calculation for tutorial
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            // Standard normal CDF approximation
            function normalCDF(x) {
                return 0.5 * (1 + erf(x / Math.sqrt(2)));
            }
            
            // Standard normal PDF
            function normalPDF(x) {
                return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            }
            
            const delta = normalCDF(d1);
            const gamma = normalPDF(d1) / (S * sigma * Math.sqrt(T));
            const theta = -(S * normalPDF(d1) * sigma / (2 * Math.sqrt(T)) + r * K * Math.exp(-r * T) * normalCDF(d2)) / 365;
            const vega = S * normalPDF(d1) * Math.sqrt(T) / 100;
            
            return { delta, gamma, theta, vega };
        }

        // ============================================================================
        // ALGORITHM DEEP DIVES FUNCTIONALITY
        // ============================================================================

        // Deep Dive Management
        function showDeepDive(deepDiveType) {
            // Hide all deep dive content
            const deepDives = document.querySelectorAll('.deep-dive-content');
            deepDives.forEach(deepDive => {
                deepDive.classList.add('hidden');
            });
            
            // Reset button styles
            const buttons = ['binomialDeepDiveBtn', 'blackscholesDeepDiveBtn', 'trinomialDeepDiveBtn', 'montecarloDeepDiveBtn', 'jumpdiffusionDeepDiveBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                if (element) {
                    element.className = element.className.replace(/bg-\w+-\d+/, 'bg-gray-400');
                }
            });
            
            // Show selected deep dive
            const targetDeepDive = document.getElementById(deepDiveType + 'DeepDive');
            if (targetDeepDive) {
                targetDeepDive.classList.remove('hidden');
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(deepDiveType + 'DeepDiveBtn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getDeepDiveButtonColor(deepDiveType));
            }
            
            // Initialize specific deep dive
            if (deepDiveType === 'binomial') {
                initializeBinomialDeepDive();
            } else if (deepDiveType === 'blackscholes') {
                initializeBlackScholesDeepDive();
            } else if (deepDiveType === 'trinomial') {
                initializeTrinomialDeepDive();
            } else if (deepDiveType === 'montecarlo') {
                initializeMonteCarloDeepDive();
            } else if (deepDiveType === 'jumpdiffusion') {
                initializeJumpDiffusionDeepDive();
            }
        }
        
        function getDeepDiveButtonColor(deepDiveType) {
            const colors = {
                'binomial': 'bg-blue-700',
                'blackscholes': 'bg-green-700',
                'trinomial': 'bg-purple-700',
                'montecarlo': 'bg-orange-700',
                'jumpdiffusion': 'bg-red-700'
            };
            return colors[deepDiveType] || 'bg-blue-700';
        }

        // Binomial Deep Dive Implementation
        function initializeBinomialDeepDive() {
            // Initialize sliders
            const stockSlider = document.getElementById('binomialStockSlider');
            const strikeSlider = document.getElementById('binomialStrikeSlider');
            const volSlider = document.getElementById('binomialVolSlider');
            const stepsSlider = document.getElementById('binomialStepsSlider');
            
            // Add event listeners
            stockSlider.addEventListener('input', updateBinomialCalculations);
            strikeSlider.addEventListener('input', updateBinomialCalculations);
            volSlider.addEventListener('input', updateBinomialCalculations);
            stepsSlider.addEventListener('input', updateBinomialCalculations);
            
            // Initial calculation and visualization
            updateBinomialCalculations();
            drawBinomialTree();
        }
        
        function updateBinomialCalculations() {
            const stockPrice = parseFloat(document.getElementById('binomialStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('binomialStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('binomialVolSlider').value) / 100;
            const steps = parseInt(document.getElementById('binomialStepsSlider').value);
            
            // Update display values
            document.getElementById('binomialStockValue').textContent = '$' + stockPrice;
            document.getElementById('binomialStrikeValue').textContent = '$' + strikePrice;
            document.getElementById('binomialVolValue').textContent = volatility * 100 + '%';
            document.getElementById('binomialStepsValue').textContent = steps;
            
            // Calculate binomial parameters
            const timeToExpiry = 30 / 365; // 30 days
            const riskFreeRate = 0.04;
            const dt = timeToExpiry / steps;
            
            const u = Math.exp(volatility * Math.sqrt(dt));
            const d = 1 / u;
            const p = (Math.exp(riskFreeRate * dt) - d) / (u - d);
            
            // Calculate option price using binomial
            const optionPrice = calculateBinomialPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility, steps, 'call');
            
            // Update displays
            document.getElementById('upFactor').textContent = u.toFixed(3);
            document.getElementById('downFactor').textContent = d.toFixed(3);
            document.getElementById('riskNeutralProb').textContent = p.toFixed(3);
            document.getElementById('binomialOptionPrice').textContent = '$' + optionPrice.toFixed(2);
            
            // Redraw tree with new parameters
            drawBinomialTree();
        }
        
        function calculateBinomialPrice(S, K, T, r, sigma, steps, optionType) {
            const dt = T / steps;
            const u = Math.exp(sigma * Math.sqrt(dt));
            const d = 1 / u;
            const p = (Math.exp(r * dt) - d) / (u - d);
            
            // Build the tree backward
            let optionValues = [];
            
            // Initialize final payoffs
            for (let i = 0; i <= steps; i++) {
                const finalPrice = S * Math.pow(u, steps - i) * Math.pow(d, i);
                const payoff = optionType === 'call' ? 
                    Math.max(0, finalPrice - K) : 
                    Math.max(0, K - finalPrice);
                optionValues[i] = payoff;
            }
            
            // Work backward through the tree
            for (let step = steps - 1; step >= 0; step--) {
                const newValues = [];
                for (let i = 0; i <= step; i++) {
                    const discountedExpected = Math.exp(-r * dt) * (p * optionValues[i] + (1 - p) * optionValues[i + 1]);
                    
                    // For American options, check early exercise
                    const currentPrice = S * Math.pow(u, step - i) * Math.pow(d, i);
                    const intrinsicValue = optionType === 'call' ? 
                        Math.max(0, currentPrice - K) : 
                        Math.max(0, K - currentPrice);
                    
                    newValues[i] = Math.max(discountedExpected, intrinsicValue); // American option
                }
                optionValues = newValues;
            }
            
            return optionValues[0];
        }
        
        function drawBinomialTree() {
            const svg = document.getElementById('binomialTreeSVG');
            const container = document.getElementById('binomialTreeContainer');
            const rect = container.getBoundingClientRect();
            
            // Clear previous tree
            svg.innerHTML = '';
            
            const stockPrice = parseFloat(document.getElementById('binomialStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('binomialStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('binomialVolSlider').value) / 100;
            const steps = parseInt(document.getElementById('binomialStepsSlider').value);
            
            const timeToExpiry = 30 / 365;
            const dt = timeToExpiry / steps;
            const u = Math.exp(volatility * Math.sqrt(dt));
            const d = 1 / u;
            
            const width = rect.width || 600;
            const height = rect.height || 400;
            const margin = 40;
            
            const stepWidth = (width - 2 * margin) / steps;
            const maxHeight = height - 2 * margin;
            
            // Calculate node positions and draw
            for (let step = 0; step <= steps; step++) {
                const x = margin + step * stepWidth;
                const nodesInStep = step + 1;
                
                for (let node = 0; node <= step; node++) {
                    const y = margin + (maxHeight * node) / Math.max(1, step);
                    const price = stockPrice * Math.pow(u, step - node) * Math.pow(d, node);
                    
                    // Draw connections to next step
                    if (step < steps) {
                        // Up connection
                        const nextX = margin + (step + 1) * stepWidth;
                        const upY = margin + (maxHeight * node) / Math.max(1, step + 1);
                        const downY = margin + (maxHeight * (node + 1)) / Math.max(1, step + 1);
                        
                        // Up line
                        const upLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        upLine.setAttribute('x1', x);
                        upLine.setAttribute('y1', y);
                        upLine.setAttribute('x2', nextX);
                        upLine.setAttribute('y2', upY);
                        upLine.setAttribute('stroke', '#cbd5e1');
                        upLine.setAttribute('stroke-width', '1');
                        svg.appendChild(upLine);
                        
                        // Down line
                        const downLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        downLine.setAttribute('x1', x);
                        downLine.setAttribute('y1', y);
                        downLine.setAttribute('x2', nextX);
                        downLine.setAttribute('y2', downY);
                        downLine.setAttribute('stroke', '#cbd5e1');
                        downLine.setAttribute('stroke-width', '1');
                        svg.appendChild(downLine);
                    }
                    
                    // Draw node
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', step === steps ? (price > strikePrice ? '#16a34a' : '#dc2626') : '#3b82f6');
                    circle.setAttribute('stroke', '#1e40af');
                    circle.setAttribute('stroke-width', '2');
                    circle.style.cursor = 'pointer';
                    
                    // Add click handler
                    circle.addEventListener('click', () => analyzePath(step, node, steps));
                    
                    svg.appendChild(circle);
                    
                    // Add price label
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', y - 12);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '10');
                    text.setAttribute('fill', '#374151');
                    text.textContent = '$' + price.toFixed(1);
                    svg.appendChild(text);
                }
            }
        }
        
        function analyzePath(step, node, totalSteps) {
            const stockPrice = parseFloat(document.getElementById('binomialStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('binomialStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('binomialVolSlider').value) / 100;
            
            const timeToExpiry = 30 / 365;
            const dt = timeToExpiry / totalSteps;
            const u = Math.exp(volatility * Math.sqrt(dt));
            const d = 1 / u;
            const p = (Math.exp(0.04 * dt) - d) / (u - d);
            
            // Calculate final stock price for this path
            const finalPrice = stockPrice * Math.pow(u, step - node) * Math.pow(d, node);
            const optionPayoff = Math.max(0, finalPrice - strikePrice); // Call option
            
            // Calculate path probability (simplified - showing one specific path)
            const upMoves = step - node;
            const downMoves = node;
            const pathProb = Math.pow(p, upMoves) * Math.pow(1 - p, downMoves);
            
            // Update display
            document.getElementById('selectedPath').textContent = 
                step === totalSteps ? `Terminal node: ${upMoves}U, ${downMoves}D` : `Intermediate: Step ${step}, Node ${node}`;
            document.getElementById('finalStockPrice').textContent = '$' + finalPrice.toFixed(2);
            document.getElementById('optionPayoff').textContent = '$' + optionPayoff.toFixed(2);
            document.getElementById('pathProbability').textContent = (pathProb * 100).toFixed(4) + '%';
        }

        // Black-Scholes Deep Dive Implementation
        function initializeBlackScholesDeepDive() {
            // Initialize sliders
            const stockSlider = document.getElementById('bsStockSlider');
            const strikeSlider = document.getElementById('bsStrikeSlider');
            const timeSlider = document.getElementById('bsTimeSlider');
            const volSlider = document.getElementById('bsVolSlider');
            const rateSlider = document.getElementById('bsRateSlider');
            
            // Add event listeners
            stockSlider.addEventListener('input', updateBlackScholesCalculations);
            strikeSlider.addEventListener('input', updateBlackScholesCalculations);
            timeSlider.addEventListener('input', updateBlackScholesCalculations);
            volSlider.addEventListener('input', updateBlackScholesCalculations);
            rateSlider.addEventListener('input', updateBlackScholesCalculations);
            
            // Initial calculation and visualization
            updateBlackScholesCalculations();
            drawNormalDistribution();
        }
        
        function updateBlackScholesCalculations() {
            const S = parseFloat(document.getElementById('bsStockSlider').value);
            const K = parseFloat(document.getElementById('bsStrikeSlider').value);
            const T = parseFloat(document.getElementById('bsTimeSlider').value) / 365; // Convert days to years
            const sigma = parseFloat(document.getElementById('bsVolSlider').value) / 100; // Convert percentage to decimal
            const r = parseFloat(document.getElementById('bsRateSlider').value) / 100; // Convert percentage to decimal
            
            // Update display values
            document.getElementById('bsStockValue').textContent = '$' + S;
            document.getElementById('bsStrikeValue').textContent = '$' + K;
            document.getElementById('bsTimeValue').textContent = document.getElementById('bsTimeSlider').value;
            document.getElementById('bsVolValue').textContent = document.getElementById('bsVolSlider').value + '%';
            document.getElementById('bsRateValue').textContent = (r * 100).toFixed(1) + '%';
            
            // Calculate Black-Scholes parameters
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            // Normal CDF and Error functions available globally at top of script
            
            const Nd1 = normalCDF(d1);
            const Nd2 = normalCDF(d2);
            
            // Calculate call option price
            const callPrice = S * Nd1 - K * Math.exp(-r * T) * Nd2;
            
            // Update displays
            document.getElementById('bsD1').textContent = d1.toFixed(3);
            document.getElementById('bsD2').textContent = d2.toFixed(3);
            document.getElementById('bsNd1').textContent = Nd1.toFixed(3);
            document.getElementById('bsNd2').textContent = Nd2.toFixed(3);
            document.getElementById('bsCallPrice').textContent = '$' + callPrice.toFixed(2);
            
            // Update sensitivity analysis
            updateSensitivityAnalysis(S, K, T, sigma, r);
            
            // Redraw distribution visualization
            drawNormalDistribution();
        }
        
        function updateSensitivityAnalysis(S, K, T, sigma, r) {
            const moneyness = S / K;
            const timeInDays = T * 365;
            
            // Moneyness effect
            let moneynessText;
            if (moneyness > 1.05) {
                moneynessText = "ITM: High intrinsic value";
            } else if (moneyness < 0.95) {
                moneynessText = "OTM: Pure time value";
            } else {
                moneynessText = "ATM: Maximum time value";
            }
            document.getElementById('moneynessEffect').textContent = moneynessText;
            
            // Time effect
            let timeText;
            if (timeInDays > 90) {
                timeText = "Long expiry: High time value";
            } else if (timeInDays > 30) {
                timeText = "Medium expiry: Moderate decay";
            } else {
                timeText = "Short expiry: Rapid theta decay";
            }
            document.getElementById('timeEffect').textContent = timeText;
            
            // Volatility effect
            let volText;
            if (sigma > 0.4) {
                volText = "High vol: Large uncertainty premium";
            } else if (sigma > 0.2) {
                volText = "Normal vol: Standard premium";
            } else {
                volText = "Low vol: Minimal uncertainty";
            }
            document.getElementById('volEffect').textContent = volText;
            
            // Interest rate effect
            let rateText;
            if (r > 0.06) {
                rateText = "High rates: Significant carry benefit";
            } else if (r > 0.02) {
                rateText = "Normal rates: Moderate carry";
            } else {
                rateText = "Low rates: Minimal carry benefit";
            }
            document.getElementById('rateEffect').textContent = rateText;
        }
        
        function drawNormalDistribution() {
            const canvas = document.getElementById('bsDistributionCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Set canvas size to match container
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Get current parameters
            const S = parseFloat(document.getElementById('bsStockSlider').value);
            const K = parseFloat(document.getElementById('bsStrikeSlider').value);
            const T = parseFloat(document.getElementById('bsTimeSlider').value) / 365;
            const sigma = parseFloat(document.getElementById('bsVolSlider').value) / 100;
            const r = parseFloat(document.getElementById('bsRateSlider').value) / 100;
            
            // Calculate d1 and d2
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            // Standard normal PDF
            function normalPDF(x) {
                return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            }
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw standard normal curve
            const xMin = -4;
            const xMax = 4;
            const xRange = xMax - xMin;
            const yMax = normalPDF(0); // Peak of standard normal
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i <= 200; i++) {
                const x = xMin + (i / 200) * xRange;
                const y = normalPDF(x);
                const pixelX = margin + (i / 200) * (width - 2 * margin);
                const pixelY = height - margin - (y / yMax) * (height - 2 * margin);
                
                if (i === 0) {
                    ctx.moveTo(pixelX, pixelY);
                } else {
                    ctx.lineTo(pixelX, pixelY);
                }
            }
            ctx.stroke();
            
            // Draw vertical lines for d1 and d2
            function xToPixel(x) {
                return margin + ((x - xMin) / xRange) * (width - 2 * margin);
            }
            
            // d1 line
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const d1Pixel = xToPixel(d1);
            ctx.beginPath();
            ctx.moveTo(d1Pixel, margin);
            ctx.lineTo(d1Pixel, height - margin);
            ctx.stroke();
            
            // d2 line
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            const d2Pixel = xToPixel(d2);
            ctx.beginPath();
            ctx.moveTo(d2Pixel, margin);
            ctx.lineTo(d2Pixel, height - margin);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Add labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            // d1 label
            ctx.fillStyle = '#10b981';
            ctx.fillText('d₁', d1Pixel, height - margin + 15);
            
            // d2 label
            ctx.fillStyle = '#f59e0b';
            ctx.fillText('d₂', d2Pixel, height - margin + 15);
            
            // Title
            ctx.fillStyle = '#374151';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Standard Normal Distribution with d₁ and d₂', width / 2, 20);
            
            // Legend
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#10b981';
            ctx.fillText('— d₁ (delta calculation)', width - 150, 40);
            ctx.fillStyle = '#f59e0b';
            ctx.fillText('— d₂ (probability of exercise)', width - 150, 55);
        }

        // Trinomial Comparison Deep Dive Implementation
        function initializeTrinomialDeepDive() {
            // Initialize sliders
            const stockSlider = document.getElementById('triStockSlider');
            const strikeSlider = document.getElementById('triStrikeSlider');
            const volSlider = document.getElementById('triVolSlider');
            const stepsSlider = document.getElementById('triStepsSlider');
            
            // Add event listeners
            stockSlider.addEventListener('input', updateTrinomialComparison);
            strikeSlider.addEventListener('input', updateTrinomialComparison);
            volSlider.addEventListener('input', updateTrinomialComparison);
            stepsSlider.addEventListener('input', updateTrinomialComparison);
            
            // Initial calculation and visualization
            updateTrinomialComparison();
            drawConvergenceChart();
        }
        
        function updateTrinomialComparison() {
            const stockPrice = parseFloat(document.getElementById('triStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('triStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('triVolSlider').value) / 100;
            const steps = parseInt(document.getElementById('triStepsSlider').value);
            
            // Update display values
            document.getElementById('triStockValue').textContent = '$' + stockPrice;
            document.getElementById('triStrikeValue').textContent = '$' + strikePrice;
            document.getElementById('triVolValue').textContent = volatility * 100 + '%';
            document.getElementById('triStepsValue').textContent = steps;
            
            const timeToExpiry = 30 / 365; // 30 days
            const riskFreeRate = 0.04;
            
            // Calculate prices using all three methods
            const binomialPrice = calculateBinomialPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility, steps, 'call');
            const trinomialPrice = calculateTrinomialPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility, steps, 'call');
            const bsPrice = calculateBlackScholesPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility);
            
            // Update displays
            document.getElementById('trinomialBinomialPrice').textContent = '$' + binomialPrice.toFixed(2);
            document.getElementById('trinomialTrinomialPrice').textContent = '$' + trinomialPrice.toFixed(2);
            document.getElementById('trinomialBSPrice').textContent = '$' + bsPrice.toFixed(2);
            
            // Calculate differences
            const binomialDiff = Math.abs(binomialPrice - bsPrice);
            const trinomialDiff = Math.abs(trinomialPrice - bsPrice);
            const priceDiff = Math.abs(trinomialPrice - binomialPrice);
            
            document.getElementById('priceDifference').textContent = '$' + priceDiff.toFixed(3);
            
            // Update performance analysis
            updatePerformanceAnalysis(steps, binomialDiff, trinomialDiff);
            
            // Redraw convergence chart
            drawConvergenceChart();
        }
        
        function calculateTrinomialPrice(S, K, T, r, sigma, steps, optionType) {
            const dt = T / steps;
            const u = Math.exp(sigma * Math.sqrt(3 * dt));
            const d = 1 / u;
            const pu = ((Math.exp(r * dt / 2) - Math.exp(-sigma * Math.sqrt(dt / 12))) / 
                        (Math.exp(sigma * Math.sqrt(dt / 12)) - Math.exp(-sigma * Math.sqrt(dt / 12)))) ** 2;
            const pd = ((Math.exp(sigma * Math.sqrt(dt / 12)) - Math.exp(r * dt / 2)) / 
                        (Math.exp(sigma * Math.sqrt(dt / 12)) - Math.exp(-sigma * Math.sqrt(dt / 12)))) ** 2;
            const pm = 1 - pu - pd;
            
            // Build trinomial tree backward
            let optionValues = [];
            
            // Initialize final payoffs
            for (let i = 0; i <= 2 * steps; i++) {
                const finalPrice = S * Math.pow(u, Math.max(i - steps, 0)) * Math.pow(d, Math.max(steps - i, 0));
                const payoff = optionType === 'call' ? 
                    Math.max(0, finalPrice - K) : 
                    Math.max(0, K - finalPrice);
                optionValues[i] = payoff;
            }
            
            // Work backward through the tree
            for (let step = steps - 1; step >= 0; step--) {
                const newValues = [];
                for (let i = 0; i <= 2 * step; i++) {
                    const discountedExpected = Math.exp(-r * dt) * 
                        (pu * optionValues[i] + pm * optionValues[i + 1] + pd * optionValues[i + 2]);
                    
                    // For American options, check early exercise
                    const nodeIndex = i - step;
                    const currentPrice = S * Math.pow(u, Math.max(nodeIndex, 0)) * Math.pow(d, Math.max(-nodeIndex, 0));
                    const intrinsicValue = optionType === 'call' ? 
                        Math.max(0, currentPrice - K) : 
                        Math.max(0, K - currentPrice);
                    
                    newValues[i] = Math.max(discountedExpected, intrinsicValue);
                }
                optionValues = newValues;
            }
            
            return optionValues[0];
        }
        
        function calculateBlackScholesPrice(S, K, T, r, sigma) {
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            function normalCDF(x) {
                return 0.5 * (1 + erf(x / Math.sqrt(2)));
            }
            
            return S * normalCDF(d1) - K * Math.exp(-r * T) * normalCDF(d2);
        }
        
        function updatePerformanceAnalysis(steps, binomialError, trinomialError) {
            const accuracyImprovement = ((binomialError - trinomialError) / binomialError * 100);
            
            document.getElementById('computationalCost').textContent = 
                `Trinomial: ~${Math.round(50 + steps * 0.5)}% more expensive`;
            
            document.getElementById('memoryUsage').textContent = 
                `Trinomial: ${Math.round(steps * 1.5)} vs ${steps} nodes per step`;
            
            document.getElementById('accuracyGain').textContent = 
                `${Math.abs(accuracyImprovement).toFixed(1)}% ${accuracyImprovement > 0 ? 'better' : 'similar'} accuracy`;
            
            // Dynamic recommendation
            if (steps < 20) {
                document.getElementById('bestUseCase').textContent = "Binomial sufficient for learning";
            } else if (trinomialError < binomialError * 0.8) {
                document.getElementById('bestUseCase').textContent = "Trinomial recommended here";
            } else {
                document.getElementById('bestUseCase').textContent = "Both models converging";
            }
        }
        
        function drawConvergenceChart() {
            const canvas = document.getElementById('convergenceCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Set canvas size to match container
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Get current parameters
            const stockPrice = parseFloat(document.getElementById('triStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('triStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('triVolSlider').value) / 100;
            const timeToExpiry = 30 / 365;
            const riskFreeRate = 0.04;
            
            // Calculate Black-Scholes reference price
            const bsPrice = calculateBlackScholesPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility);
            
            // Calculate convergence data
            const maxSteps = 50;
            const stepIncrement = 5;
            const convergenceData = [];
            
            for (let steps = 5; steps <= maxSteps; steps += stepIncrement) {
                const binPrice = calculateBinomialPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility, steps, 'call');
                const triPrice = calculateTrinomialPrice(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility, steps, 'call');
                
                convergenceData.push({
                    steps: steps,
                    binomialError: Math.abs(binPrice - bsPrice),
                    trinomialError: Math.abs(triPrice - bsPrice)
                });
            }
            
            // Find max error for scaling
            const maxError = Math.max(...convergenceData.map(d => Math.max(d.binomialError, d.trinomialError)));
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Helper function to convert data to pixels
            function xToPixel(steps) {
                return margin + ((steps - 5) / (maxSteps - 5)) * (width - 2 * margin);
            }
            
            function yToPixel(error) {
                return height - margin - (error / maxError) * (height - 2 * margin);
            }
            
            // Draw binomial line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            convergenceData.forEach((d, i) => {
                const x = xToPixel(d.steps);
                const y = yToPixel(d.binomialError);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw trinomial line
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            convergenceData.forEach((d, i) => {
                const x = xToPixel(d.steps);
                const y = yToPixel(d.trinomialError);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Add labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            // X-axis label
            ctx.fillText('Time Steps', width / 2, height - 10);
            
            // Y-axis label
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Error vs Black-Scholes ($)', 0, 0);
            ctx.restore();
            
            // Title
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Model Convergence to Black-Scholes', width / 2, 20);
            
            // Legend
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#3b82f6';
            ctx.fillText('— Binomial', width - 100, 40);
            ctx.fillStyle = '#8b5cf6';
            ctx.fillText('— Trinomial', width - 100, 55);
        }

        // Monte Carlo Deep Dive Implementation
        let mcSimulationData = [];
        let mcIsRunning = false;
        
        function initializeMonteCarloDeepDive() {
            // Initialize sliders
            const stockSlider = document.getElementById('mcStockSlider');
            const strikeSlider = document.getElementById('mcStrikeSlider');
            const volSlider = document.getElementById('mcVolSlider');
            const simsSlider = document.getElementById('mcSimsSlider');
            
            // Add event listeners for sliders (update display values only)
            stockSlider.addEventListener('input', updateMCDisplayValues);
            strikeSlider.addEventListener('input', updateMCDisplayValues);
            volSlider.addEventListener('input', updateMCDisplayValues);
            simsSlider.addEventListener('input', updateMCDisplayValues);
            
            // Add button event listeners
            document.getElementById('runMCSimulation').addEventListener('click', runMonteCarloSimulation);
            document.getElementById('resetMCSimulation').addEventListener('click', resetMonteCarloSimulation);
            
            // Initial setup
            updateMCDisplayValues();
            resetMonteCarloSimulation();
        }
        
        function updateMCDisplayValues() {
            const stockPrice = parseFloat(document.getElementById('mcStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('mcStrikeSlider').value);
            const volatility = parseFloat(document.getElementById('mcVolSlider').value);
            const maxSims = parseInt(document.getElementById('mcSimsSlider').value);
            
            document.getElementById('mcStockValue').textContent = '$' + stockPrice;
            document.getElementById('mcStrikeValue').textContent = '$' + strikePrice;
            document.getElementById('mcVolValue').textContent = volatility + '%';
            document.getElementById('mcSimsValue').textContent = maxSims.toLocaleString();
            
            // Update Black-Scholes reference if not running simulation
            if (!mcIsRunning) {
                const bsPrice = calculateBlackScholesPrice(stockPrice, strikePrice, 30/365, 0.04, volatility/100);
                document.getElementById('mcBSReference').textContent = '$' + bsPrice.toFixed(2);
            }
        }
        
        function resetMonteCarloSimulation() {
            mcSimulationData = [];
            mcIsRunning = false;
            
            // Reset displays
            document.getElementById('mcFinalPrice').textContent = '$--';
            document.getElementById('mcBSReference').textContent = '$--';
            document.getElementById('mcStandardError').textContent = '±$--';
            document.getElementById('mcConfidenceInterval').textContent = '[$--, $--]';
            
            // Hide progress bar
            document.getElementById('mcProgress').classList.add('hidden');
            
            // Clear charts
            clearCanvas('mcConvergenceCanvas');
            clearCanvas('mcPathsCanvas');
            
            // Update reference price
            updateMCDisplayValues();
        }
        
        async function runMonteCarloSimulation() {
            if (mcIsRunning) return;
            
            mcIsRunning = true;
            mcSimulationData = [];
            
            // Get parameters
            const S0 = parseFloat(document.getElementById('mcStockSlider').value);
            const K = parseFloat(document.getElementById('mcStrikeSlider').value);
            const sigma = parseFloat(document.getElementById('mcVolSlider').value) / 100;
            const maxSims = parseInt(document.getElementById('mcSimsSlider').value);
            const T = 30 / 365;
            const r = 0.04;
            
            // Show progress bar
            document.getElementById('mcProgress').classList.remove('hidden');
            
            // Calculate reference Black-Scholes price
            const bsPrice = calculateBlackScholesPrice(S0, K, T, r, sigma);
            document.getElementById('mcBSReference').textContent = '$' + bsPrice.toFixed(2);
            
            const batchSize = 500; // Process in batches to show progress
            let totalSims = 0;
            let runningSum = 0;
            let runningSumSquares = 0;
            const samplePaths = []; // Store first 20 paths for visualization
            
            while (totalSims < maxSims) {
                const currentBatchSize = Math.min(batchSize, maxSims - totalSims);
                
                for (let i = 0; i < currentBatchSize; i++) {
                    // Generate random normal variable (Box-Muller)
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    
                    // Calculate final stock price
                    const ST = S0 * Math.exp((r - 0.5 * sigma * sigma) * T + sigma * Math.sqrt(T) * z);
                    
                    // Calculate payoff
                    const payoff = Math.max(0, ST - K);
                    const discountedPayoff = Math.exp(-r * T) * payoff;
                    
                    runningSum += discountedPayoff;
                    runningSumSquares += discountedPayoff * discountedPayoff;
                    
                    // Store sample paths for visualization
                    if (samplePaths.length < 20) {
                        samplePaths.push({path: ST, payoff: payoff});
                    }
                }
                
                totalSims += currentBatchSize;
                
                // Calculate current statistics
                const currentPrice = runningSum / totalSims;
                const variance = (runningSumSquares / totalSims) - (currentPrice * currentPrice);
                const standardError = Math.sqrt(variance / totalSims);
                const confidenceLower = currentPrice - 1.96 * standardError;
                const confidenceUpper = currentPrice + 1.96 * standardError;
                
                // Store convergence data
                mcSimulationData.push({
                    simulations: totalSims,
                    price: currentPrice,
                    standardError: standardError,
                    confidenceLower: confidenceLower,
                    confidenceUpper: confidenceUpper
                });
                
                // Update displays
                document.getElementById('mcFinalPrice').textContent = '$' + currentPrice.toFixed(2);
                document.getElementById('mcStandardError').textContent = '±$' + standardError.toFixed(3);
                document.getElementById('mcConfidenceInterval').textContent = 
                    '[$' + confidenceLower.toFixed(2) + ', $' + confidenceUpper.toFixed(2) + ']';
                
                // Update progress
                const progress = (totalSims / maxSims) * 100;
                document.getElementById('mcProgressBar').style.width = progress + '%';
                document.getElementById('mcProgressText').textContent = Math.round(progress) + '%';
                
                // Update charts
                drawMCConvergenceChart();
                if (samplePaths.length >= 20) {
                    drawMCPathsChart(samplePaths, S0, K);
                }
                
                // Small delay to show progress and prevent UI blocking
                if (totalSims % (batchSize * 2) === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // Hide progress bar
            setTimeout(() => {
                document.getElementById('mcProgress').classList.add('hidden');
            }, 1000);
            
            mcIsRunning = false;
        }
        
        function drawMCConvergenceChart() {
            const canvas = document.getElementById('mcConvergenceCanvas');
            if (!canvas || mcSimulationData.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Get price range
            const bsPrice = parseFloat(document.getElementById('mcBSReference').textContent.replace('$', ''));
            const prices = mcSimulationData.map(d => d.price);
            const maxPrice = Math.max(...prices, bsPrice + 1);
            const minPrice = Math.min(...prices, bsPrice - 1);
            const priceRange = maxPrice - minPrice;
            
            const maxSims = Math.max(...mcSimulationData.map(d => d.simulations));
            
            // Helper functions
            function xToPixel(sims) {
                return margin + (sims / maxSims) * (width - 2 * margin);
            }
            
            function yToPixel(price) {
                return height - margin - ((price - minPrice) / priceRange) * (height - 2 * margin);
            }
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw Black-Scholes reference line
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const bsY = yToPixel(bsPrice);
            ctx.beginPath();
            ctx.moveTo(margin, bsY);
            ctx.lineTo(width - margin, bsY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw confidence interval
            ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
            ctx.beginPath();
            ctx.moveTo(margin, yToPixel(mcSimulationData[0].confidenceUpper));
            
            mcSimulationData.forEach(d => {
                ctx.lineTo(xToPixel(d.simulations), yToPixel(d.confidenceUpper));
            });
            
            for (let i = mcSimulationData.length - 1; i >= 0; i--) {
                const d = mcSimulationData[i];
                ctx.lineTo(xToPixel(d.simulations), yToPixel(d.confidenceLower));
            }
            
            ctx.closePath();
            ctx.fill();
            
            // Draw Monte Carlo price line
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            mcSimulationData.forEach((d, i) => {
                const x = xToPixel(d.simulations);
                const y = yToPixel(d.price);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Number of Simulations', width / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Option Price ($)', 0, 0);
            ctx.restore();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Monte Carlo Convergence', width / 2, 20);
            
            // Legend
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#f59e0b';
            ctx.fillText('— Monte Carlo', width - 120, 40);
            ctx.fillStyle = '#10b981';
            ctx.fillText('--- Black-Scholes', width - 120, 52);
            ctx.fillStyle = '#ef4444';
            ctx.fillText('█ 95% Confidence', width - 120, 64);
        }
        
        function drawMCPathsChart(samplePaths, S0, K) {
            const canvas = document.getElementById('mcPathsCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Find price range
            const allPrices = [S0, K, ...samplePaths.map(p => p.path)];
            const maxPrice = Math.max(...allPrices) * 1.1;
            const minPrice = Math.min(...allPrices) * 0.9;
            const priceRange = maxPrice - minPrice;
            
            // Helper function
            function yToPixel(price) {
                return height - margin - ((price - minPrice) / priceRange) * (height - 2 * margin);
            }
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw strike line
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.setLineDash([3, 3]);
            const strikeY = yToPixel(K);
            ctx.beginPath();
            ctx.moveTo(margin, strikeY);
            ctx.lineTo(width - margin, strikeY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw sample paths
            const startX = margin + 20;
            const endX = width - margin - 20;
            
            samplePaths.forEach((path, i) => {
                const startY = yToPixel(S0);
                const endY = yToPixel(path.path);
                
                // Color based on payoff
                const alpha = 0.6;
                if (path.payoff > 0) {
                    ctx.strokeStyle = `rgba(34, 197, 94, ${alpha})`; // Green for ITM
                } else {
                    ctx.strokeStyle = `rgba(156, 163, 175, ${alpha})`; // Gray for OTM
                }
                
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            });
            
            // Labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Time →', width / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Stock Price ($)', 0, 0);
            ctx.restore();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Sample Stock Price Paths', width / 2, 20);
            
            // Labels for start and strike
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#374151';
            ctx.fillText(`Start: $${S0}`, startX, yToPixel(S0) - 5);
            ctx.fillStyle = '#ef4444';
            ctx.fillText(`Strike: $${K}`, margin + 5, strikeY - 5);
        }
        
        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Jump Diffusion Deep Dive Implementation
        function initializeJumpDiffusionDeepDive() {
            // Initialize sliders
            const stockSlider = document.getElementById('jdStockSlider');
            const strikeSlider = document.getElementById('jdStrikeSlider');
            const intensitySlider = document.getElementById('jdIntensitySlider');
            const jumpSizeSlider = document.getElementById('jdJumpSizeSlider');
            const jumpVolSlider = document.getElementById('jdJumpVolSlider');
            
            // Add event listeners
            stockSlider.addEventListener('input', updateJumpDiffusionCalculations);
            strikeSlider.addEventListener('input', updateJumpDiffusionCalculations);
            intensitySlider.addEventListener('input', updateJumpDiffusionCalculations);
            jumpSizeSlider.addEventListener('input', updateJumpDiffusionCalculations);
            jumpVolSlider.addEventListener('input', updateJumpDiffusionCalculations);
            
            // Add button event listeners
            document.getElementById('simulateJumpPaths').addEventListener('click', simulateJumpPaths);
            document.getElementById('resetJumpSimulation').addEventListener('click', resetJumpSimulation);
            
            // Initial setup
            updateJumpDiffusionCalculations();
            resetJumpSimulation();
        }
        
        function updateJumpDiffusionCalculations() {
            const stockPrice = parseFloat(document.getElementById('jdStockSlider').value);
            const strikePrice = parseFloat(document.getElementById('jdStrikeSlider').value);
            const jumpIntensity = parseFloat(document.getElementById('jdIntensitySlider').value);
            const jumpSize = parseFloat(document.getElementById('jdJumpSizeSlider').value) / 100; // Convert to decimal
            const jumpVol = parseFloat(document.getElementById('jdJumpVolSlider').value) / 100; // Convert to decimal
            
            // Update display values
            document.getElementById('jdStockValue').textContent = '$' + stockPrice;
            document.getElementById('jdStrikeValue').textContent = '$' + strikePrice;
            document.getElementById('jdIntensityValue').textContent = jumpIntensity.toFixed(1);
            document.getElementById('jdJumpSizeValue').textContent = (jumpSize * 100).toFixed(0) + '%';
            document.getElementById('jdJumpVolValue').textContent = (jumpVol * 100).toFixed(0) + '%';
            
            const T = 30 / 365; // 30 days
            const r = 0.04;
            const sigma = 0.25; // Base volatility
            
            // Calculate standard Black-Scholes price
            const standardPrice = calculateBlackScholesPrice(stockPrice, strikePrice, T, r, sigma);
            
            // Calculate jump-adjusted price (simplified Merton model)
            const jumpPrice = calculateJumpDiffusionPrice(stockPrice, strikePrice, T, r, sigma, jumpIntensity, jumpSize, jumpVol);
            
            const crashPremium = jumpPrice - standardPrice;
            const premiumPercent = (crashPremium / standardPrice) * 100;
            
            // Update displays
            document.getElementById('jdStandardPrice').textContent = '$' + standardPrice.toFixed(2);
            document.getElementById('jdJumpPrice').textContent = '$' + jumpPrice.toFixed(2);
            document.getElementById('jdCrashPremium').textContent = '$' + crashPremium.toFixed(2);
            document.getElementById('jdPremiumPercent').textContent = premiumPercent.toFixed(1) + '%';
        }
        
        function calculateJumpDiffusionPrice(S, K, T, r, sigma, lambda, jumpMean, jumpVol) {
            // Merton Jump Diffusion Model - simplified approximation
            // Uses series expansion for first few terms
            
            let price = 0;
            const maxTerms = 10; // Truncate series
            
            for (let n = 0; n < maxTerms; n++) {
                // Poisson probability
                const poissonProb = Math.exp(-lambda * T) * Math.pow(lambda * T, n) / factorial(n);
                
                if (poissonProb < 1e-8) break; // Skip very small terms
                
                // Adjusted parameters for n jumps
                const adjustedSigma = Math.sqrt(sigma * sigma + n * jumpVol * jumpVol / T);
                const adjustedMu = r - 0.5 * sigma * sigma + n * Math.log(1 + jumpMean) / T - lambda * jumpMean;
                
                // Black-Scholes price with adjusted parameters
                const termPrice = calculateBlackScholesWithMu(S, K, T, adjustedMu, adjustedSigma);
                
                price += poissonProb * termPrice;
            }
            
            return price;
        }
        
        function calculateBlackScholesWithMu(S, K, T, mu, sigma) {
            const d1 = (Math.log(S / K) + (mu + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            function normalCDF(x) {
                return 0.5 * (1 + erf(x / Math.sqrt(2)));
            }
            
            return S * Math.exp((mu - 0.04) * T) * normalCDF(d1) - K * Math.exp(-0.04 * T) * normalCDF(d2);
        }
        
        function setMarketScenario(scenario) {
            const scenarios = {
                normal: { intensity: 0.5, jumpSize: -2, jumpVol: 8 },
                volatile: { intensity: 2, jumpSize: -5, jumpVol: 12 },
                crash: { intensity: 8, jumpSize: -15, jumpVol: 25 },
                bubble: { intensity: 4, jumpSize: -20, jumpVol: 20 }
            };
            
            const params = scenarios[scenario];
            if (!params) return;
            
            document.getElementById('jdIntensitySlider').value = params.intensity;
            document.getElementById('jdJumpSizeSlider').value = params.jumpSize;
            document.getElementById('jdJumpVolSlider').value = params.jumpVol;
            
            updateJumpDiffusionCalculations();
        }
        
        function simulateJumpPaths() {
            const stockPrice = parseFloat(document.getElementById('jdStockSlider').value);
            const jumpIntensity = parseFloat(document.getElementById('jdIntensitySlider').value);
            const jumpSize = parseFloat(document.getElementById('jdJumpSizeSlider').value) / 100;
            const jumpVol = parseFloat(document.getElementById('jdJumpVolSlider').value) / 100;
            
            drawJumpPaths(stockPrice, jumpIntensity, jumpSize, jumpVol);
            drawReturnDistribution(jumpIntensity, jumpSize, jumpVol);
        }
        
        function resetJumpSimulation() {
            clearCanvas('jdPathsCanvas');
            clearCanvas('jdDistributionCanvas');
            updateJumpDiffusionCalculations();
        }
        
        function drawJumpPaths(S0, lambda, jumpMean, jumpVol) {
            const canvas = document.getElementById('jdPathsCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 30;
            
            ctx.clearRect(0, 0, width, height);
            
            const T = 30 / 365; // 30 days
            const dt = T / 100; // 100 time steps
            const numPaths = 10;
            const sigma = 0.25;
            const r = 0.04;
            
            // Generate price range
            let minPrice = S0 * 0.7;
            let maxPrice = S0 * 1.3;
            
            // Helper function
            function yToPixel(price) {
                return height - margin - ((price - minPrice) / (maxPrice - minPrice)) * (height - 2 * margin);
            }
            
            function xToPixel(step) {
                return margin + (step / 100) * (width - 2 * margin);
            }
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw normal paths (for comparison)
            for (let path = 0; path < numPaths / 2; path++) {
                ctx.strokeStyle = 'rgba(156, 163, 175, 0.6)'; // Gray
                ctx.lineWidth = 1;
                ctx.beginPath();
                
                let price = S0;
                ctx.moveTo(xToPixel(0), yToPixel(price));
                
                for (let step = 1; step <= 100; step++) {
                    const z = Math.random() * 2 - 1; // Simple random
                    price = price * Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * z);
                    ctx.lineTo(xToPixel(step), yToPixel(price));
                }
                
                ctx.stroke();
            }
            
            // Draw jump diffusion paths
            for (let path = 0; path < numPaths / 2; path++) {
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.8)'; // Red
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let price = S0;
                ctx.moveTo(xToPixel(0), yToPixel(price));
                
                for (let step = 1; step <= 100; step++) {
                    const z = Math.random() * 2 - 1; // Simple random
                    
                    // Normal diffusion component
                    price = price * Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * z);
                    
                    // Jump component (Poisson process)
                    const jumpProb = lambda * dt;
                    if (Math.random() < jumpProb) {
                        // Jump occurs
                        const jumpZ = Math.random() * 2 - 1; // Simple random for jump size
                        const jumpSize = jumpMean + jumpVol * jumpZ;
                        price = price * (1 + jumpSize);
                        
                        // Draw jump indicator
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.3)';
                        ctx.fillRect(xToPixel(step) - 2, yToPixel(price) - 10, 4, 20);
                    }
                    
                    ctx.lineTo(xToPixel(step), yToPixel(price));
                }
                
                ctx.stroke();
            }
            
            // Labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Time →', width / 2, height - 5);
            
            ctx.save();
            ctx.translate(10, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($)', 0, 0);
            ctx.restore();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Jump Diffusion vs Normal Paths', width / 2, 20);
            
            // Legend
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#9ca3af';
            ctx.fillText('— Normal Diffusion', width - 120, 35);
            ctx.fillStyle = '#ef4444';
            ctx.fillText('— Jump Diffusion', width - 120, 47);
            ctx.fillStyle = '#ef4444';
            ctx.fillText('█ Jump Events', width - 120, 59);
        }
        
        function drawReturnDistribution(lambda, jumpMean, jumpVol) {
            const canvas = document.getElementById('jdDistributionCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width || 400;
            canvas.height = rect.height || 200;
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Normal distribution
            const xMin = -0.2;
            const xMax = 0.1;
            const xRange = xMax - xMin;
            
            function xToPixel(x) {
                return margin + ((x - xMin) / xRange) * (width - 2 * margin);
            }
            
            function normalPDF(x, mu, sig) {
                return Math.exp(-0.5 * ((x - mu) / sig) ** 2) / (sig * Math.sqrt(2 * Math.PI));
            }
            
            // Draw normal distribution
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const normalSigma = 0.02; // Daily volatility
            const maxNormal = normalPDF(0, 0, normalSigma);
            
            for (let i = 0; i <= 200; i++) {
                const x = xMin + (i / 200) * xRange;
                const y = normalPDF(x, 0, normalSigma);
                const pixelX = xToPixel(x);
                const pixelY = height - margin - (y / maxNormal) * (height - 2 * margin);
                
                if (i === 0) {
                    ctx.moveTo(pixelX, pixelY);
                } else {
                    ctx.lineTo(pixelX, pixelY);
                }
            }
            ctx.stroke();
            
            // Draw jump-adjusted distribution (simplified)
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i <= 200; i++) {
                const x = xMin + (i / 200) * xRange;
                
                // Mixture of normal and jump components
                const normalComponent = 0.8 * normalPDF(x, 0, normalSigma);
                const jumpComponent = 0.2 * normalPDF(x, jumpMean / 30, jumpVol / Math.sqrt(30)); // Scaled for daily
                
                const y = normalComponent + jumpComponent;
                const pixelX = xToPixel(x);
                const pixelY = height - margin - (y / maxNormal) * (height - 2 * margin);
                
                if (i === 0) {
                    ctx.moveTo(pixelX, pixelY);
                } else {
                    ctx.lineTo(pixelX, pixelY);
                }
            }
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Daily Return', width / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Probability Density', 0, 0);
            ctx.restore();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Return Distribution Comparison', width / 2, 20);
            
            // Legend
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#3b82f6';
            ctx.fillText('— Normal Distribution', width - 140, 40);
            ctx.fillStyle = '#ef4444';
            ctx.fillText('— Jump Diffusion (Fat Tails)', width - 140, 52);
        }

        // ============================================================================
        // OPTIONS BASICS TUTORIAL FUNCTIONS
        // ============================================================================

        let currentOptionsBasicsStep = 0;

        window.nextOptionsBasicsStep = function() {
            const tutorial = tutorialContent['options-basics'];
            if (currentOptionsBasicsStep < tutorial.totalSteps - 1) {
                currentOptionsBasicsStep++;
                updateOptionsBasicsStep();
            }
        }
        
        window.previousOptionsBasicsStep = function() {
            if (currentOptionsBasicsStep > 0) {
                currentOptionsBasicsStep--;
                updateOptionsBasicsStep();
            }
        }
        
        function updateOptionsBasicsStep() {
            const tutorial = tutorialContent['options-basics'];
            const step = tutorial.steps[currentOptionsBasicsStep];
            
            // Update progress
            document.getElementById('optionsBasicsProgress').textContent = `Step ${currentOptionsBasicsStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentOptionsBasicsStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('optionsBasicsProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('optionsBasicsStep').innerHTML = `
                <div class="text-lg font-semibold text-pink-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update demo section
            document.getElementById('optionsBasicsDemo').innerHTML = step.demo.content;
            
            // Update insight
            document.getElementById('optionsBasicsInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('optionsBasicsPrevBtn');
            const nextBtn = document.getElementById('optionsBasicsNextBtn');
            
            prevBtn.disabled = currentOptionsBasicsStep === 0;
            prevBtn.className = currentOptionsBasicsStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentOptionsBasicsStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentOptionsBasicsStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    // Show completion message in the UI
                    document.getElementById('optionsBasicsStep').innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center"><div class="text-green-800 text-xl font-semibold mb-2">🎉 Tutorial Complete!</div><p class="text-green-700">Excellent! You now understand options fundamentals.</p></div>';
                };
            } else {
                nextBtn.onclick = nextOptionsBasicsStep;
            }
            
            // Update visualization based on step
            updateOptionsBasicsVisualization();
        }
        
        function updateOptionsBasicsVisualization() {
            const visualizationDiv = document.getElementById('optionsBasicsVisualization');
            const step = currentOptionsBasicsStep;
            
            switch(step) {
                case 0: // What is an option
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-sm font-bold text-blue-600 mb-2">Contract Structure</div>
                                <div class="text-xs space-y-1">
                                    <div>👤 You ←→ 📄 Option Contract ←→ 📈 AAPL Stock</div>
                                    <div class="text-green-600">RIGHT to buy at $155</div>
                                    <div class="text-red-600">Cost: $3.50 × 100 = $350</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 1: // Calls vs Puts
                    visualizationDiv.innerHTML = `
                        <canvas id="callPutChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawCallPutChart();
                    break;
                case 2: // Moneyness
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border p-2">
                            <div class="text-xs font-bold text-center mb-2">Option Values at AAPL $150</div>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between items-center">
                                    <span>$140 Call (ITM)</span>
                                    <div class="w-16 bg-green-200 h-3 rounded flex items-center justify-center text-xs">$12</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>$150 Call (ATM)</span>
                                    <div class="w-8 bg-yellow-200 h-3 rounded flex items-center justify-center text-xs">$3.5</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>$160 Call (OTM)</span>
                                    <div class="w-2 bg-red-200 h-3 rounded flex items-center justify-center text-xs">$0.5</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 3: // Time decay
                    visualizationDiv.innerHTML = `
                        <canvas id="timeDecayChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawTimeDecayChart();
                    break;
                case 4: // Volatility
                    visualizationDiv.innerHTML = `
                        <canvas id="volatilityChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawVolatilityChart();
                    break;
                case 5: // Mistakes
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border p-2 text-xs">
                            <div class="text-center font-bold mb-2">Probability of Profit</div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-red-600">$180 Call (3 days)</span>
                                    <div class="flex items-center">
                                        <div class="w-4 bg-red-300 h-2 rounded mr-1"></div>
                                        <span>5%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-green-600">$155 Call (60 days)</span>
                                    <div class="flex items-center">
                                        <div class="w-12 bg-green-300 h-2 rounded mr-1"></div>
                                        <span>35%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }
        
        function drawCallPutChart() {
            const canvas = document.getElementById('callPutChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Call profit line (green)
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 80);
            ctx.lineTo(120, 80);
            ctx.lineTo(220, 20);
            ctx.stroke();
            
            // Put profit line (red)
            ctx.strokeStyle = '#ef4444';
            ctx.beginPath();
            ctx.moveTo(20, 20);
            ctx.lineTo(120, 80);
            ctx.lineTo(220, 80);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Call Profit', 180, 15);
            ctx.fillText('Put Profit', 180, 35);
            ctx.fillText('Stock Price →', 100, 110);
        }
        
        function drawTimeDecayChart() {
            const canvas = document.getElementById('timeDecayChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Time decay curve
            ctx.strokeStyle = '#dc2626';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 20);
            ctx.quadraticCurveTo(120, 30, 220, 100);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Option Value', 10, 15);
            ctx.fillText('Days to Expiry →', 100, 115);
            ctx.fillText('90d: $5.50', 25, 35);
            ctx.fillText('1d: $0.15', 180, 95);
        }
        
        function drawVolatilityChart() {
            const canvas = document.getElementById('volatilityChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Low vol bar
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(50, 70, 30, 30);
            
            // High vol bar
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(150, 20, 30, 80);
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Low Vol', 50, 115);
            ctx.fillText('15%', 58, 90);
            ctx.fillText('$1.20', 55, 85);
            ctx.fillText('High Vol', 145, 115);
            ctx.fillText('45%', 158, 40);
            ctx.fillText('$6.80', 155, 35);
        }

        // ============================================================================
        // PRICING MODELS TUTORIAL IMPLEMENTATION
        // ============================================================================

        let currentPricingModelsStep = 0;

        window.nextPricingModelsStep = function() {
            const tutorial = tutorialContent['pricing-models'];
            if (currentPricingModelsStep < tutorial.totalSteps - 1) {
                currentPricingModelsStep++;
                updatePricingModelsStep();
            }
        }

        window.previousPricingModelsStep = function() {
            if (currentPricingModelsStep > 0) {
                currentPricingModelsStep--;
                updatePricingModelsStep();
            }
        }
        
        function updatePricingModelsStep() {
            const tutorial = tutorialContent['pricing-models'];
            const step = tutorial.steps[currentPricingModelsStep];
            
            // Update progress
            document.getElementById('pricingModelsProgress').textContent = `Step ${currentPricingModelsStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentPricingModelsStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('pricingModelsProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('pricingModelsStep').innerHTML = `
                <div class="text-lg font-semibold text-indigo-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('modelsInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('pricingModelsPrevBtn');
            const nextBtn = document.getElementById('pricingModelsNextBtn');
            
            prevBtn.disabled = currentPricingModelsStep === 0;
            prevBtn.className = currentPricingModelsStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentPricingModelsStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentPricingModelsStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    // Show completion message in the UI
                    document.getElementById('pricingModelsStep').innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center"><div class="text-green-800 text-xl font-semibold mb-2">🎉 Tutorial Complete!</div><p class="text-green-700">Excellent! You now understand all 5 pricing models.</p></div>';
                };
            } else {
                nextBtn.onclick = nextPricingModelsStep;
            }
            
            // Update model prices
            updatePricingModelsCalculation();
        }
        
        function initializePricingModelsSliders() {
            const stockSlider = document.getElementById('modelsStockSlider');
            const daysSlider = document.getElementById('modelsDaysSlider');
            const volSlider = document.getElementById('modelsVolSlider');
            
            if (stockSlider) {
                stockSlider.addEventListener('input', function() {
                    document.getElementById('modelsStockPrice').textContent = `$${this.value}`;
                    updatePricingModelsCalculation();
                });
            }
            
            if (daysSlider) {
                daysSlider.addEventListener('input', function() {
                    document.getElementById('modelsDaysValue').textContent = this.value;
                    updatePricingModelsCalculation();
                });
            }
            
            if (volSlider) {
                volSlider.addEventListener('input', function() {
                    document.getElementById('modelsVolValue').textContent = `${this.value}%`;
                    updatePricingModelsCalculation();
                });
            }
            
            // Initial calculation
            updatePricingModelsCalculation();
        }
        
        function updatePricingModelsCalculation() {
            if (!pricingLibrary) return;
            
            try {
                const stockPrice = parseFloat(document.getElementById('modelsStockSlider')?.value) || 100;
                const daysToExpiry = parseInt(document.getElementById('modelsDaysSlider')?.value) || 30;
                const volatility = parseFloat(document.getElementById('modelsVolSlider')?.value) / 100 || 0.25;
                
                const params = {
                    stockPrice: stockPrice,
                    strikePrice: 105, // Fixed ATM strike
                    daysToExpiry: daysToExpiry,
                    volatility: volatility,
                    optionType: 'call',
                    timeToExpiry: daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                };
                
                // Calculate prices with all models
                const trinomialPrice = pricingLibrary.trinomialPrice({ ...params, steps: 50 });
                const binomialPrice = pricingLibrary.binomialPrice({ ...params, steps: 50 });
                const bsPrice = pricingLibrary.blackScholesPrice(params);
                const mcResult = pricingLibrary.monteCarloPrice({ ...params, simulations: 10000 });
                const jdPrice = pricingLibrary.jumpDiffusionPrice({ 
                    ...params, 
                    jumpIntensity: 2, 
                    jumpMean: -0.02, 
                    jumpVolatility: 0.08 
                });
                
                // Update displays
                document.getElementById('modelTrinomialPrice').textContent = '$' + trinomialPrice.toFixed(2);
                document.getElementById('modelBinomialPrice').textContent = '$' + binomialPrice.toFixed(2);
                document.getElementById('modelBSPrice').textContent = '$' + bsPrice.toFixed(2);
                document.getElementById('modelMCPrice').textContent = `$${mcResult.price.toFixed(2)} ±${mcResult.standardError.toFixed(2)}`;
                document.getElementById('modelJDPrice').textContent = '$' + jdPrice.toFixed(2);
                
            } catch (error) {
                console.warn('Pricing models tutorial calculation error:', error);
                // Show default values
                document.getElementById('modelTrinomialPrice').textContent = '$8.45';
                document.getElementById('modelBinomialPrice').textContent = '$8.42';
                document.getElementById('modelBSPrice').textContent = '$8.38';
                document.getElementById('modelMCPrice').textContent = '$8.41 ±0.05';
                document.getElementById('modelJDPrice').textContent = '$8.62';
            }
        }

        // ============================================================================
        // RISK MANAGEMENT TUTORIAL IMPLEMENTATION
        // ============================================================================

        let currentRiskManagementStep = 0;

        window.nextRiskManagementStep = function() {
            const tutorial = tutorialContent['risk-management'];
            if (currentRiskManagementStep < tutorial.totalSteps - 1) {
                currentRiskManagementStep++;
                updateRiskManagementStep();
            }
        }

        window.previousRiskManagementStep = function() {
            if (currentRiskManagementStep > 0) {
                currentRiskManagementStep--;
                updateRiskManagementStep();
            }
        }
        
        function updateRiskManagementStep() {
            const tutorial = tutorialContent['risk-management'];
            const step = tutorial.steps[currentRiskManagementStep];
            
            // Update progress
            document.getElementById('riskManagementProgress').textContent = `Step ${currentRiskManagementStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentRiskManagementStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('riskManagementProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('riskManagementStep').innerHTML = `
                <div class="text-lg font-semibold text-emerald-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('riskInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('riskManagementPrevBtn');
            const nextBtn = document.getElementById('riskManagementNextBtn');
            
            prevBtn.disabled = currentRiskManagementStep === 0;
            prevBtn.className = currentRiskManagementStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentRiskManagementStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentRiskManagementStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    // Show completion message in the UI
                    document.getElementById('riskManagementStep').innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center"><div class="text-green-800 text-xl font-semibold mb-2">🎉 Tutorial Complete!</div><p class="text-green-700">Outstanding! You now understand professional risk management.</p></div>';
                };
            } else {
                nextBtn.onclick = nextRiskManagementStep;
            }
            
            // Update risk calculations
            updateRiskManagementCalculation();
        }
        
        function initializeRiskManagementSliders() {
            const portfolioSlider = document.getElementById('portfolioSlider');
            const riskSlider = document.getElementById('riskSlider');
            const winRateSlider = document.getElementById('winRateSlider');
            
            if (portfolioSlider) {
                portfolioSlider.addEventListener('input', function() {
                    document.getElementById('portfolioSize').textContent = `$${parseInt(this.value).toLocaleString()}`;
                    updateRiskManagementCalculation();
                });
            }
            
            if (riskSlider) {
                riskSlider.addEventListener('input', function() {
                    document.getElementById('riskPerTrade').textContent = `${this.value}%`;
                    updateRiskManagementCalculation();
                });
            }
            
            if (winRateSlider) {
                winRateSlider.addEventListener('input', function() {
                    document.getElementById('winRate').textContent = `${this.value}%`;
                    updateRiskManagementCalculation();
                });
            }
            
            // Initial calculation
            updateRiskManagementCalculation();
        }
        
        function updateRiskManagementCalculation() {
            try {
                const portfolioSize = parseFloat(document.getElementById('portfolioSlider')?.value) || 10000;
                const riskPerTrade = parseFloat(document.getElementById('riskSlider')?.value) / 100 || 0.02;
                const winRate = parseFloat(document.getElementById('winRateSlider')?.value) / 100 || 0.6;
                
                // Risk calculations
                const maxLoss = portfolioSize * riskPerTrade;
                const averageOptionCost = 3.00; // Assume $3 option
                const positionSize = Math.floor(maxLoss / (averageOptionCost * 0.5 * 100)); // 50% stop loss, 100 shares per contract
                
                // Expected value calculation (simplified)
                const averageWin = 150; // $150 average win
                const averageLoss = 150; // $150 average loss (50% stop loss)
                const expectedValue = (winRate * averageWin) - ((1 - winRate) * averageLoss);
                
                // Kelly Criterion: f = (bp - q) / b where b=odds, p=win rate, q=loss rate
                const payoutRatio = averageWin / averageLoss;
                const kelly = Math.max(0, (payoutRatio * winRate - (1 - winRate)) / payoutRatio);
                
                // Simplified Risk of Ruin calculation
                const riskOfRuin = Math.pow((1 - winRate) / winRate, portfolioSize / maxLoss) * 100;
                
                // Update displays
                document.getElementById('maxLossPerTrade').textContent = `$${Math.round(maxLoss)}`;
                document.getElementById('positionSize').textContent = `${Math.max(1, positionSize)} contract${positionSize !== 1 ? 's' : ''}`;
                document.getElementById('expectedValue').textContent = expectedValue > 0 ? `+$${Math.round(expectedValue)}` : `-$${Math.round(Math.abs(expectedValue))}`;
                document.getElementById('kellyCriterion').textContent = `${(kelly * 100).toFixed(1)}%`;
                document.getElementById('riskOfRuin').textContent = `${Math.min(99.9, riskOfRuin).toFixed(1)}%`;
                
            } catch (error) {
                console.warn('Risk management tutorial calculation error:', error);
                // Show default values
                document.getElementById('maxLossPerTrade').textContent = '$200';
                document.getElementById('positionSize').textContent = '2 contracts';
                document.getElementById('expectedValue').textContent = '+$24';
                document.getElementById('kellyCriterion').textContent = '3.6%';
                document.getElementById('riskOfRuin').textContent = '8.2%';
            }
        }

        // ============================================================================
        // 3D GREEKS SURFACE PLOTS IMPLEMENTATION
        // ============================================================================

        let scene, camera, renderer, surfaceMesh, controls;
        let animationFrame;
        let isRotating = false;

        // Create labeled axes for better understanding
        function createLabeledAxes() {
            // Create axis lines with arrows
            const axisLength = 10;
            const axisGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(axisLength, 0, 0)
            ]);
            
            // X-axis (Stock Price) - Red
            const xAxisMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 });
            const xAxis = new THREE.Line(axisGeometry, xAxisMaterial);
            scene.add(xAxis);
            
            // Y-axis (Time to Expiry) - Blue
            const yAxisGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(0, axisLength, 0)
            ]);
            const yAxisMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });
            const yAxis = new THREE.Line(yAxisGeometry, yAxisMaterial);
            scene.add(yAxis);
            
            // Z-axis (Greek Value) - Green
            const zAxisGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(0, 0, axisLength)
            ]);
            const zAxisMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00 });
            const zAxis = new THREE.Line(zAxisGeometry, zAxisMaterial);
            scene.add(zAxis);
            
            // Add text labels using HTML elements positioned over the 3D scene
            addAxisLabels();
        }
        
        function addAxisLabels() {
            // Create HTML overlay for axis labels
            const container = document.getElementById('threejs-container');
            
            // Remove any existing labels
            const existingLabels = container.querySelectorAll('.axis-label');
            existingLabels.forEach(label => label.remove());
            
            // X-axis label (Stock Price)
            const xLabel = document.createElement('div');
            xLabel.className = 'axis-label';
            xLabel.innerHTML = 'Stock Price →';
            xLabel.style.cssText = 'position: absolute; color: #ff4444; font-weight: bold; font-size: 14px; bottom: 45%; right: 10px; pointer-events: none; text-shadow: 0 0 3px rgba(0,0,0,0.8);';
            container.appendChild(xLabel);
            
            // Y-axis label (Time to Expiry)
            const yLabel = document.createElement('div');
            yLabel.className = 'axis-label';
            yLabel.innerHTML = '↑ Time to Expiry';
            yLabel.style.cssText = 'position: absolute; color: #4444ff; font-weight: bold; font-size: 14px; top: 10px; left: 50%; transform: translateX(-50%); pointer-events: none; text-shadow: 0 0 3px rgba(0,0,0,0.8);';
            container.appendChild(yLabel);
            
            // Z-axis label (Greek Value)
            const zLabel = document.createElement('div');
            zLabel.className = 'axis-label';
            zLabel.innerHTML = '↗ Greek Value';
            zLabel.style.cssText = 'position: absolute; color: #44ff44; font-weight: bold; font-size: 14px; top: 45%; left: 10px; pointer-events: none; text-shadow: 0 0 3px rgba(0,0,0,0.8);';
            container.appendChild(zLabel);
            
            // Add scale indicators
            const scaleInfo = document.createElement('div');
            scaleInfo.className = 'axis-label';
            scaleInfo.innerHTML = `
                <div style="font-size: 11px; color: #ccc; line-height: 1.2;">
                    <div>📈 X: Stock Price (60-140)</div>
                    <div>⏰ Y: Time to Expiry (1-90 days)</div>  
                    <div>📊 Z: Greek Value (varies)</div>
                </div>
            `;
            scaleInfo.style.cssText = 'position: absolute; bottom: 10px; left: 10px; pointer-events: none; text-shadow: 0 0 3px rgba(0,0,0,0.8);';
            container.appendChild(scaleInfo);
        }

        function initialize3DVisualization() {
            const container = document.getElementById('threejs-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(15, 15, 15);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Clear container and add renderer
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Controls setup (OrbitControls)
            if (typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.enableRotate = true;
                controls.enablePan = true;
            }

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x00ffff, 0.5);
            pointLight.position.set(-10, 10, -5);
            scene.add(pointLight);

            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20, 0x666666, 0x444444);
            gridHelper.position.y = -5;
            scene.add(gridHelper);

            // Add labeled axis helpers
            createLabeledAxes();

            // Start animation loop
            animate3D();

            console.log('3D Visualization initialized successfully');
        }

        function generate3DSurface() {
            const greekType = document.getElementById('greek3D').value;
            const baseStock = parseFloat(document.getElementById('base3DStock').value);
            const strike = parseFloat(document.getElementById('strike3D').value);
            const volatility = parseFloat(document.getElementById('vol3D').value) / 100;

            // Remove existing surface
            if (surfaceMesh) {
                scene.remove(surfaceMesh);
            }

            // Generate surface data
            const resolution = 30;
            const stockRange = baseStock * 0.4; // ±40% range
            const timeRange = 90; // 0-90 days

            const geometry = new THREE.PlaneGeometry(20, 20, resolution - 1, resolution - 1);
            const vertices = geometry.attributes.position.array;
            const colors = [];

            let minValue = Infinity;
            let maxValue = -Infinity;

            // Calculate Greeks for each point
            for (let i = 0; i < resolution; i++) {
                for (let j = 0; j < resolution; j++) {
                    const stockPrice = baseStock + (stockRange * 2 * (i / (resolution - 1)) - stockRange);
                    const timeToExpiry = (timeRange * (j / (resolution - 1)) + 1) / 365; // 1-90 days
                    
                    // Calculate Greek value using our pricing library
                    try {
                        const greeks = pricingLibrary.calculateGreeks({
                            stockPrice: stockPrice,
                            strikePrice: strike,
                            timeToExpiry: timeToExpiry,
                            riskFreeRate: 0.04,
                            volatility: volatility,
                            dividendYield: 0.015,
                            optionType: 'call',
                            exerciseStyle: 'american'
                        });

                        let value = 0;
                        switch (greekType) {
                            case 'delta':
                                value = greeks.delta;
                                break;
                            case 'gamma':
                                value = greeks.gamma;
                                break;
                            case 'theta':
                                value = greeks.theta * 365; // Convert to per-year for better scaling
                                break;
                            case 'vega':
                                value = greeks.vega * 100; // Convert to per-vol-point for better scaling
                                break;
                        }

                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = value * 3; // Scale Z for visibility

                        minValue = Math.min(minValue, value);
                        maxValue = Math.max(maxValue, value);

                        // Color based on value (heat map)
                        const normalizedValue = (value - minValue) / (maxValue - minValue) || 0;
                        const color = new THREE.Color();
                        color.setHSL(0.7 * (1 - normalizedValue), 0.8, 0.5); // Blue to Red gradient
                        colors.push(color.r, color.g, color.b);

                    } catch (error) {
                        console.warn('Error calculating Greeks:', error);
                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = 0;
                        colors.push(0.5, 0.5, 0.5); // Gray for errors
                    }
                }
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            // Create surface material
            const material = new THREE.MeshLambertMaterial({
                vertexColors: true,
                side: THREE.DoubleSide,
                wireframe: false
            });

            // Create mesh
            surfaceMesh = new THREE.Mesh(geometry, material);
            surfaceMesh.rotation.x = -Math.PI / 2; // Rotate to make it horizontal
            surfaceMesh.castShadow = true;
            surfaceMesh.receiveShadow = true;

            scene.add(surfaceMesh);

            // Update analysis display
            updateSurfaceAnalysis(greekType, minValue, maxValue, baseStock, strike, volatility * 100);

            // Show analysis section
            document.getElementById('surface-analysis').style.display = 'grid';
            
            console.log(`3D ${greekType} surface generated with range: ${minValue.toFixed(4)} to ${maxValue.toFixed(4)}`);
        }

        function updateSurfaceAnalysis(greekType, minValue, maxValue, stockPrice, strike, volatility) {
            // Update statistics
            document.getElementById('max-value').textContent = maxValue.toFixed(4);
            document.getElementById('min-value').textContent = minValue.toFixed(4);
            document.getElementById('value-range').textContent = (maxValue - minValue).toFixed(4);

            // Generate insights based on Greek type
            const insightText = document.getElementById('insight-text');
            let insights = '';

            switch (greekType) {
                case 'delta':
                    insights = `
                        <div class="mb-2"><strong>Delta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Peak at strike price ($${strike})</div>
                            <div>• Call delta: 0 (far OTM) → 1 (far ITM)</div>
                            <div>• Steepest slope around at-the-money</div>
                            <div>• Less time sensitivity for far ITM/OTM</div>
                        </div>
                    `;
                    break;
                case 'gamma':
                    insights = `
                        <div class="mb-2"><strong>Gamma Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Decreases rapidly away from strike</div>
                            <div>• Increases as expiration approaches</div>
                            <div>• Near zero for far ITM/OTM options</div>
                        </div>
                    `;
                    break;
                case 'theta':
                    insights = `
                        <div class="mb-2"><strong>Theta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Most negative (decay) at-the-money</div>
                            <div>• Accelerates as expiration approaches</div>
                            <div>• Lower time decay for far ITM/OTM</div>
                            <div>• Time decay is option holder's enemy</div>
                        </div>
                    `;
                    break;
                case 'vega':
                    insights = `
                        <div class="mb-2"><strong>Vega Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Increases with more time to expiry</div>
                            <div>• Near zero for far ITM/OTM options</div>
                            <div>• Volatility=${volatility}% impacts premium</div>
                        </div>
                    `;
                    break;
            }

            insightText.innerHTML = insights;
        }

        function animate3D() {
            animationFrame = requestAnimationFrame(animate3D);

            if (controls) {
                controls.update();
            }

            if (isRotating && surfaceMesh) {
                surfaceMesh.rotation.z += 0.005;
            }

            renderer.render(scene, camera);
        }

        function toggle3DRotation() {
            isRotating = !isRotating;
            const button = document.getElementById('rotate3D');
            button.textContent = isRotating ? '⏸️ Stop Rotation' : '🔄 Auto Rotate';
        }

        // Practice Playground Functions
        function showPracticeTool(toolType) {
            // Hide all practice tools
            document.querySelectorAll('.practice-tool').forEach(tool => {
                tool.classList.add('hidden');
            });

            // Remove active state from all buttons
            document.querySelectorAll('.practice-tool-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
            });

            // Show selected tool
            const tool = document.getElementById(`${toolType}-tool`);
            if (tool) {
                tool.classList.remove('hidden');
            }

            // Add active state to clicked button
            event.target.closest('.practice-tool-btn').classList.add('ring-2', 'ring-offset-2', 'ring-purple-500');

            // Initialize the tool
            switch(toolType) {
                case 'market-scenario':
                    initializeMarketScenario();
                    break;
                case 'strategy-backtest':
                    initializeStrategyBacktest();
                    break;
                case 'greeks-sensitivity':
                    initializeGreeksSensitivity();
                    break;
                case 'volatility-smile':
                    initializeVolatilitySmile();
                    break;
            }
        }

        // Market Scenario Simulator
        function initializeMarketScenario() {
            updateScenario();
        }

        function updateScenario() {
            const days = document.getElementById('scenarioDays').value;
            document.getElementById('scenarioDaysValue').textContent = days;
        }

        function runScenario() {
            const scenarioType = document.getElementById('scenarioType').value;
            const days = parseInt(document.getElementById('scenarioDays').value);
            const position = document.getElementById('scenarioPosition').value;
            const strike = parseFloat(document.getElementById('scenarioStrike').value);
            const stockPrice = parseFloat(document.getElementById('scenarioStock').value);
            const volatility = parseFloat(document.getElementById('scenarioVol').value) / 100;

            // Define scenario parameters
            const scenarios = {
                bull: { drift: 0.20, volatility: 0.15, crashProb: 0.05 },
                bear: { drift: -0.25, volatility: 0.25, crashProb: 0.15 },
                sideways: { drift: 0.02, volatility: 0.05, crashProb: 0.02 },
                crash: { drift: -0.40, volatility: 0.50, crashProb: 0.80 },
                recovery: { drift: 0.30, volatility: 0.20, crashProb: 0.10 },
                volatile: { drift: 0.05, volatility: 0.30, crashProb: 0.20 }
            };

            const scenario = scenarios[scenarioType];
            const timeInYears = days / 365;

            // Simulate price paths
            const numPaths = 100;
            const paths = [];
            let finalPrices = [];

            for (let i = 0; i < numPaths; i++) {
                let currentPrice = stockPrice;
                let path = [currentPrice];

                for (let day = 0; day < days; day++) {
                    // Add crash probability
                    const crashRandom = Math.random();
                    let dailyReturn;
                    
                    if (crashRandom < scenario.crashProb / days) {
                        // Crash event
                        dailyReturn = -0.05 - Math.random() * 0.15; // -5% to -20%
                    } else {
                        // Normal diffusion
                        const dt = 1/365;
                        const drift = scenario.drift * dt;
                        const diffusion = scenario.volatility * Math.sqrt(dt) * normalRandom();
                        dailyReturn = drift + diffusion;
                    }
                    
                    currentPrice = currentPrice * Math.exp(dailyReturn);
                    path.push(currentPrice);
                }
                
                paths.push(path);
                finalPrices.push(currentPrice);
            }

            // Calculate position P&L
            let totalPnL = 0;
            let winCount = 0;
            let maxGain = -Infinity;
            let maxLoss = Infinity;

            finalPrices.forEach(finalPrice => {
                let positionValue = 0;
                
                switch(position) {
                    case 'long-call':
                        positionValue = Math.max(finalPrice - strike, 0) - 5; // assume $5 premium
                        break;
                    case 'long-put':
                        positionValue = Math.max(strike - finalPrice, 0) - 4; // assume $4 premium
                        break;
                    case 'short-call':
                        positionValue = 5 - Math.max(finalPrice - strike, 0);
                        break;
                    case 'short-put':
                        positionValue = 4 - Math.max(strike - finalPrice, 0);
                        break;
                    case 'straddle':
                        const callValue = Math.max(finalPrice - strike, 0);
                        const putValue = Math.max(strike - finalPrice, 0);
                        positionValue = callValue + putValue - 9; // assume $9 total premium
                        break;
                    case 'strangle':
                        const callValueStr = Math.max(finalPrice - (strike + 5), 0);
                        const putValueStr = Math.max((strike - 5) - finalPrice, 0);
                        positionValue = callValueStr + putValueStr - 6; // assume $6 total premium
                        break;
                }
                
                totalPnL += positionValue;
                if (positionValue > 0) winCount++;
                maxGain = Math.max(maxGain, positionValue);
                maxLoss = Math.min(maxLoss, positionValue);
            });

            // Display results
            const avgPnL = totalPnL / numPaths;
            const winRate = (winCount / numPaths) * 100;
            const avgFinalPrice = finalPrices.reduce((a, b) => a + b) / finalPrices.length;

            const resultsHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm font-medium">Average P&L</div>
                        <div class="text-xl font-bold ${avgPnL >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${avgPnL >= 0 ? '+' : ''}$${avgPnL.toFixed(2)}
                        </div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-sm font-medium">Win Rate</div>
                        <div class="text-xl font-bold text-green-600">${winRate.toFixed(1)}%</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-sm font-medium">Max Gain</div>
                        <div class="text-lg font-bold text-purple-600">+$${maxGain.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded">
                        <div class="text-sm font-medium">Max Loss</div>
                        <div class="text-lg font-bold text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded">
                    <div class="text-sm font-medium mb-2">Scenario Analysis</div>
                    <div class="text-sm">
                        Average final stock price: <strong>$${avgFinalPrice.toFixed(2)}</strong><br>
                        Price range: $${Math.min(...finalPrices).toFixed(2)} - $${Math.max(...finalPrices).toFixed(2)}<br>
                        Expected return: <strong>${((avgFinalPrice / stockPrice - 1) * 100).toFixed(1)}%</strong>
                    </div>
                </div>
            `;

            document.getElementById('scenarioResults').innerHTML = resultsHTML;

            // Draw chart
            drawScenarioChart(paths, stockPrice);
        }

        function drawScenarioChart(paths, initialPrice) {
            const canvas = document.getElementById('scenarioChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Find price range
            let minPrice = Infinity, maxPrice = -Infinity;
            paths.forEach(path => {
                path.forEach(price => {
                    minPrice = Math.min(minPrice, price);
                    maxPrice = Math.max(maxPrice, price);
                });
            });
            
            const priceRange = maxPrice - minPrice;
            const timeSteps = paths[0].length - 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // Draw price paths
            ctx.lineWidth = 0.5;
            ctx.globalAlpha = 0.3;
            
            paths.slice(0, 20).forEach((path, pathIndex) => { // Show only 20 paths for clarity
                ctx.strokeStyle = pathIndex % 2 === 0 ? '#3B82F6' : '#8B5CF6';
                ctx.beginPath();
                
                path.forEach((price, timeIndex) => {
                    const x = padding + (timeIndex / timeSteps) * (width - 2 * padding);
                    const y = height - padding - ((price - minPrice) / priceRange) * (height - 2 * padding);
                    
                    if (timeIndex === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            });
            
            // Draw initial price line
            ctx.globalAlpha = 1;
            ctx.strokeStyle = '#EF4444';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const initialY = height - padding - ((initialPrice - minPrice) / priceRange) * (height - 2 * padding);
            ctx.beginPath();
            ctx.moveTo(padding, initialY);
            ctx.lineTo(width - padding, initialY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.fillText(`$${minPrice.toFixed(0)}`, 5, height - padding + 15);
            ctx.fillText(`$${maxPrice.toFixed(0)}`, 5, padding + 5);
            ctx.fillText('Start', padding - 10, height - 20);
            ctx.fillText('End', width - padding - 10, height - 20);
        }

        // Strategy Backtesting
        function initializeStrategyBacktest() {
            updateBacktest();
        }

        function updateBacktest() {
            // Update displays when parameters change
        }

        function runBacktest() {
            const strategy = document.getElementById('backtestStrategy').value;
            const entryDTE = parseInt(document.getElementById('backtestDTE').value);
            const exitDTE = parseInt(document.getElementById('backtestExitDTE').value);
            const profitTarget = parseFloat(document.getElementById('backtestProfitTarget').value) / 100;
            const stopLoss = parseFloat(document.getElementById('backtestStopLoss').value) / 100;

            // Simulate historical trades
            const numTrades = 50;
            const trades = [];
            let totalPnL = 0;
            let winCount = 0;

            for (let i = 0; i < numTrades; i++) {
                // Generate random market conditions
                const initialPrice = 100 + Math.random() * 100; // $100-$200
                const initialVol = 0.15 + Math.random() * 0.25; // 15-40%
                const daysHeld = Math.random() < 0.7 ? exitDTE : entryDTE; // 70% exit at target DTE
                
                // Simulate price movement
                const drift = (Math.random() - 0.5) * 0.2; // -10% to +10%
                const finalPrice = initialPrice * Math.exp(drift + initialVol * Math.sqrt(daysHeld/365) * normalRandom());
                
                let tradePnL = 0;
                
                // Calculate P&L based on strategy
                switch(strategy) {
                    case 'covered-call':
                        const callStrike = initialPrice * 1.05;
                        const callPremium = initialPrice * 0.03;
                        const stockGain = finalPrice - initialPrice;
                        const callLoss = Math.max(finalPrice - callStrike, 0);
                        tradePnL = stockGain + callPremium - callLoss;
                        break;
                    case 'cash-secured-put':
                        const putStrike = initialPrice * 0.95;
                        const putPremium = initialPrice * 0.025;
                        const putLoss = Math.max(putStrike - finalPrice, 0);
                        tradePnL = putPremium - putLoss;
                        break;
                    case 'iron-condor':
                        const icPremium = initialPrice * 0.02;
                        const lowerStrike = initialPrice * 0.95;
                        const upperStrike = initialPrice * 1.05;
                        if (finalPrice >= lowerStrike && finalPrice <= upperStrike) {
                            tradePnL = icPremium; // Max profit
                        } else {
                            const loss = Math.min(Math.abs(finalPrice - lowerStrike), Math.abs(finalPrice - upperStrike));
                            tradePnL = icPremium - loss;
                        }
                        break;
                    default:
                        tradePnL = Math.random() * 20 - 10; // -$10 to +$10
                }
                
                // Apply profit target and stop loss
                const premiumReceived = initialPrice * 0.025;
                if (tradePnL > premiumReceived * profitTarget) {
                    tradePnL = premiumReceived * profitTarget;
                } else if (tradePnL < -premiumReceived * stopLoss) {
                    tradePnL = -premiumReceived * stopLoss;
                }
                
                trades.push(tradePnL);
                totalPnL += tradePnL;
                if (tradePnL > 0) winCount++;
            }

            // Calculate metrics
            const avgPnL = totalPnL / numTrades;
            const winRate = (winCount / numTrades) * 100;
            const maxWin = Math.max(...trades);
            const maxLoss = Math.min(...trades);
            const sharpeRatio = (avgPnL / Math.sqrt(trades.reduce((sum, pnl) => sum + pnl * pnl, 0) / numTrades)).toFixed(2);

            const resultsHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm font-medium">Average P&L</div>
                        <div class="text-lg font-bold ${avgPnL >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${avgPnL >= 0 ? '+' : ''}$${avgPnL.toFixed(2)}
                        </div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-sm font-medium">Win Rate</div>
                        <div class="text-lg font-bold text-green-600">${winRate.toFixed(1)}%</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-sm font-medium">Max Win</div>
                        <div class="text-lg font-bold text-purple-600">+$${maxWin.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded">
                        <div class="text-sm font-medium">Max Loss</div>
                        <div class="text-lg font-bold text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-gray-50 p-2 rounded">
                        <strong>Sharpe Ratio:</strong> ${sharpeRatio}
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <strong>Total Trades:</strong> ${numTrades}
                    </div>
                </div>
            `;

            document.getElementById('backtestResults').innerHTML = resultsHTML;

            // Draw performance chart
            drawBacktestChart(trades);
        }

        function drawBacktestChart(trades) {
            const canvas = document.getElementById('backtestChart');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 30;
            
            // Calculate cumulative P&L
            let cumPnL = [0];
            trades.forEach(trade => {
                cumPnL.push(cumPnL[cumPnL.length - 1] + trade);
            });
            
            const maxCum = Math.max(...cumPnL);
            const minCum = Math.min(...cumPnL);
            const range = Math.max(Math.abs(maxCum), Math.abs(minCum), 10);
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // Draw zero line
            const zeroY = height - padding - (range / (2 * range)) * (height - 2 * padding);
            ctx.strokeStyle = '#999';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(padding, zeroY);
            ctx.lineTo(width - padding, zeroY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw performance line
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            cumPnL.forEach((pnl, index) => {
                const x = padding + (index / (cumPnL.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((pnl + range) / (2 * range)) * (height - 2 * padding);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
        }

        // Greeks Sensitivity Analysis
        function initializeGreeksSensitivity() {
            updateSensitivity();
        }

        function updateSensitivity() {
            // Update displays when parameters change
        }

        function runSensitivityAnalysis() {
            const focusGreek = document.getElementById('sensitivityGreek').value;
            const stockMin = parseFloat(document.getElementById('sensitivityStockMin').value);
            const stockMax = parseFloat(document.getElementById('sensitivityStockMax').value);
            const timeMin = parseFloat(document.getElementById('sensitivityTimeMin').value);
            const timeMax = parseFloat(document.getElementById('sensitivityTimeMax').value);
            const strike = parseFloat(document.getElementById('sensitivityStrike').value);
            const vol = parseFloat(document.getElementById('sensitivityVol').value) / 100;
            const optionType = document.getElementById('sensitivityType').value;

            // Generate sensitivity data
            const stockPrices = [];
            const greekValues = [];
            const timeValues = [];
            
            for (let price = stockMin; price <= stockMax; price += (stockMax - stockMin) / 20) {
                stockPrices.push(price);
                
                // Calculate Greek for current price and mid-time
                const midTime = (timeMin + timeMax) / 2;
                const timeToExpiry = midTime / 365;
                const greekValue = calculateGreekForPrice(price, strike, timeToExpiry, vol, optionType, focusGreek);
                greekValues.push(greekValue);
            }
            
            for (let time = timeMin; time <= timeMax; time += (timeMax - timeMin) / 20) {
                timeValues.push(time);
            }

            // Display sensitivity metrics
            const maxGreek = Math.max(...greekValues);
            const minGreek = Math.min(...greekValues);
            const avgGreek = greekValues.reduce((a, b) => a + b, 0) / greekValues.length;
            const range = maxGreek - minGreek;

            const resultsHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm font-medium">Max ${focusGreek.toUpperCase()}</div>
                        <div class="text-lg font-bold text-blue-600">${maxGreek.toFixed(4)}</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-sm font-medium">Min ${focusGreek.toUpperCase()}</div>
                        <div class="text-lg font-bold text-green-600">${minGreek.toFixed(4)}</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-sm font-medium">Average ${focusGreek.toUpperCase()}</div>
                        <div class="text-lg font-bold text-purple-600">${avgGreek.toFixed(4)}</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded">
                        <div class="text-sm font-medium">Range</div>
                        <div class="text-lg font-bold text-yellow-600">${range.toFixed(4)}</div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-gray-50 rounded text-sm">
                    <strong>Analysis:</strong> ${getGreekAnalysis(focusGreek, maxGreek, minGreek, avgGreek)}
                </div>
            `;

            document.getElementById('sensitivityResults').innerHTML = resultsHTML;

            // Draw sensitivity chart
            drawSensitivityChart(stockPrices, greekValues, focusGreek);
        }

        function calculateGreekForPrice(stockPrice, strike, timeToExpiry, volatility, optionType, greekType) {
            // Simplified Black-Scholes Greeks calculation
            const r = 0.04; // risk-free rate
            const d1 = (Math.log(stockPrice / strike) + (r + 0.5 * volatility * volatility) * timeToExpiry) / 
                      (volatility * Math.sqrt(timeToExpiry));
            const d2 = d1 - volatility * Math.sqrt(timeToExpiry);
            
            const N = (x) => 0.5 * (1 + erf(x / Math.sqrt(2)));
            const nPrime = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            
            const callMultiplier = optionType === 'call' ? 1 : -1;
            
            switch(greekType) {
                case 'delta':
                    return optionType === 'call' ? N(d1) : N(d1) - 1;
                case 'gamma':
                    return nPrime(d1) / (stockPrice * volatility * Math.sqrt(timeToExpiry));
                case 'theta':
                    const term1 = -(stockPrice * nPrime(d1) * volatility) / (2 * Math.sqrt(timeToExpiry));
                    const term2 = callMultiplier * r * strike * Math.exp(-r * timeToExpiry) * N(callMultiplier * d2);
                    return (term1 - term2) / 365;
                case 'vega':
                    return stockPrice * nPrime(d1) * Math.sqrt(timeToExpiry) / 100;
                case 'rho':
                    return callMultiplier * strike * timeToExpiry * Math.exp(-r * timeToExpiry) * N(callMultiplier * d2) / 100;
                default:
                    return 0;
            }
        }

        function getGreekAnalysis(greekType, max, min, avg) {
            switch(greekType) {
                case 'delta':
                    return "Delta shows price sensitivity. Values closer to ±1 indicate higher directional exposure.";
                case 'gamma':
                    return "Gamma shows delta sensitivity. Higher gamma means delta changes rapidly with price moves.";
                case 'theta':
                    return "Theta shows time decay. Negative values indicate daily value loss for long positions.";
                case 'vega':
                    return "Vega shows volatility sensitivity. Higher vega means more exposure to IV changes.";
                case 'rho':
                    return "Rho shows interest rate sensitivity. Usually minimal impact for short-term options.";
                default:
                    return "Greek sensitivity analysis across price and time dimensions.";
            }
        }

        function drawSensitivityChart(prices, values, greekName) {
            const canvas = document.getElementById('sensitivityChart');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // Draw Greek curve
            ctx.strokeStyle = '#10B981';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            values.forEach((value, index) => {
                const x = padding + (index / (values.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((value - minVal) / range) * (height - 2 * padding);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.fillText(greekName.toUpperCase(), width / 2 - 20, 20);
            ctx.fillText(`$${prices[0]}`, padding - 10, height - 20);
            ctx.fillText(`$${prices[prices.length - 1]}`, width - padding - 20, height - 20);
        }

        // Volatility Smile Explorer
        function initializeVolatilitySmile() {
            updateVolatilitySmile();
        }

        function updateVolatilitySmile() {
            const skew = document.getElementById('smileSkew').value;
            const curvature = document.getElementById('smileCurvature').value;
            document.getElementById('skewValue').textContent = skew;
            document.getElementById('curvatureValue').textContent = curvature;
        }

        function generateVolatilitySmile() {
            const regime = document.getElementById('smileRegime').value;
            const stockPrice = parseFloat(document.getElementById('smileStock').value);
            const atmVol = parseFloat(document.getElementById('smileATMVol').value) / 100;
            const skew = parseFloat(document.getElementById('smileSkew').value) / 100;
            const curvature = parseFloat(document.getElementById('smileCurvature').value) / 100;
            const days = parseFloat(document.getElementById('smileDays').value);

            // Generate volatility smile data
            const strikes = [];
            const impliedVols = [];
            
            for (let strike = stockPrice * 0.8; strike <= stockPrice * 1.2; strike += stockPrice * 0.05) {
                strikes.push(strike);
                
                // Calculate moneyness
                const moneyness = Math.log(strike / stockPrice);
                
                // Base smile formula: ATM vol + skew * moneyness + curvature * moneyness^2
                let iv = atmVol + skew * moneyness + curvature * moneyness * moneyness;
                
                // Adjust for market regime
                switch(regime) {
                    case 'stressed':
                        iv *= 1.3; // Higher overall vol
                        iv += Math.abs(moneyness) * 0.1; // Steeper smile
                        break;
                    case 'earnings':
                        iv *= 1.5; // Much higher vol
                        if (Math.abs(moneyness) < 0.05) iv *= 1.2; // ATM spike
                        break;
                    case 'crash':
                        iv *= 1.1;
                        if (moneyness < 0) iv *= 1.4; // Put skew
                        break;
                }
                
                // Add time decay effect
                const timeDecay = Math.exp(-days / 365);
                iv *= (1 + 0.2 * (1 - timeDecay)); // More vol for longer time
                
                impliedVols.push(Math.max(iv, 0.05)); // Minimum 5% vol
            }

            // Display analysis
            const maxIV = Math.max(...impliedVols) * 100;
            const minIV = Math.min(...impliedVols) * 100;
            const avgIV = (impliedVols.reduce((a, b) => a + b, 0) / impliedVols.length) * 100;
            const atmIndex = Math.floor(impliedVols.length / 2);
            const atmIV = impliedVols[atmIndex] * 100;

            const analysisHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm font-medium">ATM IV</div>
                        <div class="text-lg font-bold text-blue-600">${atmIV.toFixed(1)}%</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-sm font-medium">Max IV</div>
                        <div class="text-lg font-bold text-green-600">${maxIV.toFixed(1)}%</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-sm font-medium">Min IV</div>
                        <div class="text-lg font-bold text-purple-600">${minIV.toFixed(1)}%</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded">
                        <div class="text-sm font-medium">IV Range</div>
                        <div class="text-lg font-bold text-yellow-600">${(maxIV - minIV).toFixed(1)}%</div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-gray-50 rounded text-sm">
                    <strong>Smile Shape:</strong> ${getSmileAnalysis(regime, skew, curvature)}
                </div>
            `;

            document.getElementById('smileAnalysis').innerHTML = analysisHTML;

            // Draw volatility smile chart
            drawVolatilitySmileChart(strikes, impliedVols, stockPrice);
        }

        function getSmileAnalysis(regime, skew, curvature) {
            let analysis = "";
            
            if (skew < -0.02) {
                analysis += "Strong put skew (higher put IV). ";
            } else if (skew > 0.02) {
                analysis += "Call skew (higher call IV). ";
            } else {
                analysis += "Symmetric smile. ";
            }
            
            if (curvature > 0.05) {
                analysis += "High curvature indicates fear of large moves. ";
            }
            
            switch(regime) {
                case 'stressed':
                    analysis += "Stressed market shows elevated volatility across all strikes.";
                    break;
                case 'earnings':
                    analysis += "Earnings event creates volatility spike, especially ATM.";
                    break;
                case 'crash':
                    analysis += "Post-crash regime shows pronounced put skew and elevated vol.";
                    break;
                default:
                    analysis += "Normal market conditions with typical smile pattern.";
            }
            
            return analysis;
        }

        function drawVolatilitySmileChart(strikes, ivs, spotPrice) {
            const canvas = document.getElementById('volatilitySmileChart');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            const minIV = Math.min(...ivs);
            const maxIV = Math.max(...ivs);
            const ivRange = maxIV - minIV || 0.01;
            
            const minStrike = Math.min(...strikes);
            const maxStrike = Math.max(...strikes);
            const strikeRange = maxStrike - minStrike;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // Draw volatility smile
            ctx.strokeStyle = '#F59E0B';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            strikes.forEach((strike, index) => {
                const x = padding + ((strike - minStrike) / strikeRange) * (width - 2 * padding);
                const y = height - padding - ((ivs[index] - minIV) / ivRange) * (height - 2 * padding);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw ATM line
            ctx.strokeStyle = '#EF4444';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const atmX = padding + ((spotPrice - minStrike) / strikeRange) * (width - 2 * padding);
            ctx.beginPath();
            ctx.moveTo(atmX, padding);
            ctx.lineTo(atmX, height - padding);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.fillText('IV', 5, 20);
            ctx.fillText('Strike', width / 2, height - 5);
            ctx.fillText('ATM', atmX - 10, height - 10);
            ctx.fillText(`${(minIV * 100).toFixed(0)}%`, 5, height - padding + 15);
            ctx.fillText(`${(maxIV * 100).toFixed(0)}%`, 5, padding + 5);
        }


        // Event listeners for 3D functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize 3D scene when the page loads
            setTimeout(initialize3DVisualization, 500);

            // Event listeners
            document.getElementById('generate3D').addEventListener('click', generate3DSurface);
            document.getElementById('rotate3D').addEventListener('click', toggle3DRotation);

            // Auto-generate initial surface
            setTimeout(() => {
                generate3DSurface();
            }, 1000);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (camera && renderer) {
                    const container = document.getElementById('threejs-container');
                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                }
            });
        });

        // ==========================================
        // PHASE 3: LIVE MARKET INTEGRATION FEATURES
        // ==========================================

        // Market tools state management
        let currentMarketTool = 'options-chain';
        let optionsChainData = [];
        let ivSurfaceRenderer = null;

        // Show market tool function
        window.showMarketTool = function(toolName) {
            // Update button styles
            document.querySelectorAll('.market-tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-orange-600');
                btn.classList.add('bg-gray-400');
            });
            
            // Hide all tool content
            document.querySelectorAll('.market-tool-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tool
            const toolElement = document.getElementById(toolName + 'Tool');
            if (toolElement) {
                toolElement.classList.remove('hidden');
            }
            
            // Update active button
            const activeBtn = document.getElementById(toolName === 'options-chain' ? 'optionsChainBtn' : 
                                                   toolName === 'iv-surface' ? 'ivSurfaceBtn' :
                                                   toolName === 'market-maker' ? 'marketMakerBtn' : 'learningPathsBtn');
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-400');
                activeBtn.classList.add(toolName === 'options-chain' ? 'bg-blue-600' : 
                                       toolName === 'iv-surface' ? 'bg-green-600' :
                                       toolName === 'market-maker' ? 'bg-purple-600' : 'bg-orange-600');
            }
            
            currentMarketTool = toolName;
            
            // Initialize tool-specific features
            if (toolName === 'iv-surface') {
                setTimeout(() => initializeIVSurface3D(), 500);
            } else if (toolName === 'market-maker') {
                setTimeout(() => initializeMarketMakerCharts(), 500);
            }
        };

        // Generate Options Chain
        window.generateOptionsChain = function() {
            const symbol = document.getElementById('chainSymbol').value;
            const expiration = parseInt(document.getElementById('chainExpiration').value);
            const moneynessRange = parseInt(document.getElementById('chainMoneyness').value);
            
            // Get current price for the symbol (simulated data)
            const stockPrices = {
                'SPY': 450.25,
                'AAPL': 175.80,
                'MSFT': 332.50,
                'TSLA': 245.60,
                'NVDA': 485.90
            };
            
            const currentPrice = stockPrices[symbol] || 450.25;
            
            // Update market statistics
            document.getElementById('currentPrice').textContent = `$${currentPrice.toFixed(2)}`;
            document.getElementById('avgImpliedVol').textContent = `${(18 + Math.random() * 10).toFixed(1)}%`;
            document.getElementById('putCallRatio').textContent = (0.7 + Math.random() * 0.4).toFixed(2);
            document.getElementById('totalVolume').textContent = (Math.random() * 5000000).toLocaleString();
            
            // Generate option chain data
            optionsChainData = [];
            const numStrikes = Math.ceil(moneynessRange / 5) * 10;
            const strikeSpacing = currentPrice * 0.01; // 1% spacing
            
            const container = document.getElementById('optionsChainData');
            container.innerHTML = '';
            
            for (let i = -numStrikes/2; i <= numStrikes/2; i++) {
                if (i === 0) continue; // Skip at-the-money for cleaner display
                
                const strike = Math.round((currentPrice + (i * strikeSpacing)) / 5) * 5; // Round to nearest $5
                if (strike <= 0) continue;
                
                const isITM_call = currentPrice > strike;
                const isITM_put = currentPrice < strike;
                
                // Calculate theoretical prices using our pricing library
                const timeToExpiry = expiration / 365.0;
                const volatility = 0.20 + (Math.abs(i) * 0.002) + (Math.random() - 0.5) * 0.05; // Volatility smile
                
                const callPrice = pricingLibrary ? pricingLibrary.priceOption({
                    stockPrice: currentPrice,
                    strikePrice: strike,
                    daysToExpiry: expiration,
                    volatility: Math.max(0.1, volatility),
                    optionType: 'call'
                }) : Math.max(0.05, (isITM_call ? currentPrice - strike : 0) + Math.random() * 3);
                
                const putPrice = pricingLibrary ? pricingLibrary.priceOption({
                    stockPrice: currentPrice,
                    strikePrice: strike,
                    daysToExpiry: expiration,
                    volatility: Math.max(0.1, volatility),
                    optionType: 'put'
                }) : Math.max(0.05, (isITM_put ? strike - currentPrice : 0) + Math.random() * 3);
                
                // Simulate volume and IV
                const callVolume = Math.floor(Math.random() * 1000 + 100);
                const putVolume = Math.floor(Math.random() * 800 + 50);
                const callIV = (volatility * 100).toFixed(1);
                const putIV = (volatility * 100 + (Math.random() - 0.5) * 2).toFixed(1);
                
                // Create row
                const row = document.createElement('div');
                row.className = 'grid grid-cols-7 gap-1 text-xs py-1 ' + (Math.abs(currentPrice - strike) < strikeSpacing * 2 ? 'bg-yellow-50' : '');
                
                row.innerHTML = `
                    <div class="text-center text-gray-600">${callVolume}</div>
                    <div class="text-center text-blue-600">${callIV}%</div>
                    <div class="text-center font-mono ${isITM_call ? 'text-green-600 font-semibold' : 'text-gray-700'}">$${callPrice.toFixed(2)}</div>
                    <div class="text-center font-mono bg-blue-50 p-1 rounded font-semibold">$${strike}</div>
                    <div class="text-center font-mono ${isITM_put ? 'text-red-600 font-semibold' : 'text-gray-700'}">$${putPrice.toFixed(2)}</div>
                    <div class="text-center text-purple-600">${putIV}%</div>
                    <div class="text-center text-gray-600">${putVolume}</div>
                `;
                
                container.appendChild(row);
                
                optionsChainData.push({
                    strike, callPrice, putPrice, callVolume, putVolume, callIV: parseFloat(callIV), putIV: parseFloat(putIV)
                });
            }
            
            // Update analysis
            const analysis = document.getElementById('chainAnalysis');
            const avgCallIV = optionsChainData.reduce((sum, row) => sum + row.callIV, 0) / optionsChainData.length;
            const avgPutIV = optionsChainData.reduce((sum, row) => sum + row.putIV, 0) / optionsChainData.length;
            const totalCallVolume = optionsChainData.reduce((sum, row) => sum + row.callVolume, 0);
            const totalPutVolume = optionsChainData.reduce((sum, row) => sum + row.putVolume, 0);
            const putCallVolumeRatio = (totalPutVolume / totalCallVolume).toFixed(2);
            
            analysis.innerHTML = `
                <div class="space-y-2">
                    <div><strong>Volatility Analysis:</strong> Average call IV: ${avgCallIV.toFixed(1)}%, Average put IV: ${avgPutIV.toFixed(1)}%</div>
                    <div><strong>Volume Analysis:</strong> Put/Call volume ratio: ${putCallVolumeRatio} (${putCallVolumeRatio > 1.2 ? 'Bearish' : putCallVolumeRatio < 0.8 ? 'Bullish' : 'Neutral'} sentiment)</div>
                    <div><strong>Moneyness:</strong> Showing ${numStrikes} strikes around current price of $${currentPrice.toFixed(2)}</div>
                </div>
            `;
        };

        // Generate IV Surface
        window.generateIVSurface = function() {
            const symbol = document.getElementById('ivSurfaceSymbol').value;
            const surfaceType = document.getElementById('surfaceType').value;
            
            // Clear previous surface
            const container = document.getElementById('ivSurface3D');
            container.innerHTML = '';
            
            // Create Three.js scene for IV surface
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0xf8f9fa);
            container.appendChild(renderer.domElement);
            
            // Generate IV surface data
            const stockPrice = 450;
            
            if (surfaceType === 'iv-surface') {
                // Create IV surface (Strike vs Time to Expiry)
                const geometry = new THREE.PlaneGeometry(200, 200, 20, 20);
                const positions = geometry.attributes.position;
                
                for (let i = 0; i < positions.count; i++) {
                    const x = positions.getX(i); // Strike dimension
                    const y = positions.getY(i); // Time dimension
                    
                    // Create volatility smile effect
                    const moneyness = (stockPrice + x) / stockPrice;
                    const timeToExpiry = Math.max(0.01, (y + 100) / 200); // 0 to 1 years
                    
                    // Volatility smile: higher IV for OTM options
                    const smile = 0.20 + 0.15 * Math.pow(Math.abs(moneyness - 1), 0.5);
                    // Term structure: higher IV for shorter expirations
                    const term = 1 + 0.3 * Math.exp(-timeToExpiry * 2);
                    const iv = smile * term + (Math.random() - 0.5) * 0.02;
                    
                    positions.setZ(i, iv * 100); // Scale for visualization
                }
                
                positions.needsUpdate = true;
                geometry.computeVertexNormals();
                
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x4f46e5, 
                    wireframe: false, 
                    side: THREE.DoubleSide 
                });
                const surface = new THREE.Mesh(geometry, material);
                scene.add(surface);
                
                // Add wireframe
                const wireframe = new THREE.WireframeGeometry(geometry);
                const line = new THREE.LineSegments(wireframe, new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.3 }));
                scene.add(line);
                
            } else if (surfaceType === 'volatility-smile') {
                // Create 2D volatility smile curve
                const points = [];
                for (let strike = 350; strike <= 550; strike += 5) {
                    const moneyness = strike / stockPrice;
                    const iv = 0.20 + 0.15 * Math.pow(Math.abs(moneyness - 1), 0.5);
                    points.push(new THREE.Vector3((strike - stockPrice) * 2, iv * 200, 0));
                }
                
                const curve = new THREE.CatmullRomCurve3(points);
                const geometry = new THREE.TubeGeometry(curve, 50, 2, 8, false);
                const material = new THREE.MeshBasicMaterial({ color: 0x10b981 });
                const smile = new THREE.Mesh(geometry, material);
                scene.add(smile);
            }
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Position camera
            camera.position.set(150, 100, 150);
            camera.lookAt(0, 0, 0);
            
            // Add controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            // Store reference for cleanup
            ivSurfaceRenderer = { scene, camera, renderer, controls };
        };

        // Initialize IV Surface 3D container
        function initializeIVSurface3D() {
            // Ensure container is ready for 3D rendering
            const container = document.getElementById('ivSurface3D');
            if (container && container.clientWidth > 0) {
                console.log('IV Surface 3D container initialized');
            }
        }

        // Initialize Market Maker Charts
        function initializeMarketMakerCharts() {
            // Bid-Ask Spread Chart
            const bidAskCtx = document.getElementById('bidAskChart');
            if (bidAskCtx) {
                const chart = new Chart(bidAskCtx, {
                    type: 'line',
                    data: {
                        labels: ['400', '410', '420', '430', '440', '450', '460', '470', '480'],
                        datasets: [{
                            label: 'Bid-Ask Spread (%)',
                            data: [0.8, 0.6, 0.4, 0.3, 0.2, 0.2, 0.3, 0.4, 0.6],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Spread (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Strike Price'
                                }
                            }
                        }
                    }
                });
            }

            // Portfolio Greeks Chart
            const portfolioGreeksCtx = document.getElementById('portfolioGreeksChart');
            if (portfolioGreeksCtx) {
                const chart = new Chart(portfolioGreeksCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Delta', 'Gamma', 'Theta', 'Vega', 'Rho'],
                        datasets: [{
                            label: 'Current Position',
                            data: [0.65, 0.02, -0.08, 0.15, 0.03],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            pointBackgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: -0.1,
                                suggestedMax: 0.8
                            }
                        }
                    }
                });
            }
        }

        // Initialize Phase 3 features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize live market section after other initializations
            setTimeout(() => {
                showMarketTool('options-chain');
            }, 1500);
        });

        // Auto-update market data simulation (every 15 seconds)
        setInterval(() => {
            if (currentMarketTool === 'options-chain' && optionsChainData.length > 0) {
                // Simulate minor price changes
                const currentPriceElement = document.getElementById('currentPrice');
                if (currentPriceElement) {
                    const currentPriceText = currentPriceElement.textContent;
                    const price = parseFloat(currentPriceText.replace('$', ''));
                    const change = (Math.random() - 0.5) * 2; // ±$1 change
                    const newPrice = Math.max(0, price + change);
                    currentPriceElement.textContent = `$${newPrice.toFixed(2)}`;
                    
                    // Update visual indicator
                    currentPriceElement.style.color = change > 0 ? '#10b981' : change < 0 ? '#ef4444' : '#374151';
                    setTimeout(() => {
                        currentPriceElement.style.color = '#374151';
                    }, 2000);
                }
            }
        }, 15000);

        // ==========================================
        // PHASE 4A: PROFESSIONAL MARKET DATA FEATURES
        // ==========================================

        // Professional tools state management
        let currentProfessionalTool = 'market-data';
        let marketDataConnection = null;
        let marketDataStats = {
            activeSymbols: 0,
            updatesPerMin: 0,
            dataVolume: 0,
            startTime: null
        };

        // Show professional tool function
        window.showProfessionalTool = function(toolName) {
            // Update button styles
            document.querySelectorAll('.professional-tool-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'bg-blue-600', 'bg-green-600', 'bg-orange-600');
                btn.classList.add('bg-gray-400');
            });
            
            // Hide all tool content
            document.querySelectorAll('.professional-tool-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tool
            const toolElement = document.getElementById(toolName === 'market-data' ? 'marketDataTool' : 
                                                      toolName === 'strategy-optimizer' ? 'strategyOptimizerTool' :
                                                      toolName === 'risk-analytics' ? 'riskAnalyticsTool' : 'portfolioManagerTool');
            if (toolElement) {
                toolElement.classList.remove('hidden');
            }
            
            // Update active button
            const activeBtn = document.getElementById(toolName === 'market-data' ? 'marketDataBtn' : 
                                                    toolName === 'strategy-optimizer' ? 'strategyOptimizerBtn' :
                                                    toolName === 'risk-analytics' ? 'riskAnalyticsBtn' : 'portfolioManagerBtn');
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-400');
                activeBtn.classList.add(toolName === 'market-data' ? 'bg-purple-600' : 
                                       toolName === 'strategy-optimizer' ? 'bg-blue-600' :
                                       toolName === 'risk-analytics' ? 'bg-green-600' : 'bg-orange-600');
            }
            
            currentProfessionalTool = toolName;
            
            // Initialize tool-specific features
            if (toolName === 'risk-analytics') {
                setTimeout(() => initializeRiskAnalytics(), 500);
            }
        };

        // Market Data Connection
        window.connectMarketData = function() {
            const provider = document.getElementById('dataProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // Show/hide API key section based on provider
            const apiKeySection = document.getElementById('apiKeySection');
            const statusElement = document.getElementById('connectionStatus');
            const providerElement = document.getElementById('activeProvider');
            const feedElement = document.getElementById('liveDataFeed');
            
            if (provider !== 'demo') {
                apiKeySection.classList.remove('hidden');
                if (!apiKey) {
                    alert('Please enter your API key for ' + provider);
                    return;
                }
            } else {
                apiKeySection.classList.add('hidden');
            }
            
            // Update connection status
            statusElement.textContent = 'Connecting...';
            statusElement.className = 'font-mono text-yellow-600';
            
            // Simulate connection process
            setTimeout(() => {
                statusElement.textContent = 'Connected';
                statusElement.className = 'font-mono text-green-600';
                
                const providerNames = {
                    'demo': 'Demo Mode',
                    'alphavantage': 'Alpha Vantage',
                    'polygon': 'Polygon.io',
                    'iex': 'IEX Cloud'
                };
                
                providerElement.textContent = providerNames[provider];
                
                // Start market data stream
                startMarketDataStream(provider, feedElement);
                
                // Update stats
                marketDataStats.startTime = new Date();
                marketDataStats.activeSymbols = provider === 'demo' ? 5 : Math.floor(Math.random() * 50) + 10;
                updateMarketDataStats();
                
            }, 2000);
        };

        // Market Data Stream Simulation
        function startMarketDataStream(provider, feedElement) {
            feedElement.innerHTML = '<div class="text-green-600 font-semibold mb-2">📡 Live Market Data Stream</div>';
            
            const symbols = ['SPY', 'QQQ', 'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN'];
            
            // Clear existing interval if any
            if (marketDataConnection) {
                clearInterval(marketDataConnection);
            }
            
            marketDataConnection = setInterval(() => {
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                const price = (100 + Math.random() * 400).toFixed(2);
                const change = (Math.random() - 0.5) * 10;
                const changeStr = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
                const changeColor = change >= 0 ? 'text-green-600' : 'text-red-600';
                const timestamp = new Date().toLocaleTimeString();
                
                const dataEntry = document.createElement('div');
                dataEntry.className = 'flex justify-between text-xs border-b border-gray-200 py-1';
                dataEntry.innerHTML = `
                    <span>${timestamp}</span>
                    <span class="font-semibold">${symbol}</span>
                    <span>$${price}</span>
                    <span class="${changeColor}">${changeStr}</span>
                `;
                
                feedElement.insertBefore(dataEntry, feedElement.children[1] || null);
                
                // Keep only last 20 entries
                while (feedElement.children.length > 21) {
                    feedElement.removeChild(feedElement.lastChild);
                }
                
                // Update stats
                marketDataStats.updatesPerMin += 1;
                marketDataStats.dataVolume += Math.random() * 2;
                
                updateMarketDataStats();
                
            }, provider === 'demo' ? 2000 : 1000); // Demo mode is slower
        }

        // Update Market Data Statistics
        function updateMarketDataStats() {
            document.getElementById('activeSymbols').textContent = marketDataStats.activeSymbols;
            document.getElementById('updatesPerMin').textContent = Math.floor(marketDataStats.updatesPerMin);
            document.getElementById('dataVolume').textContent = Math.floor(marketDataStats.dataVolume) + ' KB';
            
            if (marketDataStats.startTime) {
                const uptime = Math.floor((new Date() - marketDataStats.startTime) / 1000);
                const minutes = Math.floor(uptime / 60);
                const seconds = uptime % 60;
                document.getElementById('uptime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Strategy Optimization
        window.runStrategyOptimization = function() {
            const strategy = document.getElementById('optimizerStrategy').value;
            const objective = document.getElementById('optimizationObjective').value;
            const resultsElement = document.getElementById('optimizationResults');
            
            resultsElement.innerHTML = '<div class="text-center text-blue-600 py-8">🔄 Running optimization...</div>';
            
            // Simulate optimization process
            setTimeout(() => {
                const results = generateOptimizationResults(strategy, objective);
                resultsElement.innerHTML = `
                    <h5 class="font-semibold text-gray-800 mb-4">🎯 Optimization Results</h5>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Strategy:</span>
                            <span class="font-semibold">${strategy.replace('-', ' ').toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Optimal Strike:</span>
                            <span class="font-mono">$${results.optimalStrike}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Expected Return:</span>
                            <span class="font-mono ${results.expectedReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${results.expectedReturn}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Max Risk:</span>
                            <span class="font-mono text-red-600">-$${results.maxRisk}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Profit Probability:</span>
                            <span class="font-mono">${results.profitProb}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Sharpe Ratio:</span>
                            <span class="font-mono">${results.sharpeRatio}</span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
                        <strong>Recommendation:</strong> ${results.recommendation}
                    </div>
                `;
            }, 3000);
        };

        // Generate Optimization Results
        function generateOptimizationResults(strategy, objective) {
            const basePrice = 450;
            const optimalStrike = Math.round((basePrice + (Math.random() - 0.5) * 50) / 5) * 5;
            
            return {
                optimalStrike: optimalStrike,
                expectedReturn: ((Math.random() - 0.3) * 40).toFixed(1),
                maxRisk: (Math.random() * 2000 + 500).toFixed(0),
                profitProb: (Math.random() * 40 + 40).toFixed(1),
                sharpeRatio: (Math.random() * 2 + 0.5).toFixed(2),
                recommendation: `Based on ${objective}, this configuration provides optimal risk-adjusted returns for current market conditions.`
            };
        }

        // Initialize Risk Analytics Charts
        function initializeRiskAnalytics() {
            // VaR Chart
            const varCtx = document.getElementById('varChart');
            if (varCtx) {
                const chart = new Chart(varCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1-Day', '5-Day', '10-Day', '30-Day'],
                        datasets: [{
                            label: '95% VaR',
                            data: [1500, 3200, 4800, 8500],
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'VaR ($)'
                                }
                            }
                        }
                    }
                });
            }

            // Correlation Chart
            const corrCtx = document.getElementById('correlationChart');
            if (corrCtx) {
                const chart = new Chart(corrCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['SPY', 'QQQ', 'AAPL', 'MSFT', 'Other'],
                        datasets: [{
                            data: [35, 25, 15, 15, 10],
                            backgroundColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444',
                                '#8b5cf6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // Data provider change handler
        document.addEventListener('DOMContentLoaded', function() {
            const dataProviderSelect = document.getElementById('dataProvider');
            if (dataProviderSelect) {
                dataProviderSelect.addEventListener('change', function() {
                    const apiKeySection = document.getElementById('apiKeySection');
                    if (this.value !== 'demo') {
                        apiKeySection.classList.remove('hidden');
                    } else {
                        apiKeySection.classList.add('hidden');
                    }
                });
            }
        });

        // Initialize Phase 4A features
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize professional data section after other initializations
            setTimeout(() => {
                showProfessionalTool('market-data');
            }, 2000);
        });

        // Clean up intervals on page unload
        window.addEventListener('beforeunload', function() {
            if (marketDataConnection) {
                clearInterval(marketDataConnection);
            }
        });
    </script>
</body>
</html>
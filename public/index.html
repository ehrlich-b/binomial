<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Pricing Calculator - Real-time Greeks & Analysis</title>
    <meta name="description" content="Interactive options pricing calculator with real-time Greeks analysis and model comparisons">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Math.js for calculations -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js"></script>
    
    <style>
        /* Custom animations and styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Options Calculator</h1>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors">Home</a>
                    <a href="#calculator" class="text-gray-600 hover:text-blue-600 transition-colors">Calculator</a>
                    <a href="#greeks" class="text-gray-600 hover:text-blue-600 transition-colors">Greeks</a>
                    <a href="#learn" class="text-gray-600 hover:text-blue-600 transition-colors">Learn</a>
                    <a href="#playground" class="text-gray-600 hover:text-blue-600 transition-colors">Playground</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-gradient text-white py-20">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-5xl font-bold mb-6">Advanced Options Pricing & Greeks Analysis</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Real-time options pricing with comprehensive Greeks analysis. 
                Professional-grade calculations using multiple validated pricing models.
            </p>
            <div class="flex justify-center space-x-4">
                <button onclick="scrollToSection('calculator')" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    Start Calculating
                </button>
                <button onclick="scrollToSection('learn')" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors">
                    Learn Basics
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        <!-- Options Calculator Section -->
        <section id="calculator" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Options Calculator</h3>
                
                <!-- Calculator Form -->
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Option Parameters</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol (Optional)</label>
                            <input type="text" id="symbol" placeholder="AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Price ($)</label>
                            <input type="number" id="stockPrice" value="150" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Strike Price ($)</label>
                            <input type="number" id="strikePrice" value="155" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Days to Expiry</label>
                            <input type="number" id="daysToExpiry" value="30" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Volatility (%)</label>
                            <input type="number" id="volatility" value="25" step="0.1" min="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Option Type</label>
                            <select id="optionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                            </select>
                        </div>
                        
                        <button onclick="calculateOption()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Calculate Option Price
                        </button>
                    </div>
                    
                    <!-- Results Display -->
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Pricing Results</h4>
                        <div id="results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Enter parameters and click calculate to see results
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Visualization Section -->
        <section id="greeks" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Greeks Dashboard</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Values</h4>
                        <div id="greeksDisplay" class="space-y-3">
                            <!-- Greeks will be displayed here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Chart</h4>
                        <div class="relative w-full" style="height: 400px;">
                            <canvas id="greeksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Greeks Tutorial -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üéì Interactive Greeks Tutorial</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">Learn the difference between actual rates and sensitivity measures through interactive examples. This addresses the common confusion between rates and Greeks.</p>
                
                <!-- Tutorial Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">üìä</span>
                            Risk-Free Rate (Actual Rate)
                        </h4>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="text-sm font-medium text-gray-700 w-16">Rate:</label>
                            <input type="range" id="tutorialRate" min="1" max="10" step="0.5" value="4" class="flex-1">
                            <span id="tutorialRateValue" class="text-xl font-bold text-green-600 w-16">4.0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This is the actual interest rate in the economy:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>‚Ä¢ Fed funds rate</li>
                                <li>‚Ä¢ Treasury bond yields</li>
                                <li>‚Ä¢ What banks pay on deposits</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">‚ö°</span>
                            Rho (Rate Sensitivity)
                        </h4>
                        <div class="text-center mb-3">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="tutorialRhoValue">$0.27</div>
                            <p class="text-sm text-gray-600">per 1% rate change</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This tells you how much your option price changes:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>‚Ä¢ NOT the rate itself</li>
                                <li>‚Ä¢ Rate of change (derivative)</li>
                                <li>‚Ä¢ Like speed vs distance</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Demonstration -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="font-semibold text-gray-800 mb-6 text-center flex items-center justify-center">
                        <span class="text-2xl mr-2">üéØ</span>
                        See the Difference in Action
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="p-6 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-2xl font-bold text-green-700 mb-2" id="currentOptionPrice">$8.45</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Current Option Price</p>
                            <p class="text-xs text-green-600">At <span id="currentRate1">4.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-2xl font-bold text-blue-700 mb-2" id="newOptionPrice">$8.72</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">New Option Price</p>
                            <p class="text-xs text-blue-600">At <span id="newRate">5.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-2xl font-bold text-purple-700 mb-2" id="priceChange">+$0.27</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Price Change</p>
                            <p class="text-xs text-purple-600 font-semibold">This equals Rho!</p>
                        </div>
                    </div>
                    
                    <!-- Dynamic Explanation -->
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center">
                            <span class="text-xl mr-2">üí°</span>
                            Key Insight
                        </h5>
                        <div class="space-y-2 text-amber-700">
                            <p class="font-medium">
                                Risk-Free Rate = <span id="explanationCurrentRate">4%</span> (the actual rate)
                            </p>
                            <p class="font-medium">
                                Rho = <span id="explanationRho">$0.27</span> (how much price changes per 1% rate move)
                            </p>
                            <p class="text-sm border-t border-amber-200 pt-2 mt-3">
                                <strong>Example:</strong> If rates go from <span id="explanationFromRate">4%</span> ‚Üí <span id="explanationToRate">5%</span>, 
                                your option gains <span id="explanationGain">$0.27</span> in value.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Algorithm Animations Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üé¨ Algorithm Visualizations</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">See how options pricing models work step-by-step. Watch the mathematics come to life through interactive animations.</p>
                
                <!-- Algorithm Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showAlgorithm('binomial')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="binomialBtn">
                        üå≥ Binomial Tree
                    </button>
                    <button onclick="showAlgorithm('trinomial')" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors" id="trinomialBtn">
                        üî∑ Trinomial Tree
                    </button>
                    <button onclick="showAlgorithm('blackscholes')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="blackscholesBtn">
                        üìê Black-Scholes
                    </button>
                    <button onclick="showAlgorithm('montecarlo')" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="montecarloBtn">
                        üé≤ Monte Carlo
                    </button>
                </div>
                
                <!-- Binomial Tree Animation -->
                <div id="binomialAnimation" class="algorithm-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">üå≥</span>
                            Binomial Tree Model (Cox-Ross-Rubinstein)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Step-by-Step Construction</h5>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Steps:</span>
                                            <input type="range" id="binomialSteps" min="1" max="5" value="3" class="ml-4">
                                            <span id="binomialStepsValue" class="font-bold ml-2">3</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Speed:</span>
                                            <input type="range" id="animationSpeed" min="500" max="3000" value="1500" class="ml-4">
                                            <span class="text-xs ml-2">Slow ‚Üí Fast</span>
                                        </div>
                                        <button onclick="animateBinomialTree()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-3">
                                            ‚ñ∂Ô∏è Animate Tree Construction
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tree Visualization Canvas -->
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="treeCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üå≥</div>
                                            <p>Click "Animate Tree Construction" to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Explanation Panel -->
                            <div class="space-y-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">How It Works</h5>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <div class="step-explanation" id="step1">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">1</span>
                                                <div>
                                                    <strong>Start:</strong> Current stock price S‚ÇÄ = $<span class="font-mono">100</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step2">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">2</span>
                                                <div>
                                                    <strong>Up/Down:</strong> Price can go up by factor u = <span class="font-mono">1.05</span> or down by d = <span class="font-mono">0.95</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step3">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">3</span>
                                                <div>
                                                    <strong>Risk-Neutral:</strong> Probability p = <span class="font-mono">0.52</span>, (1-p) = <span class="font-mono">0.48</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step4">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">4</span>
                                                <div>
                                                    <strong>Work Backwards:</strong> Start from expiry, calculate option values at each node
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">Current Step</h5>
                                    <div id="currentStepDisplay" class="text-sm text-amber-700">
                                        Ready to begin animation...
                                    </div>
                                </div>
                                
                                <!-- Mathematical Formula -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Key Formulas</h5>
                                    <div class="space-y-2 text-xs font-mono text-gray-600">
                                        <div>u = e^(œÉ‚àöŒît) ‚âà 1.05</div>
                                        <div>d = 1/u ‚âà 0.95</div>
                                        <div>p = (e^(rŒît) - d)/(u - d)</div>
                                        <div>V = e^(-rŒît)[pV_up + (1-p)V_down]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monte Carlo Animation -->
                <div id="montecarloAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">üé≤</span>
                            Monte Carlo Simulation
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Simulation Controls -->
                            <div class="space-y-4">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">Simulation Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Paths:</span>
                                            <input type="range" id="mcPaths" min="100" max="10000" step="100" value="1000" class="ml-4">
                                            <span id="mcPathsValue" class="font-bold ml-2">1,000</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Show Paths:</span>
                                            <input type="range" id="mcShowPaths" min="10" max="100" value="50" class="ml-4">
                                            <span id="mcShowPathsValue" class="font-bold ml-2">50</span>
                                        </div>
                                        <button onclick="animateMonteCarlo()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                            üé≤ Run Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Statistics Panel -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Live Statistics</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Paths Completed:</span>
                                            <span id="mcPathsCompleted" class="font-bold">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Current Price:</span>
                                            <span id="mcCurrentPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Standard Error:</span>
                                            <span id="mcStandardError" class="font-bold">¬±$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Confidence:</span>
                                            <span id="mcConfidence" class="font-bold">95%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Path Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="mcCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üìà</div>
                                            <p>Click "Run Simulation" to see random paths</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Insight -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-2">üí° Key Insight</h5>
                                    <p class="text-sm text-yellow-700">
                                        Each path follows: S(t) = S‚ÇÄ √ó e^((r-œÉ¬≤/2)t + œÉ‚àöt√óZ) where Z ~ N(0,1). 
                                        More paths = more accurate price!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Black-Scholes Animation -->
                <div id="blackscholesAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">üìê</span>
                            Black-Scholes Formula
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formula Breakdown -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">Formula Components</h5>
                                    <button onclick="animateBlackScholes()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors mb-4">
                                        üìê Break Down Formula
                                    </button>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="formula-step opacity-30" id="bsStep1">
                                            <div class="font-mono bg-white p-2 rounded">C = S‚ÇÄN(d‚ÇÅ) - Ke^(-rT)N(d‚ÇÇ)</div>
                                            <p class="text-purple-700 mt-1">Call option price formula</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep2">
                                            <div class="font-mono bg-white p-2 rounded">d‚ÇÅ = [ln(S/K) + (r + œÉ¬≤/2)T] / (œÉ‚àöT)</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (adjusted for drift)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep3">
                                            <div class="font-mono bg-white p-2 rounded">d‚ÇÇ = d‚ÇÅ - œÉ‚àöT</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (risk-adjusted)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep4">
                                            <div class="font-mono bg-white p-2 rounded">N(x) = Cumulative normal distribution</div>
                                            <p class="text-purple-700 mt-1">Probability of being in-the-money</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Calculation -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Live Calculation</h5>
                                    <div id="bsCalculation" class="space-y-2 text-sm font-mono">
                                        <div>S‚ÇÄ = $100, K = $105, T = 0.082 years</div>
                                        <div>r = 4%, œÉ = 25%</div>
                                        <div id="bsLiveCalc">Click "Break Down Formula" to see calculation...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Normal Distribution Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-64" id="bsCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üìä</div>
                                            <p>Normal distribution visualization will appear here</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Assumptions -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">‚ö†Ô∏è Key Assumptions</h5>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>‚Ä¢ Constant volatility and risk-free rate</li>
                                        <li>‚Ä¢ No dividends (can be adjusted)</li>
                                        <li>‚Ä¢ European exercise only</li>
                                        <li>‚Ä¢ Log-normal stock price distribution</li>
                                        <li>‚Ä¢ No transaction costs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Education Section -->
        <section id="learn" class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Understanding the Greeks</h3>
            
            <!-- Common Misconception Alert -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 mb-8">
                <div class="flex">
                    <div class="text-amber-400 text-2xl mr-3">‚ö†Ô∏è</div>
                    <div>
                        <h4 class="text-lg font-semibold text-amber-800 mb-2">Common Confusion: Rho ‚â† Risk-Free Rate</h4>
                        <p class="text-amber-700">The risk-free rate is the actual interest rate (like 4%). <strong>Rho</strong> is how much your option price <em>changes</em> when that rate moves by 1%.</p>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <h5 class="font-bold text-blue-800 mb-2">Delta (Œî)</h5>
                    <p class="text-sm text-blue-700 mb-2">Speed of price change</p>
                    <p class="text-xs text-gray-600">If stock moves $1, option moves ~$Delta. Call: 0-1, Put: -1-0</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                    <h5 class="font-bold text-green-800 mb-2">Gamma (Œì)</h5>
                    <p class="text-sm text-green-700 mb-2">Acceleration</p>
                    <p class="text-xs text-gray-600">How much Delta changes per $1 stock move. Higher = more responsive</p>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                    <h5 class="font-bold text-red-800 mb-2">Theta (Œò)</h5>
                    <p class="text-sm text-red-700 mb-2">Time decay</p>
                    <p class="text-xs text-gray-600">$ lost per day. Always negative - time kills options</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                    <h5 class="font-bold text-purple-800 mb-2">Vega (V)</h5>
                    <p class="text-sm text-purple-700 mb-2">Volatility sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% volatility move (25% ‚Üí 26%)</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h5 class="font-bold text-yellow-800 mb-2">Rho (œÅ)</h5>
                    <p class="text-sm text-yellow-700 mb-2">Rate sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% rate move (4% ‚Üí 5%). Call: +, Put: -</p>
                </div>
            </div>

            <!-- Interactive Examples -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-semibold mb-4">Real-World Example</h4>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium mb-3">üì± AAPL $150 Call, $155 Strike, 30 days</h5>
                        <div class="space-y-2 text-sm">
                            <div><strong>Delta = 0.35:</strong> If AAPL rises $1 ‚Üí Call gains ~$0.35</div>
                            <div><strong>Gamma = 0.02:</strong> That 0.35 delta becomes ~0.37</div>
                            <div><strong>Theta = -0.08:</strong> Loses $0.08 every day that passes</div>
                            <div><strong>Vega = 0.12:</strong> If volatility rises 1% ‚Üí Call gains $0.12</div>
                            <div><strong>Rho = 0.27:</strong> If rates rise from 4%‚Üí5% ‚Üí Call gains $0.27</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium mb-3">üéØ Key Insights</h5>
                        <ul class="text-sm space-y-1 text-gray-700">
                            <li>‚Ä¢ <strong>All Greeks are rates of change</strong> (derivatives)</li>
                            <li>‚Ä¢ Delta shows directional exposure</li>
                            <li>‚Ä¢ Gamma shows how fast that changes</li>
                            <li>‚Ä¢ Theta is your daily bleed</li>
                            <li>‚Ä¢ Vega matters most for earnings/events</li>
                            <li>‚Ä¢ Rho barely matters unless rates are moving fast</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Calculator Features</h3>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-blue-600 text-3xl mb-4">üìä</div>
                    <h4 class="text-xl font-semibold mb-3">Real-time Pricing</h4>
                    <p class="text-gray-600 mb-4">Calculate options prices using multiple validated pricing models with instant results.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-green-600 text-3xl mb-4">üìà</div>
                    <h4 class="text-xl font-semibold mb-3">Greeks Analysis</h4>
                    <p class="text-gray-600 mb-4">Complete Greeks calculation with visual charts showing risk sensitivities.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-purple-600 text-3xl mb-4">üßÆ</div>
                    <h4 class="text-xl font-semibold mb-3">Model Comparison</h4>
                    <p class="text-gray-600 mb-4">Compare Trinomial, Binomial, Black-Scholes, and Monte Carlo pricing side-by-side.</p>
                </div>
            </div>
        </section>

        <!-- Payoff Diagram Builder Section -->
        <section id="playground" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Strategy Builder & Payoff Diagrams</h3>
                
                <!-- Strategy Builder Controls -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Build Your Strategy</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                                <select id="strategyType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="single">Single Option</option>
                                    <option value="covered-call">Covered Call</option>
                                    <option value="protective-put">Protective Put</option>
                                    <option value="straddle">Long Straddle</option>
                                    <option value="strangle">Long Strangle</option>
                                    <option value="butterfly">Butterfly Spread</option>
                                    <option value="custom">Custom Multi-Leg</option>
                                </select>
                            </div>
                            
                            <div id="strategyParams" class="space-y-3">
                                <!-- Strategy parameters will be populated here -->
                            </div>
                            
                            <button onclick="buildPayoffDiagram()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Generate Payoff Diagram
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Payoff Chart</h4>
                        <div class="relative w-full bg-gray-50 rounded-lg" style="height: 300px;">
                            <canvas id="payoffChart"></canvas>
                        </div>
                        
                        <div id="strategyMetrics" class="mt-4 space-y-2">
                            <!-- Strategy metrics will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Predefined Strategy Examples -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-4">Popular Strategies</h4>
                    <div class="grid md:grid-cols-4 gap-4">
                        <button onclick="loadStrategy('covered-call')" class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-blue-800">Covered Call</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + sell call</p>
                            <p class="text-xs text-blue-600 mt-1">üìà Neutral/Bullish</p>
                        </button>
                        
                        <button onclick="loadStrategy('protective-put')" class="bg-green-50 hover:bg-green-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-green-800">Protective Put</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + buy put</p>
                            <p class="text-xs text-green-600 mt-1">üìà Bullish protection</p>
                        </button>
                        
                        <button onclick="loadStrategy('straddle')" class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-purple-800">Long Straddle</h5>
                            <p class="text-xs text-gray-600 mt-1">Buy call + put same strike</p>
                            <p class="text-xs text-purple-600 mt-1">‚ö° High volatility play</p>
                        </button>
                        
                        <button onclick="loadStrategy('iron-condor')" class="bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-yellow-800">Iron Condor</h5>
                            <p class="text-xs text-gray-600 mt-1">4-leg neutral strategy</p>
                            <p class="text-xs text-yellow-600 mt-1">üò¥ Low volatility play</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">About</h3>
                <div class="text-center">
                    <p class="text-gray-600 mb-6">Professional options pricing calculator with advanced Greeks analysis and model comparison capabilities.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">Multiple Models</h5>
                            <p class="text-sm text-blue-600">Trinomial, Binomial, Black-Scholes, Monte Carlo</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">Real-time Greeks</h5>
                            <p class="text-sm text-green-600">Delta, Gamma, Theta, Vega, Rho analysis</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-2">Validated Accuracy</h5>
                            <p class="text-sm text-purple-600">Market-tested pricing algorithms</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-red-800 mb-2">Professional Grade</h5>
                            <p class="text-sm text-red-600">Industry-standard calculations</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h5 class="text-lg font-semibold mb-4">Options Calculator</h5>
                    <p class="text-gray-400">Professional-grade options pricing and Greeks analysis.</p>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Models</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Trinomial Trees</li>
                        <li>Binomial Trees</li>
                        <li>Black-Scholes</li>
                        <li>Monte Carlo</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Analysis</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Complete Greeks Suite</li>
                        <li>Model Comparison</li>
                        <li>Risk Visualization</li>
                        <li>Real-time Updates</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>Professional Options Pricing Calculator</p>
            </div>
        </div>
    </footer>

    <!-- Include the pricing library -->
    <script type="module" src="../lib/index.js"></script>
    
    <!-- Main application JavaScript -->
    <script type="module">
        // Import pricing functions from our validated library
        let pricingLibrary;
        let greeksChart;
        
        // Initialize the application
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Import pricing library
                const module = await import('../lib/index.js');
                pricingLibrary = module;
                console.log('üöÄ Pricing library loaded successfully');
                console.log('üìä Loaded modules:', Object.keys(module));
                
                // Initialize Greeks chart with fixed responsive settings
                initializeGreeksChart();
                
            } catch (error) {
                console.error('‚ùå Failed to load pricing library:', error);
                // Show error to user
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Library Loading Error</h5>
                        <p class="text-sm">Failed to load the pricing library. Please check the console for details.</p>
                    </div>
                `;
            }
        });

        // Initialize Greeks radar chart with proper responsive settings
        function initializeGreeksChart() {
            const ctx = document.getElementById('greeksChart').getContext('2d');
            
            greeksChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Delta', 'Gamma', 'Theta', 'Vega', 'Rho'],
                    datasets: [{
                        label: 'Greeks Values',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                circular: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                display: false
                            },
                            min: -1,
                            max: 1
                        }
                    }
                }
            });
        }

        // Calculator functionality - with safety checks
        window.calculateOption = function() {
            // Prevent recursive calls
            if (isCalculating) {
                console.log('Already calculating, skipping...');
                return;
            }
            
            if (!pricingLibrary) {
                console.error('Pricing library not loaded yet');
                return;
            }

            isCalculating = true;

            try {
                const params = {
                    symbol: document.getElementById('symbol').value || undefined,
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    strikePrice: parseFloat(document.getElementById('strikePrice').value),
                    daysToExpiry: parseInt(document.getElementById('daysToExpiry').value),
                    volatility: parseFloat(document.getElementById('volatility').value) / 100,
                    optionType: document.getElementById('optionType').value
                };

                // Validate inputs
                if (isNaN(params.stockPrice) || isNaN(params.strikePrice) || isNaN(params.daysToExpiry) || isNaN(params.volatility)) {
                    throw new Error('Please enter valid numbers for all fields');
                }

                // Simple pricing only - no complex calculations
                const price = pricingLibrary.priceOption(params);
                
                // Basic Greeks calculation
                const greeks = pricingLibrary.calculateGreeks({
                    ...params,
                    timeToExpiry: params.daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                });
                
                displayResults(price, greeks, params);
                updateGreeksDisplay(greeks);
                updateGreeksChart(greeks);
                
            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Calculation Error</h5>
                        <p class="text-sm">Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                isCalculating = false;
            }
        };

        function displayResults(price, greeks, params) {
            const intrinsic = params.optionType === 'call' 
                ? Math.max(0, params.stockPrice - params.strikePrice)
                : Math.max(0, params.strikePrice - params.stockPrice);
            const timeValue = price - intrinsic;

            document.getElementById('results').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h5 class="font-semibold text-blue-800 mb-2">Option Price</h5>
                        <div class="text-3xl font-bold text-blue-600">$${price.toFixed(2)}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-sm text-green-600">Intrinsic Value</div>
                            <div class="font-semibold text-green-800">$${intrinsic.toFixed(2)}</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <div class="text-sm text-purple-600">Time Value</div>
                            <div class="font-semibold text-purple-800">$${timeValue.toFixed(2)}</div>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        function updateGreeksDisplay(greeks) {
            if (!greeks || Object.keys(greeks).length === 0) return;

            const greeksHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Delta</span>
                            <div class="text-xs text-gray-600">Price change per $1 stock move</div>
                            <div class="text-xs text-blue-700 mt-1">‚âà ${((greeks.delta || 0) * 100).toFixed(1)}% of stock moves</div>
                        </div>
                        <span class="font-bold text-blue-600">${greeks.delta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Gamma</span>
                            <div class="text-xs text-gray-600">Delta change per $1 stock move</div>
                            <div class="text-xs text-green-700 mt-1">Higher = more delta acceleration</div>
                        </div>
                        <span class="font-bold text-green-600">${greeks.gamma?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Theta</span>
                            <div class="text-xs text-gray-600">Price decay per day</div>
                            <div class="text-xs text-red-700 mt-1">Time is your enemy: $${((greeks.theta || 0) * -1).toFixed(2)}/day lost</div>
                        </div>
                        <span class="font-bold text-red-600">${greeks.theta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Vega</span>
                            <div class="text-xs text-gray-600">Price change per 1% volatility</div>
                            <div class="text-xs text-purple-700 mt-1">Vol from ${((greeks.vega || 0) > 0 ? '24% ‚Üí 25%' : '25% ‚Üí 24%')} = $${Math.abs(greeks.vega || 0).toFixed(2)}</div>
                        </div>
                        <span class="font-bold text-purple-600">${greeks.vega?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Rho</span>
                            <div class="text-xs text-gray-600">Price change per 1% rate change</div>
                            <div class="text-xs text-yellow-700 mt-1">Rates 4% ‚Üí 5% = $${(greeks.rho || 0).toFixed(2)} change</div>
                        </div>
                        <span class="font-bold text-yellow-600">${greeks.rho?.toFixed(4) || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('greeksDisplay').innerHTML = greeksHtml;
        }

        // Update Greeks chart with real values
        function updateGreeksChart(greeks) {
            if (!greeksChart || !greeks) return;
            
            // Normalize values for radar chart visualization
            const normalizeValue = (value, maxExpected) => {
                return Math.max(-1, Math.min(1, value / maxExpected));
            };
            
            const chartData = [
                normalizeValue(greeks.delta || 0, 1),      // Delta: -1 to 1
                normalizeValue(greeks.gamma || 0, 0.1),    // Gamma: normalize around 0.1
                normalizeValue(greeks.theta || 0, 0.1),    // Theta: normalize around 0.1 (daily)
                normalizeValue(greeks.vega || 0, 0.5),     // Vega: normalize around 0.5
                normalizeValue(greeks.rho || 0, 0.2)       // Rho: normalize around 0.2
            ];
            
            greeksChart.data.datasets[0].data = chartData;
            greeksChart.update('none'); // No animation for smooth real-time updates
        }

        // Smooth scrolling
        window.scrollToSection = function(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth' 
            });
        };

        // Manual calculation only - prevent infinite loops
        let isCalculating = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - ready for manual calculations');
            // Remove all auto-calculation to prevent infinite loops
        });

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Payoff Diagram Builder Functions
        let payoffChart;
        let currentStrategy = {};

        // Initialize payoff chart
        function initializePayoffChart() {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            
            payoffChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Strategy Payoff at Expiration'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price at Expiration ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)'
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load predefined strategy
        window.loadStrategy = function(strategyType) {
            document.getElementById('strategyType').value = strategyType;
            populateStrategyParams(strategyType);
            buildPayoffDiagram();
        };

        // Populate strategy parameters based on selected strategy
        function populateStrategyParams(strategyType) {
            const paramsContainer = document.getElementById('strategyParams');
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            
            let paramsHtml = '';
            
            switch (strategyType) {
                case 'single':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <select id="position" class="w-full px-2 py-1 border rounded">
                                <option value="long-call">Long Call</option>
                                <option value="short-call">Short Call</option>
                                <option value="long-put">Long Put</option>
                                <option value="short-put">Short Put</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="strike1" value="${stockPrice + 5}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'covered-call':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Sell 1 call</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'protective-put':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Buy 1 put</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'straddle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (same strike)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="straddleStrike" value="${stockPrice}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'strangle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (different strikes)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
            }
            
            paramsContainer.innerHTML = paramsHtml;
        }

        // Build and display payoff diagram
        window.buildPayoffDiagram = function() {
            if (!pricingLibrary) {
                console.error('Pricing library not loaded');
                return;
            }

            const strategyType = document.getElementById('strategyType').value;
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            const volatility = parseFloat(document.getElementById('volatility').value) / 100 || 0.25;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 30;
            
            // Generate stock price range for payoff calculation
            const minPrice = stockPrice * 0.7;
            const maxPrice = stockPrice * 1.3;
            const priceStep = (maxPrice - minPrice) / 50;
            const stockPrices = [];
            const payoffs = [];
            
            for (let price = minPrice; price <= maxPrice; price += priceStep) {
                stockPrices.push(price);
                payoffs.push(calculateStrategyPayoff(strategyType, price, stockPrice, volatility, daysToExpiry));
            }
            
            // Update chart
            payoffChart.data.labels = stockPrices.map(p => p.toFixed(0));
            payoffChart.data.datasets = [{
                label: getStrategyName(strategyType),
                data: payoffs,
                borderColor: 'rgb(147, 51, 234)',
                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                borderWidth: 2,
                fill: true
            }];
            
            payoffChart.update();
            
            // Update strategy metrics
            updateStrategyMetrics(strategyType, payoffs, stockPrices, stockPrice);
        };

        function calculateStrategyPayoff(strategyType, currentPrice, stockPrice, volatility, daysToExpiry) {
            const timeToExpiry = daysToExpiry / 365;
            
            switch (strategyType) {
                case 'single':
                    const position = document.getElementById('position')?.value || 'long-call';
                    const strike = parseFloat(document.getElementById('strike1')?.value) || stockPrice + 5;
                    
                    if (position === 'long-call') {
                        return Math.max(0, currentPrice - strike);
                    } else if (position === 'short-call') {
                        return -Math.max(0, currentPrice - strike);
                    } else if (position === 'long-put') {
                        return Math.max(0, strike - currentPrice);
                    } else if (position === 'short-put') {
                        return -Math.max(0, strike - currentPrice);
                    }
                    break;
                    
                case 'covered-call':
                    const callStrike = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const stockProfit = currentPrice - stockPrice;
                    const callPayoff = -Math.max(0, currentPrice - callStrike);
                    return stockProfit + callPayoff;
                    
                case 'protective-put':
                    const putStrike = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const stockProfitPP = currentPrice - stockPrice;
                    const putPayoff = Math.max(0, putStrike - currentPrice);
                    return stockProfitPP + putPayoff;
                    
                case 'straddle':
                    const straddleStrike = parseFloat(document.getElementById('straddleStrike')?.value) || stockPrice;
                    const callPayoffStraddle = Math.max(0, currentPrice - straddleStrike);
                    const putPayoffStraddle = Math.max(0, straddleStrike - currentPrice);
                    return callPayoffStraddle + putPayoffStraddle;
                    
                case 'strangle':
                    const putStrikeStrangle = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const callStrikeStrangle = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const callPayoffStrangle = Math.max(0, currentPrice - callStrikeStrangle);
                    const putPayoffStrangle = Math.max(0, putStrikeStrangle - currentPrice);
                    return callPayoffStrangle + putPayoffStrangle;
            }
            
            return 0;
        }

        function getStrategyName(strategyType) {
            const names = {
                'single': 'Single Option',
                'covered-call': 'Covered Call',
                'protective-put': 'Protective Put',
                'straddle': 'Long Straddle',
                'strangle': 'Long Strangle',
                'butterfly': 'Butterfly Spread'
            };
            return names[strategyType] || strategyType;
        }

        function updateStrategyMetrics(strategyType, payoffs, stockPrices, currentStockPrice) {
            const maxProfit = Math.max(...payoffs);
            const maxLoss = Math.min(...payoffs);
            const currentIndex = stockPrices.findIndex(p => p >= currentStockPrice);
            const currentPayoff = payoffs[currentIndex] || 0;
            
            // Find breakeven points
            const breakevens = [];
            for (let i = 1; i < payoffs.length; i++) {
                if ((payoffs[i-1] <= 0 && payoffs[i] >= 0) || (payoffs[i-1] >= 0 && payoffs[i] <= 0)) {
                    breakevens.push(stockPrices[i]);
                }
            }
            
            document.getElementById('strategyMetrics').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-green-50 p-2 rounded">
                        <div class="font-medium text-green-800">Max Profit</div>
                        <div class="text-green-600">$${maxProfit.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded">
                        <div class="font-medium text-red-800">Max Loss</div>
                        <div class="text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded col-span-2">
                        <div class="font-medium text-blue-800">Breakevens</div>
                        <div class="text-blue-600">$${breakevens.map(b => b.toFixed(2)).join(', ')}</div>
                    </div>
                </div>
            `;
        }

        // Initialize payoff chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add small delay to ensure Chart.js is ready
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    initializePayoffChart();
                    populateStrategyParams('single');
                }
            }, 500);
        });

        // Auto-update strategy params when strategy type changes
        document.addEventListener('change', function(e) {
            if (e.target.id === 'strategyType') {
                populateStrategyParams(e.target.value);
            }
        });

        // Interactive Greeks Tutorial Functionality
        function initializeTutorial() {
            const rateSlider = document.getElementById('tutorialRate');
            const rateValue = document.getElementById('tutorialRateValue');
            const rhoValue = document.getElementById('tutorialRhoValue');
            const currentPrice = document.getElementById('currentOptionPrice');
            const newPrice = document.getElementById('newOptionPrice');
            const priceChange = document.getElementById('priceChange');
            const currentRate1 = document.getElementById('currentRate1');
            const newRate = document.getElementById('newRate');
            const explanationCurrentRate = document.getElementById('explanationCurrentRate');
            const explanationRho = document.getElementById('explanationRho');
            const explanationFromRate = document.getElementById('explanationFromRate');
            const explanationToRate = document.getElementById('explanationToRate');
            const explanationGain = document.getElementById('explanationGain');
            
            // Base option parameters for tutorial
            const baseParams = {
                stockPrice: 100,
                strikePrice: 105,
                daysToExpiry: 30,
                volatility: 0.25,
                optionType: 'call'
            };
            
            function updateTutorial() {
                const currentRiskFreeRate = parseFloat(rateSlider.value) / 100;
                const newRiskFreeRate = currentRiskFreeRate + 0.01; // +1%
                
                // Update display values
                rateValue.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                currentRate1.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                newRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                explanationCurrentRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationFromRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationToRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                
                try {
                    if (pricingLibrary && pricingLibrary.binomialPrice) {
                        // Calculate prices at both rates
                        const priceAtCurrentRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: currentRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const priceAtNewRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: newRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const change = priceAtNewRate - priceAtCurrentRate;
                        
                        // Update displays
                        currentPrice.textContent = '$' + priceAtCurrentRate.toFixed(2);
                        newPrice.textContent = '$' + priceAtNewRate.toFixed(2);
                        priceChange.textContent = (change >= 0 ? '+' : '') + '$' + change.toFixed(2);
                        rhoValue.textContent = '$' + change.toFixed(2);
                        explanationRho.textContent = '$' + change.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(change).toFixed(2);
                        
                        // Color coding for price change
                        const changeColor = change >= 0 ? 'text-green-700' : 'text-red-700';
                        priceChange.className = `text-2xl font-bold ${changeColor} mb-2`;
                        
                    } else {
                        // Fallback with estimated values
                        const estimatedRho = 0.25 + (currentRiskFreeRate - 0.04) * 2; // Rough estimation
                        rhoValue.textContent = '$' + estimatedRho.toFixed(2);
                        explanationRho.textContent = '$' + estimatedRho.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(estimatedRho).toFixed(2);
                    }
                } catch (error) {
                    console.warn('Tutorial calculation error:', error);
                    // Show default values if calculation fails
                    const defaultRho = 0.27;
                    rhoValue.textContent = '$' + defaultRho.toFixed(2);
                    explanationRho.textContent = '$' + defaultRho.toFixed(2);
                    explanationGain.textContent = '$' + Math.abs(defaultRho).toFixed(2);
                }
            }
            
            // Initialize tutorial
            updateTutorial();
            
            // Add event listener for rate slider
            rateSlider.addEventListener('input', updateTutorial);
        }
        
        // Initialize tutorial when pricing library is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeTutorial();
                initializeAlgorithmAnimations();
            }, 1000); // Wait for pricing library to load
        });

        // Algorithm Animation Functionality
        function initializeAlgorithmAnimations() {
            // Initialize slider values
            document.getElementById('binomialSteps').addEventListener('input', function() {
                document.getElementById('binomialStepsValue').textContent = this.value;
            });
            
            document.getElementById('mcPaths').addEventListener('input', function() {
                document.getElementById('mcPathsValue').textContent = parseInt(this.value).toLocaleString();
            });
            
            document.getElementById('mcShowPaths').addEventListener('input', function() {
                document.getElementById('mcShowPathsValue').textContent = this.value;
            });
        }
        
        // Algorithm switching functionality
        function showAlgorithm(algorithm) {
            // Hide all algorithm content
            const contents = document.querySelectorAll('.algorithm-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Reset button styles
            const buttons = ['binomialBtn', 'trinomialBtn', 'blackscholesBtn', 'montecarloBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
            });
            
            // Show selected algorithm
            document.getElementById(algorithm + 'Animation').classList.remove('hidden');
            
            // Highlight selected button
            const selectedBtn = document.getElementById(algorithm + 'Btn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getButtonColor(algorithm));
            }
        }
        
        function getButtonColor(algorithm) {
            const colors = {
                'binomial': 'bg-blue-700',
                'trinomial': 'bg-green-700',
                'blackscholes': 'bg-purple-700',
                'montecarlo': 'bg-red-700'
            };
            return colors[algorithm] || 'bg-blue-700';
        }
        
        // Binomial Tree Animation
        function animateBinomialTree() {
            const steps = parseInt(document.getElementById('binomialSteps').value);
            const speed = parseInt(document.getElementById('animationSpeed').value);
            const canvas = document.getElementById('treeCanvas');
            const stepDisplay = document.getElementById('currentStepDisplay');
            
            // Reset step explanations
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.opacity = '0.3';
            }
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">Building Binomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 4;
            
            function nextStep() {
                currentStep++;
                
                // Highlight current step
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}`).style.opacity = '1';
                }
                
                switch(currentStep) {
                    case 1:
                        stepDisplay.textContent = "Starting with current stock price S‚ÇÄ = $100";
                        canvas.innerHTML = createTreeVisualization(1, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = "Adding up and down movements for each time step";
                        canvas.innerHTML = createTreeVisualization(2, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = "Calculating risk-neutral probabilities";
                        canvas.innerHTML = createTreeVisualization(3, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = "Working backwards to find option value";
                        canvas.innerHTML = createTreeVisualization(4, steps);
                        break;
                    default:
                        stepDisplay.textContent = "Animation complete! Tree shows all possible paths.";
                        return;
                }
                
                if (currentStep < totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }
        
        function createTreeVisualization(step, totalSteps) {
            let html = '<div class="p-4">';
            
            if (step === 1) {
                html += `
                    <div class="flex justify-center">
                        <div class="bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center font-bold">
                            $100
                        </div>
                    </div>
                    <div class="text-center mt-2 text-sm text-gray-600">Current Stock Price</div>
                `;
            } else if (step === 2) {
                html += `
                    <div class="space-y-6">
                        ${Array.from({length: Math.min(totalSteps + 1, 4)}, (_, t) => `
                            <div class="flex justify-center items-center" style="gap: ${40 + t * 30}px;">
                                ${Array.from({length: t + 1}, (_, i) => {
                                    const price = 100 * Math.pow(1.05, t - i) * Math.pow(0.95, i);
                                    return `
                                        <div class="bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xs font-bold">
                                            $${price.toFixed(0)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (step === 3) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-yellow-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Risk-Neutral Probabilities</div>
                            <div class="text-xs mt-1">p = 0.52 (up), 1-p = 0.48 (down)</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="200" height="120" viewBox="0 0 200 120">
                                <line x1="100" y1="100" x2="50" y2="20" stroke="#10B981" stroke-width="3"/>
                                <line x1="100" y1="100" x2="150" y2="20" stroke="#EF4444" stroke-width="3"/>
                                <circle cx="100" cy="100" r="15" fill="#3B82F6"/>
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="150" cy="20" r="12" fill="#EF4444"/>
                                <text x="100" y="105" text-anchor="middle" font-size="10" fill="white">$100</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$105</text>
                                <text x="150" y="25" text-anchor="middle" font-size="8" fill="white">$95</text>
                                <text x="75" y="65" font-size="8" fill="#10B981">52%</text>
                                <text x="125" y="65" font-size="8" fill="#EF4444">48%</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else if (step === 4) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Backward Induction</div>
                            <div class="text-xs mt-1">Start from expiry, work backwards</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="250" height="150" viewBox="0 0 250 150">
                                <!-- Final nodes -->
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="125" cy="75" r="12" fill="#F59E0B"/>
                                <circle cx="200" cy="130" r="12" fill="#EF4444"/>
                                <!-- Intermediate nodes -->
                                <circle cx="90" cy="47" r="10" fill="#8B5CF6"/>
                                <circle cx="160" cy="102" r="10" fill="#8B5CF6"/>
                                <!-- Root node -->
                                <circle cx="125" cy="75" r="15" fill="#3B82F6"/>
                                <!-- Lines -->
                                <line x1="125" y1="75" x2="90" y2="47" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="125" y1="75" x2="160" y2="102" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="90" y1="47" x2="50" y2="20" stroke="#10B981" stroke-width="2"/>
                                <line x1="90" y1="47" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="200" y2="130" stroke="#EF4444" stroke-width="2"/>
                                <!-- Values -->
                                <text x="125" y="80" text-anchor="middle" font-size="10" fill="white">$6.15</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$10.5</text>
                                <text x="200" y="135" text-anchor="middle" font-size="8" fill="white">$0</text>
                                <text x="90" y="52" text-anchor="middle" font-size="8" fill="white">$8.2</text>
                                <text x="160" y="107" text-anchor="middle" font-size="8" fill="white">$2.4</text>
                            </svg>
                        </div>
                    </div>
                    <div class="text-center mt-4 text-sm text-green-600 font-semibold">
                        Option Value: $6.15
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Monte Carlo Animation
        function animateMonteCarlo() {
            const totalPaths = parseInt(document.getElementById('mcPaths').value);
            const showPaths = parseInt(document.getElementById('mcShowPaths').value);
            const canvas = document.getElementById('mcCanvas');
            
            let pathsCompleted = 0;
            let runningTotal = 0;
            let runningSquareTotal = 0;
            
            canvas.innerHTML = `
                <div class="h-full">
                    <div class="text-center mb-4 font-semibold">Simulating ${totalPaths.toLocaleString()} Price Paths</div>
                    <div class="relative h-64 bg-white rounded border">
                        <canvas id="mcPathCanvas" width="400" height="200" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 bg-blue-100 rounded-full h-2">
                        <div id="mcProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            const pathCanvas = document.getElementById('mcPathCanvas');
            const ctx = pathCanvas.getContext('2d');
            
            // Setup canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 200);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 180);
            ctx.lineTo(380, 180);
            ctx.moveTo(40, 20);
            ctx.lineTo(40, 180);
            ctx.stroke();
            
            let pathsDrawn = 0;
            const batchSize = Math.ceil(totalPaths / 100); // Update in batches
            
            function simulateBatch() {
                for (let i = 0; i < Math.min(batchSize, totalPaths - pathsCompleted); i++) {
                    const optionValue = simulatePath();
                    runningTotal += optionValue;
                    runningSquareTotal += optionValue * optionValue;
                    pathsCompleted++;
                    
                    // Draw some paths for visualization
                    if (pathsDrawn < showPaths && pathsCompleted % Math.floor(totalPaths / showPaths) === 0) {
                        drawRandomPath(ctx, pathsDrawn);
                        pathsDrawn++;
                    }
                }
                
                // Update statistics
                updateMonteCarloStats(pathsCompleted, totalPaths, runningTotal, runningSquareTotal);
                
                if (pathsCompleted < totalPaths) {
                    setTimeout(simulateBatch, 10);
                } else {
                    document.getElementById('mcProgressBar').style.width = '100%';
                }
            }
            
            simulateBatch();
        }
        
        function simulatePath() {
            // Simple Monte Carlo option pricing
            const S0 = 100, K = 105, T = 30/365, r = 0.04, sigma = 0.25;
            const dt = T / 30;
            let S = S0;
            
            // Generate random path
            for (let i = 0; i < 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * Z);
            }
            
            // Option payoff (call option)
            return Math.max(S - K, 0) * Math.exp(-r * T);
        }
        
        function drawRandomPath(ctx, pathIndex) {
            const S0 = 100;
            const colors = ['rgba(59, 130, 246, 0.4)', 'rgba(16, 185, 129, 0.4)', 'rgba(239, 68, 68, 0.4)'];
            
            ctx.strokeStyle = colors[pathIndex % colors.length];
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            let S = S0;
            let prevX = 40;
            let prevY = 180 - (S - 80) * 2; // Scale to canvas
            
            ctx.moveTo(prevX, prevY);
            
            for (let i = 1; i <= 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((0.04 - 0.5 * 0.25 * 0.25) * (30/365/30) + 0.25 * Math.sqrt(30/365/30) * Z);
                
                const x = 40 + (i / 30) * 340;
                const y = Math.max(20, Math.min(180, 180 - (S - 80) * 2));
                
                ctx.lineTo(x, y);
                prevX = x;
                prevY = y;
            }
            
            ctx.stroke();
        }
        
        function normalRandom() {
            // Box-Muller transformation
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        
        function updateMonteCarloStats(completed, total, runningTotal, runningSquareTotal) {
            const currentPrice = runningTotal / completed;
            const variance = (runningSquareTotal / completed) - (currentPrice * currentPrice);
            const standardError = Math.sqrt(variance / completed);
            
            document.getElementById('mcPathsCompleted').textContent = completed.toLocaleString();
            document.getElementById('mcCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
            document.getElementById('mcStandardError').textContent = '¬±$' + (1.96 * standardError).toFixed(2);
            
            const progress = (completed / total) * 100;
            document.getElementById('mcProgressBar').style.width = progress + '%';
        }
        
        // Black-Scholes Animation
        function animateBlackScholes() {
            const steps = ['bsStep1', 'bsStep2', 'bsStep3', 'bsStep4'];
            const calculation = document.getElementById('bsLiveCalc');
            
            // Reset opacity
            steps.forEach(step => {
                document.getElementById(step).style.opacity = '0.3';
            });
            
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).style.opacity = '1';
                    
                    switch(currentStep) {
                        case 0:
                            calculation.innerHTML = `
                                <div>Breaking down the Black-Scholes formula...</div>
                                <div class="mt-2 text-purple-600">C = S‚ÇÄN(d‚ÇÅ) - Ke^(-rT)N(d‚ÇÇ)</div>
                            `;
                            break;
                        case 1:
                            calculation.innerHTML = `
                                <div>d‚ÇÅ = [ln(100/105) + (0.04 + 0.25¬≤/2)√ó0.082] / (0.25√ó‚àö0.082)</div>
                                <div>d‚ÇÅ = [-0.0488 + 0.0059] / 0.0717 = -0.598</div>
                            `;
                            break;
                        case 2:
                            calculation.innerHTML = `
                                <div>d‚ÇÇ = d‚ÇÅ - œÉ‚àöT = -0.598 - 0.25√ó‚àö0.082</div>
                                <div>d‚ÇÇ = -0.598 - 0.0717 = -0.670</div>
                            `;
                            break;
                        case 3:
                            calculation.innerHTML = `
                                <div>N(d‚ÇÅ) = N(-0.598) = 0.275</div>
                                <div>N(d‚ÇÇ) = N(-0.670) = 0.251</div>
                                <div class="mt-2 text-green-600 font-bold">C = 100√ó0.275 - 105√óe^(-0.04√ó0.082)√ó0.251 = $1.31</div>
                            `;
                            break;
                    }
                    
                    currentStep++;
                    setTimeout(nextStep, 2000);
                }
            }
            
            nextStep();
        }
    </script>
</body>
</html>
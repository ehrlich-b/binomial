<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Pricing Calculator - Real-time Greeks & Analysis</title>
    <meta name="description" content="Interactive options pricing calculator with real-time Greeks analysis and model comparisons">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Math.js for calculations -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js"></script>
    
    <!-- Three.js for 3D visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fallback OrbitControls in case CDN fails -->
    <script>
        // OrbitControls fallback implementation
        if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
            THREE.OrbitControls = class OrbitControls {
                constructor(camera, domElement) {
                    this.camera = camera;
                    this.domElement = domElement;
                    this.enableDamping = true;
                    this.dampingFactor = 0.05;
                    this.enableZoom = true;
                    this.enableRotate = true;
                    this.enablePan = true;
                    
                    this.mouseX = 0;
                    this.mouseY = 0;
                    this.isMouseDown = false;
                    
                    this.initEventListeners();
                }
                
                initEventListeners() {
                    this.domElement.addEventListener('mousedown', (e) => {
                        this.isMouseDown = true;
                        this.mouseX = e.clientX;
                        this.mouseY = e.clientY;
                    });
                    
                    this.domElement.addEventListener('mouseup', () => {
                        this.isMouseDown = false;
                    });
                    
                    this.domElement.addEventListener('mousemove', (e) => {
                        if (this.isMouseDown && this.enableRotate) {
                            const deltaX = e.clientX - this.mouseX;
                            const deltaY = e.clientY - this.mouseY;
                            
                            this.camera.position.x = this.camera.position.x * Math.cos(deltaX * 0.01) - this.camera.position.z * Math.sin(deltaX * 0.01);
                            this.camera.position.z = this.camera.position.x * Math.sin(deltaX * 0.01) + this.camera.position.z * Math.cos(deltaX * 0.01);
                            this.camera.position.y += deltaY * 0.1;
                            
                            this.camera.lookAt(0, 0, 0);
                            
                            this.mouseX = e.clientX;
                            this.mouseY = e.clientY;
                        }
                    });
                    
                    this.domElement.addEventListener('wheel', (e) => {
                        if (this.enableZoom) {
                            const scale = e.deltaY > 0 ? 1.1 : 0.9;
                            this.camera.position.multiplyScalar(scale);
                            e.preventDefault();
                        }
                    });
                }
                
                update() {
                    // Basic damping could be implemented here
                }
            };
        }
    </script>
    
    <style>
        /* Custom animations and styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Options Calculator</h1>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors">Home</a>
                    <a href="#calculator" class="text-gray-600 hover:text-blue-600 transition-colors">Calculator</a>
                    <a href="#greeks" class="text-gray-600 hover:text-blue-600 transition-colors">Greeks</a>
                    <a href="#learn" class="text-gray-600 hover:text-blue-600 transition-colors">Learn</a>
                    <a href="#playground" class="text-gray-600 hover:text-blue-600 transition-colors">Playground</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-gradient text-white py-20">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-5xl font-bold mb-6">Advanced Options Pricing & Greeks Analysis</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Real-time options pricing with comprehensive Greeks analysis. 
                Professional-grade calculations using multiple validated pricing models.
            </p>
            <div class="flex justify-center space-x-4">
                <button onclick="scrollToSection('calculator')" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    Start Calculating
                </button>
                <button onclick="scrollToSection('learn')" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors">
                    Learn Basics
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        <!-- Options Calculator Section -->
        <section id="calculator" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Options Calculator</h3>
                
                <!-- Calculator Form -->
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Option Parameters</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol (Optional)</label>
                            <input type="text" id="symbol" placeholder="AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Price ($)</label>
                            <input type="number" id="stockPrice" value="150" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Strike Price ($)</label>
                            <input type="number" id="strikePrice" value="155" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Days to Expiry</label>
                            <input type="number" id="daysToExpiry" value="30" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Volatility (%)</label>
                            <input type="number" id="volatility" value="25" step="0.1" min="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Option Type</label>
                            <select id="optionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                            </select>
                        </div>
                        
                        <button onclick="calculateOption()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Calculate Option Price
                        </button>
                    </div>
                    
                    <!-- Results Display -->
                    <div class="space-y-6">
                        <h4 class="text-xl font-semibold mb-4">Pricing Results</h4>
                        <div id="results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Enter parameters and click calculate to see results
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Visualization Section -->
        <section id="greeks" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Interactive Greeks Dashboard</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Values</h4>
                        <div id="greeksDisplay" class="space-y-3">
                            <!-- Greeks will be displayed here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Greeks Chart</h4>
                        <div class="relative w-full" style="height: 400px;">
                            <canvas id="greeksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Greeks Tutorial -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎓 Interactive Greeks Tutorial</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">Learn the difference between actual rates and sensitivity measures through interactive examples. This addresses the common confusion between rates and Greeks.</p>
                
                <!-- Tutorial Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">📊</span>
                            Risk-Free Rate (Actual Rate)
                        </h4>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="text-sm font-medium text-gray-700 w-16">Rate:</label>
                            <input type="range" id="tutorialRate" min="1" max="10" step="0.5" value="4" class="flex-1">
                            <span id="tutorialRateValue" class="text-xl font-bold text-green-600 w-16">4.0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This is the actual interest rate in the economy:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• Fed funds rate</li>
                                <li>• Treasury bond yields</li>
                                <li>• What banks pay on deposits</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">⚡</span>
                            Rho (Rate Sensitivity)
                        </h4>
                        <div class="text-center mb-3">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="tutorialRhoValue">$0.27</div>
                            <p class="text-sm text-gray-600">per 1% rate change</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 mb-2">This tells you how much your option price changes:</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>• NOT the rate itself</li>
                                <li>• Rate of change (derivative)</li>
                                <li>• Like speed vs distance</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Demonstration -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="font-semibold text-gray-800 mb-6 text-center flex items-center justify-center">
                        <span class="text-2xl mr-2">🎯</span>
                        See the Difference in Action
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="p-6 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-2xl font-bold text-green-700 mb-2" id="currentOptionPrice">$8.45</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Current Option Price</p>
                            <p class="text-xs text-green-600">At <span id="currentRate1">4.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-2xl font-bold text-blue-700 mb-2" id="newOptionPrice">$8.72</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">New Option Price</p>
                            <p class="text-xs text-blue-600">At <span id="newRate">5.0%</span> rate</p>
                        </div>
                        <div class="p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-2xl font-bold text-purple-700 mb-2" id="priceChange">+$0.27</div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Price Change</p>
                            <p class="text-xs text-purple-600 font-semibold">This equals Rho!</p>
                        </div>
                    </div>
                    
                    <!-- Dynamic Explanation -->
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center">
                            <span class="text-xl mr-2">💡</span>
                            Key Insight
                        </h5>
                        <div class="space-y-2 text-amber-700">
                            <p class="font-medium">
                                Risk-Free Rate = <span id="explanationCurrentRate">4%</span> (the actual rate)
                            </p>
                            <p class="font-medium">
                                Rho = <span id="explanationRho">$0.27</span> (how much price changes per 1% rate move)
                            </p>
                            <p class="text-sm border-t border-amber-200 pt-2 mt-3">
                                <strong>Example:</strong> If rates go from <span id="explanationFromRate">4%</span> → <span id="explanationToRate">5%</span>, 
                                your option gains <span id="explanationGain">$0.27</span> in value.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Algorithm Animations Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🎬 Algorithm Visualizations</h3>
                <p class="text-gray-600 mb-8 text-center max-w-3xl mx-auto">See how options pricing models work step-by-step. Watch the mathematics come to life through interactive animations.</p>
                
                <!-- Algorithm Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showAlgorithm('binomial')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" id="binomialBtn">
                        🌳 Binomial Tree
                    </button>
                    <button onclick="showAlgorithm('trinomial')" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors" id="trinomialBtn">
                        🔷 Trinomial Tree
                    </button>
                    <button onclick="showAlgorithm('blackscholes')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="blackscholesBtn">
                        📐 Black-Scholes
                    </button>
                    <button onclick="showAlgorithm('montecarlo')" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" id="montecarloBtn">
                        🎲 Monte Carlo
                    </button>
                    <button onclick="showAlgorithm('jumpdiffusion')" class="px-6 py-3 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 transition-colors" id="jumpdiffusionBtn">
                        ⚡ Jump Diffusion
                    </button>
                </div>
                
                <!-- Binomial Tree Animation -->
                <div id="binomialAnimation" class="algorithm-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🌳</span>
                            Binomial Tree Model (Cox-Ross-Rubinstein)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Step-by-Step Construction</h5>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Steps:</span>
                                            <input type="range" id="binomialSteps" min="1" max="5" value="3" class="ml-4">
                                            <span id="binomialStepsValue" class="font-bold ml-2">3</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Speed:</span>
                                            <input type="range" id="animationSpeed" min="500" max="3000" value="1500" class="ml-4">
                                            <span class="text-xs ml-2">Slow → Fast</span>
                                        </div>
                                        <button onclick="animateBinomialTree()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-3">
                                            ▶️ Animate Tree Construction
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tree Visualization Canvas -->
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="treeCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">🌳</div>
                                            <p>Click "Animate Tree Construction" to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Explanation Panel -->
                            <div class="space-y-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">How It Works</h5>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <div class="step-explanation" id="step1">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">1</span>
                                                <div>
                                                    <strong>Start:</strong> Current stock price S₀ = $<span class="font-mono">100</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step2">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">2</span>
                                                <div>
                                                    <strong>Up/Down:</strong> Price can go up by factor u = <span class="font-mono">1.05</span> or down by d = <span class="font-mono">0.95</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step3">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">3</span>
                                                <div>
                                                    <strong>Risk-Neutral:</strong> Probability p = <span class="font-mono">0.52</span>, (1-p) = <span class="font-mono">0.48</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation opacity-50" id="step4">
                                            <div class="flex items-start">
                                                <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">4</span>
                                                <div>
                                                    <strong>Work Backwards:</strong> Start from expiry, calculate option values at each node
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">Current Step</h5>
                                    <div id="currentStepDisplay" class="text-sm text-amber-700">
                                        Ready to begin animation...
                                    </div>
                                </div>
                                
                                <!-- Mathematical Formula -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Key Formulas</h5>
                                    <div class="space-y-2 text-xs font-mono text-gray-600">
                                        <div>u = e^(σ√Δt) ≈ 1.05</div>
                                        <div>d = 1/u ≈ 0.95</div>
                                        <div>p = (e^(rΔt) - d)/(u - d)</div>
                                        <div>V = e^(-rΔt)[pV_up + (1-p)V_down]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trinomial Tree Animation -->
                <div id="trinomialAnimation" class="algorithm-content" style="display: none;">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🔷</span>
                            Trinomial Tree Model (Boyle)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tree Visualization -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h5 class="text-lg font-semibold">Tree Evolution</h5>
                                    <div class="flex gap-2">
                                        <button onclick="animateTrinomialTree()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">
                                            ▶️ Animate
                                        </button>
                                        <button onclick="resetTrinomialAnimation()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-semibold hover:bg-gray-700">
                                            🔄 Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="mb-4 space-y-3">
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Steps:</label>
                                        <input type="range" id="trinomialSteps" min="2" max="4" value="3" class="flex-1">
                                        <span id="trinomialStepsDisplay" class="text-sm font-mono">3</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <label class="text-sm font-medium">Speed:</label>
                                        <input type="range" id="trinomialSpeed" min="500" max="3000" value="1500" class="flex-1">
                                        <span class="text-sm">Slow ↔ Fast</span>
                                    </div>
                                </div>
                                
                                <!-- Animation Canvas -->
                                <div id="trinomialCanvas" class="bg-gray-50 rounded-lg min-h-64 border overflow-auto">
                                    <div class="p-8 text-center text-gray-500">
                                        <div class="text-4xl mb-4">🔷</div>
                                        <p>Click "Animate" to see trinomial tree construction</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Educational Content -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Trinomial vs Binomial</h5>
                                    <div class="space-y-2 text-sm text-blue-700">
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔺</span>
                                                <div>
                                                    <strong>Up Move:</strong> Price increases by factor u = <span class="font-mono">e^(σ√(2Δt))</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">➡️</span>
                                                <div>
                                                    <strong>Middle Move:</strong> Price stays the same (unique to trinomial)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🔻</span>
                                                <div>
                                                    <strong>Down Move:</strong> Price decreases by factor d = 1/u
                                                </div>
                                            </div>
                                        </div>
                                        <div class="step-explanation">
                                            <div class="flex items-start">
                                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 mt-0.5">🎯</span>
                                                <div>
                                                    <strong>Better Accuracy:</strong> 16.4% more accurate than binomial trees
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Step Display -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Current Step</h5>
                                    <div id="trinomialStepDisplay" class="text-sm text-green-700">
                                        Ready to begin trinomial tree animation...
                                    </div>
                                </div>
                                
                                <!-- Probability Formulas -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-800 mb-3">Risk-Neutral Probabilities</h5>
                                    <div class="text-sm space-y-2 font-mono">
                                        <div><strong>p_u</strong> = ((e^(r·Δt) - d)(u - 1)) / ((u - d)(u - 1))</div>
                                        <div><strong>p_m</strong> = 1 - p_u - p_d</div>
                                        <div><strong>p_d</strong> = ((e^(r·Δt) - d)(1 - d)) / ((u - d)(1 - d))</div>
                                    </div>
                                </div>
                                
                                <!-- Advantages -->
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">🚀 Advantages</h5>
                                    <ul class="text-sm text-purple-700 space-y-1">
                                        <li>• <strong>Higher accuracy</strong> with fewer steps</li>
                                        <li>• <strong>Stable convergence</strong> to analytical solutions</li>
                                        <li>• <strong>Better for exotic options</strong> with barriers</li>
                                        <li>• <strong>Recommended model</strong> for production use</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monte Carlo Animation -->
                <div id="montecarloAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎲</span>
                            Monte Carlo Simulation
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Simulation Controls -->
                            <div class="space-y-4">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">Simulation Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Paths:</span>
                                            <input type="range" id="mcPaths" min="100" max="10000" step="100" value="1000" class="ml-4">
                                            <span id="mcPathsValue" class="font-bold ml-2">1,000</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Show Paths:</span>
                                            <input type="range" id="mcShowPaths" min="10" max="100" value="50" class="ml-4">
                                            <span id="mcShowPathsValue" class="font-bold ml-2">50</span>
                                        </div>
                                        <button onclick="animateMonteCarlo()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                            🎲 Run Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Statistics Panel -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Live Statistics</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Paths Completed:</span>
                                            <span id="mcPathsCompleted" class="font-bold">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Current Price:</span>
                                            <span id="mcCurrentPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Standard Error:</span>
                                            <span id="mcStandardError" class="font-bold">±$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Confidence:</span>
                                            <span id="mcConfidence" class="font-bold">95%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Path Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="mcCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📈</div>
                                            <p>Click "Run Simulation" to see random paths</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Insight -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-2">💡 Key Insight</h5>
                                    <p class="text-sm text-yellow-700">
                                        Each path follows: S(t) = S₀ × e^((r-σ²/2)t + σ√t×Z) where Z ~ N(0,1). 
                                        More paths = more accurate price!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Black-Scholes Animation -->
                <div id="blackscholesAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📐</span>
                            Black-Scholes Formula
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formula Breakdown -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-purple-800 mb-3">Formula Components</h5>
                                    <button onclick="animateBlackScholes()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors mb-4">
                                        📐 Break Down Formula
                                    </button>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="formula-step opacity-30" id="bsStep1">
                                            <div class="font-mono bg-white p-2 rounded">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                                            <p class="text-purple-700 mt-1">Call option price formula</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep2">
                                            <div class="font-mono bg-white p-2 rounded">d₁ = [ln(S/K) + (r + σ²/2)T] / (σ√T)</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (adjusted for drift)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep3">
                                            <div class="font-mono bg-white p-2 rounded">d₂ = d₁ - σ√T</div>
                                            <p class="text-purple-700 mt-1">Distance to strike (risk-adjusted)</p>
                                        </div>
                                        
                                        <div class="formula-step opacity-30" id="bsStep4">
                                            <div class="font-mono bg-white p-2 rounded">N(x) = Cumulative normal distribution</div>
                                            <p class="text-purple-700 mt-1">Probability of being in-the-money</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Calculation -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">Live Calculation</h5>
                                    <div id="bsCalculation" class="space-y-2 text-sm font-mono">
                                        <div>S₀ = $100, K = $105, T = 0.082 years</div>
                                        <div>r = 4%, σ = 25%</div>
                                        <div id="bsLiveCalc">Click "Break Down Formula" to see calculation...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Normal Distribution Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-64" id="bsCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">📊</div>
                                            <p>Normal distribution visualization will appear here</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Assumptions -->
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-amber-800 mb-3">⚠️ Key Assumptions</h5>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>• Constant volatility and risk-free rate</li>
                                        <li>• No dividends (can be adjusted)</li>
                                        <li>• European exercise only</li>
                                        <li>• Log-normal stock price distribution</li>
                                        <li>• No transaction costs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jump Diffusion Animation -->
                <div id="jumpdiffusionAnimation" class="algorithm-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">⚡</span>
                            Jump Diffusion Model (Merton)
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Jump Controls -->
                            <div class="space-y-4">
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-3">Jump Parameters</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Intensity (λ):</span>
                                            <input type="range" id="jumpIntensity" min="0.1" max="5" step="0.1" value="2" class="ml-4">
                                            <span id="jumpIntensityValue" class="font-bold ml-2">2.0</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Size (μ_J):</span>
                                            <input type="range" id="jumpMean" min="-0.1" max="0.1" step="0.01" value="-0.02" class="ml-4">
                                            <span id="jumpMeanValue" class="font-bold ml-2">-2%</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Jump Vol (σ_J):</span>
                                            <input type="range" id="jumpVol" min="0.05" max="0.2" step="0.01" value="0.08" class="ml-4">
                                            <span id="jumpVolValue" class="font-bold ml-2">8%</span>
                                        </div>
                                        <div class="flex items-center justify-between text-sm">
                                            <span>Time Steps:</span>
                                            <input type="range" id="jumpSteps" min="100" max="1000" step="50" value="250" class="ml-4">
                                            <span id="jumpStepsValue" class="font-bold ml-2">250</span>
                                        </div>
                                        <button onclick="animateJumpDiffusion()" class="w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                                            ⚡ Start Jump Simulation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Educational Content -->
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-red-800 mb-3">🎯 Why Jump Diffusion?</h5>
                                    <div class="text-sm text-red-700 space-y-2">
                                        <p><strong>Market Reality:</strong> Stock prices can jump suddenly due to news, earnings, or market crashes.</p>
                                        <p><strong>Black-Scholes Limitation:</strong> Assumes continuous, smooth price changes only.</p>
                                        <p><strong>Jump Enhancement:</strong> Adds sudden price jumps to normal diffusion process.</p>
                                        <div class="font-mono bg-white p-2 rounded mt-3">
                                            dS = μSdt + σSdW + SdJ
                                        </div>
                                        <p><strong>dJ:</strong> Jump component with Poisson arrival</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visualization -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4 h-80" id="jumpCanvas">
                                    <div class="flex items-center justify-center h-full text-gray-500">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">⚡</div>
                                            <p>Jump diffusion simulation will appear here</p>
                                            <p class="text-sm mt-2">Click "Start Jump Simulation" to see price paths with sudden jumps</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Jump Statistics -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Jump Statistics</h5>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="block text-gray-600">Expected Jumps/Year:</span>
                                            <span id="expectedJumps" class="font-bold text-blue-800">2.0</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Observed Jumps:</span>
                                            <span id="observedJumps" class="font-bold text-blue-800">0</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Avg Jump Size:</span>
                                            <span id="avgJumpSize" class="font-bold text-blue-800">0%</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-600">Price Range:</span>
                                            <span id="priceRange" class="font-bold text-blue-800">$0 - $0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Model Comparison -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">📊 Model Comparison</h5>
                                    <div class="text-sm text-green-700 space-y-1">
                                        <div class="flex justify-between">
                                            <span>Black-Scholes Price:</span>
                                            <span id="bsJumpPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Jump-Diffusion Price:</span>
                                            <span id="jdJumpPrice" class="font-bold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Jump Premium:</span>
                                            <span id="jumpPremium" class="font-bold">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Tutorials Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">📚 Interactive Tutorials</h3>
                <p class="text-gray-600 text-center mb-8">Step-by-step guided learning experiences to master options concepts</p>
                
                <!-- Tutorial Selection -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button onclick="showTutorial('greeks')" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors" id="greeksTutorialBtn">
                        📊 Understanding Greeks
                    </button>
                    <button onclick="showTutorial('options-basics')" class="px-6 py-3 bg-pink-600 text-white rounded-lg font-semibold hover:bg-pink-700 transition-colors" id="optionsBasicsTutorialBtn">
                        🎯 Options Basics
                    </button>
                    <button onclick="showTutorial('pricing-models')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors" id="pricingModelsTutorialBtn">
                        ⚙️ Pricing Models
                    </button>
                    <button onclick="showTutorial('risk-management')" class="px-6 py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors" id="riskManagementTutorialBtn">
                        🛡️ Risk Management
                    </button>
                </div>
                
                <!-- Understanding Greeks Tutorial -->
                <div id="greeksTutorial" class="tutorial-content">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">📊</span>
                            Understanding the Greeks - Interactive Tutorial
                        </h4>
                        
                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="tutorialProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-500" id="progressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div id="tutorialStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-purple-800">Step 1: What are the Greeks?</div>
                                        <p class="text-purple-700">The "Greeks" are risk sensitivities that measure how an option's price changes with respect to various factors. They're called Greeks because most are represented by Greek letters (Δ, Γ, Θ, ν, ρ).</p>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Think of Greeks as:</strong>
                                            <ul class="mt-2 text-sm space-y-1">
                                                <li>• <strong>Delta (Δ):</strong> Speed - how fast price moves with stock</li>
                                                <li>• <strong>Gamma (Γ):</strong> Acceleration - how speed changes</li>
                                                <li>• <strong>Theta (Θ):</strong> Time decay - daily price erosion</li>
                                                <li>• <strong>Vega (ν):</strong> Volatility sensitivity</li>
                                                <li>• <strong>Rho (ρ):</strong> Interest rate sensitivity</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousTutorialStep()" id="prevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextTutorialStep()" id="nextBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Live Greeks Demo</h5>
                                    <div id="tutorialDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Price: <span id="tutorialStockPrice">$100</span></label>
                                                <input type="range" id="tutorialStockSlider" min="80" max="120" value="100" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Days to Expiry: <span id="tutorialDaysValue">30</span></label>
                                                <input type="range" id="tutorialDaysSlider" min="1" max="90" value="30" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Volatility: <span id="tutorialVolValue">25%</span></label>
                                                <input type="range" id="tutorialVolSlider" min="10" max="50" value="25" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Greeks Display for Tutorial -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Current Greeks</h5>
                                    <div class="space-y-2 text-sm" id="tutorialGreeksDisplay">
                                        <div class="flex justify-between">
                                            <span>Delta (Δ):</span>
                                            <span class="font-bold" id="tutorialDelta">0.60</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Gamma (Γ):</span>
                                            <span class="font-bold" id="tutorialGamma">0.03</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Theta (Θ):</span>
                                            <span class="font-bold" id="tutorialTheta">-0.15</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Vega (ν):</span>
                                            <span class="font-bold" id="tutorialVega">0.20</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">💡 Key Insight</h5>
                                    <p class="text-sm text-green-700" id="tutorialInsight">
                                        Move the stock price slider and watch how Delta changes the option value. Delta tells you how much the option price moves for each $1 stock price change!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Options Basics Tutorial -->
                <div id="optionsBasicsTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🎯</span>
                            Options Basics - Interactive Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Options Basics -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="optionsBasicsProgress">Step 1 of 6</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-pink-600 h-2 rounded-full transition-all duration-500" id="optionsBasicsProgressBar" style="width: 16.6%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-pink-50 p-4 rounded-lg">
                                    <div id="optionsBasicsStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-pink-800">Step 1: What is an Option?</div>
                                        <p class="text-pink-700">An option is a contract that gives you the RIGHT (not obligation) to buy or sell a stock at a specific price by a certain date. Think of it like a reservation at a restaurant - you have the right to use it, but you don't have to.</p>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Key Components:</strong>
                                            <ul class="mt-2 text-sm space-y-1">
                                                <li>• <strong>Strike Price:</strong> The price at which you can buy/sell</li>
                                                <li>• <strong>Expiration Date:</strong> When the option expires</li>
                                                <li>• <strong>Premium:</strong> The cost to buy the option</li>
                                                <li>• <strong>Underlying Asset:</strong> The stock the option is based on</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousOptionsBasicsStep()" id="optionsBasicsPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextOptionsBasicsStep()" id="optionsBasicsNextBtn" class="px-4 py-2 bg-pink-600 text-white rounded-lg font-medium hover:bg-pink-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Interactive Example</h5>
                                    <div id="optionsBasicsDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div class="bg-blue-100 p-3 rounded">
                                                <div class="text-sm font-medium text-blue-800">Example: AAPL Call Option</div>
                                                <div class="text-xs text-blue-600 mt-1">
                                                    <div>Current AAPL Price: $150</div>
                                                    <div>Strike Price: $155</div>
                                                    <div>Expires: 30 days</div>
                                                    <div>Premium: $3.50</div>
                                                </div>
                                            </div>
                                            <div class="text-sm">
                                                <strong>What this means:</strong> You pay $350 ($3.50 × 100 shares) for the right to buy 100 AAPL shares at $155 each, anytime in the next 30 days.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dynamic Visualization Area -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">📊 Visualization</h5>
                                    <div id="optionsBasicsVisualization">
                                        <div class="h-32 bg-white rounded border flex items-center justify-center">
                                            <div class="text-center text-gray-500">
                                                <div class="text-2xl mb-1">📈</div>
                                                <div class="text-sm">Option concept diagram</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-yellow-800 mb-3">💡 Key Point</h5>
                                    <p class="text-sm text-yellow-700" id="optionsBasicsInsight">
                                        Options give you leverage and limited risk. You can control 100 shares for much less money than buying the stock outright!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="pricingModelsTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">⚙️</span>
                            Pricing Models Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Pricing Models -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="pricingModelsProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" id="pricingModelsProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <div id="pricingModelsStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-indigo-800">Step 1: Why Multiple Pricing Models?</div>
                                        <p class="text-indigo-700">Different pricing models make different assumptions and trade off accuracy for speed. Understanding when to use each model is crucial for effective options trading.</p>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousPricingModelsStep()" id="pricingModelsPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextPricingModelsStep()" id="pricingModelsNextBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo Area -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Live Model Comparison</h5>
                                    <div id="pricingModelsDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Price: <span id="modelsStockPrice">$100</span></label>
                                                <input type="range" id="modelsStockSlider" min="80" max="120" value="100" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Days to Expiry: <span id="modelsDaysValue">30</span></label>
                                                <input type="range" id="modelsDaysSlider" min="1" max="90" value="30" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Volatility: <span id="modelsVolValue">25%</span></label>
                                                <input type="range" id="modelsVolSlider" min="10" max="50" value="25" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Model Prices Display -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Model Comparison</h5>
                                    <div class="space-y-2 text-sm" id="modelPricesDisplay">
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                                Trinomial:
                                            </span>
                                            <span class="font-bold" id="modelTrinomialPrice">$8.45</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                                Binomial:
                                            </span>
                                            <span class="font-bold" id="modelBinomialPrice">$8.42</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                                Black-Scholes:
                                            </span>
                                            <span class="font-bold" id="modelBSPrice">$8.38</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                                Monte Carlo:
                                            </span>
                                            <span class="font-bold" id="modelMCPrice">$8.41 ±0.05</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="flex items-center">
                                                <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                                                Jump Diffusion:
                                            </span>
                                            <span class="font-bold" id="modelJDPrice">$8.62</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">💡 Key Insight</h5>
                                    <p class="text-sm text-green-700" id="modelsInsight">
                                        Notice how different models give slightly different prices. The trinomial model is generally the most accurate, while Black-Scholes is the fastest but assumes no early exercise.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="riskManagementTutorial" class="tutorial-content hidden">
                    <div class="bg-white rounded-lg p-6 shadow-sm">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-3xl mr-3">🛡️</span>
                            Risk Management Tutorial
                        </h4>
                        
                        <!-- Progress Bar for Risk Management -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Tutorial Progress</span>
                                <span class="text-sm text-gray-600" id="riskManagementProgress">Step 1 of 5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-emerald-600 h-2 rounded-full transition-all duration-500" id="riskManagementProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Tutorial Content -->
                            <div class="space-y-4">
                                <div class="bg-emerald-50 p-4 rounded-lg">
                                    <div id="riskManagementStep" class="space-y-4">
                                        <!-- Step content will be dynamically updated -->
                                        <div class="text-lg font-semibold text-emerald-800">Step 1: The Foundation of Options Risk</div>
                                        <p class="text-emerald-700">Successful options trading starts with understanding and managing risk. Unlike stock trading, options have multiple risk dimensions that must be monitored continuously.</p>
                                    </div>
                                    
                                    <div class="flex justify-between mt-6">
                                        <button onclick="previousRiskManagementStep()" id="riskManagementPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" disabled>
                                            ← Previous
                                        </button>
                                        <button onclick="nextRiskManagementStep()" id="riskManagementNextBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                                            Next →
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interactive Demo Area -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Portfolio Risk Simulator</h5>
                                    <div id="riskManagementDemo">
                                        <!-- Interactive elements for current step -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Portfolio Size: <span id="portfolioSize">$10,000</span></label>
                                                <input type="range" id="portfolioSlider" min="5000" max="50000" step="1000" value="10000" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Risk Per Trade: <span id="riskPerTrade">2%</span></label>
                                                <input type="range" id="riskSlider" min="1" max="10" step="0.5" value="2" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Win Rate: <span id="winRate">60%</span></label>
                                                <input type="range" id="winRateSlider" min="30" max="80" step="5" value="60" class="w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Metrics Display -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-blue-800 mb-3">Risk Analysis</h5>
                                    <div class="space-y-2 text-sm" id="riskMetricsDisplay">
                                        <div class="flex justify-between items-center">
                                            <span>Max Loss Per Trade:</span>
                                            <span class="font-bold text-red-600" id="maxLossPerTrade">$200</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Position Size:</span>
                                            <span class="font-bold" id="positionSize">2 contracts</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Expected Value:</span>
                                            <span class="font-bold text-green-600" id="expectedValue">+$24</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Kelly Criterion:</span>
                                            <span class="font-bold" id="kellyCriterion">3.6%</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Risk of Ruin:</span>
                                            <span class="font-bold text-orange-600" id="riskOfRuin">8.2%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step-specific insights -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-green-800 mb-3">🛡️ Risk Insight</h5>
                                    <p class="text-sm text-green-700" id="riskInsight">
                                        Risk management starts with position sizing. Never risk more than 1-2% of your portfolio on a single trade, regardless of how confident you feel!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3D Greeks Surface Plots Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">🌊 3D Greeks Surface Plots</h3>
                <p class="text-gray-600 text-center mb-8">Visualize how Greeks change across stock price and time dimensions</p>
                
                <!-- 3D Controls -->
                <div class="bg-white rounded-lg p-6 mb-6">
                    <div class="grid md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Greek to Visualize</label>
                            <select id="greek3D" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="delta">Delta (Price Sensitivity)</option>
                                <option value="gamma">Gamma (Delta Change)</option>
                                <option value="theta">Theta (Time Decay)</option>
                                <option value="vega">Vega (Volatility Sensitivity)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Base Stock Price ($)</label>
                            <input type="number" id="base3DStock" value="100" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price ($)</label>
                            <input type="number" id="strike3D" value="105" min="10" max="500" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Volatility (%)</label>
                            <input type="number" id="vol3D" value="25" min="5" max="100" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-center space-x-4 mb-4">
                        <button id="generate3D" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            🎨 Generate 3D Surface
                        </button>
                        <button id="rotate3D" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            🔄 Auto Rotate
                        </button>
                    </div>
                </div>
                
                <!-- 3D Canvas Container -->
                <div class="bg-white rounded-lg p-4 mb-6">
                    <div id="threejs-container" class="w-full h-96 bg-gray-900 rounded-lg relative">
                        <div id="loading3D" class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center">
                                <div class="animate-spin text-4xl mb-4">🌀</div>
                                <p>Loading 3D visualization...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3D Analysis Display -->
                <div id="surface-analysis" class="grid md:grid-cols-3 gap-4 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Surface Statistics</h5>
                        <div id="surface-stats" class="text-sm text-gray-600">
                            <div class="mb-1">Max Value: <span id="max-value" class="font-mono text-blue-600">--</span></div>
                            <div class="mb-1">Min Value: <span id="min-value" class="font-mono text-red-600">--</span></div>
                            <div>Range: <span id="value-range" class="font-mono text-green-600">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Key Insights</h5>
                        <div id="surface-insights" class="text-sm text-gray-600">
                            <div id="insight-text">Click "Generate 3D Surface" to see insights</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-semibold text-gray-800 mb-2">Interactive Guide</h5>
                        <div class="text-sm text-gray-600">
                            <div class="mb-1">🖱️ <strong>Mouse:</strong> Rotate view</div>
                            <div class="mb-1">🔍 <strong>Scroll:</strong> Zoom in/out</div>
                            <div>🎯 <strong>Click:</strong> Reset view</div>
                        </div>
                    </div>
                </div>

                <!-- Educational Context -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">🎓 Understanding 3D Greeks</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">What You're Seeing:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>X-Axis:</strong> Stock prices (around current price)</li>
                                <li>• <strong>Y-Axis:</strong> Time to expiration (days)</li>
                                <li>• <strong>Z-Axis (Height):</strong> Greek value</li>
                                <li>• <strong>Colors:</strong> Heat map of values</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium text-blue-700 mb-2">Key Patterns:</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• <strong>Delta:</strong> Steeper near strike, flatter far away</li>
                                <li>• <strong>Gamma:</strong> Peaks at-the-money, fades with time</li>
                                <li>• <strong>Theta:</strong> Accelerates as expiration approaches</li>
                                <li>• <strong>Vega:</strong> Highest with time, peaks at-the-money</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Greeks Education Section -->
        <section id="learn" class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Understanding the Greeks</h3>
            
            <!-- Common Misconception Alert -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 mb-8">
                <div class="flex">
                    <div class="text-amber-400 text-2xl mr-3">⚠️</div>
                    <div>
                        <h4 class="text-lg font-semibold text-amber-800 mb-2">Common Confusion: Rho ≠ Risk-Free Rate</h4>
                        <p class="text-amber-700">The risk-free rate is the actual interest rate (like 4%). <strong>Rho</strong> is how much your option price <em>changes</em> when that rate moves by 1%.</p>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <h5 class="font-bold text-blue-800 mb-2">Delta (Δ)</h5>
                    <p class="text-sm text-blue-700 mb-2">Speed of price change</p>
                    <p class="text-xs text-gray-600">If stock moves $1, option moves ~$Delta. Call: 0-1, Put: -1-0</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                    <h5 class="font-bold text-green-800 mb-2">Gamma (Γ)</h5>
                    <p class="text-sm text-green-700 mb-2">Acceleration</p>
                    <p class="text-xs text-gray-600">How much Delta changes per $1 stock move. Higher = more responsive</p>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                    <h5 class="font-bold text-red-800 mb-2">Theta (Θ)</h5>
                    <p class="text-sm text-red-700 mb-2">Time decay</p>
                    <p class="text-xs text-gray-600">$ lost per day. Always negative - time kills options</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                    <h5 class="font-bold text-purple-800 mb-2">Vega (V)</h5>
                    <p class="text-sm text-purple-700 mb-2">Volatility sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% volatility move (25% → 26%)</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h5 class="font-bold text-yellow-800 mb-2">Rho (ρ)</h5>
                    <p class="text-sm text-yellow-700 mb-2">Rate sensitivity</p>
                    <p class="text-xs text-gray-600">$ change per 1% rate move (4% → 5%). Call: +, Put: -</p>
                </div>
            </div>

            <!-- Interactive Examples -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-semibold mb-4">Real-World Example</h4>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium mb-3">📱 AAPL $150 Call, $155 Strike, 30 days</h5>
                        <div class="space-y-2 text-sm">
                            <div><strong>Delta = 0.35:</strong> If AAPL rises $1 → Call gains ~$0.35</div>
                            <div><strong>Gamma = 0.02:</strong> That 0.35 delta becomes ~0.37</div>
                            <div><strong>Theta = -0.08:</strong> Loses $0.08 every day that passes</div>
                            <div><strong>Vega = 0.12:</strong> If volatility rises 1% → Call gains $0.12</div>
                            <div><strong>Rho = 0.27:</strong> If rates rise from 4%→5% → Call gains $0.27</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium mb-3">🎯 Key Insights</h5>
                        <ul class="text-sm space-y-1 text-gray-700">
                            <li>• <strong>All Greeks are rates of change</strong> (derivatives)</li>
                            <li>• Delta shows directional exposure</li>
                            <li>• Gamma shows how fast that changes</li>
                            <li>• Theta is your daily bleed</li>
                            <li>• Vega matters most for earnings/events</li>
                            <li>• Rho barely matters unless rates are moving fast</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center">Calculator Features</h3>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-blue-600 text-3xl mb-4">📊</div>
                    <h4 class="text-xl font-semibold mb-3">Real-time Pricing</h4>
                    <p class="text-gray-600 mb-4">Calculate options prices using multiple validated pricing models with instant results.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-green-600 text-3xl mb-4">📈</div>
                    <h4 class="text-xl font-semibold mb-3">Greeks Analysis</h4>
                    <p class="text-gray-600 mb-4">Complete Greeks calculation with visual charts showing risk sensitivities.</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="text-purple-600 text-3xl mb-4">🧮</div>
                    <h4 class="text-xl font-semibold mb-3">Model Comparison</h4>
                    <p class="text-gray-600 mb-4">Compare Trinomial, Binomial, Black-Scholes, and Monte Carlo pricing side-by-side.</p>
                </div>
            </div>
        </section>

        <!-- Payoff Diagram Builder Section -->
        <section id="playground" class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">Strategy Builder & Payoff Diagrams</h3>
                
                <!-- Strategy Builder Controls -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Build Your Strategy</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                                <select id="strategyType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="single">Single Option</option>
                                    <option value="covered-call">Covered Call</option>
                                    <option value="protective-put">Protective Put</option>
                                    <option value="straddle">Long Straddle</option>
                                    <option value="strangle">Long Strangle</option>
                                    <option value="butterfly">Butterfly Spread</option>
                                    <option value="custom">Custom Multi-Leg</option>
                                </select>
                            </div>
                            
                            <div id="strategyParams" class="space-y-3">
                                <!-- Strategy parameters will be populated here -->
                            </div>
                            
                            <button onclick="buildPayoffDiagram()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Generate Payoff Diagram
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xl font-semibold mb-4">Payoff Chart</h4>
                        <div class="relative w-full bg-gray-50 rounded-lg" style="height: 300px;">
                            <canvas id="payoffChart"></canvas>
                        </div>
                        
                        <div id="strategyMetrics" class="mt-4 space-y-2">
                            <!-- Strategy metrics will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Predefined Strategy Examples -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-4">Popular Strategies</h4>
                    <div class="grid md:grid-cols-4 gap-4">
                        <button onclick="loadStrategy('covered-call')" class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-blue-800">Covered Call</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + sell call</p>
                            <p class="text-xs text-blue-600 mt-1">📈 Neutral/Bullish</p>
                        </button>
                        
                        <button onclick="loadStrategy('protective-put')" class="bg-green-50 hover:bg-green-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-green-800">Protective Put</h5>
                            <p class="text-xs text-gray-600 mt-1">Own stock + buy put</p>
                            <p class="text-xs text-green-600 mt-1">📈 Bullish protection</p>
                        </button>
                        
                        <button onclick="loadStrategy('straddle')" class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-purple-800">Long Straddle</h5>
                            <p class="text-xs text-gray-600 mt-1">Buy call + put same strike</p>
                            <p class="text-xs text-purple-600 mt-1">⚡ High volatility play</p>
                        </button>
                        
                        <button onclick="loadStrategy('iron-condor')" class="bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg text-left transition-colors">
                            <h5 class="font-medium text-yellow-800">Iron Condor</h5>
                            <p class="text-xs text-gray-600 mt-1">4-leg neutral strategy</p>
                            <p class="text-xs text-yellow-600 mt-1">😴 Low volatility play</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="mb-16">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h3 class="text-3xl font-bold mb-8 text-center">About</h3>
                <div class="text-center">
                    <p class="text-gray-600 mb-6">Professional options pricing calculator with advanced Greeks analysis and model comparison capabilities.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">Multiple Models</h5>
                            <p class="text-sm text-blue-600">Trinomial, Binomial, Black-Scholes, Monte Carlo</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">Real-time Greeks</h5>
                            <p class="text-sm text-green-600">Delta, Gamma, Theta, Vega, Rho analysis</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-2">Validated Accuracy</h5>
                            <p class="text-sm text-purple-600">Market-tested pricing algorithms</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-red-800 mb-2">Professional Grade</h5>
                            <p class="text-sm text-red-600">Industry-standard calculations</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h5 class="text-lg font-semibold mb-4">Options Calculator</h5>
                    <p class="text-gray-400">Professional-grade options pricing and Greeks analysis.</p>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Models</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Trinomial Trees</li>
                        <li>Binomial Trees</li>
                        <li>Black-Scholes</li>
                        <li>Monte Carlo</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Analysis</h5>
                    <ul class="text-gray-400 space-y-2">
                        <li>Complete Greeks Suite</li>
                        <li>Model Comparison</li>
                        <li>Risk Visualization</li>
                        <li>Real-time Updates</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>Professional Options Pricing Calculator</p>
            </div>
        </div>
    </footer>

    <!-- Include the pricing library -->
    <script type="module" src="../lib/index.js"></script>
    
    <!-- Main application JavaScript -->
    <script type="module">
        // Import pricing functions from our validated library
        let pricingLibrary;
        let greeksChart;
        
        // Initialize the application
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Import pricing library
                const module = await import('../lib/index.js');
                pricingLibrary = module;
                console.log('🚀 Pricing library loaded successfully');
                console.log('📊 Loaded modules:', Object.keys(module));
                
                // Initialize Greeks chart with fixed responsive settings
                initializeGreeksChart();
                
            } catch (error) {
                console.error('❌ Failed to load pricing library:', error);
                // Show error to user
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Library Loading Error</h5>
                        <p class="text-sm">Failed to load the pricing library. Please check the console for details.</p>
                    </div>
                `;
            }
        });

        // Initialize Greeks radar chart with proper responsive settings
        function initializeGreeksChart() {
            const ctx = document.getElementById('greeksChart').getContext('2d');
            
            greeksChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Delta', 'Gamma', 'Theta', 'Vega', 'Rho'],
                    datasets: [{
                        label: 'Greeks Values',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                circular: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                display: false
                            },
                            min: -1,
                            max: 1
                        }
                    }
                }
            });
        }

        // Calculator functionality - with safety checks
        window.calculateOption = function() {
            // Prevent recursive calls
            if (isCalculating) {
                console.log('Already calculating, skipping...');
                return;
            }
            
            if (!pricingLibrary) {
                console.error('Pricing library not loaded yet');
                return;
            }

            isCalculating = true;

            try {
                const params = {
                    symbol: document.getElementById('symbol').value || undefined,
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    strikePrice: parseFloat(document.getElementById('strikePrice').value),
                    daysToExpiry: parseInt(document.getElementById('daysToExpiry').value),
                    volatility: parseFloat(document.getElementById('volatility').value) / 100,
                    optionType: document.getElementById('optionType').value
                };

                // Validate inputs
                if (isNaN(params.stockPrice) || isNaN(params.strikePrice) || isNaN(params.daysToExpiry) || isNaN(params.volatility)) {
                    throw new Error('Please enter valid numbers for all fields');
                }

                // Simple pricing only - no complex calculations
                const price = pricingLibrary.priceOption(params);
                
                // Basic Greeks calculation
                const greeks = pricingLibrary.calculateGreeks({
                    ...params,
                    timeToExpiry: params.daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                });
                
                displayResults(price, greeks, params);
                updateGreeksDisplay(greeks);
                updateGreeksChart(greeks);
                
            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="text-red-600 p-4 bg-red-50 rounded-lg">
                        <h5 class="font-semibold mb-2">Calculation Error</h5>
                        <p class="text-sm">Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                isCalculating = false;
            }
        };

        function displayResults(price, greeks, params) {
            const intrinsic = params.optionType === 'call' 
                ? Math.max(0, params.stockPrice - params.strikePrice)
                : Math.max(0, params.strikePrice - params.stockPrice);
            const timeValue = price - intrinsic;

            document.getElementById('results').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h5 class="font-semibold text-blue-800 mb-2">Option Price</h5>
                        <div class="text-3xl font-bold text-blue-600">$${price.toFixed(2)}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-sm text-green-600">Intrinsic Value</div>
                            <div class="font-semibold text-green-800">$${intrinsic.toFixed(2)}</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <div class="text-sm text-purple-600">Time Value</div>
                            <div class="font-semibold text-purple-800">$${timeValue.toFixed(2)}</div>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        function updateGreeksDisplay(greeks) {
            if (!greeks || Object.keys(greeks).length === 0) return;

            const greeksHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Delta</span>
                            <div class="text-xs text-gray-600">Price change per $1 stock move</div>
                            <div class="text-xs text-blue-700 mt-1">≈ ${((greeks.delta || 0) * 100).toFixed(1)}% of stock moves</div>
                        </div>
                        <span class="font-bold text-blue-600">${greeks.delta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Gamma</span>
                            <div class="text-xs text-gray-600">Delta change per $1 stock move</div>
                            <div class="text-xs text-green-700 mt-1">Higher = more delta acceleration</div>
                        </div>
                        <span class="font-bold text-green-600">${greeks.gamma?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Theta</span>
                            <div class="text-xs text-gray-600">Price decay per day</div>
                            <div class="text-xs text-red-700 mt-1">Time is your enemy: $${((greeks.theta || 0) * -1).toFixed(2)}/day lost</div>
                        </div>
                        <span class="font-bold text-red-600">${greeks.theta?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Vega</span>
                            <div class="text-xs text-gray-600">Price change per 1% volatility</div>
                            <div class="text-xs text-purple-700 mt-1">Vol from ${((greeks.vega || 0) > 0 ? '24% → 25%' : '25% → 24%')} = $${Math.abs(greeks.vega || 0).toFixed(2)}</div>
                        </div>
                        <span class="font-bold text-purple-600">${greeks.vega?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <div class="flex-1">
                            <span class="font-medium">Rho</span>
                            <div class="text-xs text-gray-600">Price change per 1% rate change</div>
                            <div class="text-xs text-yellow-700 mt-1">Rates 4% → 5% = $${(greeks.rho || 0).toFixed(2)} change</div>
                        </div>
                        <span class="font-bold text-yellow-600">${greeks.rho?.toFixed(4) || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('greeksDisplay').innerHTML = greeksHtml;
        }

        // Update Greeks chart with real values
        function updateGreeksChart(greeks) {
            if (!greeksChart || !greeks) return;
            
            // Normalize values for radar chart visualization
            const normalizeValue = (value, maxExpected) => {
                return Math.max(-1, Math.min(1, value / maxExpected));
            };
            
            const chartData = [
                normalizeValue(greeks.delta || 0, 1),      // Delta: -1 to 1
                normalizeValue(greeks.gamma || 0, 0.1),    // Gamma: normalize around 0.1
                normalizeValue(greeks.theta || 0, 0.1),    // Theta: normalize around 0.1 (daily)
                normalizeValue(greeks.vega || 0, 0.5),     // Vega: normalize around 0.5
                normalizeValue(greeks.rho || 0, 0.2)       // Rho: normalize around 0.2
            ];
            
            greeksChart.data.datasets[0].data = chartData;
            greeksChart.update('none'); // No animation for smooth real-time updates
        }

        // Smooth scrolling
        window.scrollToSection = function(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth' 
            });
        };

        // Manual calculation only - prevent infinite loops
        let isCalculating = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - ready for manual calculations');
            // Remove all auto-calculation to prevent infinite loops
        });

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Payoff Diagram Builder Functions
        let payoffChart;
        let currentStrategy = {};

        // Initialize payoff chart
        function initializePayoffChart() {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            
            payoffChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Strategy Payoff at Expiration'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price at Expiration ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)'
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load predefined strategy
        window.loadStrategy = function(strategyType) {
            document.getElementById('strategyType').value = strategyType;
            populateStrategyParams(strategyType);
            buildPayoffDiagram();
        };

        // Populate strategy parameters based on selected strategy
        function populateStrategyParams(strategyType) {
            const paramsContainer = document.getElementById('strategyParams');
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            
            let paramsHtml = '';
            
            switch (strategyType) {
                case 'single':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <select id="position" class="w-full px-2 py-1 border rounded">
                                <option value="long-call">Long Call</option>
                                <option value="short-call">Short Call</option>
                                <option value="long-put">Long Put</option>
                                <option value="short-put">Short Put</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="strike1" value="${stockPrice + 5}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'covered-call':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Sell 1 call</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'protective-put':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Own 100 shares + Buy 1 put</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'straddle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (same strike)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="straddleStrike" value="${stockPrice}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
                    
                case 'strangle':
                    paramsHtml = `
                        <div class="text-sm text-gray-600 mb-2">Buy call + Buy put (different strikes)</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Put Strike</label>
                            <input type="number" id="putStrike" value="${stockPrice - 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Call Strike</label>
                            <input type="number" id="callStrike" value="${stockPrice + 10}" step="1" class="w-full px-2 py-1 border rounded">
                        </div>
                    `;
                    break;
            }
            
            paramsContainer.innerHTML = paramsHtml;
        }

        // Build and display payoff diagram
        window.buildPayoffDiagram = function() {
            if (!pricingLibrary) {
                console.error('Pricing library not loaded');
                return;
            }

            const strategyType = document.getElementById('strategyType').value;
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 150;
            const volatility = parseFloat(document.getElementById('volatility').value) / 100 || 0.25;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 30;
            
            // Generate stock price range for payoff calculation
            const minPrice = stockPrice * 0.7;
            const maxPrice = stockPrice * 1.3;
            const priceStep = (maxPrice - minPrice) / 50;
            const stockPrices = [];
            const payoffs = [];
            
            for (let price = minPrice; price <= maxPrice; price += priceStep) {
                stockPrices.push(price);
                payoffs.push(calculateStrategyPayoff(strategyType, price, stockPrice, volatility, daysToExpiry));
            }
            
            // Update chart
            payoffChart.data.labels = stockPrices.map(p => p.toFixed(0));
            payoffChart.data.datasets = [{
                label: getStrategyName(strategyType),
                data: payoffs,
                borderColor: 'rgb(147, 51, 234)',
                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                borderWidth: 2,
                fill: true
            }];
            
            payoffChart.update();
            
            // Update strategy metrics
            updateStrategyMetrics(strategyType, payoffs, stockPrices, stockPrice);
        };

        function calculateStrategyPayoff(strategyType, currentPrice, stockPrice, volatility, daysToExpiry) {
            const timeToExpiry = daysToExpiry / 365;
            
            switch (strategyType) {
                case 'single':
                    const position = document.getElementById('position')?.value || 'long-call';
                    const strike = parseFloat(document.getElementById('strike1')?.value) || stockPrice + 5;
                    
                    if (position === 'long-call') {
                        return Math.max(0, currentPrice - strike);
                    } else if (position === 'short-call') {
                        return -Math.max(0, currentPrice - strike);
                    } else if (position === 'long-put') {
                        return Math.max(0, strike - currentPrice);
                    } else if (position === 'short-put') {
                        return -Math.max(0, strike - currentPrice);
                    }
                    break;
                    
                case 'covered-call':
                    const callStrike = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const stockProfit = currentPrice - stockPrice;
                    const callPayoff = -Math.max(0, currentPrice - callStrike);
                    return stockProfit + callPayoff;
                    
                case 'protective-put':
                    const putStrike = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const stockProfitPP = currentPrice - stockPrice;
                    const putPayoff = Math.max(0, putStrike - currentPrice);
                    return stockProfitPP + putPayoff;
                    
                case 'straddle':
                    const straddleStrike = parseFloat(document.getElementById('straddleStrike')?.value) || stockPrice;
                    const callPayoffStraddle = Math.max(0, currentPrice - straddleStrike);
                    const putPayoffStraddle = Math.max(0, straddleStrike - currentPrice);
                    return callPayoffStraddle + putPayoffStraddle;
                    
                case 'strangle':
                    const putStrikeStrangle = parseFloat(document.getElementById('putStrike')?.value) || stockPrice - 10;
                    const callStrikeStrangle = parseFloat(document.getElementById('callStrike')?.value) || stockPrice + 10;
                    const callPayoffStrangle = Math.max(0, currentPrice - callStrikeStrangle);
                    const putPayoffStrangle = Math.max(0, putStrikeStrangle - currentPrice);
                    return callPayoffStrangle + putPayoffStrangle;
            }
            
            return 0;
        }

        function getStrategyName(strategyType) {
            const names = {
                'single': 'Single Option',
                'covered-call': 'Covered Call',
                'protective-put': 'Protective Put',
                'straddle': 'Long Straddle',
                'strangle': 'Long Strangle',
                'butterfly': 'Butterfly Spread'
            };
            return names[strategyType] || strategyType;
        }

        function updateStrategyMetrics(strategyType, payoffs, stockPrices, currentStockPrice) {
            const maxProfit = Math.max(...payoffs);
            const maxLoss = Math.min(...payoffs);
            const currentIndex = stockPrices.findIndex(p => p >= currentStockPrice);
            const currentPayoff = payoffs[currentIndex] || 0;
            
            // Find breakeven points
            const breakevens = [];
            for (let i = 1; i < payoffs.length; i++) {
                if ((payoffs[i-1] <= 0 && payoffs[i] >= 0) || (payoffs[i-1] >= 0 && payoffs[i] <= 0)) {
                    breakevens.push(stockPrices[i]);
                }
            }
            
            document.getElementById('strategyMetrics').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-green-50 p-2 rounded">
                        <div class="font-medium text-green-800">Max Profit</div>
                        <div class="text-green-600">$${maxProfit.toFixed(2)}</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded">
                        <div class="font-medium text-red-800">Max Loss</div>
                        <div class="text-red-600">$${maxLoss.toFixed(2)}</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded col-span-2">
                        <div class="font-medium text-blue-800">Breakevens</div>
                        <div class="text-blue-600">$${breakevens.map(b => b.toFixed(2)).join(', ')}</div>
                    </div>
                </div>
            `;
        }

        // Initialize payoff chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add small delay to ensure Chart.js is ready
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    initializePayoffChart();
                    populateStrategyParams('single');
                }
            }, 500);
        });

        // Auto-update strategy params when strategy type changes
        document.addEventListener('change', function(e) {
            if (e.target.id === 'strategyType') {
                populateStrategyParams(e.target.value);
            }
        });

        // Interactive Greeks Tutorial Functionality
        function initializeTutorial() {
            const rateSlider = document.getElementById('tutorialRate');
            const rateValue = document.getElementById('tutorialRateValue');
            const rhoValue = document.getElementById('tutorialRhoValue');
            const currentPrice = document.getElementById('currentOptionPrice');
            const newPrice = document.getElementById('newOptionPrice');
            const priceChange = document.getElementById('priceChange');
            const currentRate1 = document.getElementById('currentRate1');
            const newRate = document.getElementById('newRate');
            const explanationCurrentRate = document.getElementById('explanationCurrentRate');
            const explanationRho = document.getElementById('explanationRho');
            const explanationFromRate = document.getElementById('explanationFromRate');
            const explanationToRate = document.getElementById('explanationToRate');
            const explanationGain = document.getElementById('explanationGain');
            
            // Base option parameters for tutorial
            const baseParams = {
                stockPrice: 100,
                strikePrice: 105,
                daysToExpiry: 30,
                volatility: 0.25,
                optionType: 'call'
            };
            
            function updateTutorial() {
                const currentRiskFreeRate = parseFloat(rateSlider.value) / 100;
                const newRiskFreeRate = currentRiskFreeRate + 0.01; // +1%
                
                // Update display values
                rateValue.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                currentRate1.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                newRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                explanationCurrentRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationFromRate.textContent = (currentRiskFreeRate * 100).toFixed(1) + '%';
                explanationToRate.textContent = (newRiskFreeRate * 100).toFixed(1) + '%';
                
                try {
                    if (pricingLibrary && pricingLibrary.binomialPrice) {
                        // Calculate prices at both rates
                        const priceAtCurrentRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: currentRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const priceAtNewRate = pricingLibrary.binomialPrice({
                            ...baseParams,
                            riskFreeRate: newRiskFreeRate,
                            timeToExpiry: baseParams.daysToExpiry / 365,
                            dividendYield: 0.015,
                            steps: 50,
                            exerciseStyle: 'american'
                        });
                        
                        const change = priceAtNewRate - priceAtCurrentRate;
                        
                        // Update displays
                        currentPrice.textContent = '$' + priceAtCurrentRate.toFixed(2);
                        newPrice.textContent = '$' + priceAtNewRate.toFixed(2);
                        priceChange.textContent = (change >= 0 ? '+' : '') + '$' + change.toFixed(2);
                        rhoValue.textContent = '$' + change.toFixed(2);
                        explanationRho.textContent = '$' + change.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(change).toFixed(2);
                        
                        // Color coding for price change
                        const changeColor = change >= 0 ? 'text-green-700' : 'text-red-700';
                        priceChange.className = `text-2xl font-bold ${changeColor} mb-2`;
                        
                    } else {
                        // Fallback with estimated values
                        const estimatedRho = 0.25 + (currentRiskFreeRate - 0.04) * 2; // Rough estimation
                        rhoValue.textContent = '$' + estimatedRho.toFixed(2);
                        explanationRho.textContent = '$' + estimatedRho.toFixed(2);
                        explanationGain.textContent = '$' + Math.abs(estimatedRho).toFixed(2);
                    }
                } catch (error) {
                    console.warn('Tutorial calculation error:', error);
                    // Show default values if calculation fails
                    const defaultRho = 0.27;
                    rhoValue.textContent = '$' + defaultRho.toFixed(2);
                    explanationRho.textContent = '$' + defaultRho.toFixed(2);
                    explanationGain.textContent = '$' + Math.abs(defaultRho).toFixed(2);
                }
            }
            
            // Initialize tutorial
            updateTutorial();
            
            // Add event listener for rate slider
            rateSlider.addEventListener('input', updateTutorial);
        }
        
        // Initialize tutorial when pricing library is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeTutorial();
                initializeAlgorithmAnimations();
            }, 1000); // Wait for pricing library to load
        });

        // Algorithm Animation Functionality
        function initializeAlgorithmAnimations() {
            // Initialize slider values
            document.getElementById('binomialSteps').addEventListener('input', function() {
                document.getElementById('binomialStepsValue').textContent = this.value;
            });
            
            // Trinomial tree input listeners
            document.getElementById('trinomialSteps').addEventListener('input', function() {
                document.getElementById('trinomialStepsDisplay').textContent = this.value;
            });
            
            document.getElementById('mcPaths').addEventListener('input', function() {
                document.getElementById('mcPathsValue').textContent = parseInt(this.value).toLocaleString();
            });
            
            document.getElementById('mcShowPaths').addEventListener('input', function() {
                document.getElementById('mcShowPathsValue').textContent = this.value;
            });
            
            // Jump Diffusion sliders
            document.getElementById('jumpIntensity').addEventListener('input', function() {
                document.getElementById('jumpIntensityValue').textContent = parseFloat(this.value).toFixed(1);
            });
            
            document.getElementById('jumpMean').addEventListener('input', function() {
                document.getElementById('jumpMeanValue').textContent = (parseFloat(this.value) * 100).toFixed(0) + '%';
            });
            
            document.getElementById('jumpVol').addEventListener('input', function() {
                document.getElementById('jumpVolValue').textContent = (parseFloat(this.value) * 100).toFixed(0) + '%';
            });
            
            document.getElementById('jumpSteps').addEventListener('input', function() {
                document.getElementById('jumpStepsValue').textContent = this.value;
            });
        }
        
        // Algorithm switching functionality
        function showAlgorithm(algorithm) {
            // Hide all algorithm content
            const contents = document.querySelectorAll('.algorithm-content');
            contents.forEach(content => {
                content.classList.add('hidden');
                content.style.display = 'none';
            });
            
            // Reset button styles
            const buttons = ['binomialBtn', 'trinomialBtn', 'blackscholesBtn', 'montecarloBtn', 'jumpdiffusionBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
            });
            
            // Show selected algorithm
            const targetElement = document.getElementById(algorithm + 'Animation');
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.style.display = 'block';
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(algorithm + 'Btn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getButtonColor(algorithm));
            }
        }
        
        function getButtonColor(algorithm) {
            const colors = {
                'binomial': 'bg-blue-700',
                'trinomial': 'bg-green-700',
                'blackscholes': 'bg-purple-700',
                'montecarlo': 'bg-red-700',
                'jumpdiffusion': 'bg-yellow-700'
            };
            return colors[algorithm] || 'bg-blue-700';
        }
        
        // Binomial Tree Animation
        function animateBinomialTree() {
            const steps = parseInt(document.getElementById('binomialSteps').value);
            const speed = parseInt(document.getElementById('animationSpeed').value);
            const canvas = document.getElementById('treeCanvas');
            const stepDisplay = document.getElementById('currentStepDisplay');
            
            // Reset step explanations
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.opacity = '0.3';
            }
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">Building Binomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 4;
            
            function nextStep() {
                currentStep++;
                
                // Highlight current step
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}`).style.opacity = '1';
                }
                
                switch(currentStep) {
                    case 1:
                        stepDisplay.textContent = "Starting with current stock price S₀ = $100";
                        canvas.innerHTML = createTreeVisualization(1, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = "Adding up and down movements for each time step";
                        canvas.innerHTML = createTreeVisualization(2, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = "Calculating risk-neutral probabilities";
                        canvas.innerHTML = createTreeVisualization(3, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = "Working backwards to find option value";
                        canvas.innerHTML = createTreeVisualization(4, steps);
                        break;
                    default:
                        stepDisplay.textContent = "Animation complete! Tree shows all possible paths.";
                        return;
                }
                
                if (currentStep < totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }

        // Trinomial Tree Animation
        function animateTrinomialTree() {
            const steps = parseInt(document.getElementById('trinomialSteps').value);
            const speed = parseInt(document.getElementById('trinomialSpeed').value);
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            // Update steps display
            document.getElementById('trinomialStepsDisplay').textContent = steps;
            
            // Clear canvas
            canvas.innerHTML = '<div class="p-4"><div class="text-center text-lg font-bold mb-4">🔷 Building Trinomial Tree...</div></div>';
            
            let currentStep = 0;
            const totalSteps = 5; // More steps for trinomial explanation
            
            function nextStep() {
                switch (currentStep) {
                    case 0:
                        stepDisplay.textContent = 'Step 1: Initialize root node with current stock price';
                        canvas.innerHTML = createTrinomialVisualization(1, steps);
                        break;
                    case 1:
                        stepDisplay.textContent = 'Step 2: Calculate up, middle, and down factors (u, m=1, d)';
                        canvas.innerHTML = createTrinomialVisualization(2, steps);
                        break;
                    case 2:
                        stepDisplay.textContent = 'Step 3: Calculate risk-neutral probabilities (p_u, p_m, p_d)';
                        canvas.innerHTML = createTrinomialVisualization(3, steps);
                        break;
                    case 3:
                        stepDisplay.textContent = 'Step 4: Build complete tree forward to expiration';
                        canvas.innerHTML = createTrinomialVisualization(4, steps);
                        break;
                    case 4:
                        stepDisplay.textContent = 'Step 5: Work backwards calculating option values using trinomial recombination';
                        canvas.innerHTML = createTrinomialVisualization(5, steps);
                        break;
                }
                
                currentStep++;
                if (currentStep <= totalSteps) {
                    setTimeout(nextStep, speed);
                }
            }
            
            nextStep();
        }
        
        function createTrinomialVisualization(step, maxSteps) {
            const S0 = 100; // Current stock price
            const u = 1.22; // Up factor (higher than binomial)
            const d = 1/u; // Down factor
            const m = 1.0; // Middle factor (stays same)
            
            let html = '<div class="p-4">';
            html += '<div class="text-center mb-4"><h6 class="font-bold text-lg">Trinomial Tree Construction</h6></div>';
            
            if (step >= 1) {
                // Root node
                html += '<div class="flex justify-center mb-4">';
                html += `<div class="bg-blue-100 border-2 border-blue-500 rounded-lg p-2 text-center">`;
                html += `<div class="font-bold">S₀</div><div class="text-sm">$${S0}</div>`;
                html += '</div></div>';
                
                if (step >= 2) {
                    // First level (showing three branches)
                    html += '<div class="flex justify-center space-x-8 mb-4">';
                    
                    // Up node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-green-100 border-2 border-green-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Su</div><div class="text-sm">$${(S0 * u).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-green-700">×${u.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Middle node (unique to trinomial)
                    html += `<div class="text-center">`;
                    html += `<div class="bg-yellow-100 border-2 border-yellow-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sm</div><div class="text-sm">$${(S0 * m).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-yellow-700">×${m.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    // Down node
                    html += `<div class="text-center">`;
                    html += `<div class="bg-red-100 border-2 border-red-500 rounded-lg p-2">`;
                    html += `<div class="font-bold">Sd</div><div class="text-sm">$${(S0 * d).toFixed(1)}</div>`;
                    html += `<div class="text-xs text-red-700">×${d.toFixed(2)}</div>`;
                    html += '</div></div>';
                    
                    html += '</div>';
                    
                    if (step >= 3) {
                        // Add probability explanations
                        html += '<div class="bg-gray-50 rounded-lg p-3 mt-4 text-center">';
                        html += '<div class="text-sm font-semibold mb-2">Risk-Neutral Probabilities:</div>';
                        html += '<div class="grid grid-cols-3 gap-4 text-xs">';
                        html += '<div class="text-green-700"><strong>p_u = 0.25</strong><br>Up probability</div>';
                        html += '<div class="text-yellow-700"><strong>p_m = 0.50</strong><br>Middle probability</div>';
                        html += '<div class="text-red-700"><strong>p_d = 0.25</strong><br>Down probability</div>';
                        html += '</div>';
                        html += '<div class="text-xs text-gray-600 mt-2">p_u + p_m + p_d = 1.0 ✓</div>';
                        html += '</div>';
                        
                        if (step >= 4) {
                            // Show next level to demonstrate recombination
                            html += '<div class="mt-6">';
                            html += '<div class="text-center text-sm font-semibold mb-3">Next Time Step (Recombining Tree):</div>';
                            html += '<div class="flex justify-center space-x-4">';
                            
                            const prices = [
                                S0 * u * u,
                                S0 * u * m,
                                S0 * u * d, // Same as S0 * m * u (recombining!)
                                S0 * m * d,
                                S0 * d * d
                            ];
                            
                            prices.forEach((price, i) => {
                                let colorClass = '';
                                if (i === 0) {
                                    colorClass = 'bg-green-50 border-green-300';
                                } else if (i === prices.length - 1) {
                                    colorClass = 'bg-red-50 border-red-300';
                                } else {
                                    colorClass = 'bg-blue-50 border-blue-300';
                                }
                                html += '<div class="' + colorClass + ' border rounded p-1 text-xs text-center">';
                                html += '$' + price.toFixed(1);
                                html += '</div>';
                            });
                            
                            html += '</div>';
                            html += '<div class="text-xs text-center text-gray-600 mt-2">Notice: Su*d = Sm*u (recombining tree structure)</div>';
                            html += '</div>';
                            
                            if (step >= 5) {
                                // Show option valuation
                                html += '<div class="mt-4 bg-purple-50 rounded-lg p-3">';
                                html += '<div class="text-sm font-semibold text-purple-800 mb-2">🔄 Working Backwards:</div>';
                                html += '<div class="text-xs text-purple-700 space-y-1">';
                                html += '<div>1. Start at expiration: Option value = max(S-K, 0) for calls</div>';
                                html += '<div>2. At each earlier node: V = e^(-r×Δt) × (p_u×V_u + p_m×V_m + p_d×V_d)</div>';
                                html += '<div>3. Continue until reaching root node</div>';
                                html += '<div class="font-semibold text-green-700">Result: More accurate than binomial (3 branches vs 2)</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        }
                    }
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function resetTrinomialAnimation() {
            const canvas = document.getElementById('trinomialCanvas');
            const stepDisplay = document.getElementById('trinomialStepDisplay');
            
            canvas.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <div class="text-4xl mb-4">🔷</div>
                    <p>Click "Animate" to see trinomial tree construction</p>
                </div>
            `;
            stepDisplay.textContent = 'Ready to begin trinomial tree animation...';
        }
        
        function createTreeVisualization(step, totalSteps) {
            let html = '<div class="p-4">';
            
            if (step === 1) {
                html += `
                    <div class="flex justify-center">
                        <div class="bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center font-bold">
                            $100
                        </div>
                    </div>
                    <div class="text-center mt-2 text-sm text-gray-600">Current Stock Price</div>
                `;
            } else if (step === 2) {
                html += `
                    <div class="space-y-6">
                        ${Array.from({length: Math.min(totalSteps + 1, 4)}, (_, t) => `
                            <div class="flex justify-center items-center" style="gap: ${40 + t * 30}px;">
                                ${Array.from({length: t + 1}, (_, i) => {
                                    const price = 100 * Math.pow(1.05, t - i) * Math.pow(0.95, i);
                                    return `
                                        <div class="bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center text-xs font-bold">
                                            $${price.toFixed(0)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (step === 3) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-yellow-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Risk-Neutral Probabilities</div>
                            <div class="text-xs mt-1">p = 0.52 (up), 1-p = 0.48 (down)</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="200" height="120" viewBox="0 0 200 120">
                                <line x1="100" y1="100" x2="50" y2="20" stroke="#10B981" stroke-width="3"/>
                                <line x1="100" y1="100" x2="150" y2="20" stroke="#EF4444" stroke-width="3"/>
                                <circle cx="100" cy="100" r="15" fill="#3B82F6"/>
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="150" cy="20" r="12" fill="#EF4444"/>
                                <text x="100" y="105" text-anchor="middle" font-size="10" fill="white">$100</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$105</text>
                                <text x="150" y="25" text-anchor="middle" font-size="8" fill="white">$95</text>
                                <text x="75" y="65" font-size="8" fill="#10B981">52%</text>
                                <text x="125" y="65" font-size="8" fill="#EF4444">48%</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else if (step === 4) {
                html += `
                    <div class="text-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-lg inline-block">
                            <div class="text-sm font-semibold">Backward Induction</div>
                            <div class="text-xs mt-1">Start from expiry, work backwards</div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <div class="relative">
                            <svg width="250" height="150" viewBox="0 0 250 150">
                                <!-- Final nodes -->
                                <circle cx="50" cy="20" r="12" fill="#10B981"/>
                                <circle cx="125" cy="75" r="12" fill="#F59E0B"/>
                                <circle cx="200" cy="130" r="12" fill="#EF4444"/>
                                <!-- Intermediate nodes -->
                                <circle cx="90" cy="47" r="10" fill="#8B5CF6"/>
                                <circle cx="160" cy="102" r="10" fill="#8B5CF6"/>
                                <!-- Root node -->
                                <circle cx="125" cy="75" r="15" fill="#3B82F6"/>
                                <!-- Lines -->
                                <line x1="125" y1="75" x2="90" y2="47" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="125" y1="75" x2="160" y2="102" stroke="#8B5CF6" stroke-width="2"/>
                                <line x1="90" y1="47" x2="50" y2="20" stroke="#10B981" stroke-width="2"/>
                                <line x1="90" y1="47" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="125" y2="75" stroke="#F59E0B" stroke-width="2"/>
                                <line x1="160" y1="102" x2="200" y2="130" stroke="#EF4444" stroke-width="2"/>
                                <!-- Values -->
                                <text x="125" y="80" text-anchor="middle" font-size="10" fill="white">$6.15</text>
                                <text x="50" y="25" text-anchor="middle" font-size="8" fill="white">$10.5</text>
                                <text x="200" y="135" text-anchor="middle" font-size="8" fill="white">$0</text>
                                <text x="90" y="52" text-anchor="middle" font-size="8" fill="white">$8.2</text>
                                <text x="160" y="107" text-anchor="middle" font-size="8" fill="white">$2.4</text>
                            </svg>
                        </div>
                    </div>
                    <div class="text-center mt-4 text-sm text-green-600 font-semibold">
                        Option Value: $6.15
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Monte Carlo Animation
        function animateMonteCarlo() {
            const totalPaths = parseInt(document.getElementById('mcPaths').value);
            const showPaths = parseInt(document.getElementById('mcShowPaths').value);
            const canvas = document.getElementById('mcCanvas');
            
            let pathsCompleted = 0;
            let runningTotal = 0;
            let runningSquareTotal = 0;
            
            canvas.innerHTML = `
                <div class="h-full">
                    <div class="text-center mb-4 font-semibold">Simulating ${totalPaths.toLocaleString()} Price Paths</div>
                    <div class="relative h-64 bg-white rounded border">
                        <canvas id="mcPathCanvas" width="400" height="200" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 bg-blue-100 rounded-full h-2">
                        <div id="mcProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            const pathCanvas = document.getElementById('mcPathCanvas');
            const ctx = pathCanvas.getContext('2d');
            
            // Setup canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 200);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 1;
            
            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 180);
            ctx.lineTo(380, 180);
            ctx.moveTo(40, 20);
            ctx.lineTo(40, 180);
            ctx.stroke();
            
            let pathsDrawn = 0;
            const batchSize = Math.ceil(totalPaths / 100); // Update in batches
            
            function simulateBatch() {
                for (let i = 0; i < Math.min(batchSize, totalPaths - pathsCompleted); i++) {
                    const optionValue = simulatePath();
                    runningTotal += optionValue;
                    runningSquareTotal += optionValue * optionValue;
                    pathsCompleted++;
                    
                    // Draw some paths for visualization
                    if (pathsDrawn < showPaths && pathsCompleted % Math.floor(totalPaths / showPaths) === 0) {
                        drawRandomPath(ctx, pathsDrawn);
                        pathsDrawn++;
                    }
                }
                
                // Update statistics
                updateMonteCarloStats(pathsCompleted, totalPaths, runningTotal, runningSquareTotal);
                
                if (pathsCompleted < totalPaths) {
                    setTimeout(simulateBatch, 10);
                } else {
                    document.getElementById('mcProgressBar').style.width = '100%';
                }
            }
            
            simulateBatch();
        }
        
        function simulatePath() {
            // Simple Monte Carlo option pricing
            const S0 = 100, K = 105, T = 30/365, r = 0.04, sigma = 0.25;
            const dt = T / 30;
            let S = S0;
            
            // Generate random path
            for (let i = 0; i < 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((r - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * Z);
            }
            
            // Option payoff (call option)
            return Math.max(S - K, 0) * Math.exp(-r * T);
        }
        
        function drawRandomPath(ctx, pathIndex) {
            const S0 = 100;
            const colors = ['rgba(59, 130, 246, 0.4)', 'rgba(16, 185, 129, 0.4)', 'rgba(239, 68, 68, 0.4)'];
            
            ctx.strokeStyle = colors[pathIndex % colors.length];
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            let S = S0;
            let prevX = 40;
            let prevY = 180 - (S - 80) * 2; // Scale to canvas
            
            ctx.moveTo(prevX, prevY);
            
            for (let i = 1; i <= 30; i++) {
                const Z = normalRandom();
                S *= Math.exp((0.04 - 0.5 * 0.25 * 0.25) * (30/365/30) + 0.25 * Math.sqrt(30/365/30) * Z);
                
                const x = 40 + (i / 30) * 340;
                const y = Math.max(20, Math.min(180, 180 - (S - 80) * 2));
                
                ctx.lineTo(x, y);
                prevX = x;
                prevY = y;
            }
            
            ctx.stroke();
        }
        
        function normalRandom() {
            // Box-Muller transformation
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        
        function updateMonteCarloStats(completed, total, runningTotal, runningSquareTotal) {
            const currentPrice = runningTotal / completed;
            const variance = (runningSquareTotal / completed) - (currentPrice * currentPrice);
            const standardError = Math.sqrt(variance / completed);
            
            document.getElementById('mcPathsCompleted').textContent = completed.toLocaleString();
            document.getElementById('mcCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
            document.getElementById('mcStandardError').textContent = '±$' + (1.96 * standardError).toFixed(2);
            
            const progress = (completed / total) * 100;
            document.getElementById('mcProgressBar').style.width = progress + '%';
        }
        
        // Black-Scholes Animation
        function animateBlackScholes() {
            const steps = ['bsStep1', 'bsStep2', 'bsStep3', 'bsStep4'];
            const calculation = document.getElementById('bsLiveCalc');
            
            // Reset opacity
            steps.forEach(step => {
                document.getElementById(step).style.opacity = '0.3';
            });
            
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).style.opacity = '1';
                    
                    switch(currentStep) {
                        case 0:
                            calculation.innerHTML = `
                                <div>Breaking down the Black-Scholes formula...</div>
                                <div class="mt-2 text-purple-600">C = S₀N(d₁) - Ke^(-rT)N(d₂)</div>
                            `;
                            break;
                        case 1:
                            calculation.innerHTML = `
                                <div>d₁ = [ln(100/105) + (0.04 + 0.25²/2)×0.082] / (0.25×√0.082)</div>
                                <div>d₁ = [-0.0488 + 0.0059] / 0.0717 = -0.598</div>
                            `;
                            break;
                        case 2:
                            calculation.innerHTML = `
                                <div>d₂ = d₁ - σ√T = -0.598 - 0.25×√0.082</div>
                                <div>d₂ = -0.598 - 0.0717 = -0.670</div>
                            `;
                            break;
                        case 3:
                            calculation.innerHTML = `
                                <div>N(d₁) = N(-0.598) = 0.275</div>
                                <div>N(d₂) = N(-0.670) = 0.251</div>
                                <div class="mt-2 text-green-600 font-bold">C = 100×0.275 - 105×e^(-0.04×0.082)×0.251 = $1.31</div>
                            `;
                            break;
                    }
                    
                    currentStep++;
                    setTimeout(nextStep, 2000);
                }
            }
            
            nextStep();
        }

        // ============================================================================
        // JUMP DIFFUSION ANIMATION IMPLEMENTATION
        // ============================================================================

        let jumpPaths = [];
        let jumpStats = { jumps: 0, totalJumpSize: 0 };

        function animateJumpDiffusion() {
            const intensity = parseFloat(document.getElementById('jumpIntensity').value);
            const jumpMean = parseFloat(document.getElementById('jumpMean').value);
            const jumpVol = parseFloat(document.getElementById('jumpVol').value);
            const steps = parseInt(document.getElementById('jumpSteps').value);
            
            // Reset statistics
            jumpStats = { jumps: 0, totalJumpSize: 0 };
            jumpPaths = [];
            
            // Get current option parameters
            const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 100;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 105;
            const timeToExpiry = parseFloat(document.getElementById('timeToExpiry').value) || 30;
            const riskFreeRate = parseFloat(document.getElementById('riskFreeRate').value) || 4;
            const volatility = parseFloat(document.getElementById('volatility').value) || 25;
            
            // Convert to decimal
            const r = riskFreeRate / 100;
            const sigma = volatility / 100;
            const T = timeToExpiry / 365;
            
            // Generate 5 sample paths for visualization
            const numPaths = 5;
            const dt = T / steps;
            
            for (let path = 0; path < numPaths; path++) {
                const prices = [stockPrice];
                let currentPrice = stockPrice;
                let pathJumps = 0;
                let pathJumpSize = 0;
                
                for (let i = 1; i <= steps; i++) {
                    // Standard Brownian motion component
                    const dW = Math.sqrt(dt) * normalRandom();
                    
                    // Check for jump (Poisson process)
                    const jumpProbability = intensity * dt;
                    const hasJump = Math.random() < jumpProbability;
                    
                    let jumpComponent = 0;
                    if (hasJump) {
                        // Generate jump size (log-normal)
                        const jumpSize = jumpMean + jumpVol * normalRandom();
                        jumpComponent = Math.exp(jumpSize) - 1;
                        pathJumps++;
                        pathJumpSize += jumpComponent;
                        jumpStats.jumps++;
                        jumpStats.totalJumpSize += jumpComponent;
                    }
                    
                    // Jump-diffusion price evolution
                    const drift = (r - intensity * (Math.exp(jumpMean + 0.5 * jumpVol * jumpVol) - 1)) * dt;
                    const diffusion = sigma * dW;
                    const jump = jumpComponent;
                    
                    currentPrice = currentPrice * Math.exp(drift + diffusion + Math.log(1 + jump));
                    prices.push(currentPrice);
                }
                
                jumpPaths.push({
                    prices: prices,
                    jumps: pathJumps,
                    avgJumpSize: pathJumps > 0 ? pathJumpSize / pathJumps : 0
                });
            }
            
            // Update statistics display
            updateJumpStatistics(intensity, T);
            
            // Calculate and display model prices
            updateJumpPricing(stockPrice, strikePrice, T, r, sigma, intensity, jumpMean, jumpVol);
            
            // Render the visualization
            renderJumpVisualization(steps, T);
        }
        
        function updateJumpStatistics(intensity, T) {
            document.getElementById('expectedJumps').textContent = (intensity * T).toFixed(1);
            document.getElementById('observedJumps').textContent = jumpStats.jumps;
            
            const avgJump = jumpStats.jumps > 0 ? (jumpStats.totalJumpSize / jumpStats.jumps * 100).toFixed(1) : '0';
            document.getElementById('avgJumpSize').textContent = avgJump + '%';
            
            // Calculate price range
            let minPrice = Infinity, maxPrice = -Infinity;
            jumpPaths.forEach(path => {
                path.prices.forEach(price => {
                    minPrice = Math.min(minPrice, price);
                    maxPrice = Math.max(maxPrice, price);
                });
            });
            
            if (jumpPaths.length > 0) {
                document.getElementById('priceRange').textContent = 
                    '$' + minPrice.toFixed(0) + ' - $' + maxPrice.toFixed(0);
            }
        }
        
        function updateJumpPricing(S, K, T, r, sigma, lambda, mu, sigmaJ) {
            // Calculate Black-Scholes price (for comparison)
            const bsPrice = calculateBlackScholesPrice(S, K, T, r, sigma);
            
            // Approximate Jump-Diffusion price using Merton's formula
            // This is a simplified implementation for educational purposes
            const jumpDiffusionPrice = calculateJumpDiffusionPrice(S, K, T, r, sigma, lambda, mu, sigmaJ);
            
            document.getElementById('bsJumpPrice').textContent = '$' + bsPrice.toFixed(2);
            document.getElementById('jdJumpPrice').textContent = '$' + jumpDiffusionPrice.toFixed(2);
            document.getElementById('jumpPremium').textContent = '$' + (jumpDiffusionPrice - bsPrice).toFixed(2);
        }
        
        function calculateJumpDiffusionPrice(S, K, T, r, sigma, lambda, mu, sigmaJ) {
            // Merton's jump-diffusion formula (simplified)
            // In practice, this involves summing over multiple terms
            const k = Math.exp(mu + 0.5 * sigmaJ * sigmaJ) - 1;
            const adjustedRate = r - lambda * k;
            
            // Use Black-Scholes with adjusted parameters as approximation
            return calculateBlackScholesPrice(S, K, T, adjustedRate, sigma) * (1 + lambda * T * k);
        }
        
        function renderJumpVisualization(steps, T) {
            const canvas = document.getElementById('jumpCanvas');
            const ctx = document.createElement('canvas');
            ctx.width = canvas.clientWidth - 20;
            ctx.height = canvas.clientHeight - 20;
            ctx.style.width = '100%';
            ctx.style.height = '100%';
            
            // Clear canvas and add the new one
            canvas.innerHTML = '';
            canvas.appendChild(ctx);
            
            const context = ctx.getContext('2d');
            const width = ctx.width;
            const height = ctx.height;
            
            // Set up axes
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // Find price bounds
            let minPrice = Infinity, maxPrice = -Infinity;
            jumpPaths.forEach(path => {
                path.prices.forEach(price => {
                    minPrice = Math.min(minPrice, price);
                    maxPrice = Math.max(maxPrice, price);
                });
            });
            
            const priceRange = maxPrice - minPrice;
            minPrice -= priceRange * 0.1;
            maxPrice += priceRange * 0.1;
            
            // Clear background
            context.fillStyle = '#f9fafb';
            context.fillRect(0, 0, width, height);
            
            // Draw grid
            context.strokeStyle = '#e5e7eb';
            context.lineWidth = 1;
            
            // Vertical grid lines (time)
            for (let i = 0; i <= 10; i++) {
                const x = padding + (i / 10) * chartWidth;
                context.beginPath();
                context.moveTo(x, padding);
                context.lineTo(x, height - padding);
                context.stroke();
            }
            
            // Horizontal grid lines (price)
            for (let i = 0; i <= 10; i++) {
                const y = padding + (i / 10) * chartHeight;
                context.beginPath();
                context.moveTo(padding, y);
                context.lineTo(width - padding, y);
                context.stroke();
            }
            
            // Draw axes
            context.strokeStyle = '#374151';
            context.lineWidth = 2;
            context.beginPath();
            context.moveTo(padding, height - padding);
            context.lineTo(width - padding, height - padding);
            context.moveTo(padding, padding);
            context.lineTo(padding, height - padding);
            context.stroke();
            
            // Draw price paths
            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            
            jumpPaths.forEach((path, pathIndex) => {
                context.strokeStyle = colors[pathIndex % colors.length];
                context.lineWidth = 2;
                context.beginPath();
                
                path.prices.forEach((price, i) => {
                    const x = padding + (i / (steps)) * chartWidth;
                    const y = height - padding - ((price - minPrice) / (maxPrice - minPrice)) * chartHeight;
                    
                    if (i === 0) {
                        context.moveTo(x, y);
                    } else {
                        context.lineTo(x, y);
                    }
                });
                
                context.stroke();
            });
            
            // Add labels
            context.fillStyle = '#374151';
            context.font = '12px Arial';
            context.textAlign = 'center';
            context.fillText('Time', width / 2, height - 10);
            
            context.save();
            context.translate(15, height / 2);
            context.rotate(-Math.PI / 2);
            context.fillText('Stock Price ($)', 0, 0);
            context.restore();
            
            // Price axis labels
            context.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const price = minPrice + (i / 5) * (maxPrice - minPrice);
                const y = height - padding - (i / 5) * chartHeight;
                context.fillText('$' + price.toFixed(0), padding - 5, y + 3);
            }
        }
        
        function normalRandom() {
            // Box-Muller transformation for normal random variables
            if (!normalRandom.hasSpare) {
                normalRandom.hasSpare = true;
                const u1 = Math.random();
                const u2 = Math.random();
                normalRandom.spare = Math.sqrt(-2 * Math.log(u1)) * Math.sin(2 * Math.PI * u2);
                return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            } else {
                normalRandom.hasSpare = false;
                return normalRandom.spare;
            }
        }

        // ============================================================================
        // INTERACTIVE TUTORIALS IMPLEMENTATION
        // ============================================================================

        let currentTutorialStep = 0;
        let currentTutorial = 'greeks';
        
        // Tutorial content data
        const tutorialContent = {
            greeks: {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: What are the Greeks?",
                        content: `
                            <p class="text-purple-700">The "Greeks" are risk sensitivities that measure how an option's price changes with respect to various factors. They're called Greeks because most are represented by Greek letters (Δ, Γ, Θ, ν, ρ).</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Think of Greeks as:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Delta (Δ):</strong> Speed - how fast price moves with stock</li>
                                    <li>• <strong>Gamma (Γ):</strong> Acceleration - how speed changes</li>
                                    <li>• <strong>Theta (Θ):</strong> Time decay - daily price erosion</li>
                                    <li>• <strong>Vega (ν):</strong> Volatility sensitivity</li>
                                    <li>• <strong>Rho (ρ):</strong> Interest rate sensitivity</li>
                                </ul>
                            </div>
                        `,
                        insight: "Move the stock price slider and watch how Delta changes the option value. Delta tells you how much the option price moves for each $1 stock price change!",
                        focusGreek: "delta"
                    },
                    {
                        title: "Step 2: Delta - The Price Speedometer",
                        content: `
                            <p class="text-purple-700">Delta measures how much an option's price changes when the underlying stock price moves by $1. It ranges from 0 to 1 for calls, and 0 to -1 for puts.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Delta Examples:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Call with Δ = 0.60:</strong> Price rises $0.60 per $1 stock increase</li>
                                    <li>• <strong>Put with Δ = -0.40:</strong> Price falls $0.40 per $1 stock increase</li>
                                    <li>• <strong>At-the-money:</strong> Delta ≈ 0.50 (50% probability of expiring ITM)</li>
                                    <li>• <strong>Deep ITM:</strong> Delta approaches 1.0 (almost certain to expire ITM)</li>
                                </ul>
                            </div>
                        `,
                        insight: "Watch how Delta changes as you move the stock price! Notice it's highest when the option is at-the-money (stock price = strike price).",
                        focusGreek: "delta"
                    },
                    {
                        title: "Step 3: Gamma - The Acceleration Factor",
                        content: `
                            <p class="text-purple-700">Gamma measures how much Delta changes when the stock price moves by $1. Think of it as the "acceleration" of your option's price sensitivity.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Why Gamma Matters:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>High Gamma:</strong> Delta changes quickly = more risk/reward</li>
                                    <li>• <strong>ATM options:</strong> Highest gamma (most acceleration)</li>
                                    <li>• <strong>Short-term options:</strong> Gamma spikes near expiration</li>
                                    <li>• <strong>Risk management:</strong> High gamma = position can change fast</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust the days to expiry! Notice how gamma gets larger as expiration approaches - this is why short-term options are so sensitive!",
                        focusGreek: "gamma"
                    },
                    {
                        title: "Step 4: Theta - The Time Thief",
                        content: `
                            <p class="text-purple-700">Theta measures how much an option loses value each day due to time decay. It's always negative for long positions because time works against you.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Time Decay Reality:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Theta = -0.15:</strong> Option loses $15 per day per contract</li>
                                    <li>• <strong>ATM options:</strong> Highest theta (most time decay)</li>
                                    <li>• <strong>Weekends count:</strong> Monday options show 3 days of decay</li>
                                    <li>• <strong>Final weeks:</strong> Theta accelerates dramatically</li>
                                </ul>
                            </div>
                        `,
                        insight: "Reduce the days to expiry and watch Theta become more negative! Time decay accelerates as expiration approaches - this is the option seller's friend!",
                        focusGreek: "theta"
                    },
                    {
                        title: "Step 5: Vega - The Volatility Amplifier",
                        content: `
                            <p class="text-purple-700">Vega measures how much an option's price changes when volatility increases by 1%. Higher volatility means higher option prices because there's more chance of big moves.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Volatility Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Vega = 0.20:</strong> Price rises $20 per 1% volatility increase</li>
                                    <li>• <strong>ATM options:</strong> Highest vega (most vol sensitivity)</li>
                                    <li>• <strong>Earnings/events:</strong> Vol often spikes before, crashes after</li>
                                    <li>• <strong>Long options:</strong> Want high vol, short options want low vol</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust the volatility slider and see how dramatically option prices change! This is why options are expensive before earnings announcements!",
                        focusGreek: "vega"
                    }
                ]
            },
            'options-basics': {
                totalSteps: 6,
                steps: [
                    {
                        title: "Step 1: What is an Option?",
                        content: `
                            <p class="text-pink-700">An option is a contract that gives you the RIGHT (not obligation) to buy or sell a stock at a specific price by a certain date. Think of it like a reservation at a restaurant - you have the right to use it, but you don't have to.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Key Components:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Strike Price:</strong> The price at which you can buy/sell</li>
                                    <li>• <strong>Expiration Date:</strong> When the option expires</li>
                                    <li>• <strong>Premium:</strong> The cost to buy the option</li>
                                    <li>• <strong>Underlying Asset:</strong> The stock the option is based on</li>
                                </ul>
                            </div>
                        `,
                        insight: "Options give you leverage and limited risk. You can control 100 shares for much less money than buying the stock outright!",
                        demo: {
                            type: "basic_example",
                            content: `
                                <div class="bg-blue-100 p-3 rounded">
                                    <div class="text-sm font-medium text-blue-800">Example: AAPL Call Option</div>
                                    <div class="text-xs text-blue-600 mt-1">
                                        <div>Current AAPL Price: $150</div>
                                        <div>Strike Price: $155</div>
                                        <div>Expires: 30 days</div>
                                        <div>Premium: $3.50</div>
                                    </div>
                                </div>
                                <div class="text-sm mt-2">
                                    <strong>What this means:</strong> You pay $350 ($3.50 × 100 shares) for the right to buy 100 AAPL shares at $155 each, anytime in the next 30 days.
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 2: Calls vs Puts",
                        content: `
                            <p class="text-pink-700">There are two types of options: Calls and Puts. Think of them as betting on whether a stock will go up or down.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Call Options:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Right to BUY</strong> at strike price</li>
                                    <li>• <strong>Bullish:</strong> You think stock will go UP</li>
                                    <li>• <strong>Profit when:</strong> Stock price > Strike + Premium</li>
                                    <li>• <strong>Max Loss:</strong> Premium paid</li>
                                </ul>
                                <strong class="block mt-3">Put Options:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Right to SELL</strong> at strike price</li>
                                    <li>• <strong>Bearish:</strong> You think stock will go DOWN</li>
                                    <li>• <strong>Profit when:</strong> Stock price < Strike - Premium</li>
                                    <li>• <strong>Max Loss:</strong> Premium paid</li>
                                </ul>
                            </div>
                        `,
                        insight: "Calls profit from UP moves, Puts profit from DOWN moves. Your maximum loss is always limited to the premium you paid!",
                        demo: {
                            type: "call_put_comparison",
                            content: `
                                <div class="space-y-2">
                                    <div class="bg-green-100 p-2 rounded text-xs">
                                        <strong class="text-green-800">CALL EXAMPLE</strong><br>
                                        AAPL $155 Call @ $3.50<br>
                                        If AAPL → $160: Profit = $160-$155-$3.50 = $1.50/share
                                    </div>
                                    <div class="bg-red-100 p-2 rounded text-xs">
                                        <strong class="text-red-800">PUT EXAMPLE</strong><br>
                                        AAPL $145 Put @ $2.25<br>
                                        If AAPL → $140: Profit = $145-$140-$2.25 = $2.75/share
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 3: In-the-Money vs Out-of-the-Money",
                        content: `
                            <p class="text-pink-700">Options are classified based on their relationship to the current stock price. This determines their intrinsic value.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>For CALLS (Stock = $150):</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>ITM:</strong> Strike < $150 (e.g., $145 call) - Has intrinsic value</li>
                                    <li>• <strong>ATM:</strong> Strike = $150 (e.g., $150 call) - At the money</li>
                                    <li>• <strong>OTM:</strong> Strike > $150 (e.g., $155 call) - Only time value</li>
                                </ul>
                                <strong class="block mt-3">For PUTS (Stock = $150):</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>ITM:</strong> Strike > $150 (e.g., $155 put) - Has intrinsic value</li>
                                    <li>• <strong>ATM:</strong> Strike = $150 (e.g., $150 put) - At the money</li>
                                    <li>• <strong>OTM:</strong> Strike < $150 (e.g., $145 put) - Only time value</li>
                                </ul>
                            </div>
                        `,
                        insight: "ITM options are more expensive but safer. OTM options are cheaper but require bigger stock moves to be profitable!",
                        demo: {
                            type: "moneyness_table",
                            content: `
                                <div class="text-xs">
                                    <div class="grid grid-cols-3 gap-1 mb-2 font-bold text-center">
                                        <div class="bg-red-200 p-1 rounded">OTM</div>
                                        <div class="bg-yellow-200 p-1 rounded">ATM</div>
                                        <div class="bg-green-200 p-1 rounded">ITM</div>
                                    </div>
                                    <div class="text-center text-gray-600 text-xs mb-1">AAPL @ $150</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs">
                                            <span>$160 Call:</span><span class="text-red-600">OTM - $0.50</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span>$150 Call:</span><span class="text-yellow-600">ATM - $3.50</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span>$140 Call:</span><span class="text-green-600">ITM - $12.00</span>
                                        </div>
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 4: Time Decay - Your Enemy or Friend?",
                        content: `
                            <p class="text-pink-700">Time decay (Theta) is the enemy of option buyers and the friend of option sellers. Every day that passes, options lose value due to approaching expiration.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Time Decay Facts:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Accelerates:</strong> Decay speeds up in final 30 days</li>
                                    <li>• <strong>ATM highest:</strong> At-the-money options lose most time value</li>
                                    <li>• <strong>Weekends count:</strong> 3 days of decay hit on Monday</li>
                                    <li>• <strong>Never stops:</strong> Decay happens even when markets are closed</li>
                                </ul>
                                <strong class="block mt-3">Strategy Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Buying options:</strong> Time decay works against you</li>
                                    <li>• <strong>Selling options:</strong> Time decay works for you</li>
                                </ul>
                            </div>
                        `,
                        insight: "Time decay is why many option buyers lose money even when they're right about direction. Factor in time decay to your predictions!",
                        demo: {
                            type: "time_decay_chart",
                            content: `
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-center mb-2 font-bold">Option Value Over Time</div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between"><span>90 days:</span><span>$5.50</span></div>
                                        <div class="flex justify-between"><span>60 days:</span><span>$4.20</span></div>
                                        <div class="flex justify-between"><span>30 days:</span><span>$2.80</span></div>
                                        <div class="flex justify-between"><span>7 days:</span><span>$1.10</span></div>
                                        <div class="flex justify-between"><span>1 day:</span><span>$0.15</span></div>
                                    </div>
                                    <div class="text-xs text-red-600 text-center mt-2">
                                        Stock stayed at $150, but option lost 97% of value!
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 5: Volatility - The Option's Best Friend",
                        content: `
                            <p class="text-pink-700">Volatility is the amount a stock price moves up and down. Higher volatility = higher option prices, because there's more chance of big profitable moves.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Volatility Types:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Historical Vol:</strong> How much stock moved in the past</li>
                                    <li>• <strong>Implied Vol:</strong> What market expects future movement to be</li>
                                    <li>• <strong>Vol Crush:</strong> IV drops after earnings/events</li>
                                </ul>
                                <strong class="block mt-3">Trading Impact:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Before earnings:</strong> IV spikes, options get expensive</li>
                                    <li>• <strong>After earnings:</strong> IV crashes, options lose value fast</li>
                                    <li>• <strong>Buy low IV:</strong> When market is calm</li>
                                    <li>• <strong>Sell high IV:</strong> When market expects big moves</li>
                                </ul>
                            </div>
                        `,
                        insight: "You can be right about direction but still lose money if volatility drops! Always check IV before buying options.",
                        demo: {
                            type: "volatility_impact",
                            content: `
                                <div class="space-y-2 text-xs">
                                    <div class="bg-blue-100 p-2 rounded">
                                        <strong>Low Volatility (15%)</strong><br>
                                        AAPL $155 Call: $1.20<br>
                                        Market expects small moves
                                    </div>
                                    <div class="bg-orange-100 p-2 rounded">
                                        <strong>High Volatility (45%)</strong><br>
                                        AAPL $155 Call: $6.80<br>
                                        Market expects big moves (earnings week)
                                    </div>
                                    <div class="text-center text-gray-600">
                                        Same option, 467% price difference!
                                    </div>
                                </div>
                            `
                        }
                    },
                    {
                        title: "Step 6: Common Beginner Mistakes",
                        content: `
                            <p class="text-pink-700">Learn from others' mistakes! Here are the most common pitfalls that trap new options traders.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Top 5 Beginner Mistakes:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Buying OTM weeklies:</strong> Low probability, high decay</li>
                                    <li>• <strong>Ignoring time decay:</strong> Not factoring in daily losses</li>
                                    <li>• <strong>Chasing lottery tickets:</strong> Deep OTM "cheap" options</li>
                                    <li>• <strong>Not taking profits:</strong> Holding winning trades too long</li>
                                    <li>• <strong>Buying high IV:</strong> Overpaying right before vol crush</li>
                                </ul>
                                <strong class="block mt-3">Smart Strategies:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Start with ATM/ITM:</strong> Higher probability trades</li>
                                    <li>• <strong>Give yourself time:</strong> 45+ days to expiration</li>
                                    <li>• <strong>Take profits at 25-50%:</strong> Don't be greedy</li>
                                    <li>• <strong>Paper trade first:</strong> Practice without real money</li>
                                </ul>
                            </div>
                        `,
                        insight: "Most option buyers lose money not because they're wrong about direction, but because they ignore time decay and volatility!",
                        demo: {
                            type: "mistake_examples",
                            content: `
                                <div class="space-y-2 text-xs">
                                    <div class="bg-red-100 p-2 rounded border-l-4 border-red-400">
                                        <strong class="text-red-800">❌ Bad Trade</strong><br>
                                        Buy $180 AAPL calls expiring Friday<br>
                                        Stock at $150, needs 20% gain in 3 days
                                    </div>
                                    <div class="bg-green-100 p-2 rounded border-l-4 border-green-400">
                                        <strong class="text-green-800">✅ Better Trade</strong><br>
                                        Buy $155 AAPL calls expiring in 60 days<br>
                                        Stock at $150, needs 3.3% gain with time
                                    </div>
                                </div>
                            `
                        }
                    }
                ]
            },
            'pricing-models': {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: Why Multiple Pricing Models?",
                        content: `
                            <p class="text-indigo-700">Different pricing models make different assumptions and trade off accuracy for speed. Understanding when to use each model is crucial for effective options trading.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>The Five Models:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Black-Scholes:</strong> Fast analytical formula (European options)</li>
                                    <li>• <strong>Binomial:</strong> Industry standard tree model</li>
                                    <li>• <strong>Trinomial:</strong> More accurate tree model (recommended)</li>
                                    <li>• <strong>Monte Carlo:</strong> Statistical simulation with confidence intervals</li>
                                    <li>• <strong>Jump Diffusion:</strong> Handles market crashes and sudden moves</li>
                                </ul>
                                <div class="mt-3 bg-blue-50 p-2 rounded text-xs">
                                    <strong>Validation:</strong> All models tested against 671,360 real market options from June 2024
                                </div>
                            </div>
                        `,
                        insight: "Notice how different models give slightly different prices. The trinomial model is generally the most accurate, while Black-Scholes is the fastest but assumes no early exercise."
                    },
                    {
                        title: "Step 2: Black-Scholes - The Speed Demon",
                        content: `
                            <p class="text-indigo-700">Black-Scholes uses a mathematical formula to instantly calculate option prices. It's blazingly fast but makes strict assumptions about market behavior.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Key Assumptions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Constant volatility:</strong> Vol stays the same until expiration</li>
                                    <li>• <strong>No early exercise:</strong> European-style options only</li>
                                    <li>• <strong>No dividends:</strong> (or constant dividend yield)</li>
                                    <li>• <strong>Constant risk-free rate:</strong> Interest rates don't change</li>
                                    <li>• <strong>Log-normal distribution:</strong> Stock prices follow smooth curves</li>
                                </ul>
                                <strong class="block mt-3">Best For:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• Quick estimates and screening</li>
                                    <li>• European options (index options)</li>
                                    <li>• When speed matters more than precision</li>
                                </ul>
                            </div>
                        `,
                        insight: "Change parameters quickly and see how Black-Scholes responds instantly! Perfect for real-time trading systems, but less accurate for American options."
                    },
                    {
                        title: "Step 3: Binomial Trees - The Industry Standard",
                        content: `
                            <p class="text-indigo-700">The binomial model builds a tree of possible stock price paths, calculating option values at each node. It handles American early exercise and is widely used by professionals.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>How It Works:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Price tree:</strong> Stock can go up or down each period</li>
                                    <li>• <strong>Risk-neutral probabilities:</strong> Mathematical, not real probabilities</li>
                                    <li>• <strong>Backward induction:</strong> Works from expiration back to today</li>
                                    <li>• <strong>Early exercise:</strong> Checks American exercise at each node</li>
                                </ul>
                                <strong class="block mt-3">Accuracy:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• 50 steps: Good for most trading (±$0.01 typical error)</li>
                                    <li>• 100+ steps: High precision (±$0.003 typical error)</li>
                                    <li>• More steps = better accuracy but slower computation</li>
                                </ul>
                            </div>
                        `,
                        insight: "Try changing days to expiry and see how the models diverge more for American options with dividends - this shows the early exercise premium!"
                    },
                    {
                        title: "Step 4: Trinomial Trees - The Accuracy Champion",
                        content: `
                            <p class="text-indigo-700">Trinomial models use three possible moves (up, down, stay same) at each step instead of two. This provides 16.4% better accuracy than binomial models according to our market validation.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Advantages:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Better convergence:</strong> More stable as steps increase</li>
                                    <li>• <strong>Smoother Greeks:</strong> Less numerical noise in sensitivities</li>
                                    <li>• <strong>Flexible calibration:</strong> Matches market volatility better</li>
                                    <li>• <strong>Professional standard:</strong> Used by most banks and hedge funds</li>
                                </ul>
                                <strong class="block mt-3">Validation Results:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• 16.4% more accurate than binomial baseline</li>
                                    <li>• 4.8% average implied volatility difference vs market</li>
                                    <li>• 87% of options within 5% IV difference</li>
                                </ul>
                                <div class="bg-green-50 p-2 rounded text-xs mt-3">
                                    <strong>💡 Recommendation:</strong> Use trinomial for production trading systems
                                </div>
                            </div>
                        `,
                        insight: "Watch how trinomial prices stay closest to market consensus! The extra accuracy is especially valuable for complex strategies and risk management."
                    },
                    {
                        title: "Step 5: Monte Carlo & Jump Diffusion - Advanced Realism",
                        content: `
                            <p class="text-indigo-700">Monte Carlo simulates thousands of random price paths, while Jump Diffusion adds sudden market crashes. These models capture real market complexity that simple models miss.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Monte Carlo Benefits:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Statistical confidence:</strong> Provides error bounds (±$0.05)</li>
                                    <li>• <strong>Complex payoffs:</strong> Handles path-dependent options</li>
                                    <li>• <strong>Flexible modeling:</strong> Any volatility/rate process</li>
                                </ul>
                                <strong class="block mt-3">Jump Diffusion Realism:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Market crashes:</strong> Captures COVID-19, 2008 financial crisis style drops</li>
                                    <li>• <strong>Earnings gaps:</strong> Models sudden 10%+ moves</li>
                                    <li>• <strong>Fat tails:</strong> More realistic than normal distribution</li>
                                    <li>• <strong>Risk premiums:</strong> Higher prices reflect crash risk</li>
                                </ul>
                                <div class="bg-orange-50 p-2 rounded text-xs mt-3">
                                    <strong>📊 Usage:</strong> Jump diffusion prices typically 2-8% higher during volatile periods
                                </div>
                            </div>
                        `,
                        insight: "Compare normal models vs jump diffusion - notice how crash risk increases option values, especially for protective puts and portfolio insurance!"
                    }
                ]
            },
            'risk-management': {
                totalSteps: 5,
                steps: [
                    {
                        title: "Step 1: The Foundation of Options Risk",
                        content: `
                            <p class="text-emerald-700">Successful options trading starts with understanding and managing risk. Unlike stock trading, options have multiple risk dimensions that must be monitored continuously.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Options Risk Dimensions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Directional Risk (Delta):</strong> Stock price movement</li>
                                    <li>• <strong>Time Decay Risk (Theta):</strong> Value loss over time</li>
                                    <li>• <strong>Volatility Risk (Vega):</strong> Changes in implied volatility</li>
                                    <li>• <strong>Acceleration Risk (Gamma):</strong> How quickly delta changes</li>
                                    <li>• <strong>Interest Rate Risk (Rho):</strong> Rate changes (usually minor)</li>
                                </ul>
                                <div class="mt-3 bg-red-50 p-2 rounded text-xs">
                                    <strong>⚠️ Key Insight:</strong> You can be right about direction but still lose money due to time decay or volatility crush!
                                </div>
                            </div>
                        `,
                        insight: "Risk management starts with position sizing. Never risk more than 1-2% of your portfolio on a single trade, regardless of how confident you feel!"
                    },
                    {
                        title: "Step 2: Position Sizing - Your Safety Net",
                        content: `
                            <p class="text-emerald-700">Position sizing is the most critical risk management tool. It determines how much you can lose on any single trade and protects you from catastrophic losses.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Position Sizing Rules:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>1-2% Rule:</strong> Risk only 1-2% of portfolio per trade</li>
                                    <li>• <strong>Kelly Criterion:</strong> Mathematical optimal bet sizing</li>
                                    <li>• <strong>Fixed Dollar Amount:</strong> Same $ risk per trade</li>
                                    <li>• <strong>Volatility Adjusted:</strong> Smaller size for high-vol stocks</li>
                                </ul>
                                <strong class="block mt-3">Example Calculation:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• Portfolio: $10,000</li>
                                    <li>• Risk per trade: 2% = $200</li>
                                    <li>• Option cost: $3.00</li>
                                    <li>• Stop loss: 50% = $1.50 risk per share</li>
                                    <li>• <strong>Position size:</strong> $200 ÷ $1.50 = 133 shares (1 contract)</li>
                                </ul>
                            </div>
                        `,
                        insight: "Adjust your position size based on the portfolio slider. Notice how larger portfolios can take bigger risks while maintaining the same percentage risk."
                    },
                    {
                        title: "Step 3: Stop Losses & Profit Taking",
                        content: `
                            <p class="text-emerald-700">Setting exit rules before entering a trade removes emotion from your decisions and ensures consistent risk management across all positions.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Exit Strategy Rules:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Stop Loss:</strong> Exit at 50% loss (before worthless)</li>
                                    <li>• <strong>Profit Target:</strong> Take profits at 25-50% gain</li>
                                    <li>• <strong>Time Stop:</strong> Exit 7-10 days before expiration</li>
                                    <li>• <strong>Volatility Stop:</strong> Exit if IV drops by 30%+</li>
                                </ul>
                                <strong class="block mt-3">Why These Rules Work:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>50% stop loss:</strong> Prevents total loss, preserves capital</li>
                                    <li>• <strong>25-50% profit:</strong> Captures gains before time decay</li>
                                    <li>• <strong>Time stop:</strong> Avoids final week gamma risk</li>
                                    <li>• <strong>IV stop:</strong> Exits before vol crush events</li>
                                </ul>
                            </div>
                        `,
                        insight: "Professional traders take profits early and cut losses quickly. The win rate slider shows how these exit rules affect your expected value over many trades."
                    },
                    {
                        title: "Step 4: Portfolio Greeks Management",
                        content: `
                            <p class="text-emerald-700">Managing portfolio-level Greeks helps you understand your overall exposure and avoid concentration risk in any single risk factor.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Portfolio Greek Limits:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Net Delta:</strong> Keep between -0.2 to +0.2 per $1000</li>
                                    <li>• <strong>Gamma Exposure:</strong> Limit to 0.1 per $1000 capital</li>
                                    <li>• <strong>Theta Income:</strong> Positive theta helps offset losses</li>
                                    <li>• <strong>Vega Exposure:</strong> Don't exceed 0.5 per $1000 capital</li>
                                </ul>
                                <strong class="block mt-3">Risk Scenarios:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>High Delta:</strong> Vulnerable to market crashes</li>
                                    <li>• <strong>High Gamma:</strong> Position can change quickly</li>
                                    <li>• <strong>Negative Theta:</strong> Losing money every day</li>
                                    <li>• <strong>High Vega:</strong> Vulnerable to vol crush</li>
                                </ul>
                            </div>
                        `,
                        insight: "Think of Greeks as your portfolio's vital signs. Just like a doctor monitors heart rate and blood pressure, you should monitor delta, theta, and vega exposure."
                    },
                    {
                        title: "Step 5: Psychological Risk Management",
                        content: `
                            <p class="text-emerald-700">The biggest risk in options trading isn't market risk—it's psychological risk. Managing your emotions and behavior is crucial for long-term success.</p>
                            <div class="bg-white p-3 rounded border">
                                <strong>Emotional Risk Factors:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>FOMO:</strong> Chasing trades you missed</li>
                                    <li>• <strong>Revenge Trading:</strong> Trying to make back losses quickly</li>
                                    <li>• <strong>Overconfidence:</strong> Increasing size after wins</li>
                                    <li>• <strong>Analysis Paralysis:</strong> Over-thinking simple trades</li>
                                </ul>
                                <strong class="block mt-3">Psychological Solutions:</strong>
                                <ul class="mt-2 text-sm space-y-1">
                                    <li>• <strong>Trade Journal:</strong> Track emotions, not just P&L</li>
                                    <li>• <strong>Position Limits:</strong> Max 3-5 open positions</li>
                                    <li>• <strong>Daily Max Loss:</strong> Stop trading at -1% portfolio loss</li>
                                    <li>• <strong>Regular Breaks:</strong> Take time off after big wins/losses</li>
                                    <li>• <strong>Paper Trading:</strong> Practice new strategies risk-free</li>
                                </ul>
                                <div class="bg-green-50 p-2 rounded text-xs mt-3">
                                    <strong>💡 Pro Tip:</strong> The best traders are boring. They follow their rules consistently, regardless of emotions.
                                </div>
                            </div>
                        `,
                        insight: "Risk of Ruin percentage shows your long-term survival probability. Lower risk per trade dramatically improves your chances of long-term success!"
                    }
                ]
            }
        };

        function showTutorial(tutorialType) {
            // Hide all tutorial content
            const tutorials = document.querySelectorAll('.tutorial-content');
            tutorials.forEach(tutorial => {
                tutorial.classList.add('hidden');
            });
            
            // Reset button styles  
            const buttons = ['greeksTutorialBtn', 'optionsBasicsTutorialBtn', 'pricingModelsTutorialBtn', 'riskManagementTutorialBtn'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                if (element) {
                    element.className = element.className.replace(/bg-\w+-700/, 'bg-gray-400');
                }
            });
            
            // Show selected tutorial
            const targetTutorial = document.getElementById(tutorialType + 'Tutorial');
            if (targetTutorial) {
                targetTutorial.classList.remove('hidden');
            }
            
            // Highlight selected button
            const selectedBtn = document.getElementById(tutorialType + 'TutorialBtn');
            if (selectedBtn) {
                selectedBtn.className = selectedBtn.className.replace('bg-gray-400', getTutorialButtonColor(tutorialType));
            }
            
            // Initialize tutorial based on type
            if (tutorialType === 'greeks') {
                currentTutorial = 'greeks';
                currentTutorialStep = 0;
                updateTutorialStep();
                initializeTutorialSliders();
            } else if (tutorialType === 'options-basics') {
                currentTutorial = 'options-basics';
                currentTutorialStep = 0;
                updateOptionsBasicsStep();
            } else if (tutorialType === 'pricing-models') {
                currentTutorial = 'pricing-models';
                currentTutorialStep = 0;
                updatePricingModelsStep();
                initializePricingModelsSliders();
            } else if (tutorialType === 'risk-management') {
                currentTutorial = 'risk-management';
                currentTutorialStep = 0;
                updateRiskManagementStep();
                initializeRiskManagementSliders();
            }
        }
        
        function getTutorialButtonColor(tutorialType) {
            const colors = {
                'greeks': 'bg-purple-700',
                'options-basics': 'bg-pink-700',
                'pricing-models': 'bg-indigo-700',
                'risk-management': 'bg-emerald-700'
            };
            return colors[tutorialType] || 'bg-purple-700';
        }
        
        function nextTutorialStep() {
            const tutorial = tutorialContent[currentTutorial];
            if (currentTutorialStep < tutorial.totalSteps - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            }
        }
        
        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }
        
        function updateTutorialStep() {
            const tutorial = tutorialContent[currentTutorial];
            const step = tutorial.steps[currentTutorialStep];
            
            // Update progress
            document.getElementById('tutorialProgress').textContent = `Step ${currentTutorialStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentTutorialStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('tutorialStep').innerHTML = `
                <div class="text-lg font-semibold text-purple-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('tutorialInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentTutorialStep === 0;
            prevBtn.className = currentTutorialStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentTutorialStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentTutorialStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    alert("🎉 Congratulations! You've completed the Greeks tutorial. Try exploring the other sections of the platform!");
                };
            } else {
                nextBtn.onclick = nextTutorialStep;
            }
            
            // Update tutorial Greeks calculation
            updateTutorialGreeks();
        }
        
        function initializeTutorialSliders() {
            // Stock price slider
            const stockSlider = document.getElementById('tutorialStockSlider');
            stockSlider.addEventListener('input', function() {
                document.getElementById('tutorialStockPrice').textContent = '$' + this.value;
                updateTutorialGreeks();
            });
            
            // Days slider
            const daysSlider = document.getElementById('tutorialDaysSlider');
            daysSlider.addEventListener('input', function() {
                document.getElementById('tutorialDaysValue').textContent = this.value;
                updateTutorialGreeks();
            });
            
            // Volatility slider
            const volSlider = document.getElementById('tutorialVolSlider');
            volSlider.addEventListener('input', function() {
                document.getElementById('tutorialVolValue').textContent = this.value + '%';
                updateTutorialGreeks();
            });
            
            // Initial calculation
            updateTutorialGreeks();
        }
        
        function updateTutorialGreeks() {
            const stockPrice = parseFloat(document.getElementById('tutorialStockSlider').value);
            const daysToExpiry = parseInt(document.getElementById('tutorialDaysSlider').value);
            const volatility = parseFloat(document.getElementById('tutorialVolSlider').value) / 100;
            
            // Use simplified Black-Scholes for tutorial
            const strikePrice = 105; // Fixed strike for tutorial
            const riskFreeRate = 0.04;
            const timeToExpiry = daysToExpiry / 365;
            
            try {
                // Calculate Greeks using our existing function
                const greeks = calculateBlackScholesGreeks(stockPrice, strikePrice, timeToExpiry, riskFreeRate, volatility);
                
                // Update display with highlighting for current step
                const currentStep = tutorialContent[currentTutorial].steps[currentTutorialStep];
                const focusGreek = currentStep.focusGreek;
                
                document.getElementById('tutorialDelta').innerHTML = 
                    (focusGreek === 'delta' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.delta.toFixed(3) + 
                    (focusGreek === 'delta' ? '</span>' : '');
                
                document.getElementById('tutorialGamma').innerHTML = 
                    (focusGreek === 'gamma' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.gamma.toFixed(3) + 
                    (focusGreek === 'gamma' ? '</span>' : '');
                
                document.getElementById('tutorialTheta').innerHTML = 
                    (focusGreek === 'theta' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.theta.toFixed(3) + 
                    (focusGreek === 'theta' ? '</span>' : '');
                
                document.getElementById('tutorialVega').innerHTML = 
                    (focusGreek === 'vega' ? '<span class="bg-yellow-200 px-1 rounded">' : '') + 
                    greeks.vega.toFixed(3) + 
                    (focusGreek === 'vega' ? '</span>' : '');
                    
            } catch (error) {
                console.error('Tutorial Greeks calculation error:', error);
            }
        }
        
        function calculateBlackScholesGreeks(S, K, T, r, sigma) {
            // Black-Scholes Greeks calculation for tutorial
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            // Standard normal CDF approximation
            function normalCDF(x) {
                return 0.5 * (1 + erf(x / Math.sqrt(2)));
            }
            
            // Standard normal PDF
            function normalPDF(x) {
                return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            }
            
            // Error function approximation
            function erf(x) {
                const a1 =  0.254829592;
                const a2 = -0.284496736;
                const a3 =  1.421413741;
                const a4 = -1.453152027;
                const a5 =  1.061405429;
                const p  =  0.3275911;
                const sign = x < 0 ? -1 : 1;
                x = Math.abs(x);
                const t = 1.0 / (1.0 + p * x);
                const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                return sign * y;
            }
            
            const delta = normalCDF(d1);
            const gamma = normalPDF(d1) / (S * sigma * Math.sqrt(T));
            const theta = -(S * normalPDF(d1) * sigma / (2 * Math.sqrt(T)) + r * K * Math.exp(-r * T) * normalCDF(d2)) / 365;
            const vega = S * normalPDF(d1) * Math.sqrt(T) / 100;
            
            return { delta, gamma, theta, vega };
        }

        // ============================================================================
        // OPTIONS BASICS TUTORIAL FUNCTIONS
        // ============================================================================

        let currentOptionsBasicsStep = 0;

        function nextOptionsBasicsStep() {
            const tutorial = tutorialContent['options-basics'];
            if (currentOptionsBasicsStep < tutorial.totalSteps - 1) {
                currentOptionsBasicsStep++;
                updateOptionsBasicsStep();
            }
        }
        
        function previousOptionsBasicsStep() {
            if (currentOptionsBasicsStep > 0) {
                currentOptionsBasicsStep--;
                updateOptionsBasicsStep();
            }
        }
        
        function updateOptionsBasicsStep() {
            const tutorial = tutorialContent['options-basics'];
            const step = tutorial.steps[currentOptionsBasicsStep];
            
            // Update progress
            document.getElementById('optionsBasicsProgress').textContent = `Step ${currentOptionsBasicsStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentOptionsBasicsStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('optionsBasicsProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('optionsBasicsStep').innerHTML = `
                <div class="text-lg font-semibold text-pink-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update demo section
            document.getElementById('optionsBasicsDemo').innerHTML = step.demo.content;
            
            // Update insight
            document.getElementById('optionsBasicsInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('optionsBasicsPrevBtn');
            const nextBtn = document.getElementById('optionsBasicsNextBtn');
            
            prevBtn.disabled = currentOptionsBasicsStep === 0;
            prevBtn.className = currentOptionsBasicsStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentOptionsBasicsStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentOptionsBasicsStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    alert("🎉 Excellent! You've completed the Options Basics tutorial. You now understand the fundamentals of options trading. Try the other tutorials to deepen your knowledge!");
                };
            } else {
                nextBtn.onclick = nextOptionsBasicsStep;
            }
            
            // Update visualization based on step
            updateOptionsBasicsVisualization();
        }
        
        function updateOptionsBasicsVisualization() {
            const visualizationDiv = document.getElementById('optionsBasicsVisualization');
            const step = currentOptionsBasicsStep;
            
            switch(step) {
                case 0: // What is an option
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-sm font-bold text-blue-600 mb-2">Contract Structure</div>
                                <div class="text-xs space-y-1">
                                    <div>👤 You ←→ 📄 Option Contract ←→ 📈 AAPL Stock</div>
                                    <div class="text-green-600">RIGHT to buy at $155</div>
                                    <div class="text-red-600">Cost: $3.50 × 100 = $350</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 1: // Calls vs Puts
                    visualizationDiv.innerHTML = `
                        <canvas id="callPutChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawCallPutChart();
                    break;
                case 2: // Moneyness
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border p-2">
                            <div class="text-xs font-bold text-center mb-2">Option Values at AAPL $150</div>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between items-center">
                                    <span>$140 Call (ITM)</span>
                                    <div class="w-16 bg-green-200 h-3 rounded flex items-center justify-center text-xs">$12</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>$150 Call (ATM)</span>
                                    <div class="w-8 bg-yellow-200 h-3 rounded flex items-center justify-center text-xs">$3.5</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>$160 Call (OTM)</span>
                                    <div class="w-2 bg-red-200 h-3 rounded flex items-center justify-center text-xs">$0.5</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 3: // Time decay
                    visualizationDiv.innerHTML = `
                        <canvas id="timeDecayChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawTimeDecayChart();
                    break;
                case 4: // Volatility
                    visualizationDiv.innerHTML = `
                        <canvas id="volatilityChart" width="260" height="120" class="bg-white rounded border"></canvas>
                    `;
                    drawVolatilityChart();
                    break;
                case 5: // Mistakes
                    visualizationDiv.innerHTML = `
                        <div class="h-32 bg-white rounded border p-2 text-xs">
                            <div class="text-center font-bold mb-2">Probability of Profit</div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-red-600">$180 Call (3 days)</span>
                                    <div class="flex items-center">
                                        <div class="w-4 bg-red-300 h-2 rounded mr-1"></div>
                                        <span>5%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-green-600">$155 Call (60 days)</span>
                                    <div class="flex items-center">
                                        <div class="w-12 bg-green-300 h-2 rounded mr-1"></div>
                                        <span>35%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }
        
        function drawCallPutChart() {
            const canvas = document.getElementById('callPutChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Call profit line (green)
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 80);
            ctx.lineTo(120, 80);
            ctx.lineTo(220, 20);
            ctx.stroke();
            
            // Put profit line (red)
            ctx.strokeStyle = '#ef4444';
            ctx.beginPath();
            ctx.moveTo(20, 20);
            ctx.lineTo(120, 80);
            ctx.lineTo(220, 80);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Call Profit', 180, 15);
            ctx.fillText('Put Profit', 180, 35);
            ctx.fillText('Stock Price →', 100, 110);
        }
        
        function drawTimeDecayChart() {
            const canvas = document.getElementById('timeDecayChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Time decay curve
            ctx.strokeStyle = '#dc2626';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 20);
            ctx.quadraticCurveTo(120, 30, 220, 100);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Option Value', 10, 15);
            ctx.fillText('Days to Expiry →', 100, 115);
            ctx.fillText('90d: $5.50', 25, 35);
            ctx.fillText('1d: $0.15', 180, 95);
        }
        
        function drawVolatilityChart() {
            const canvas = document.getElementById('volatilityChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Low vol bar
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(50, 70, 30, 30);
            
            // High vol bar
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(150, 20, 30, 80);
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.fillText('Low Vol', 50, 115);
            ctx.fillText('15%', 58, 90);
            ctx.fillText('$1.20', 55, 85);
            ctx.fillText('High Vol', 145, 115);
            ctx.fillText('45%', 158, 40);
            ctx.fillText('$6.80', 155, 35);
        }

        // ============================================================================
        // PRICING MODELS TUTORIAL IMPLEMENTATION
        // ============================================================================

        let currentPricingModelsStep = 0;

        function nextPricingModelsStep() {
            const tutorial = tutorialContent['pricing-models'];
            if (currentPricingModelsStep < tutorial.totalSteps - 1) {
                currentPricingModelsStep++;
                updatePricingModelsStep();
            }
        }

        function previousPricingModelsStep() {
            if (currentPricingModelsStep > 0) {
                currentPricingModelsStep--;
                updatePricingModelsStep();
            }
        }
        
        function updatePricingModelsStep() {
            const tutorial = tutorialContent['pricing-models'];
            const step = tutorial.steps[currentPricingModelsStep];
            
            // Update progress
            document.getElementById('pricingModelsProgress').textContent = `Step ${currentPricingModelsStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentPricingModelsStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('pricingModelsProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('pricingModelsStep').innerHTML = `
                <div class="text-lg font-semibold text-indigo-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('modelsInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('pricingModelsPrevBtn');
            const nextBtn = document.getElementById('pricingModelsNextBtn');
            
            prevBtn.disabled = currentPricingModelsStep === 0;
            prevBtn.className = currentPricingModelsStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentPricingModelsStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentPricingModelsStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    alert("🎉 Excellent! You've completed the Pricing Models tutorial. You now understand the different models and when to use each one. This knowledge will help you make better trading decisions!");
                };
            } else {
                nextBtn.onclick = nextPricingModelsStep;
            }
            
            // Update model prices
            updatePricingModelsCalculation();
        }
        
        function initializePricingModelsSliders() {
            const stockSlider = document.getElementById('modelsStockSlider');
            const daysSlider = document.getElementById('modelsDaysSlider');
            const volSlider = document.getElementById('modelsVolSlider');
            
            if (stockSlider) {
                stockSlider.addEventListener('input', function() {
                    document.getElementById('modelsStockPrice').textContent = `$${this.value}`;
                    updatePricingModelsCalculation();
                });
            }
            
            if (daysSlider) {
                daysSlider.addEventListener('input', function() {
                    document.getElementById('modelsDaysValue').textContent = this.value;
                    updatePricingModelsCalculation();
                });
            }
            
            if (volSlider) {
                volSlider.addEventListener('input', function() {
                    document.getElementById('modelsVolValue').textContent = `${this.value}%`;
                    updatePricingModelsCalculation();
                });
            }
            
            // Initial calculation
            updatePricingModelsCalculation();
        }
        
        function updatePricingModelsCalculation() {
            if (!pricingLibrary) return;
            
            try {
                const stockPrice = parseFloat(document.getElementById('modelsStockSlider')?.value) || 100;
                const daysToExpiry = parseInt(document.getElementById('modelsDaysSlider')?.value) || 30;
                const volatility = parseFloat(document.getElementById('modelsVolSlider')?.value) / 100 || 0.25;
                
                const params = {
                    stockPrice: stockPrice,
                    strikePrice: 105, // Fixed ATM strike
                    daysToExpiry: daysToExpiry,
                    volatility: volatility,
                    optionType: 'call',
                    timeToExpiry: daysToExpiry / 365,
                    riskFreeRate: 0.04,
                    dividendYield: 0.02,
                    exerciseStyle: 'american'
                };
                
                // Calculate prices with all models
                const trinomialPrice = pricingLibrary.trinomialPrice({ ...params, steps: 50 });
                const binomialPrice = pricingLibrary.binomialPrice({ ...params, steps: 50 });
                const bsPrice = pricingLibrary.blackScholesPrice(params);
                const mcResult = pricingLibrary.monteCarloPrice({ ...params, simulations: 10000 });
                const jdPrice = pricingLibrary.jumpDiffusionPrice({ 
                    ...params, 
                    jumpIntensity: 2, 
                    jumpMean: -0.02, 
                    jumpVolatility: 0.08 
                });
                
                // Update displays
                document.getElementById('modelTrinomialPrice').textContent = '$' + trinomialPrice.toFixed(2);
                document.getElementById('modelBinomialPrice').textContent = '$' + binomialPrice.toFixed(2);
                document.getElementById('modelBSPrice').textContent = '$' + bsPrice.toFixed(2);
                document.getElementById('modelMCPrice').textContent = `$${mcResult.price.toFixed(2)} ±${mcResult.standardError.toFixed(2)}`;
                document.getElementById('modelJDPrice').textContent = '$' + jdPrice.toFixed(2);
                
            } catch (error) {
                console.warn('Pricing models tutorial calculation error:', error);
                // Show default values
                document.getElementById('modelTrinomialPrice').textContent = '$8.45';
                document.getElementById('modelBinomialPrice').textContent = '$8.42';
                document.getElementById('modelBSPrice').textContent = '$8.38';
                document.getElementById('modelMCPrice').textContent = '$8.41 ±0.05';
                document.getElementById('modelJDPrice').textContent = '$8.62';
            }
        }

        // ============================================================================
        // RISK MANAGEMENT TUTORIAL IMPLEMENTATION
        // ============================================================================

        let currentRiskManagementStep = 0;

        function nextRiskManagementStep() {
            const tutorial = tutorialContent['risk-management'];
            if (currentRiskManagementStep < tutorial.totalSteps - 1) {
                currentRiskManagementStep++;
                updateRiskManagementStep();
            }
        }

        function previousRiskManagementStep() {
            if (currentRiskManagementStep > 0) {
                currentRiskManagementStep--;
                updateRiskManagementStep();
            }
        }
        
        function updateRiskManagementStep() {
            const tutorial = tutorialContent['risk-management'];
            const step = tutorial.steps[currentRiskManagementStep];
            
            // Update progress
            document.getElementById('riskManagementProgress').textContent = `Step ${currentRiskManagementStep + 1} of ${tutorial.totalSteps}`;
            const progressPercentage = ((currentRiskManagementStep + 1) / tutorial.totalSteps) * 100;
            document.getElementById('riskManagementProgressBar').style.width = progressPercentage + '%';
            
            // Update content
            document.getElementById('riskManagementStep').innerHTML = `
                <div class="text-lg font-semibold text-emerald-800">${step.title}</div>
                ${step.content}
            `;
            
            // Update insight
            document.getElementById('riskInsight').textContent = step.insight;
            
            // Update buttons
            const prevBtn = document.getElementById('riskManagementPrevBtn');
            const nextBtn = document.getElementById('riskManagementNextBtn');
            
            prevBtn.disabled = currentRiskManagementStep === 0;
            prevBtn.className = currentRiskManagementStep === 0 
                ? "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium cursor-not-allowed"
                : "px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors";
            
            nextBtn.textContent = currentRiskManagementStep === tutorial.totalSteps - 1 ? "Complete!" : "Next →";
            if (currentRiskManagementStep === tutorial.totalSteps - 1) {
                nextBtn.onclick = function() {
                    alert("🎉 Outstanding! You've completed the Risk Management tutorial. You now understand how to protect your capital and manage multiple risk dimensions. These skills will help you become a consistently profitable trader!");
                };
            } else {
                nextBtn.onclick = nextRiskManagementStep;
            }
            
            // Update risk calculations
            updateRiskManagementCalculation();
        }
        
        function initializeRiskManagementSliders() {
            const portfolioSlider = document.getElementById('portfolioSlider');
            const riskSlider = document.getElementById('riskSlider');
            const winRateSlider = document.getElementById('winRateSlider');
            
            if (portfolioSlider) {
                portfolioSlider.addEventListener('input', function() {
                    document.getElementById('portfolioSize').textContent = `$${parseInt(this.value).toLocaleString()}`;
                    updateRiskManagementCalculation();
                });
            }
            
            if (riskSlider) {
                riskSlider.addEventListener('input', function() {
                    document.getElementById('riskPerTrade').textContent = `${this.value}%`;
                    updateRiskManagementCalculation();
                });
            }
            
            if (winRateSlider) {
                winRateSlider.addEventListener('input', function() {
                    document.getElementById('winRate').textContent = `${this.value}%`;
                    updateRiskManagementCalculation();
                });
            }
            
            // Initial calculation
            updateRiskManagementCalculation();
        }
        
        function updateRiskManagementCalculation() {
            try {
                const portfolioSize = parseFloat(document.getElementById('portfolioSlider')?.value) || 10000;
                const riskPerTrade = parseFloat(document.getElementById('riskSlider')?.value) / 100 || 0.02;
                const winRate = parseFloat(document.getElementById('winRateSlider')?.value) / 100 || 0.6;
                
                // Risk calculations
                const maxLoss = portfolioSize * riskPerTrade;
                const averageOptionCost = 3.00; // Assume $3 option
                const positionSize = Math.floor(maxLoss / (averageOptionCost * 0.5 * 100)); // 50% stop loss, 100 shares per contract
                
                // Expected value calculation (simplified)
                const averageWin = 150; // $150 average win
                const averageLoss = 150; // $150 average loss (50% stop loss)
                const expectedValue = (winRate * averageWin) - ((1 - winRate) * averageLoss);
                
                // Kelly Criterion: f = (bp - q) / b where b=odds, p=win rate, q=loss rate
                const payoutRatio = averageWin / averageLoss;
                const kelly = Math.max(0, (payoutRatio * winRate - (1 - winRate)) / payoutRatio);
                
                // Simplified Risk of Ruin calculation
                const riskOfRuin = Math.pow((1 - winRate) / winRate, portfolioSize / maxLoss) * 100;
                
                // Update displays
                document.getElementById('maxLossPerTrade').textContent = `$${Math.round(maxLoss)}`;
                document.getElementById('positionSize').textContent = `${Math.max(1, positionSize)} contract${positionSize !== 1 ? 's' : ''}`;
                document.getElementById('expectedValue').textContent = expectedValue > 0 ? `+$${Math.round(expectedValue)}` : `-$${Math.round(Math.abs(expectedValue))}`;
                document.getElementById('kellyCriterion').textContent = `${(kelly * 100).toFixed(1)}%`;
                document.getElementById('riskOfRuin').textContent = `${Math.min(99.9, riskOfRuin).toFixed(1)}%`;
                
            } catch (error) {
                console.warn('Risk management tutorial calculation error:', error);
                // Show default values
                document.getElementById('maxLossPerTrade').textContent = '$200';
                document.getElementById('positionSize').textContent = '2 contracts';
                document.getElementById('expectedValue').textContent = '+$24';
                document.getElementById('kellyCriterion').textContent = '3.6%';
                document.getElementById('riskOfRuin').textContent = '8.2%';
            }
        }

        // ============================================================================
        // 3D GREEKS SURFACE PLOTS IMPLEMENTATION
        // ============================================================================

        let scene, camera, renderer, surfaceMesh, controls;
        let animationFrame;
        let isRotating = false;

        function initialize3DVisualization() {
            const container = document.getElementById('threejs-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(15, 15, 15);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Clear container and add renderer
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Controls setup (OrbitControls)
            if (typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.enableRotate = true;
                controls.enablePan = true;
            }

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x00ffff, 0.5);
            pointLight.position.set(-10, 10, -5);
            scene.add(pointLight);

            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20, 0x666666, 0x444444);
            gridHelper.position.y = -5;
            scene.add(gridHelper);

            // Add axis helpers
            const axesHelper = new THREE.AxesHelper(10);
            scene.add(axesHelper);

            // Start animation loop
            animate3D();

            console.log('3D Visualization initialized successfully');
        }

        function generate3DSurface() {
            const greekType = document.getElementById('greek3D').value;
            const baseStock = parseFloat(document.getElementById('base3DStock').value);
            const strike = parseFloat(document.getElementById('strike3D').value);
            const volatility = parseFloat(document.getElementById('vol3D').value) / 100;

            // Remove existing surface
            if (surfaceMesh) {
                scene.remove(surfaceMesh);
            }

            // Generate surface data
            const resolution = 30;
            const stockRange = baseStock * 0.4; // ±40% range
            const timeRange = 90; // 0-90 days

            const geometry = new THREE.PlaneGeometry(20, 20, resolution - 1, resolution - 1);
            const vertices = geometry.attributes.position.array;
            const colors = [];

            let minValue = Infinity;
            let maxValue = -Infinity;

            // Calculate Greeks for each point
            for (let i = 0; i < resolution; i++) {
                for (let j = 0; j < resolution; j++) {
                    const stockPrice = baseStock + (stockRange * 2 * (i / (resolution - 1)) - stockRange);
                    const timeToExpiry = (timeRange * (j / (resolution - 1)) + 1) / 365; // 1-90 days
                    
                    // Calculate Greek value using our pricing library
                    try {
                        const greeks = pricingLibrary.calculateGreeks({
                            stockPrice: stockPrice,
                            strikePrice: strike,
                            timeToExpiry: timeToExpiry,
                            riskFreeRate: 0.04,
                            volatility: volatility,
                            dividendYield: 0.015,
                            optionType: 'call',
                            exerciseStyle: 'american'
                        });

                        let value = 0;
                        switch (greekType) {
                            case 'delta':
                                value = greeks.delta;
                                break;
                            case 'gamma':
                                value = greeks.gamma;
                                break;
                            case 'theta':
                                value = greeks.theta * 365; // Convert to per-year for better scaling
                                break;
                            case 'vega':
                                value = greeks.vega * 100; // Convert to per-vol-point for better scaling
                                break;
                        }

                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = value * 3; // Scale Z for visibility

                        minValue = Math.min(minValue, value);
                        maxValue = Math.max(maxValue, value);

                        // Color based on value (heat map)
                        const normalizedValue = (value - minValue) / (maxValue - minValue) || 0;
                        const color = new THREE.Color();
                        color.setHSL(0.7 * (1 - normalizedValue), 0.8, 0.5); // Blue to Red gradient
                        colors.push(color.r, color.g, color.b);

                    } catch (error) {
                        console.warn('Error calculating Greeks:', error);
                        const index = (i * resolution + j) * 3;
                        vertices[index + 2] = 0;
                        colors.push(0.5, 0.5, 0.5); // Gray for errors
                    }
                }
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            // Create surface material
            const material = new THREE.MeshLambertMaterial({
                vertexColors: true,
                side: THREE.DoubleSide,
                wireframe: false
            });

            // Create mesh
            surfaceMesh = new THREE.Mesh(geometry, material);
            surfaceMesh.rotation.x = -Math.PI / 2; // Rotate to make it horizontal
            surfaceMesh.castShadow = true;
            surfaceMesh.receiveShadow = true;

            scene.add(surfaceMesh);

            // Update analysis display
            updateSurfaceAnalysis(greekType, minValue, maxValue, baseStock, strike, volatility * 100);

            // Show analysis section
            document.getElementById('surface-analysis').style.display = 'grid';
            
            console.log(`3D ${greekType} surface generated with range: ${minValue.toFixed(4)} to ${maxValue.toFixed(4)}`);
        }

        function updateSurfaceAnalysis(greekType, minValue, maxValue, stockPrice, strike, volatility) {
            // Update statistics
            document.getElementById('max-value').textContent = maxValue.toFixed(4);
            document.getElementById('min-value').textContent = minValue.toFixed(4);
            document.getElementById('value-range').textContent = (maxValue - minValue).toFixed(4);

            // Generate insights based on Greek type
            const insightText = document.getElementById('insight-text');
            let insights = '';

            switch (greekType) {
                case 'delta':
                    insights = `
                        <div class="mb-2"><strong>Delta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Peak at strike price ($${strike})</div>
                            <div>• Call delta: 0 (far OTM) → 1 (far ITM)</div>
                            <div>• Steepest slope around at-the-money</div>
                            <div>• Less time sensitivity for far ITM/OTM</div>
                        </div>
                    `;
                    break;
                case 'gamma':
                    insights = `
                        <div class="mb-2"><strong>Gamma Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Decreases rapidly away from strike</div>
                            <div>• Increases as expiration approaches</div>
                            <div>• Near zero for far ITM/OTM options</div>
                        </div>
                    `;
                    break;
                case 'theta':
                    insights = `
                        <div class="mb-2"><strong>Theta Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Most negative (decay) at-the-money</div>
                            <div>• Accelerates as expiration approaches</div>
                            <div>• Lower time decay for far ITM/OTM</div>
                            <div>• Time decay is option holder's enemy</div>
                        </div>
                    `;
                    break;
                case 'vega':
                    insights = `
                        <div class="mb-2"><strong>Vega Surface Analysis:</strong></div>
                        <div class="text-xs space-y-1">
                            <div>• Highest at-the-money (strike: $${strike})</div>
                            <div>• Increases with more time to expiry</div>
                            <div>• Near zero for far ITM/OTM options</div>
                            <div>• Volatility=${volatility}% impacts premium</div>
                        </div>
                    `;
                    break;
            }

            insightText.innerHTML = insights;
        }

        function animate3D() {
            animationFrame = requestAnimationFrame(animate3D);

            if (controls) {
                controls.update();
            }

            if (isRotating && surfaceMesh) {
                surfaceMesh.rotation.z += 0.005;
            }

            renderer.render(scene, camera);
        }

        function toggle3DRotation() {
            isRotating = !isRotating;
            const button = document.getElementById('rotate3D');
            button.textContent = isRotating ? '⏸️ Stop Rotation' : '🔄 Auto Rotate';
        }

        // Event listeners for 3D functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize 3D scene when the page loads
            setTimeout(initialize3DVisualization, 500);

            // Event listeners
            document.getElementById('generate3D').addEventListener('click', generate3DSurface);
            document.getElementById('rotate3D').addEventListener('click', toggle3DRotation);

            // Auto-generate initial surface
            setTimeout(() => {
                generate3DSurface();
            }, 1000);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (camera && renderer) {
                    const container = document.getElementById('threejs-container');
                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                }
            });
        });
    </script>
</body>
</html>